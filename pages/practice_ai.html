<!-- FILE: /pages/practice_ai.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI â€¢ AI ile Pratik</title>

  <meta name="theme-color" content="#02000f">
  <style>html,body{background:#02000f !important;}</style>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#02000f;
      --card: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.12);
      --muted: rgba(255,255,255,0.62);
      --good: rgba(34,197,94,1);
      --bad: rgba(239,68,68,1);
      --ai: linear-gradient(135deg,#a5b4fc 0%,#6366f1 50%,#ec4899 100%);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
    #pageContent{ height:100%; }

    .wrap{
      height:100%;
      max-width:560px;
      margin:0 auto;
      padding: 14px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .panel{
      border-radius: 24px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 14px;
    }

    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title{
      font-family:"Space Grotesk",system-ui,sans-serif;
      font-weight:1000;
      font-size:16px;
      margin:0;
      color:#fff;
    }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      font-weight:1000;
      font-size:12px;
      color: rgba(255,255,255,0.88);
      white-space:nowrap;
    }
    .pill.ok{ color: rgba(165,180,252,0.95); }
    .pill.bad{ color: rgba(255,90,140,0.95); border-color: rgba(255,90,140,0.35); background: rgba(255,0,90,0.10); }

    .sub{
      margin: 8px 0 0;
      font-size:12px;
      font-weight:900;
      color: rgba(255,255,255,0.70);
      line-height:1.5;
    }

    /* language grid */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    button.lang{
      width:100%;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: var(--card);
      padding: 12px 12px;
      min-height: 86px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
      color:#fff;
      font-weight:1000;
      text-align:center;
      appearance:none;
      -webkit-appearance:none;
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    button.lang:active{ transform: scale(.985); }
    button.lang.sel{ border-color: rgba(165,180,252,0.55); background: rgba(99,102,241,0.16); }

    .flag{ font-size:24px; line-height:1; }
    .lname{ font-size:14px; font-weight:1000; }
    .lmeta{ font-size:11px; font-weight:900; color: rgba(255,255,255,0.58); }
    .lmeta.ok{ color: rgba(165,180,252,0.95); }

    /* gate screen */
    .gate{
      flex:1;
      display:none;
      flex-direction:column;
      gap:12px;
    }
    .gate.show{ display:flex; }

    .cta{
      margin-top:auto;
      display:flex;
      gap:10px;
    }
    .btn{
      height:56px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-weight:1000;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      flex:1;
    }
    .btn:active{ transform: scale(.99); }
    .btn-main{
      border:none;
      background: var(--ai);
      color:#050510;
      font-weight:1000;
    }
    .btn-danger{
      border:1px solid rgba(255,90,140,0.35);
      background: rgba(255,0,90,0.10);
      color:#fff;
    }

    /* chat */
    .chat{
      flex:1;
      min-height:0;
      display:none;
      flex-direction:column;
      gap:10px;
    }
    .chat.show{ display:flex; }

    .log{
      flex:1;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      padding: 12px;
    }
    .log::-webkit-scrollbar{ display:none; }

    .msg{
      display:flex;
      margin: 8px 0;
    }
    .bubble{
      max-width: 88%;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      font-weight:900;
      font-size: 12.5px;
      line-height:1.45;
      white-space:pre-wrap;
    }
    .me{ justify-content:flex-end; }
    .me .bubble{ background: rgba(99,102,241,0.18); border-color: rgba(99,102,241,0.35); }
    .aiMsg{ justify-content:flex-start; }
    .aiMsg .bubble{ background: rgba(255,255,255,0.05); }

    .composer{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .inp{
      flex:1;
      height:52px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-weight:900;
      padding: 0 12px;
      outline:none;
    }
    .send{
      width: 92px;
      height:52px;
      border-radius: 18px;
      border:none;
      background: #fff;
      color:#000;
      font-weight:1000;
      cursor:pointer;
    }
    .send:disabled{ opacity:.35; cursor:not-allowed; }

    .tog{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      font-size:12px;
      color: rgba(255,255,255,0.78);
      user-select:none;
    }
    .tog input{ transform: scale(1.1); }

    .toast{
      position: fixed;
      left:50%;
      top:18px;
      transform: translateX(-50%) translateY(-120px);
      background: rgba(10,10,18,0.95);
      border: 1px solid rgba(165,180,252,0.35);
      padding: 10px 14px;
      border-radius: 999px;
      color:#fff;
      z-index: 999999;
      font-weight: 1000;
      font-size: 12px;
      transition: .25s;
      backdrop-filter: blur(12px);
      pointer-events:none;
      max-width: min(92vw, 520px);
      text-align:center;
    }
    .toast.show{ transform: translateX(-50%) translateY(0); }
  </style>
</head>

<body>
<main id="pageContent">
  <div class="wrap">

    <section class="panel">
      <div class="row">
        <h1 class="title">AI ile Pratik</h1>
        <div class="pill" id="costPill">Maliyet: Ã—2 (TTS)</div>
      </div>
      <p class="sub">
        Dil seÃ§ â†’ seviye kontrol â†’ seviye varsa pratik baÅŸlar. Seviye yoksa Ã¶nce sÄ±nava yÃ¶nlendirir.
      </p>
    </section>

    <section class="panel">
      <div class="row" style="margin-bottom:10px;">
        <div class="pill ok" id="selLangPill">Dil: â€”</div>
        <div class="pill" id="levelPill">Seviye: â€”</div>
      </div>

      <div class="grid" id="langGrid"></div>
    </section>

    <!-- Gate -->
    <section class="gate" id="gate">
      <section class="panel">
        <h2 class="title" style="margin:0 0 6px;">Seviye gerekli</h2>
        <p class="sub" id="gateText">
          Bu derse katÄ±labilmek iÃ§in seviye tespit sÄ±navÄ±na katÄ±lmanÄ±z gerekiyor.
        </p>
        <div class="row" style="margin-top:10px;">
          <div class="pill">Ãœcret: <b>5 Jeton</b></div>
          <div class="pill">SÃ¼re: <b>40 dk</b></div>
        </div>
      </section>

      <div class="cta">
        <button class="btn btn-danger" id="btnWallet" type="button">Jeton YÃ¼kle</button>
        <button class="btn btn-main" id="btnStartTest" type="button">Seviye Tespit SÄ±navÄ±na KatÄ±l</button>
      </div>
    </section>

    <!-- Chat -->
    <section class="chat" id="chat">
      <div class="log" id="log"></div>

      <div class="row" style="justify-content:space-between;">
        <label class="tog"><input type="checkbox" id="ttsOn" checked> TTS AÃ§Ä±k (Ã—2)</label>
        <div class="pill" id="tokenPill">Jeton: â€”</div>
      </div>

      <div class="composer">
        <input class="inp" id="inp" placeholder="Mesaj yazâ€¦ (Ã¶rn: Kendimi tanÄ±tmak istiyorum)" maxlength="400"/>
        <button class="send" id="btnSend" disabled>GÃ¶nder</button>
      </div>
    </section>

  </div>
</main>

<div class="toast" id="toast"></div>

<script type="module">
  import { mountShell, setHeaderTokens } from "/js/ui_shell.js";
  import { supabase } from "/js/supabase_client.js";

  // UI Shell
  mountShell({ scroll:"auto" });

  const API_BASE = "https://italky-api.onrender.com"; // backend chat+tts

  const $ = (id)=>document.getElementById(id);

  const langGrid = $("langGrid");
  const selLangPill = $("selLangPill");
  const levelPill = $("levelPill");
  const tokenPill = $("tokenPill");

  const gate = $("gate");
  const gateText = $("gateText");
  const btnStartTest = $("btnStartTest");
  const btnWallet = $("btnWallet");

  const chat = $("chat");
  const log = $("log");
  const inp = $("inp");
  const btnSend = $("btnSend");
  const ttsOn = $("ttsOn");
  const costPill = $("costPill");

  const LANGS = [
    { code:"en", name:"English",      flag:"ðŸ‡¬ðŸ‡§" },
    { code:"fr", name:"French",       flag:"ðŸ‡«ðŸ‡·" },
    { code:"de", name:"German",       flag:"ðŸ‡©ðŸ‡ª" },
    { code:"es", name:"Spanish",      flag:"ðŸ‡ªðŸ‡¸" },
    { code:"it", name:"Italian",      flag:"ðŸ‡®ðŸ‡¹" },
    { code:"ru", name:"Russian",      flag:"ðŸ‡·ðŸ‡º" },

    { code:"ar", name:"Arabic",       flag:"ðŸ‡¸ðŸ‡¦" }, /* sen "sa" demiÅŸtin ama standard kod ar */
    { code:"az", name:"Azerbaijani",  flag:"ðŸ‡¦ðŸ‡¿" },
    { code:"zh", name:"Chinese",      flag:"ðŸ‡¨ðŸ‡³" }, /* cn yerine zh */
    { code:"da", name:"Danish",       flag:"ðŸ‡©ðŸ‡°" }, /* dk yerine da */
    { code:"el", name:"Greek",        flag:"ðŸ‡¬ðŸ‡·" }, /* gr yerine el */
    { code:"hr", name:"Croatian",     flag:"ðŸ‡­ðŸ‡·" },
    { code:"cs", name:"Czech",        flag:"ðŸ‡¨ðŸ‡¿" }, /* cz yerine cs */
    { code:"ja", name:"Japanese",     flag:"ðŸ‡¯ðŸ‡µ" }, /* jp yerine ja */
    { code:"ko", name:"Korean",       flag:"ðŸ‡°ðŸ‡·" }, /* kr yerine ko */
    { code:"fa", name:"Persian",      flag:"ðŸ‡®ðŸ‡·" }, /* Ä±r yerine fa */
    { code:"pt", name:"Portuguese",   flag:"ðŸ‡µðŸ‡¹" },
    { code:"ro", name:"Romanian",     flag:"ðŸ‡·ðŸ‡´" },
    { code:"sr", name:"Serbian",      flag:"ðŸ‡·ðŸ‡¸" }, /* rs yerine sr */
    { code:"sv", name:"Swedish",      flag:"ðŸ‡¸ðŸ‡ª" }, /* se yerine sv */
    { code:"th", name:"Thai",         flag:"ðŸ‡¹ðŸ‡­" },
    { code:"tr", name:"Turkish",      flag:"ðŸ‡¹ðŸ‡·" },
    { code:"uk", name:"Ukrainian",    flag:"ðŸ‡ºðŸ‡¦" }, /* ua yerine uk */
    { code:"bg", name:"Bulgarian",    flag:"ðŸ‡§ðŸ‡¬" },
  ];

  function toast(msg){
    const t = $("toast");
    t.textContent = String(msg||"");
    t.classList.add("show");
    clearTimeout(window.__to);
    window.__to = setTimeout(()=>t.classList.remove("show"), 1600);
  }

  function renderLangs(selectedCode, levels){
    langGrid.innerHTML = LANGS.map(l=>{
      const lv = (levels && typeof levels==="object") ? (levels[l.code] || "") : "";
      const meta = lv ? `Seviyeniz: ${lv}` : "Seviye yok";
      const metaCls = lv ? "lmeta ok" : "lmeta";
      const selCls = (l.code===selectedCode) ? "sel" : "";
      return `
        <button class="lang ${selCls}" type="button" data-code="${l.code}">
          <div class="flag">${l.flag}</div>
          <div class="lname">${l.name}</div>
          <div class="${metaCls}">${meta}</div>
        </button>
      `;
    }).join("");
  }

  function addMsg(role, text){
    const wrap = document.createElement("div");
    wrap.className = "msg " + (role==="user" ? "me" : "aiMsg");
    const b = document.createElement("div");
    b.className = "bubble";
    b.textContent = String(text||"");
    wrap.appendChild(b);
    log.appendChild(wrap);
    log.scrollTop = log.scrollHeight;
  }

  async function getSessionUser(){
    const { data:{ session } } = await supabase.auth.getSession();
    return session?.user || null;
  }

  async function getProfile(userId){
    const { data, error } = await supabase
      .from("profiles")
      .select("tokens, levels")
      .eq("id", userId)
      .maybeSingle();
    if(error) return { tokens:0, levels:{} };
    return {
      tokens: Number(data?.tokens ?? 0),
      levels: (data?.levels && typeof data.levels === "object") ? data.levels : {}
    };
  }

  // âœ… Jeton dÃ¼ÅŸ: Ã¶nce RPC varsa onu kullan
  async function spendJeton(amount){
    if(!amount || amount<=0) return { ok:true };

    // 1) RPC varsa
    try{
      const { data, error } = await supabase.rpc("spend_tokens", { p_amount: amount });
      if(!error) return { ok:true, data };
    }catch{}

    // 2) fallback optimistic (son Ã§are)
    const user = await getSessionUser();
    if(!user) return { ok:false, msg:"GiriÅŸ yok" };

    const cur = await getProfile(user.id);
    if(cur.tokens < amount) return { ok:false, msg:"Yetersiz jeton" };

    const next = cur.tokens - amount;
    const { error: upErr } = await supabase
      .from("profiles")
      .update({ tokens: next })
      .eq("id", user.id)
      .eq("tokens", cur.tokens);

    if(upErr) return { ok:false, msg:"Jeton dÃ¼ÅŸÃ¼lemedi" };
    setHeaderTokens(next);
    tokenPill.textContent = `Jeton: ${next}`;
    return { ok:true };
  }

  function costBaseForLevel(level){
    // Ä°stersen bunlarÄ± sonra deÄŸiÅŸtiririz.
    // Base cost = â€œOpenAI maliyetiâ€
    if(level==="A1" || level==="A2") return 4;
    if(level==="B1") return 6;
    if(level==="B2") return 8;
    return 10; // C1
  }

  async function ttsSpeak(text, lang){
    // Ã–nce backend TTS dene, olmazsa WebSpeech
    try{
      const r = await fetch(`${API_BASE}/api/tts`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text, lang })
      });

      const ct = (r.headers.get("content-type")||"").toLowerCase();

      if(r.ok && ct.includes("audio")){
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = new Audio(url);
        a.play().catch(()=>{});
        a.onended = ()=>URL.revokeObjectURL(url);
        return;
      }

      // json: {audio_url} veya {audio_base64}
      const j = await r.json().catch(()=>null);
      const audioUrl = j?.audio_url || j?.url || null;
      const b64 = j?.audio_base64 || null;

      if(audioUrl){
        const a = new Audio(audioUrl);
        a.play().catch(()=>{});
        return;
      }
      if(b64){
        const a = new Audio(`data:audio/mpeg;base64,${b64}`);
        a.play().catch(()=>{});
        return;
      }
    }catch{}

    // fallback: speechSynthesis
    try{
      if(!("speechSynthesis" in window)) return;
      const map = {en:"en-US",fr:"fr-FR",de:"de-DE",es:"es-ES",it:"it-IT",ru:"ru-RU",tr:"tr-TR",ar:"ar-SA",zh:"zh-CN",ja:"ja-JP",ko:"ko-KR",th:"th-TH",pt:"pt-PT",ro:"ro-RO",bg:"bg-BG",uk:"uk-UA",el:"el-GR",da:"da-DK",sv:"sv-SE",sr:"sr-RS",hr:"hr-HR",cs:"cs-CZ",fa:"fa-IR",az:"az-AZ"};
      const u = new SpeechSynthesisUtterance(String(text||""));
      u.lang = map[lang] || "en-US";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch{}
  }

  async function callPracticeAI(lang, level, userText, history){
    // Bu endpoint yoksa: senden gelen mevcut chat endpointine baÄŸlarÄ±z.
    // Åžimdilik /api/chat_openai veya /api/teacher_chat benzeri endpoint bekliyorum.
    // GÃ¼venli fallback: /api/chat_openai
    const payload = {
      mode: "practice",
      lang,
      level,
      message: userText,
      history: history.slice(-12) // son 12 mesaj
    };

    // 1) teacher_chat dene
    try{
      const r1 = await fetch(`${API_BASE}/api/teacher_chat`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(r1.ok){
        const j = await r1.json();
        const text = j?.text || j?.reply || j?.answer || "";
        if(text) return text;
      }
    }catch{}

    // 2) chat_openai dene
    try{
      const r2 = await fetch(`${API_BASE}/api/chat_openai`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(r2.ok){
        const j = await r2.json();
        const text = j?.text || j?.reply || j?.answer || "";
        if(text) return text;
      }
    }catch{}

    return "";
  }

  // ---------------------------
  // APP STATE
  // ---------------------------
  let user = null;
  let profile = { tokens:0, levels:{} };
  let selectedLang = (localStorage.getItem("italky_practice_lang") || "en").trim().toLowerCase();

  // conversation memory
  const history = []; // {role:"user"|"assistant", content:"..."}

  function setSelectedLang(code){
    selectedLang = String(code||"").trim().toLowerCase();
    localStorage.setItem("italky_practice_lang", selectedLang);
    const l = LANGS.find(x=>x.code===selectedLang);
    selLangPill.textContent = `Dil: ${l ? l.name : selectedLang.toUpperCase()}`;
  }

  function setLevelPill(level){
    if(level){
      levelPill.className = "pill ok";
      levelPill.textContent = `Seviye: ${level}`;
    }else{
      levelPill.className = "pill bad";
      levelPill.textContent = "Seviye: Yok";
    }
  }

  function setCostPill(){
    costPill.textContent = ttsOn.checked ? "Maliyet: Ã—2 (TTS)" : "Maliyet: Ã—1 (TTS kapalÄ±)";
  }

  async function refreshUI(){
    user = await getSessionUser();
    if(!user){
      location.replace("/pages/login.html");
      return;
    }

    profile = await getProfile(user.id);
    setHeaderTokens(profile.tokens);
    tokenPill.textContent = `Jeton: ${profile.tokens}`;

    renderLangs(selectedLang, profile.levels);
    setSelectedLang(selectedLang);

    const level = profile.levels?.[selectedLang] || "";
    setLevelPill(level);

    // gate vs chat
    if(!level){
      chat.classList.remove("show");
      gate.classList.add("show");

      const l = LANGS.find(x=>x.code===selectedLang);
      gateText.textContent =
`HenÃ¼z ${l ? l.name : selectedLang.toUpperCase()} dil seviyenizi tespit etmedik.
Bu derse katÄ±labilmek iÃ§in Ã¶nce seviye tespit sÄ±navÄ±na katÄ±lÄ±nÄ±z.`;

      btnStartTest.disabled = false;
      btnWallet.onclick = ()=>location.href="/pages/profile.html";
      btnStartTest.onclick = async ()=>{
        // Ã¼cret 5 jeton
        const FEE = 5;
        const cur = await getProfile(user.id);
        if(cur.tokens < FEE){
          toast("SÄ±nava katÄ±lmak iÃ§in jeton yÃ¼klemeniz gerekir.");
          location.href="/pages/profile.html";
          return;
        }

        toast("SÄ±nav baÅŸlatÄ±lÄ±yorâ€¦");
        const { data, error } = await supabase.rpc("start_level_test", { p_language_code: selectedLang });
        if(error){
          toast(error.message || "BaÅŸlatÄ±lamadÄ±");
          return;
        }
        const row = Array.isArray(data) ? (data[0] || null) : data;
        const testId = row?.test_id || row?.id || null;
        if(!testId){
          toast("test_id gelmedi");
          return;
        }
        location.href = `/pages/level_test.html?test_id=${encodeURIComponent(testId)}&lang=${encodeURIComponent(selectedLang)}`;
      };

    }else{
      gate.classList.remove("show");
      chat.classList.add("show");
      btnSend.disabled = false;

      // ilk mesaj (kÄ±sa)
      if(history.length===0){
        const l = LANGS.find(x=>x.code===selectedLang);
        addMsg("assistant",
`Tamam, ${l?l.name:selectedLang.toUpperCase()} pratik baÅŸlÄ±yor.
Seviyen: ${level}. Ben kÄ±sa dÃ¼zeltmeler + doÄŸru Ã¶rneklerle ilerleyeceÄŸim.

HazÄ±rsan bir cÃ¼mle yaz: â€œBugÃ¼n nasÄ±lsÄ±n?â€ veya kendini tanÄ±t.`);
        history.push({role:"assistant", content: log.lastChild?.textContent || ""});
      }
    }

    // attach language buttons after render
    langGrid.querySelectorAll("button.lang").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const code = btn.getAttribute("data-code");
        if(!code) return;
        setSelectedLang(code);
        renderLangs(selectedLang, profile.levels); // re-render selection
        await refreshUI();
      }, { passive:true });
    });
  }

  ttsOn.addEventListener("change", setCostPill);
  setCostPill();

  btnSend.addEventListener("click", async ()=>{
    const text = (inp.value || "").trim();
    if(!text) return;

    inp.value = "";
    btnSend.disabled = true;

    const level = profile.levels?.[selectedLang] || "";
    if(!level){
      toast("Ã–nce seviye tespit gerekli.");
      btnSend.disabled = false;
      return;
    }

    // maliyet
    const base = costBaseForLevel(level);
    const cost = ttsOn.checked ? (base * 2) : base;

    // jeton kontrol
    const cur = await getProfile(user.id);
    if(cur.tokens < cost){
      toast("Yetersiz jeton. Jeton yÃ¼kleyin.");
      location.href="/pages/profile.html";
      return;
    }

    // jeton dÃ¼ÅŸ
    const spent = await spendJeton(cost);
    if(!spent.ok){
      toast(spent.msg || "Jeton dÃ¼ÅŸÃ¼lemedi");
      btnSend.disabled = false;
      return;
    }

    // gÃ¶ster
    addMsg("user", text);
    history.push({role:"user", content:text});

    // AI yanÄ±t
    toast("AI dÃ¼ÅŸÃ¼nÃ¼yorâ€¦");
    const reply = await callPracticeAI(selectedLang, level, text, history);

    if(!reply){
      addMsg("assistant", "Åžu an cevap Ã¼retilemedi. (API/endpoint kontrol edelim)");
      history.push({role:"assistant", content:"Åžu an cevap Ã¼retilemedi."});
      btnSend.disabled = false;
      return;
    }

    addMsg("assistant", reply);
    history.push({role:"assistant", content:reply});

    // TTS
    if(ttsOn.checked){
      await ttsSpeak(reply, selectedLang);
    }

    btnSend.disabled = false;
  });

  inp.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      if(!btnSend.disabled) btnSend.click();
    }
  });

  // init
  await refreshUI();
</script>
</body>
</html>
