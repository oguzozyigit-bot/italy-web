<!-- FILE: /pages/level_required.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI ‚Ä¢ Seviye Gerekli</title>

  <meta name="theme-color" content="#02000f">
  <style>html,body{background:#02000f !important;}</style>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#02000f;
      --card: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.12);
      --muted: rgba(255,255,255,0.62);
      --ai: linear-gradient(135deg,#a5b4fc 0%,#6366f1 50%,#ec4899 100%);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
    #pageContent{ height:100%; }

    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding: 12px 14px;
      max-width: 520px;
      margin:0 auto;
    }

    /* √ºst blok */
    .hero{
      flex: 1;
      min-height: 0;
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(10,10,18,0.26);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 14px;
      position: relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap: 12px;
    }

    /* animasyon katmanƒ± */
    .fx{
      position:absolute; inset:0;
      pointer-events:none;
      opacity: 1;
    }
    .fx::before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 20% 20%, rgba(99,102,241,.30) 0%, transparent 45%),
        radial-gradient(circle at 80% 30%, rgba(236,72,153,.22) 0%, transparent 40%),
        radial-gradient(circle at 50% 80%, rgba(168,85,247,.20) 0%, transparent 45%);
      filter: blur(40px);
      animation: drift 10s ease-in-out infinite alternate;
    }
    @keyframes drift{
      from{ transform: translate3d(-10px,-6px,0) scale(1); }
      to{ transform: translate3d(10px,8px,0) scale(1.06); }
    }

    /* partik√ºller */
    .spark{
      position:absolute;
      width: 8px; height:8px;
      border-radius: 99px;
      background: rgba(165,180,252,.95);
      box-shadow: 0 0 16px rgba(165,180,252,.55);
      opacity:.55;
      animation: floaty 6.5s ease-in-out infinite;
    }
    .spark.s2{ width:10px;height:10px; opacity:.35; animation-duration: 8.2s; background: rgba(236,72,153,.9); box-shadow: 0 0 16px rgba(236,72,153,.45); }
    .spark.s3{ width:6px;height:6px; opacity:.45; animation-duration: 7.4s; background: rgba(99,102,241,.9); box-shadow: 0 0 16px rgba(99,102,241,.45); }
    @keyframes floaty{
      0%{ transform: translateY(10px); }
      50%{ transform: translateY(-14px); }
      100%{ transform: translateY(10px); }
    }

    /* ba≈ülƒ±k alanƒ± */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position:relative;
      z-index: 2;
    }
    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      font-weight: 1000;
      font-size: 12px;
      color: rgba(255,255,255,0.90);
      white-space:nowrap;
    }
    .title{
      font-family: "Space Grotesk", system-ui, sans-serif;
      font-size: 16px;
      font-weight: 1000;
      margin:0;
      color:#fff;
      letter-spacing: -.2px;
    }

    /* orta: dil kartƒ± */
    .langCard{
      position:relative;
      z-index:2;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      padding: 14px;
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .flagRing{
      width: 64px; height:64px;
      border-radius: 22px;
      padding: 2px;
      background: var(--ai);
      flex: 0 0 auto;
      position:relative;
      overflow:hidden;
      animation: ringSpin 8s linear infinite;
    }
    @keyframes ringSpin{
      from{ filter: hue-rotate(0deg); }
      to{ filter: hue-rotate(25deg); }
    }
    .flagInner{
      width:100%; height:100%;
      border-radius: 20px;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 30px;
      animation: pop 2.2s ease-in-out infinite;
    }
    @keyframes pop{
      0%,100%{ transform: scale(1); }
      50%{ transform: scale(1.06); }
    }
    .langMeta{ min-width:0; }
    .langName{
      font-size: 20px;
      font-weight: 1000;
      margin:0;
      color:#fff;
      letter-spacing: -.4px;
    }
    .langCode{
      margin-top: 3px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(165,180,252,0.92);
      letter-spacing: 1.1px;
      text-transform: uppercase;
    }

    /* mesaj */
    .msg{
      position:relative;
      z-index:2;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding: 12px 12px;
      color: rgba(255,255,255,0.78);
      font-size: 13px;
      font-weight: 900;
      line-height: 1.55;
    }
    .msg b{ color:#fff; }
    .msg .hl{
      background: var(--ai);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    /* butonlar */
    .actions{
      position:relative;
      z-index:2;
      display:flex;
      gap:10px;
    }
    .btn{
      flex:1;
      height: 54px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-weight: 1000;
      font-size: 14px;
      cursor:pointer;
      transition: transform .18s ease, opacity .18s ease;
    }
    .btn:active{ transform: scale(.985); }
    .btn.primary{
      background:#fff;
      color:#000;
      border:none;
    }
    .btn:disabled{ opacity:.4; cursor:not-allowed; }

    /* toast */
    .toast{
      position: fixed;
      left:50%;
      top:18px;
      transform: translateX(-50%) translateY(-120px);
      background: rgba(10,10,18,0.95);
      border: 1px solid rgba(165,180,252,0.35);
      padding: 10px 14px;
      border-radius: 999px;
      color:#fff;
      z-index: 999999;
      font-weight: 1000;
      font-size: 12px;
      transition: .25s;
      backdrop-filter: blur(12px);
      pointer-events:none;
      max-width: min(92vw, 520px);
      text-align:center;
    }
    .toast.show{ transform: translateX(-50%) translateY(0); }
  </style>
</head>

<body>
  <main id="pageContent">
    <div class="wrap">
      <section class="hero">
        <div class="fx">
          <div class="spark" style="left:14%; top:22%"></div>
          <div class="spark s2" style="left:78%; top:18%"></div>
          <div class="spark s3" style="left:62%; top:72%"></div>
          <div class="spark s2" style="left:20%; top:78%"></div>
        </div>

        <div class="top">
          <h1 class="title">Seviye Tespit Gerekli</h1>
          <div class="pill">S√ºre: 40 dk</div>
        </div>

        <div class="langCard">
          <div class="flagRing">
            <div class="flagInner" id="flag">üèÅ</div>
          </div>
          <div class="langMeta">
            <p class="langName" id="langName">Dil</p>
            <div class="langCode" id="langCode">‚Äî</div>
          </div>
        </div>

        <div class="msg" id="msgBox">
          <span class="hl" id="hlLang">Bu dil</span> i√ßin hen√ºz <b>seviye tespit sƒ±navƒ±na</b> katƒ±lmadƒ±nƒ±z.<br/>
          Bu derse devam edebilmek i√ßin √∂nce sƒ±nava katƒ±lƒ±n. Test sonu√ßlarƒ±:
          <b>Profil</b>, <b>Seviye Tespit</b> ve <b>Academy</b> sayfalarƒ±nda otomatik g√∂r√ºn√ºr.
        </div>

        <div class="actions">
          <button class="btn" id="btnBack" type="button">Geri</button>
          <button class="btn primary" id="btnStart" type="button">Seviye Tespit Sƒ±navƒ±na Katƒ±l</button>
        </div>
      </section>
    </div>

    <div class="toast" id="toast"></div>
  </main>

  <script type="module">
    import { mountShell } from "/js/ui_shell.js";
    import { supabase } from "/js/supabase_client.js";

    mountShell({ scroll:"none" });

    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      if(!t) return;
      t.textContent = String(msg||"");
      t.classList.add("show");
      clearTimeout(window.__to);
      window.__to = setTimeout(()=>t.classList.remove("show"), 1600);
    }

    const params = new URLSearchParams(location.search);
    const langRaw = (params.get("lang") || "en").trim().toLowerCase();
    const next = (params.get("next") || "").trim();       // √∂rn: plan_select
    const teacher = (params.get("t") || "").trim();       // √∂rn: ayda
    const nextUrl = next ? `/pages/${next}.html` : "";

    // alias (senin kod standardƒ±na)
    const ALIAS = { cn:"zh", jp:"ja", kr:"ko", sa:"ar", gr:"el", cz:"cs", rs:"sr", se:"sv", ua:"uk", ir:"fa" };
    const code = ALIAS[langRaw] || langRaw;

    // 6 dil (yeni strateji)
    const LANGS = {
      en:{ name:"English",   flag:"üá¨üáß" },
      de:{ name:"German",    flag:"üá©üá™" },
      fr:{ name:"French",    flag:"üá´üá∑" },
      it:{ name:"Italian",   flag:"üáÆüáπ" },
      ru:{ name:"Russian",   flag:"üá∑üá∫" },
      es:{ name:"Spanish",   flag:"üá™üá∏" },
    };

    const info = LANGS[code] || { name: code.toUpperCase(), flag:"üèÅ" };
    $("flag").textContent = info.flag;
    $("langName").textContent = info.name;
    $("langCode").textContent = code.toUpperCase();
    $("hlLang").textContent = info.name;

    // session ≈üart
    const { data:{ session } } = await supabase.auth.getSession();
    if(!session?.user){
      location.replace("/pages/login.html");
    }

    $("btnBack").addEventListener("click", ()=>{
      // √∂nce teacher_select'e d√∂nmek daha mantƒ±klƒ±
      if (teacher) location.href = "/pages/teacher_select.html";
      else location.href = "/pages/home.html";
    });

    // √ºcret (ekranda yazmƒ±yoruz ama buton davranƒ±≈üƒ± aynƒ±)
    const FEE = 1;

    async function startTest(){
      const btn = $("btnStart");
      btn.disabled = true;
      toast("Sƒ±nav ba≈ülatƒ±lƒ±yor‚Ä¶");

      const { data, error } = await supabase.rpc("start_level_test", { p_language_code: code });

      if(error){
        // en sƒ±k: Not enough tokens / Not authenticated
        const msg = (error.message || "").toLowerCase();

        if(msg.includes("not enough") || msg.includes("yetersiz")){
          toast("Jeton yetersiz. Jeton y√ºkleyip tekrar deneyin.");
          setTimeout(()=>location.href="/pages/profile.html", 900);
          btn.disabled = false;
          return;
        }

        if(msg.includes("not authenticated")){
          toast("Giri≈ü gerekli.");
          setTimeout(()=>location.href="/pages/login.html", 800);
          return;
        }

        toast(error.message || "Ba≈ülatƒ±lamadƒ±");
        btn.disabled = false;
        return;
      }

      const row = Array.isArray(data) ? (data[0] || null) : data;
      const testId = row?.test_id || row?.id || null;

      if(!testId){
        toast("test_id alƒ±namadƒ±");
        btn.disabled = false;
        return;
      }

      // sƒ±nav sayfasƒ±
      location.href = `/pages/level_test.html?test_id=${encodeURIComponent(testId)}&lang=${encodeURIComponent(code)}`;
    }

    $("btnStart").addEventListener("click", startTest, { passive:true });
  </script>
</body>
</html>
