<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI ‚Ä¢ Gap Master Premium</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
  <style>
    :root { 
      --bg-deep: #020205; --text-white: #ffffff; 
      --c-neon-blue: #00f3ff; --c-neon-pink: #ff00ff; --c-neon-green: #00e676; --c-error: #ff1744;
      --ai-gradient: linear-gradient(135deg, #a5b4fc 0%, #6366f1 100%);
      --glass: rgba(255, 255, 255, 0.06); --border: rgba(255, 255, 255, 0.12);
      --safe-top: env(safe-area-inset-top, 0px); --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    * { box-sizing:border-box; outline:none; user-select:none; -webkit-tap-highlight-color:transparent; }
    html, body { margin:0; width:100%; height:100%; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:#fff; position:fixed; }
    
    /* üåå DEEP SPACE COSMOS */
    .cosmos-bg { position:absolute; inset:0; background: radial-gradient(circle at 50% 35%, #0b0b2a 0%, #020205 60%, #010104 100%); z-index:0; }
    .stars { position: absolute; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.15'/%3E%3C/svg%3E"); opacity: 0.6; mix-blend-mode: screen; animation: starsFloat 110s linear infinite; }
    .nebula { position:absolute; width:100vw; height:100vw; border-radius:50%; filter: blur(100px); opacity:.14; z-index:1; pointer-events:none; }
    .neb-1 { top:-20%; left:-20%; background:#4338ca; }
    .neb-2 { bottom:-20%; right:-20%; background:#701a75; }
    @keyframes starsFloat { from { background-position: 0 0; } to { background-position: 0 1200px; } }

    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; padding-top: var(--safe-top); padding-bottom: var(--safe-bottom); }

    /* HEADER */
    .nav-top { flex: 0 0 auto; display:flex; align-items:center; justify-content:space-between; padding: 10px 18px; }
    .back-btn { background: var(--glass); border: 1px solid var(--border); padding: 8px 14px; border-radius: 12px; color:#fff; font-size: 11px; font-weight: 800; cursor:pointer; text-decoration:none; backdrop-filter: blur(12px); }
    .logo-small { font-size:24px; font-weight:900; letter-spacing:-1px; }
    .logo-small span { background: var(--ai-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    /* STATS */
    .stats-row { padding: 0 20px 10px; display: flex; justify-content: space-between; align-items: center; }
    .score-pill { font-family: 'Space Grotesk', sans-serif; font-weight: 800; color: var(--c-neon-green); font-size: 16px; }
    .hearts { font-size: 20px; }

    /* GAME AREA */
    .stage { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding: 10px 20px; gap: 20px; }
    
    .sentence-card { 
      width:100%; background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03)); 
      border: 1px solid var(--border); border-radius: 32px; padding: 45px 25px; text-align: center; 
      backdrop-filter: blur(20px); box-shadow: 0 30px 60px rgba(0,0,0,0.5);
    }
    .sentence-text { font-size: 24px; font-weight: 700; line-height: 1.6; color: #fff; }
    .gap-box { 
      display: inline-block; min-width: 90px; border-bottom: 3px solid var(--c-neon-blue); 
      color: var(--c-neon-blue); font-weight: 800; margin: 0 5px;
    }
    .gap-box.correct { border-color: var(--c-neon-green); color: var(--c-neon-green); text-shadow: 0 0 10px var(--c-neon-green); }
    .gap-box.wrong { border-color: var(--c-error); color: var(--c-error); }
    .translation-text { font-size: 15px; color: rgba(255,255,255,0.4); margin-top: 25px; font-style: italic; }

    /* OPTIONS */
    .options-grid { width:100%; display:grid; grid-template-columns: 1fr; gap: 12px; }
    .opt-btn { 
      background: var(--glass); border: 1px solid var(--border); 
      padding: 18px; border-radius: 20px; color: #fff; font-size: 17px; 
      font-weight: 700; cursor: pointer; transition: 0.2s; text-align: center;
      backdrop-filter: blur(10px);
    }
    .opt-btn.correct { background: var(--c-neon-green); color: #000; border-color: transparent; }
    .opt-btn.wrong { background: var(--c-error); color: #fff; border-color: transparent; opacity: 0.4; }

    /* MODAL */
    .modal-wrap { position: absolute; inset: 0; background: rgba(0,0,0,0.96); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(30px); }
    .modal-card { width: 100%; max-width: 360px; background: #0a0a10; border: 1px solid var(--border); border-radius: 36px; padding: 40px 30px; text-align: center; }
    .lang-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 25px 0; }
    .lang-btn { font-size: 24px; padding: 10px; border-radius: 16px; background: rgba(255,255,255,0.05); border: 1px solid transparent; cursor: pointer; }
    .lang-btn.active { border-color: var(--c-neon-blue); background: rgba(0,243,255,0.1); }
    .btn-main { width: 100%; padding: 18px; background: var(--c-neon-green); color: #000; border: none; border-radius: 20px; font-weight: 800; font-size: 16px; cursor: pointer; margin-top: 10px; }
  </style>
</head>
<body>

  <div class="cosmos-bg"><div class="stars"></div><div class="nebula neb-1"></div><div class="nebula neb-2"></div></div>

  <div class="wrap">
    <div class="nav-top">
      <a href="/pages/game.html" class="back-btn">‚úï KAPAT</a>
      <div class="logo-small">italky<span>AI</span></div>
      <div style="width:70px"></div>
    </div>

    <div class="stats-row">
      <div class="score-pill" id="scoreTxt">0 PUAN</div>
      <div class="hearts" id="heartsTxt">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div class="stage">
      <div class="sentence-card">
        <div id="sentenceDisplay" class="sentence-text">...</div>
        <div id="translationDisplay" class="translation-text">...</div>
      </div>
      <div class="options-grid" id="options"></div>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <h2 style="letter-spacing:2px; margin-top:0;">GAP MASTER</h2>
      <div class="lang-grid">
        <button onclick="setLang('en',this)" class="lang-btn active">üá¨üáß</button>
        <button onclick="setLang('de',this)" class="lang-btn">üá©üá™</button>
        <button onclick="setLang('fr',this)" class="lang-btn">üá´üá∑</button>
        <button onclick="setLang('es',this)" class="lang-btn">üá™üá∏</button>
        <button onclick="setLang('it',this)" class="lang-btn">üáÆüáπ</button>
      </div>
      <button class="btn-main" onclick="initGame('A2')">KOLAY (A2)</button>
      <button class="btn-main" onclick="initGame('B1')">ORTA (B1)</button>
      <button class="btn-main" onclick="initGame('B2')">ZOR (B2)</button>
      <div id="loaderMsg" style="margin-top:20px; font-size:12px; color:var(--c-neon-blue)"></div>
    </div>
  </div>

  <div class="modal-wrap" id="endModal" style="display:none">
    <div class="modal-card">
      <h2 id="endTitle">OYUN Bƒ∞TTƒ∞</h2>
      <p id="endScoreTxt" style="font-size:18px; opacity:0.8; margin-bottom:30px;"></p>
      <button class="btn-main" onclick="location.reload()">TEKRAR DENE</button>
      <button class="btn-main" style="background:rgba(255,255,255,0.1); color:#fff;" onclick="location.href='/pages/game.html'">√áIKI≈û</button>
    </div>
  </div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = id => document.getElementById(id);
let currentLang = 'en', pool = [], puzzles = [], currentIdx = 0;
let score = 0, lives = 3, isBusy = false;

window.setLang = (l, btn) => {
    currentLang = l;
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
};

// üéØ HAVUZA BAƒûLANTI NOKTASI
window.initGame = async (diff) => {
    $('loaderMsg').textContent = "Havuz taranƒ±yor...";
    try {
        const rawPool = await loadLangPool(currentLang); // italky standart {items:[]} d√∂ner
        
        const { used, save } = createUsedSet(`gapmaster_v2_${currentLang}_${diff}`);
        const checkLevel = (lvl) => (diff === "A2" ? ["A1", "A2"].includes(lvl) : lvl === diff);
        
        // Kilit: rawPool doƒürudan pick'e girer, pick .items'ƒ± kendi arar
        const selected = pick(rawPool, 15, used, save, it => {
            // C√ºmlesi olan ve hedef kelimeyi i√ßerenleri se√ß
            return it.sentence && it.w && it.sentence.toLowerCase().includes(it.w.toLowerCase()) && checkLevel(it.lvl);
        });

        if (selected.length === 0) {
            $('loaderMsg').textContent = "Uygun c√ºmleli kelime kalmadƒ±!";
            return;
        }

        puzzles = selected.map(item => {
            const regex = new RegExp(`\\b${item.w}\\b`, 'gi');
            return {
                word: item.w,
                sentence: item.sentence,
                display: item.sentence.replace(regex, '_____'),
                tr: item.tr
            };
        });

        $('startModal').style.display = 'none';
        renderPuzzle();
    } catch (e) {
        $('loaderMsg').textContent = "Havuz baƒülantƒ± hatasƒ±!";
    }
};

function renderPuzzle() {
    if (lives <= 0 || currentIdx >= puzzles.length) return showEnd(lives > 0);

    const p = puzzles[currentIdx];
    $('sentenceDisplay').innerHTML = p.display.replace('_____', '<span class="gap-box">...</span>');
    $('translationDisplay').textContent = p.tr;

    // ≈ûƒ±k √ºretimi (Daha g√ºvenli ≈üƒ±k se√ßimi)
    let wrongs = puzzles.filter(x => x.word.toLowerCase() !== p.word.toLowerCase()).map(x => x.word);
    if (wrongs.length < 3) wrongs = ["apple", "time", "house", "friend"]; 
    let options = shuffle([p.word, ...shuffle(wrongs).slice(0, 3)]);

    const grid = $('options');
    grid.innerHTML = '';
    options.forEach(opt => {
        const b = document.createElement('button');
        b.className = 'opt-btn';
        b.textContent = opt;
        b.onclick = () => handleChoice(opt.toLowerCase() === p.word.toLowerCase(), b);
        grid.appendChild(b);
    });
}

function handleChoice(correct, btn) {
    if (isBusy) return;
    isBusy = true;
    const p = puzzles[currentIdx];

    if (correct) {
        btn.classList.add('correct');
        score += 10;
        const gap = document.querySelector('.gap-box');
        gap.textContent = p.word;
        gap.classList.add('correct');
        speak(p.sentence);
    } else {
        btn.classList.add('wrong');
        lives--;
        // Doƒüruyu g√∂ster
        document.querySelectorAll('.opt-btn').forEach(b => {
            if (b.textContent.toLowerCase() === p.word.toLowerCase()) b.classList.add('correct');
        });
    }

    $('scoreTxt').textContent = `${score} PUAN`;
    $('heartsTxt').textContent = lives > 0 ? "‚ù§Ô∏è".repeat(lives) + "üñ§".repeat(3 - lives) : "üíÄüíÄüíÄ";

    setTimeout(() => {
        currentIdx++;
        isBusy = false;
        renderPuzzle();
    }, correct ? 2200 : 1500);
}

function showEnd(win) {
    $('endModal').style.display = 'flex';
    $('endTitle').textContent = win ? "G√ñREV TAMAMLANDI! üèÜ" : "KAYBETTƒ∞N! ü•ä";
    $('endTitle').style.color = win ? "var(--c-neon-green)" : "var(--c-error)";
    $('endScoreTxt').textContent = `Skorun: ${score}`;
}

function speak(t) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(t);
    const m = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };
    u.lang = m[currentLang] || 'en-US';
    u.rate = 0.85;
    window.speechSynthesis.speak(u);
}

function shuffle(a) { return [...a].sort(() => Math.random() - 0.5); }
</script>
</body>
</html>
