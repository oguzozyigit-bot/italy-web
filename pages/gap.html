<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI ‚Ä¢ Gap Master Master Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root { 
      --bg-deep: #020205; --c-neon-blue: #00f3ff; --c-neon-pink: #ff00ff; --c-neon-green: #00e676; --c-error: #ff1744;
      --glass: rgba(255, 255, 255, 0.08); --border: rgba(255, 255, 255, 0.15);
    }
    * { box-sizing:border-box; outline:none; user-select:none; -webkit-tap-highlight-color:transparent; }
    html, body { margin:0; width:100%; height:100%; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:#fff; position:fixed; }
    
    .cosmos-bg { position:absolute; inset:0; background: radial-gradient(circle at 50% 35%, #0b0b2a 0%, #020205 60%, #010104 100%); z-index:0; }
    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom); }

    /* UI */
    .nav-top { display:flex; align-items:center; justify-content:space-between; padding: 15px 20px; }
    .status-chip { background: var(--glass); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; border: 1px solid var(--border); letter-spacing: 1px; }
    .progress-bar { width: calc(100% - 40px); height: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 0 20px 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--c-neon-blue); width: 0%; transition: width 0.5s ease; box-shadow: 0 0 12px var(--c-neon-blue); }
    .stats-row { padding: 5px 20px; display: flex; justify-content: space-between; align-items: center; }
    .score-pill { color: var(--c-neon-green); font-weight: 900; font-size: 20px; }
    @keyframes scorePop{ from{ transform:scale(1.25); } to{ transform:scale(1); } }.score-pop{ animation: scorePop .18s ease; }

    /* STAGE */
    .stage { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding: 10px 20px; gap: 15px; }
    .sentence-card { width:100%; background: var(--glass); border: 1px solid var(--border); border-radius: 32px; padding: 35px 20px; text-align: center; backdrop-filter: blur(25px); position: relative; }
    .sentence-text { text-transform: uppercase; letter-spacing: .3px; font-size: 22px; font-weight: 700; line-height: 1.5; }
    .gap-box { color: var(--c-neon-blue); border-bottom: 3px solid var(--c-neon-blue); padding: 0 8px; font-weight: 800; }
    .translation-text { font-size: 16px; color: var(--c-neon-green); font-style: italic; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 15px; }
    #resInfo { font-size: 13px; color: var(--c-neon-blue); margin-top: 10px; font-weight: 600; opacity: 0; transition: opacity 0.3s; }

    /* OPTIONS */
    .options-grid { width: 100%; display: grid; grid-template-columns: 1fr; gap: 12px; }
    .opt-btn { 
      position:relative; overflow:hidden; width: 100%; padding: 18px; background: var(--glass); 
      border: 1px solid var(--border); border-radius: 20px; color: #fff; font-size: 17px; font-weight: 700; cursor: pointer; transition: all 0.2s;
      box-shadow: 0 10px 26px rgba(0,0,0,.42), inset 0 1px 0 rgba(255,255,255,0.12);
    }
    .opt-btn:active { transform: translateY(3px); }
    .opt-btn:disabled { opacity:.85; cursor:default; }
    .opt-btn.correct { background: linear-gradient(180deg, #00e676, #00c853) !important; color: #000; box-shadow: 0 0 22px rgba(0,230,118,.35), 0 10px 26px rgba(0,0,0,.42) !important; }
    .opt-btn.correct::after { content:""; position:absolute; inset:-30%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55) 0%, rgba(255,255,255,0) 35%); opacity:.55; transform: rotate(12deg); pointer-events:none; }
    .opt-btn.wrong { background: linear-gradient(180deg, #ff1744, #d50000) !important; animation: shake 0.4s; box-shadow: 0 0 18px rgba(255,23,68,.25), 0 10px 26px rgba(0,0,0,.42) !important; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }

    /* MODAL */
    .lang-btn{ font-size:24px; padding:10px; border-radius:16px; background: var(--glass); border: 1px solid transparent; cursor:pointer; margin:4px; transition:.2s; }
    .lang-btn.active{ border-color: var(--c-neon-blue); background: rgba(0,243,255,0.15); transform: scale(1.08); }
    .modal-wrap { position: absolute; inset: 0; background: rgba(0,0,0,0.98); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-card { width: 100%; max-width: 360px; background: #08080c; border: 1px solid var(--border); border-radius: 36px; padding: 40px 30px; text-align: center; }
    .btn-main { width: 100%; padding: 18px; background: var(--c-neon-green); color: #000; border: none; border-radius: 20px; font-weight: 900; cursor: pointer; margin-top: 12px; }
  </style>
</head>
<body>
  <div class="cosmos-bg"></div>
  <div class="wrap">
    <div class="nav-top">
      <a href="/pages/game.html" style="text-decoration:none; color:#fff; font-size:22px;">‚Üê</a>
      <div id="statusChip" class="status-chip">EN ‚Ä¢ LEVEL</div>
      <div style="font-size:20px; font-weight:900;">italky<span style="color:var(--c-neon-blue)">AI</span></div>
    </div>
    <div class="progress-bar"><div id="progFill" class="progress-fill"></div></div>
    <div class="stats-row">
      <div id="lifeBar" style="color:var(--c-neon-pink); font-size:18px;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      <div id="scoreTxt" class="score-pill">0</div>
    </div>
    <div class="stage">
      <div class="sentence-card">
        <div id="sentenceDisplay" class="sentence-text"></div>
        <div id="resInfo"></div>
        <div id="translationDisplay" class="translation-text"></div>
      </div>
      <div class="options-grid" id="optionsGrid"></div>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <h2 style="margin:0 0 20px;">GAP MASTER MASTER</h2>
      <div style="margin-bottom:25px;">
        <button onclick="setLang('en',this)" class="lang-btn active">üá¨üáß</button>
        <button onclick="setLang('de',this)" class="lang-btn">üá©üá™</button>
        <button onclick="setLang('fr',this)" class="lang-btn">üá´üá∑</button>
        <button onclick="setLang('es',this)" class="lang-btn">üá™üá∏</button>
        <button onclick="setLang('it',this)" class="lang-btn">üáÆüáπ</button>
      </div>
      <button class="btn-main" onclick="initGame('A2')">KOLAY SEVƒ∞YE</button>
      <button class="btn-main" style="background:#4338ca; color:#fff;" onclick="initGame('B1')">ORTA SEVƒ∞YE</button>
      <button class="btn-main" style="background:#701a75; color:#fff;" onclick="initGame('B2')">ZOR SEVƒ∞YE</button>
    </div>
  </div>

  <div class="modal-wrap" id="endModal" style="display:none">
    <div class="modal-card">
      <h2 id="endTitle">SET TAMAMLANDI</h2>
      <div id="endStats" style="text-align:left; margin:20px 0; font-size:15px; line-height:2;"></div>
      <button class="btn-main" onclick="location.reload()">TEKRAR DENE</button>
    </div>
  </div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = id => document.getElementById(id);
let currentLang = 'en', puzzles = [], currentIdx = 0;
let score = 0, lives = 3, maxLives = 3, streak = 0, totalCorrect = 0, totalAnswered = 0, isBusy = false, startTime = 0;

const FALLBACKS = {
  en:["TIME","WORLD","HOUSE","WATER","FRIEND","GO","LIFE","DAY"],
  de:["ZEIT","WELT","HAUS","WASSER","FREUND","GEHEN","LEBEN","TAG"],
  fr:["TEMPS","MONDE","MAISON","EAU","AMI","ALLER","VIE","JOUR"],
  es:["TIEMPO","MUNDO","CASA","AGUA","AMIGO","IR","VIDA","D√çA"],
  it:["TEMPO","MONDO","CASA","ACQUA","AMICO","ANDARE","VITA","GIORNO"]
};

function escapeRegExp(s){ return String(s ?? "").replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
const norm = (s) => String(s || "").normalize("NFC");

// ‚úÖ Fisher‚ÄìYates Shuffle Algorithm
function shuffle(a) {
  const arr = [...a];
  for(let i=arr.length-1; i>0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

window.setLang = (l, btn) => {
  currentLang = l;
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
};

window.initGame = async (diff) => {
  try {
    const rawPool = await loadLangPool(currentLang);
    if (!rawPool || !rawPool.items) throw new Error("Havuz bo≈ü");

    // ‚úÖ KURAL G√úNCELLEMESƒ∞: Havuzu pick √∂ncesi agresif karƒ±≈ütƒ±r
    const randomizedItems = shuffle(rawPool.items);

    // ‚úÖ KURAL G√úNCELLEMESƒ∞: Benzersiz oturum kaydƒ±
    const { used, save } = createUsedSet(`gap_master_v53_${currentLang}_${diff}`);
    
    maxLives = (diff === "A2") ? 4 : 3;
    lives = maxLives;

    puzzles = pick({ items: randomizedItems }, 15, used, save, it => {
      const itLvl = String(it.lvl || "").toUpperCase();
      const targetLvl = diff.toUpperCase();
      return it.sentence && (targetLvl === "A2" ? ["A1","A2"].includes(itLvl) : itLvl === targetLvl);
    });

    if (puzzles.length === 0) {
        alert("Bu seviyede t√ºm kelimeleri bitirdiniz! ƒ∞lerleme sƒ±fƒ±rlanƒ±yor.");
        localStorage.removeItem(`gap_master_v53_${currentLang}_${diff}`);
        location.reload();
        return;
    }

    $('statusChip').textContent = `${currentLang.toUpperCase()} ‚Ä¢ ${diff}`;
    $('startModal').style.display = 'none';
    currentIdx = 0;
    loadPuzzle();
  } catch (e) { 
    console.error(e);
    alert("Havuz y√ºklenemedi!"); 
  }
};

function loadPuzzle() {
  if (lives <= 0 || currentIdx >= puzzles.length) return showFinal();
  const p = puzzles[currentIdx];
  const word = norm(p.w).trim();
  const escapedWord = escapeRegExp(word).replace(/\s+/g, "\\s+");
  
  $('progFill').style.width = `${((currentIdx + 1) / puzzles.length) * 100}%`;
  
  const sentence = norm(p.sentence);
  const regex = new RegExp(`(^|[^\\p{L}'-])(${escapedWord})(?=[^\\p{L}'-]|$)`, "giu");
  $('sentenceDisplay').innerHTML = sentence.replace(regex, `$1<span class="gap-box">____</span>`);
  
  $('translationDisplay').textContent = p.tr || "";
  $('lifeBar').textContent = "‚ù§Ô∏è".repeat(lives) + "üñ§".repeat(maxLives - lives);
  $('resInfo').style.opacity = "0";
  
  const n = s => norm(s).trim().toUpperCase();
  let wrongs = shuffle(puzzles.filter(x => n(x.w) !== n(p.w)).map(x => x.w));
  const fallbackList = FALLBACKS[currentLang] || FALLBACKS.en;
  while (wrongs.length < 4) wrongs.push(fallbackList[wrongs.length % fallbackList.length]);
  
  renderOptions(shuffle([p.w, ...wrongs.slice(0,4)]));
  startTime = Date.now();
}

function renderOptions(opts) {
  const grid = $('optionsGrid'); grid.innerHTML = '';
  opts.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'opt-btn'; 
    const normalizedOpt = norm(opt).trim().toUpperCase();
    btn.textContent = normalizedOpt;
    btn.onclick = () => handleChoice(normalizedOpt, btn);
    grid.appendChild(btn);
  });
}

function handleChoice(val, btn) {
  if (isBusy) return;
  const p = puzzles[currentIdx];
  const correctVal = norm(p.w).trim().toUpperCase();
  const timeTaken = (Date.now() - startTime) / 1000;
  isBusy = true; totalAnswered++;
  document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);

  if (val === correctVal) {
    streak++; totalCorrect++;
    let speedBonus = timeTaken < 4 ? 8 : (timeTaken < 7 ? 5 : (timeTaken < 10 ? 2 : 0));
    let comboMult = streak <= 3 ? streak : (3 + (streak - 3) * 0.25);
    const roundScore = Math.round(10 * comboMult + speedBonus);
    score += roundScore;
    
    btn.classList.add('correct');
    $('scoreTxt').classList.remove('score-pop'); void $('scoreTxt').offsetWidth;
    $('scoreTxt').classList.add('score-pop');
    
    $('resInfo').textContent = `+${roundScore} PUAN ${speedBonus > 0 ? '‚Ä¢ HIZ BONUSU' : ''}`;
    $('resInfo').style.opacity = "1";
    speak(p.sentence);
  } else {
    streak = 0; lives--;
    btn.classList.add('wrong');
    $('resInfo').textContent = `DOƒûRU CEVAP: ${correctVal}`;
    $('resInfo').style.opacity = "1";
    document.querySelectorAll('.opt-btn').forEach(b => { if(norm(b.textContent) === correctVal) b.classList.add('correct'); });
    const prefix = currentLang === 'en' ? `Correct word: ${correctVal}. ` : `${correctVal}. `;
    speak(prefix + p.sentence);
  }

  $('scoreTxt').textContent = score;
  setTimeout(() => { currentIdx++; isBusy = false; loadPuzzle(); }, 2200);
}

function showFinal() {
  $('endModal').style.display = 'flex';
  const acc = totalAnswered ? Math.round((totalCorrect/totalAnswered)*100) : 0;
  const totalQ = puzzles.length;
  $('endStats').innerHTML = `
    ‚Ä¢ Toplam Skor: <b>${score}</b><br>
    ‚Ä¢ Doƒüruluk: <b>%${acc}</b> (<b>${totalCorrect}/${totalQ}</b>)
  `;
}

function speak(t) {
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(t);
  const m = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };
  u.lang = m[currentLang]; u.rate = 0.85;
  window.speechSynthesis.speak(u);
}
</script>
</body>
</html>
