<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI â€¢ Gap Master Grand Master</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root { 
      --bg-deep: #020205; --c-neon-blue: #00f3ff; --c-neon-pink: #ff00ff; --c-neon-green: #00e676; --c-error: #ff1744;
      --glass: rgba(255, 255, 255, 0.08); --border: rgba(255, 255, 255, 0.15);
    }
    * { box-sizing:border-box; outline:none; user-select:none; -webkit-tap-highlight-color:transparent; }
    html, body { margin:0; width:100%; height:100%; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:#fff; position:fixed; }
    .cosmos-bg { position:absolute; inset:0; background: radial-gradient(circle at 50% 35%, #0b0b2a 0%, #020205 60%, #010104 100%); z-index:0; }
    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom); }
    
    .nav-top { display:flex; align-items:center; justify-content:space-between; padding: 15px 20px; }
    .pb-chip { font-size: 10px; color: var(--c-neon-pink); font-weight: 800; text-align: right; margin-top: 4px; }
    .status-chip { background: var(--glass); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; border: 1px solid var(--border); letter-spacing: 1px; }

    .progress-bar { width: calc(100% - 40px); height: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 0 20px 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--c-neon-blue); width: 0%; transition: width 0.5s ease; box-shadow: 0 0 12px var(--c-neon-blue); }
    .stats-row { padding: 5px 20px; display: flex; justify-content: space-between; align-items: center; }
    .score-pill { color: var(--c-neon-green); font-weight: 900; font-size: 20px; }
    
    .stage { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding: 10px 20px; gap: 15px; }
    .sentence-card { width:100%; background: var(--glass); border: 1px solid var(--border); border-radius: 32px; padding: 35px 20px; text-align: center; backdrop-filter: blur(25px); position: relative; }
    .gap-box { color: var(--c-neon-blue); border-bottom: 3px solid var(--c-neon-blue); padding: 0 8px; font-weight: 800; }
    #resInfo { font-size: 12px; color: var(--c-neon-blue); margin-top: 10px; font-weight: 700; opacity: 0; transition: opacity 0.3s; text-align: center; min-height: 18px; }

    .opt-btn { position:relative; overflow:hidden; width: 100%; padding: 18px; background: var(--glass); border: 1px solid var(--border); border-radius: 20px; color: #fff; font-size: 17px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 10px 26px rgba(0,0,0,.42); }
    .opt-btn.correct { background: linear-gradient(180deg, #00e676, #00c853) !important; color: #000; }
    .opt-btn.wrong { background: linear-gradient(180deg, #ff1744, #d50000) !important; }

    .modal-wrap { position: absolute; inset: 0; background: rgba(0,0,0,0.98); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-card { width: 100%; max-width: 360px; background: #08080c; border: 1px solid var(--border); border-radius: 36px; padding: 30px; text-align: center; overflow-y: auto; max-height: 90vh; }
    
    /* RECORD ITEMS - PODYUM DOKUNUÅU baÅŸkanÄ±m */
    .record-item { display: flex; justify-content: space-between; align-items:center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 8px; font-size: 11px; border-left: 3px solid #444; }
    .record-item.rank-0 { border-left-color: var(--c-neon-pink); background: rgba(255,0,255,0.05); }
    .record-item.rank-1 { border-left-color: var(--c-neon-blue); }
    .record-item.rank-2 { border-left-color: var(--c-neon-green); }

    .btn-main { width: 100%; padding: 18px; background: var(--c-neon-green); color: #000; border: none; border-radius: 20px; font-weight: 900; cursor: pointer; margin-top: 12px; }
    .lvl-btn { width:100%; display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-radius: 18px; border: 1px solid var(--border); background: var(--glass); color: #fff; font-weight: 700; cursor: pointer; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="cosmos-bg"></div>
  <div class="wrap">
    <div class="nav-top">
      <a href="/pages/game.html" style="text-decoration:none; color:#fff; font-size:22px;">â†</a>
      <div style="text-align: center;">
        <div id="statusChip" class="status-chip">EN â€¢ LEVEL</div>
        <div id="pbDisplay" class="pb-chip">PB: 0</div>
      </div>
      <div style="font-size:20px; font-weight:900;">italky<span style="color:var(--c-neon-blue)">AI</span></div>
    </div>
    <div class="progress-bar"><div id="progFill" class="progress-fill"></div></div>
    <div class="stats-row">
      <div id="lifeBar" style="color:var(--c-neon-pink); font-size:18px;">â¤ï¸â¤ï¸â¤ï¸</div>
      <div id="scoreTxt" class="score-pill">0</div>
    </div>
    <div class="stage">
      <div class="sentence-card">
        <div id="sentenceDisplay" class="sentence-text" style="text-transform: uppercase; font-size: 22px; font-weight: 700;"></div>
        <div id="resInfo"></div>
        <div id="translationDisplay" class="translation-text" style="font-size: 16px; color: var(--c-neon-green); font-style: italic; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;"></div>
      </div>
      <div class="options-grid" id="optionsGrid" style="width: 100%; display: grid; gap: 12px;"></div>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <h2 style="margin:0 0 20px;">GAP MASTER ELITE</h2>
      <div style="margin-bottom:20px;">
        <button onclick="setLang('en',this)" class="lang-btn active">ğŸ‡¬ğŸ‡§</button>
        <button onclick="setLang('de',this)" class="lang-btn">ğŸ‡©ğŸ‡ª</button>
        <button onclick="setLang('fr',this)" class="lang-btn">ğŸ‡«ğŸ‡·</button>
        <button onclick="setLang('es',this)" class="lang-btn">ğŸ‡ªğŸ‡¸</button>
        <button onclick="setLang('it',this)" class="lang-btn">ğŸ‡®ğŸ‡¹</button>
      </div>
      
      <button class="lvl-btn" onclick="initGame('A2')"><span>KOLAY SEVÄ°YE</span> <span id="pb-A2" style="font-size:11px; color:var(--c-neon-blue)">PB: 0</span></button>
      <button class="lvl-btn" style="border-color: #4338ca" onclick="initGame('B1')"><span>ORTA SEVÄ°YE</span> <span id="pb-B1" style="font-size:11px; color:var(--c-neon-blue)">PB: 0</span></button>
      <button class="lvl-btn" style="border-color: #701a75" onclick="initGame('B2')"><span>ZOR SEVÄ°YE</span> <span id="pb-B2" style="font-size:11px; color:var(--c-neon-blue)">PB: 0</span></button>

      <h3 style="margin:25px 0 10px; font-size:14px; color:var(--c-neon-pink);">ğŸ† KAYIT DEFTERÄ°</h3>
      <div id="leaderboardBox"></div>
    </div>
  </div>

  <div class="modal-wrap" id="endModal" style="display:none">
    <div class="modal-card">
      <h2 id="endTitle">SET TAMAMLANDI</h2>
      <div id="endStats" style="text-align:left; margin:20px 0; font-size:15px; line-height:2;"></div>
      <button class="btn-main" id="btnContinue">DEVAM ET (RÄ°SK)</button>
      <button class="btn-main" id="btnBank" style="background:var(--c-neon-blue)">BANKALA (%5 BONUS)</button>
      <button class="btn-main" id="btnFinish" style="background:var(--glass); color:#fff; border: 1px solid var(--border)">BÄ°TÄ°R VE KAYDET</button>
    </div>
  </div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = id => document.getElementById(id);
let currentLang = 'en', currentDiff = 'A2', puzzles = [], currentIdx = 0;
let score = 0, setScore = 0, lives = 3, maxLives = 3, streak = 0, maxStreak = 0, totalCorrect = 0, totalAnswered = 0, isBusy = false, startTime = 0, lastSpoken = 0;

const FALLBACKS = {
  en:["TIME","WORLD","HOUSE","WATER","FRIEND","GO","LIFE","DAY"],
  de:["ZEIT","WELT","HAUS","WASSER","FREUND","GEHEN","LEBEN","TAG"],
  fr:["TEMPS","MONDE","MAISON","EAU","AMI","ALLER","VIE","JOUR"],
  es:["TIEMPO","MUNDO","CASA","AGUA","AMIGO","IR","VIDA","DÃA"],
  it:["TEMPO","MONDO","CASA","ACQUA","AMICO","ANDARE","VITA","GIORNO"]
};

function escapeRegExp(s){ return String(s ?? "").replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
const norm = (s) => String(s || "").normalize("NFC");

function shuffle(a) {
  const arr = [...a];
  for(let i=arr.length-1; i>0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function updateLeaderboardUI() {
  const records = JSON.parse(localStorage.getItem('italky_hof_v63') || '[]');
  const badges = ["ğŸ‘‘", "ğŸ¥ˆ", "ğŸ¥‰"];
  
  $('leaderboardBox').innerHTML = records.map((r, i) => `
    <div class="record-item rank-${i < 3 ? i : 'rest'}">
      <span>${i < 3 ? badges[i] : i+1 + '.'} <b>${r.score}</b> <small>${r.lang}-${r.lvl}</small></span>
      <span style="color:var(--c-neon-pink)">ğŸ”¥${r.streak} <small>${r.time}</small></span>
    </div>
  `).join('') || '<div style="font-size:12px; opacity:0.5">HenÃ¼z rekor yok baÅŸkanÄ±m.</div>';
  
  ['A2', 'B1', 'B2'].forEach(lvl => {
    const local = records.filter(r => r.lang === currentLang.toUpperCase() && r.lvl === lvl);
    const top = local.length > 0 ? Math.max(...local.map(r => r.score)) : 0;
    $(`pb-${lvl}`).textContent = `PB: ${top}`;
    if (lvl === currentDiff) $('pbDisplay').textContent = `PB (${currentLang.toUpperCase()}-${lvl}): ${top}`;
  });
}

window.setLang = (l, btn) => {
  currentLang = l;
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  updateLeaderboardUI(); 
};

window.initGame = async (diff) => {
  try {
    currentDiff = diff;
    const rawPool = await loadLangPool(currentLang);
    const randomizedItems = shuffle([...rawPool.items]);
    const { used, save } = createUsedSet(`gap_elite_v63_${currentLang}_${diff}`);
    
    if (totalAnswered === 0) {
      maxLives = (diff === "A2") ? 4 : 3;
      lives = maxLives;
    }

    puzzles = pick({ items: randomizedItems }, 15, used, save, it => {
      const itLvl = String(it.lvl || "").toUpperCase();
      const targetLvl = diff.toUpperCase();
      return it.sentence && (targetLvl === "A2" ? ["A1","A2"].includes(itLvl) : itLvl === targetLvl);
    });

    try { 
      save(puzzles.map(x => x.w)); 
      await Promise.resolve();
    } catch {}

    if (puzzles.length === 0) {
        alert("Havuz tÃ¼kendi baÅŸkanÄ±m! Liste temizleniyor.");
        localStorage.removeItem(`gap_elite_v63_${currentLang}_${diff}`);
        location.reload(); return;
    }

    $('startModal').style.display = 'none';
    $('endModal').style.display = 'none';
    $('btnContinue').disabled = false;
    $('btnBank').disabled = false;
    $('statusChip').textContent = `${currentLang.toUpperCase()} â€¢ ${diff}`;
    
    currentIdx = 0; setScore = 0; loadPuzzle();
  } catch (e) { alert("Sistem hatasÄ± baÅŸkanÄ±m!"); }
};

function loadPuzzle() {
  if (lives <= 0) return showFinal(true);
  if (currentIdx >= puzzles.length) return showFinal(false);

  const p = puzzles[currentIdx];
  const word = norm(p.w).trim();
  const escapedWord = escapeRegExp(word).replace(/\s+/g, "\\s+");
  
  $('progFill').style.width = `${((currentIdx + 1) / puzzles.length) * 100}%`;
  const sentence = norm(p.sentence);
  const regex = new RegExp(`(^|[^\\p{L}'-])(${escapedWord})(?=[^\\p{L}'-]|$)`, "giu");
  $('sentenceDisplay').innerHTML = sentence.replace(regex, `$1<span class="gap-box">____</span>`);
  
  $('translationDisplay').textContent = p.tr || "";
  $('lifeBar').textContent = "â¤ï¸".repeat(lives) + "ğŸ–¤".repeat(maxLives - lives);
  $('resInfo').style.opacity = "0";
  
  const n = s => norm(s).trim().toUpperCase();
  const correctN = n(p.w);
  let setWrongs = shuffle(puzzles.filter(x => n(x.w) !== correctN).map(x => x.w));
  const fallbackList = FALLBACKS[currentLang] || FALLBACKS.en;
  let rawWrongs = shuffle([...setWrongs.slice(0, 2), ...shuffle(fallbackList).slice(0, 3)]);
  
  const uniqueWrongs = [];
  const addWrong = (cand) => {
    if (n(cand) !== correctN && !uniqueWrongs.some(x => n(x) === n(cand))) uniqueWrongs.push(cand);
  };
  rawWrongs.forEach(w => { if(uniqueWrongs.length < 4) addWrong(w); });
  while (uniqueWrongs.length < 4) addWrong(fallbackList[uniqueWrongs.length % fallbackList.length]);
  
  const grid = $('optionsGrid'); grid.innerHTML = '';
  shuffle([p.w, ...uniqueWrongs]).forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'opt-btn'; 
    const normalizedOpt = norm(opt).trim().toUpperCase();
    btn.textContent = normalizedOpt;
    btn.onclick = () => handleChoice(normalizedOpt, btn);
    grid.appendChild(btn);
  });
  startTime = Date.now();
}

function handleChoice(val, btn) {
  if (isBusy) return;
  const p = puzzles[currentIdx];
  const correctVal = norm(p.w).trim().toUpperCase();
  const timeTaken = (Date.now() - startTime) / 1000;
  isBusy = true; totalAnswered++;
  document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);

  if (val === correctVal) {
    streak++; totalCorrect++;
    maxStreak = Math.max(maxStreak, streak);
    let comboMsg = "";
    if (streak > 0 && streak % 10 === 0 && timeTaken < 7 && lives < maxLives) {
      lives = Math.min(lives + 1, maxLives);
      comboMsg = " â€¢ â¤ï¸ CAN KAZANDIN!";
      $('lifeBar').style.transform = "scale(1.2)";
      setTimeout(()=> $('lifeBar').style.transform="scale(1)", 200);
    }
    let comboMult = Math.min(streak <= 3 ? streak : (3 + (streak - 3) * 0.25), 6); 
    let speedBonus = timeTaken < 4 ? 8 : (timeTaken < 7 ? 5 : (timeTaken < 10 ? 2 : 0));
    if (currentDiff === "B2") speedBonus = Math.floor(speedBonus * 0.7);
    const roundScore = Math.round(10 * comboMult + speedBonus);
    score += roundScore; setScore += roundScore;
    btn.classList.add('correct');
    $('resInfo').textContent = `+${roundScore} PUAN â€¢ STREAK ${streak} â€¢ MULT x${comboMult.toFixed(1)}${comboMsg}`;
    $('resInfo').style.opacity = "1";
    speak(p.sentence);
  } else {
    streak = 0; lives--;
    const penalty = currentDiff === "B2" ? 7 : 5;
    score = Math.max(0, score - penalty);
    btn.classList.add('wrong');
    $('resInfo').textContent = `DOÄRU: ${correctVal} â€¢ STREAK SIFIRLANDI (-${penalty})`;
    $('resInfo').style.opacity = "1";
    document.querySelectorAll('.opt-btn').forEach(b => { if(norm(b.textContent) === correctVal) b.classList.add('correct'); });
    speak(correctVal); 
  }
  $('scoreTxt').textContent = score;
  $('lifeBar').textContent = "â¤ï¸".repeat(Math.max(0, lives)) + "ğŸ–¤".repeat(maxLives - Math.max(0, lives));
  setTimeout(() => { currentIdx++; isBusy = false; loadPuzzle(); }, 2200);
}

function saveRecord() {
  if (score <= 0) return false;
  const records = JSON.parse(localStorage.getItem('italky_hof_v63') || '[]');
  const now = new Date();
  const newRecord = {
    id: now.getTime() + "-" + Math.random().toString(16).slice(2), // âœ… EÅSÄ°Z ID baÅŸkanÄ±m
    score: score,
    lang: currentLang.toUpperCase(),
    lvl: currentDiff,
    streak: maxStreak,
    time: now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) + ' ' + now.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' })
  };
  records.push(newRecord);
  records.sort((a,b) => b.score - a.score);
  const finalRecords = records.slice(0, 10);
  localStorage.setItem('italky_hof_v63', JSON.stringify(finalRecords));
  updateLeaderboardUI();
  return finalRecords.some(r => r.id === newRecord.id); // âœ… Kesin Top 10 kontrolÃ¼
}

function showFinal(gameEnded) {
  $('endModal').style.display = 'flex';
  const acc = totalAnswered ? Math.round((totalCorrect/totalAnswered)*100) : 0;
  if (gameEnded) {
    const isNewRecord = saveRecord();
    $('endTitle').textContent = isNewRecord ? "YENÄ° REKOR! ğŸ‘‘" : "OYUN BÄ°TTÄ° ğŸ’€";
    $('btnContinue').style.display = 'none'; $('btnBank').style.display = 'none';
  } else {
    $('endTitle').textContent = "SET TAMAMLANDI ğŸ†";
    $('btnContinue').style.display = 'block'; $('btnBank').style.display = 'block';
  }
  $('endStats').innerHTML = `Skor: <b>${score}</b><br>En Ä°yi Seri: <b>ğŸ”¥ ${maxStreak}</b><br>DoÄŸruluk: <b>%${acc}</b>`;
}

// MenÃ¼ye Temiz DÃ¶nÃ¼ÅŸ baÅŸkanÄ±m
function returnToMenu() {
  saveRecord();
  score = 0; setScore = 0; lives = 3; streak = 0; maxStreak = 0; totalAnswered = 0; totalCorrect = 0;
  $('scoreTxt').textContent = "0";
  $('endModal').style.display = 'none';
  $('startModal').style.display = 'flex';
  updateLeaderboardUI();
}

$('btnContinue').onclick = () => { 
  $('btnContinue').disabled = true; $('btnBank').disabled = true;
  $('endModal').style.display = 'none';
  setScore = 0; initGame(currentDiff);
};

$('btnBank').onclick = () => {
  $('btnContinue').disabled = true; $('btnBank').disabled = true;
  $('endModal').style.display = 'none';
  const bonus = Math.round(setScore * 0.05);
  score += bonus;
  $('resInfo').textContent = `BANKA BONUSU +${bonus} PUAN`;
  $('resInfo').style.opacity = "1";
  setScore = 0; lives = maxLives; streak = 0; initGame(currentDiff);
};

$('btnFinish').onclick = () => returnToMenu();

function speak(t) {
  const now = Date.now();
  if (now - lastSpoken < 250) return;
  lastSpoken = now;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(t);
  const m = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };
  u.lang = m[currentLang] || 'en-US';
  u.rate = 0.85;
  window.speechSynthesis.speak(u);
}

window.addEventListener('load', updateLeaderboardUI);
</script>
</body>
</html>
