<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ITALKY ‚Ä¢ Gap Master</title>
  <link rel="icon" href="data:,"/>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
  
  <style>
    :root { 
      --bg-deep:#020205; 
      --text-main:#fff; 
      --c-accent:#ffb800; 
      --c-success:#00e676; 
      --c-error:#ff1744; 
      --c-cyan: #00f3ff;
      --border:rgba(255,255,255,0.1); 
    }
    
    * { box-sizing:border-box; outline:none; user-select:none; -webkit-tap-highlight-color:transparent; }
    html,body { margin:0; height:100dvh; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:var(--text-main); }
    
    .cosmos-bg { position:absolute; inset:0; background:radial-gradient(circle at center, #1a1a2e 0%, #000 100%); z-index:0; }
    .star-dust { position: absolute; inset: 0; opacity: 0.3; background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 50px 50px; animation: dustMove 100s linear infinite; } 
    #effectCanvas { position: absolute; inset: 0; pointer-events: none; z-index: 9999; display: none; }
    @keyframes dustMove { from { transform: translateY(0); } to { transform: translateY(-500px); } }
    
    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; }
    
    /* LOGO HEADER */
    .game-logo-header {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding-top: 20px; margin-bottom: -10px; position: relative; z-index: 20;
    }
    .gl-brand { font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 700; color: rgba(255, 255, 255, 0.6); letter-spacing: 2px; margin-bottom: 5px; }
    .gl-icon { font-size: 32px; margin-bottom: 2px; filter: drop-shadow(0 0 5px var(--c-accent)); animation: pulseNeon 2s infinite alternate; }
    .gl-title { font-family: 'Space Grotesk', sans-serif; font-weight: 900; font-size: 26px; letter-spacing: 1px; background: linear-gradient(to right, var(--c-accent), #ff5500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; line-height: 1; }
    .gl-sub { font-size: 9px; letter-spacing: 4px; color: var(--c-accent); opacity: 0.8; margin-top: 4px; font-weight: 700; }
    @keyframes pulseNeon { from { transform: scale(1); } to { transform: scale(1.05); } }

    /* NAV & SCORE */
    .nav-layer { position:absolute; top:0; left:0; width:100%; height:70px; z-index:50; display:flex; justify-content:space-between; padding:10px 12px; pointer-events:none; }
    .nav-btn { pointer-events:auto; height:44px; padding:0 16px; border-radius:14px; background:rgba(0,0,0,0.4); border:1px solid var(--border); color:#fff; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px); cursor:pointer; font-weight:700; transition:0.2s; }
    .nav-btn:active { transform:scale(0.95); }
    
    .score-badge { font-family:'Space Grotesk', sans-serif; font-weight:800; font-size:16px; color:var(--c-accent); display:flex; flex-direction:column; align-items:flex-end; pointer-events:auto; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
    .lives-display { font-size:12px; margin-top:2px; letter-spacing:2px; }

    /* OYUN ALANI */
    .game-stage { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; padding-top:40px; position:relative; }
    
    .puzzle-card { 
      width:100%; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:24px; padding:30px 20px; text-align:center; backdrop-filter:blur(10px); box-shadow:0 20px 60px rgba(0,0,0,0.5); transition:0.3s; 
    }
    
    .sentence-container { 
      font-size:24px; font-weight:600; line-height:1.6; color:rgba(255,255,255,0.95); min-height:100px; display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:8px; 
    }
    
    .gap-slot { 
      display:inline-block; min-width:80px; height:36px; border-bottom:3px solid var(--c-accent); color:var(--c-accent); font-weight:800; text-align:center; transition:0.3s; padding:0 5px;
    }
    .gap-slot.filled { border-bottom-color:var(--c-success); color:var(--c-success); transform:scale(1.1); text-shadow: 0 0 10px var(--c-success); }
    .gap-slot.error { border-bottom-color:var(--c-error); color:var(--c-error); animation:shake 0.4s; }
    
    .translation { 
      margin-top:24px; font-size:16px; opacity:0; transform:translateY(10px); transition:all 0.5s ease; font-weight:500; color:var(--c-success); 
    } 
    .translation.show { opacity:1; transform:translateY(0); }
    
    /* KONTROLLER */
    .controls { padding:40px; width:100%; display:flex; flex-direction:column; align-items:center; gap:20px; }
    
    .mic-btn { 
      width:80px; height:80px; border-radius:50%; background:rgba(255,255,255,0.08); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.2s; box-shadow:0 10px 40px rgba(0,0,0,0.3); 
    }
    .mic-btn svg { width:32px; height:32px; stroke:#fff; fill:none; stroke-width:2; transition:0.3s; }
    .mic-btn:active { transform:scale(0.95); }
    .mic-btn.listening { background:#fff; box-shadow:0 0 30px rgba(255,184,0,0.4); animation:pulseMic 1.5s infinite; } 
    .mic-btn.listening svg { stroke:#000; }
    .mic-btn:disabled { opacity:0.5; filter:grayscale(1); cursor:not-allowed; }
    
    .status-text { font-family:'Space Grotesk', sans-serif; font-weight:700; font-size:14px; opacity:0.7; letter-spacing:1px; text-transform:uppercase; height:20px; transition: color 0.3s; }
    .status-text.combo { color: var(--c-accent); animation: pulse 0.5s infinite; }
    
    /* MODAL */
    .modal-wrap { position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(20px); } 
    .modal-card { width:85%; background:#101014; border:1px solid var(--border); border-radius:32px; padding:32px; text-align:center; box-shadow:0 30px 80px rgba(0,0,0,1); animation:popIn 0.5s; }
    .modal-title { font-size:24px; font-weight:800; margin-bottom:12px; color:var(--c-accent); font-family:'Space Grotesk', sans-serif; }
    .modal-p { font-size:15px; opacity:0.7; margin-bottom:24px; line-height:1.6; }
    
    .btn-primary { width:100%; padding:16px; border-radius:16px; border:none; background:linear-gradient(135deg, var(--c-accent), #ff8800); color:#000; font-weight:800; font-size:16px; cursor:pointer; box-shadow:0 10px 30px rgba(255,184,0,0.3); transition:0.2s; }
    .btn-primary:active { transform:scale(0.98); }
    .btn-sec { background:rgba(255,255,255,0.1); margin-top:10px; color:#fff; }

    /* Dƒ∞L SE√áƒ∞Mƒ∞ */
    .lang-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
    .lang-btn { background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 8px; padding: 10px 0; cursor: pointer; font-size: 24px; transition: 0.2s; display: flex; justify-content: center; }
    .lang-btn:active, .lang-btn.active { background: var(--c-accent); border-color: var(--c-accent); color:#000; transform: scale(1.05); }
    
    .loader { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--c-accent); border-radius: 50%; width: 40px; height: 40px; animation:spin 1s linear infinite; margin:0 auto 20px; }
    
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } } 
    @keyframes pulseMic { 0% { box-shadow:0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow:0 0 0 20px rgba(255,255,255,0); } 100% { box-shadow:0 0 0 0 rgba(255,255,255,0); } } 
    @keyframes shake { 0% { transform:translateX(0); } 25% { transform:translateX(-5px); } 50% { transform:translateX(5px); } 75% { transform:translateX(-5px); } 100% { transform:translateX(0); } } 
    @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }
  </style>
</head>
<body>

  <div class="cosmos-bg"><div class="star-dust"></div></div>
  <canvas id="effectCanvas"></canvas>

  <div class="wrap">
    <div class="game-logo-header">
      <div class="gl-brand">ITALKY<span style="color:var(--c-accent)">AI</span></div>
      <div class="gl-icon">üß©</div>
      <div class="gl-title">GAP MASTER</div>
      <div class="gl-sub">MIND ARENA</div>
    </div>

    <div class="nav-layer">
      <button class="nav-btn" onclick="window.location.href='/pages/game.html'">‚Üê</button>
      <div class="score-badge">
        <span id="scoreVal">0 PUAN</span>
        <div class="lives-display" id="livesVal">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      </div>
    </div>

    <div class="game-stage">
      <div class="puzzle-card">
        <div class="sentence-container" id="sentenceBox">Y√ºkleniyor...</div>
        <div class="translation" id="translationBox"></div>
      </div>
    </div>

    <div class="controls">
      <div class="status-text" id="statusText">HAZIR</div>
      <button class="mic-btn" id="micBtn">
        <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
      </button>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <div class="modal-title">GAP MASTER üß©</div>
      <div class="modal-p" style="margin-bottom:10px;font-weight:700">Dil Se√ßimi:</div>
      <div class="lang-grid">
        <div class="lang-btn active" onclick="setLang('en', this)">üá¨üáß</div>
        <div class="lang-btn" onclick="setLang('de', this)">üá©üá™</div>
        <div class="lang-btn" onclick="setLang('fr', this)">üá´üá∑</div>
        <div class="lang-btn" onclick="setLang('es', this)">üá™üá∏</div>
        <div class="lang-btn" onclick="setLang('it', this)">üáÆüáπ</div>
      </div>
      <div class="modal-p">
        1. C√ºmleyi Dinle (Bo≈ülukta susacak)<br>
        2. Eksik Kelimeyi S√∂yle<br>
        3. Hƒ±zlƒ± Ol, Canƒ±nƒ± Koru!
      </div>
      <div id="loading" style="display:none;margin-bottom:20px"><div class="loader"></div><div>Hazƒ±rlanƒ±yor...</div></div>
      <button class="btn-primary" id="startBtn">BA≈ûLA</button>
    </div>
  </div>

  <div class="modal-wrap" id="endModal" style="display:none">
    <div class="modal-card">
      <div class="modal-title">OYUN Bƒ∞TTƒ∞! üèÅ</div>
      <div class="modal-p" id="endResult"></div>
      <button class="btn-primary" onclick="location.reload()">TEKRAR</button>
      <button class="btn-primary btn-sec" onclick="location.href='/pages/game.html'">√áIKI≈û</button>
    </div>
  </div>

<script type="module">
import { BASE_DOMAIN } from "/js/config.js";
const $ = (id) => document.getElementById(id);
const apiBase = () => String(BASE_DOMAIN || "").replace(/\/+$/, "");

// Dƒ∞L AYARLARI (Hƒ±z Limitleri: DE/FR daha uzun s√ºre ister)
let currentLang = 'en';
const LANG_CONFIG = {
  en: { code: 'en-US', name: 'ƒ∞ngilizce', prompt: 'ƒ∞ngilizce', speedLimit: 4 },
  de: { code: 'de-DE', name: 'Almanca', prompt: 'Almanca', speedLimit: 5 },
  fr: { code: 'fr-FR', name: 'Fransƒ±zca', prompt: 'Fransƒ±zca', speedLimit: 5 },
  es: { code: 'es-ES', name: 'ƒ∞spanyolca', prompt: 'ƒ∞spanyolca', speedLimit: 4 },
  it: { code: 'it-IT', name: 'ƒ∞talyanca', prompt: 'ƒ∞talyanca', speedLimit: 4 }
};

window.setLang = (l, el) => {
  currentLang = l;
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  if(el) el.classList.add('active');
  ensureAudio();
};

// SES (Lazy Load)
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){ const AC = window.AudioContext || window.webkitAudioContext; audioCtx = AC ? new AC() : null; }
  if(audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  return audioCtx;
}

const SFX = {
  correct: () => {
    const c=ensureAudio(); if(!c)return; const t=c.currentTime;
    [523,659,783].forEach((f,i)=>{ const o=c.createOscillator(),g=c.createGain(); o.frequency.value=f; o.connect(g); g.connect(c.destination); g.gain.setValueAtTime(.05,t+i*.1); g.gain.exponentialRampToValueAtTime(.001,t+i*.1+.3); o.start(t+i*.1); o.stop(t+i*.1+.3); });
  },
  wrong: () => {
    const c=ensureAudio(); if(!c)return; const t=c.currentTime,o=c.createOscillator(),g=c.createGain(); o.type='sawtooth'; o.frequency.value=150; o.connect(g); g.connect(c.destination); g.gain.setValueAtTime(.1,t); g.gain.linearRampToValueAtTime(.001,t+.3); o.start(t); o.stop(t+.3);
  }
};

let puzzleList = [];
let currentIndex = 0;
let score = 0;
let lives = 3;
let combo = 0;
let isBusy = false;
let turnStartTime = 0;

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

// ROBUST PARSE (T√ºm hatalarƒ± yutar)
function safeParse(raw){
  let txt = "";
  if(typeof raw === "string") txt = raw;
  else if(raw && typeof raw === "object") txt = raw.text || raw.message || raw.output || "";
  
  txt = String(txt||"").trim().replace(/```json/gi,"").replace(/```/g,"").trim();
  const a = txt.indexOf("["); const b = txt.lastIndexOf("]");
  if(a !== -1 && b !== -1) txt = txt.slice(a, b+1);

  try { return JSON.parse(txt); } catch { return []; }
}

// NORMALIZE (Akƒ±llƒ± Karakter)
function normalize(s){
  return String(s||"").toLowerCase().trim()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") 
    .replace(/√ü/g, "ss").replace(/≈ì/g, "oe")
    .replace(/[.,!?]/g,"");
}

async function fetchPuzzles() {
  ensureAudio(); 
  $("loading").style.display = "block"; $("startBtn").style.display = "none";

  try {
    const lg = LANG_CONFIG[currentLang];
    const res = await fetch(`${apiBase()}/api/chat`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        text: `Bana ${lg.name} dilinde B1 seviyesinde 10 c√ºmle ver. Bir kelimeyi (fiil/isim) gizle. SADECE JSON formatƒ±nda: [{'sentence_parts':['I drink','every day.'],'hidden_word':'coffee','translation':'Her g√ºn kahve i√ßerim.'},...]`,
        max_tokens: 1500 
      })
    });
    const data = await res.json();
    puzzleList = safeParse(data).filter(p => Array.isArray(p.sentence_parts) && p.sentence_parts.length === 2 && typeof p.hidden_word === "string");
    
    if (puzzleList.length < 3) throw new Error("Yetersiz veri");

  } catch (err) {
    if(currentLang === 'en') {
      puzzleList = [{sentence_parts:["The sky is","today."], hidden_word:"blue", translation:"Bug√ºn g√∂ky√ºz√º mavi."}, {sentence_parts:["I drink","water."], hidden_word:"cold", translation:"Soƒüuk su i√ßerim."}];
    } else {
      puzzleList = [{sentence_parts:["Das ist","gut."], hidden_word:"sehr", translation:"Bu √ßok iyi."}, {sentence_parts:["Ich bin","Mann."], hidden_word:"ein", translation:"Ben bir adamƒ±m."}];
    }
  }
  
  $("startModal").style.display = "none";
  lives = 3; score = 0; combo = 0; currentIndex = 0;
  updateScoreUI();
  loadPuzzle();
}

function loadPuzzle() {
  if (currentIndex >= puzzleList.length) { endSet(false); return; }

  // Spam Korumasƒ±: Mic Disable
  $("micBtn").disabled = true;
  $("micBtn").classList.remove("listening");

  const p = puzzleList[currentIndex];
  $("translationBox").className = "translation";
  $("translationBox").textContent = p.translation;
  
  $("sentenceBox").innerHTML = `
    <span>${p.sentence_parts[0]}</span>
    <span class="gap-slot" id="gapSlot">_____</span>
    <span>${p.sentence_parts[1]}</span>
  `;
  
  setStatus("Dƒ∞NLE VE CEVAPLA");
  turnStartTime = Date.now();
  setTimeout(() => speakPuzzle(p), 800);
}

function setStatus(txt, type="normal") {
  const el = $("statusText");
  el.textContent = txt;
  el.className = "status-text";
  if(type==="combo") el.classList.add("combo");
}

function speak(text, rate=0.85) {
  return new Promise(resolve => {
    try{ window.speechSynthesis.cancel(); }catch{}
    const u = new SpeechSynthesisUtterance(text);
    u.lang = LANG_CONFIG[currentLang].code;
    u.rate = rate;
    u.onend = resolve; u.onerror = resolve;
    try{ window.speechSynthesis.speak(u); }catch{ resolve(); }
  });
}

async function speakPuzzle(p) {
  if (isBusy) return;
  isBusy = true;
  $("micBtn").disabled = true;
  
  await speak(`${p.sentence_parts[0]} ... ${p.sentence_parts[1]}`);
  
  isBusy = false;
  $("micBtn").disabled = false;
  setStatus("Mƒ∞KROFONA BASIP S√ñYLE");
}

async function speakFullSentence(p) {
  isBusy = true;
  $("statusText").textContent = "Dƒ∞NLE VE √ñƒûREN...";
  try{ window.speechSynthesis.cancel(); }catch{}
  await speak(`${p.sentence_parts[0]} ${p.hidden_word} ${p.sentence_parts[1]}`, 0.9);
  isBusy = false;
}

function listen() {
  if (isBusy) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return alert("Desteklenmiyor");
  
  try{ window.speechSynthesis.cancel(); }catch{}
  
  isBusy = true;
  $("micBtn").classList.add("listening");
  $("statusText").textContent = "Dƒ∞NLƒ∞YOR...";
  
  const rec = new SR();
  rec.lang = LANG_CONFIG[currentLang].code;
  rec.interimResults = false;
  let handled = false;
  
  rec.onresult = (e) => {
    if(handled) return;
    handled = true;
    try{ rec.stop(); }catch{} // Lifecycle Fix
    checkAnswer(e.results[0][0].transcript);
  };
  
  rec.onerror = () => { if(!handled) cleanup("SES GELMEDƒ∞"); };
  rec.onend = () => { if (!handled) cleanup("SES GELMEDƒ∞"); };
  
  try{ rec.start(); }catch{ cleanup("HATA"); }
}

function cleanup(msg) {
  isBusy = false;
  $("micBtn").classList.remove("listening");
  $("micBtn").disabled = false;
  setStatus(msg);
}

async function checkAnswer(inputRaw) {
  // Temizlik (UI Spam √ñnlemi)
  $("micBtn").classList.remove("listening");
  $("micBtn").disabled = true;

  const p = puzzleList[currentIndex];
  const target = normalize(p.hidden_word);
  const input = normalize(inputRaw);
  const slot = $("gapSlot");

  const ok = input.includes(target) || target.includes(input);
  
  // Hƒ±z Bonusu (Dile G√∂re)
  const limit = LANG_CONFIG[currentLang].speedLimit;
  const sec = (Date.now() - turnStartTime) / 1000;
  const speedBonus = sec <= limit ? 5 : 0;

  if (ok) {
    // DOƒûRU
    SFX.correct();
    slot.textContent = p.hidden_word.toUpperCase();
    slot.classList.remove("error");
    slot.classList.add("filled");
    
    combo++;
    let bonus = combo >= 5 ? 20 : (combo >= 3 ? 10 : (combo >= 2 ? 5 : 0));
    score += (10 + bonus + speedBonus);
    
    let msg = "DOƒûRU!";
    if(combo >= 5) msg = "MEGA SERƒ∞!! üî•";
    else if(bonus>0) msg += ` SERƒ∞ +${bonus}`;
    
    setStatus(msg, "combo");
    updateScoreUI();
    $("translationBox").classList.add("show");
    if(combo >= 3) startConfetti();

    await sleep(600);
    await speakFullSentence(p);
    await sleep(500);

  } else {
    // YANLI≈û -> ARENA KURALI
    SFX.wrong();
    lives--;
    score = Math.max(0, score - 5);
    combo = 0;
    
    slot.classList.add("error");
    slot.textContent = p.hidden_word.toUpperCase();
    setStatus(`YANLI≈û!`);
    updateScoreUI();
    
    await sleep(1500);
    if(lives <= 0) { endSet(true); return; }
  }
  
  // Her durumda sonraki soru
  currentIndex++;
  isBusy = false;
  loadPuzzle();
}

function updateScoreUI(){
  $("scoreVal").textContent = `${score} PUAN`;
  const hearts = "‚ù§Ô∏è".repeat(lives) + "ü§ç".repeat(3-lives);
  $("livesVal").textContent = lives > 0 ? hearts : "üíÄüíÄüíÄ";
}

function endSet(isDead){
  try{ window.speechSynthesis.cancel(); }catch{}
  $("endModal").style.display = "flex";
  if(isDead) {
    $("endResult").innerHTML = `<span style="color:var(--c-error);font-size:32px">OYUN Bƒ∞TTƒ∞</span><br>Skor: ${score}`;
  } else {
    $("endResult").innerHTML = `<span style="color:var(--c-success);font-size:32px">TEBRƒ∞KLER!</span><br>Skor: ${score}`;
    startConfetti();
  }
}

// CONFETTI (Strict Cleanup)
let fwInterval=null; const cvs=$("effectCanvas"), ctx=cvs.getContext("2d"); let particles=[];
function startConfetti(){
  if(fwInterval) clearInterval(fwInterval);
  particles=[]; cvs.style.display="block"; cvs.width=window.innerWidth; cvs.height=window.innerHeight;
  fwInterval=setInterval(()=>{ for(let i=0;i<5;i++) particles.push({x:Math.random()*cvs.width,y:cvs.height,vx:(Math.random()-.5)*5,vy:-(Math.random()*5+5),c:`hsl(${Math.random()*360},100%,50%)`,l:100}); },100);
  setTimeout(()=>{ 
    if(fwInterval)clearInterval(fwInterval); fwInterval=null; 
    cvs.style.display="none"; particles=[]; 
  }, 4000);
  requestAnimationFrame(loopConfetti);
}
function loopConfetti(){
  if(particles.length <= 0) return;
  ctx.clearRect(0,0,cvs.width,cvs.height);
  for(let i=0;i<particles.length;i++){ let p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.l--; ctx.beginPath(); ctx.arc(p.x,p.y,5,0,Math.PI*2); ctx.fillStyle=p.c; ctx.fill(); if(p.l<=0){particles.splice(i,1);i--} }
  requestAnimationFrame(loopConfetti);
}

$("startBtn").onclick = fetchPuzzles;
$("micBtn").onclick = () => { ensureAudio(); listen(); };

</script>
</body>
</html>
