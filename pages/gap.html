<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>ITALKY â€¢ Gap Master</title>
<link rel="icon" href="data:,"/>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#020205;--text:#fff;--accent:#ffb800;
  --ok:#00e676;--bad:#ff1744;--border:rgba(255,255,255,.12)
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{margin:0;width:100%;height:100%;background:var(--bg);color:var(--text);font-family:Outfit,sans-serif;overflow:hidden}
.wrap{max-width:480px;height:100%;margin:0 auto;display:flex;flex-direction:column}
.header{text-align:center;padding:14px 0;font-family:Space Grotesk;font-weight:900;letter-spacing:2px}
.stage{flex:1;padding:16px;display:flex;flex-direction:column;gap:16px}
.card{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:24px;padding:20px;text-align:center}
.sentence{font-size:22px;font-weight:700;line-height:1.4}
.gap{border-bottom:2px solid var(--accent);padding:0 6px;color:var(--accent)}
.opts{display:grid;gap:10px}
.opt{padding:14px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.06);font-weight:800;font-size:18px;text-transform:uppercase;cursor:pointer}
.opt.correct{border-color:var(--ok);color:var(--ok);background:rgba(0,230,118,.15)}
.opt.wrong{border-color:var(--bad);color:var(--bad);background:rgba(255,23,68,.15)}
.scorebar{display:flex;justify-content:space-between;font-family:Space Grotesk;font-weight:800}
.modal{position:absolute;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center}
.box{background:#101014;border:1px solid var(--border);border-radius:24px;padding:24px;width:90%;text-align:center}
.langs{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px}
.lang{border:1px solid var(--border);border-radius:10px;padding:10px;font-size:22px;cursor:pointer}
.lang.active{background:var(--accent);color:#000}
.btn{width:100%;padding:14px;border-radius:14px;border:none;font-weight:900;background:linear-gradient(135deg,var(--accent),#ff8800);color:#000}
</style>
</head>

<body>
<div class="wrap">
  <div class="header">GAP MASTER</div>

  <div class="stage">
    <div class="scorebar">
      <div id="scoreTxt">0 PUAN</div>
      <div id="lifeTxt">â¤ï¸â¤ï¸â¤ï¸</div>
    </div>

    <div class="card">
      <div class="sentence" id="sentence">...</div>
    </div>

    <div class="opts" id="opts"></div>
  </div>
</div>

<div class="modal" id="startModal">
  <div class="box">
    <h3>DÄ°L SEÃ‡</h3>
    <div class="langs">
      <div class="lang active" data-lang="en">ğŸ‡¬ğŸ‡§</div>
      <div class="lang" data-lang="de">ğŸ‡©ğŸ‡ª</div>
      <div class="lang" data-lang="fr">ğŸ‡«ğŸ‡·</div>
      <div class="lang" data-lang="es">ğŸ‡ªğŸ‡¸</div>
      <div class="lang" data-lang="it">ğŸ‡®ğŸ‡¹</div>
    </div>
    <button class="btn" id="startBtn">BAÅLA</button>
  </div>
</div>

<div class="modal" id="endModal" style="display:none">
  <div class="box">
    <h2>OYUN BÄ°TTÄ°</h2>
    <div id="endTxt"></div>
    <button class="btn" onclick="location.reload()">TEKRAR</button>
  </div>
</div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $=id=>document.getElementById(id);

let currentLang="en";
let pool=null;
let puzzles=[];
let idx=0;
let score=0;
let lives=3;

const LANG_MAP={en:"en-US",de:"de-DE",fr:"fr-FR",es:"es-ES",it:"it-IT"};

document.querySelectorAll(".lang").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".lang").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    currentLang=b.dataset.lang;
  };
});

$("#startBtn").onclick=async()=>{
  $("#startModal").style.display="none";
  pool=await loadLangPool(currentLang);
  const {used,save}=createUsedSet("gapmaster_"+currentLang);

  const words=pick(pool,30,used,save,it=>{
    const w=String(it.w||"").replace(/[^a-zA-Z]/g,"");
    return w.length>=3 && w.length<=10;
  });

  puzzles=words.map(it=>{
    const sent=it.sentence || `This is ${it.w}.`;
    const clean=sent.replace(new RegExp(`\\b${it.w}\\b`,`i`),"_____");
    const opts=shuffle([it.w,...randomOpts(pool.items,it.w,4)]);
    return {sentence:clean,answer:it.w,opts};
  });

  idx=0;score=0;lives=3;
  updateUI();
  loadPuzzle();
};

function randomOpts(all,exclude,n){
  const a=all.filter(x=>x.w!==exclude).map(x=>x.w);
  return shuffle(a).slice(0,n);
}

function loadPuzzle(){
  if(idx>=puzzles.length||lives<=0){ endGame(); return; }
  const p=puzzles[idx];
  $("#sentence").innerHTML=p.sentence.replace("_____","<span class='gap'>_____</span>");
  const grid=$("#opts"); grid.innerHTML="";
  p.opts.forEach(o=>{
    const b=document.createElement("button");
    b.className="opt";
    b.textContent=o;
    b.onclick=()=>choose(b,o,p);
    grid.appendChild(b);
  });
}

async function choose(btn,choice,p){
  document.querySelectorAll(".opt").forEach(x=>x.disabled=true);
  if(choice.toLowerCase()===p.answer.toLowerCase()){
    btn.classList.add("correct");
    score+=10;
    await speak(p.answer);
  }else{
    btn.classList.add("wrong");
    lives--;
    document.querySelectorAll(".opt").forEach(x=>{
      if(x.textContent.toLowerCase()===p.answer.toLowerCase()) x.classList.add("correct");
    });
  }
  updateUI();
  setTimeout(()=>{idx++;loadPuzzle();},900);
}

function updateUI(){
  $("#scoreTxt").textContent=`${score} PUAN`;
  $("#lifeTxt").textContent=lives>0?"â¤ï¸".repeat(lives)+"ğŸ¤".repeat(3-lives):"ğŸ’€ğŸ’€ğŸ’€";
}

function endGame(){
  $("#endModal").style.display="flex";
  $("#endTxt").innerHTML=`Skor: <b>${score}</b>`;
}

function speak(t){
  return new Promise(res=>{
    try{speechSynthesis.cancel();}catch{}
    const u=new SpeechSynthesisUtterance(t);
    u.lang=LANG_MAP[currentLang]||"en-US";
    u.rate=.9;
    u.onend=res;u.onerror=res;
    try{speechSynthesis.speak(u);}catch{res();}
  });
}

function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
</script>
</body>
</html>
