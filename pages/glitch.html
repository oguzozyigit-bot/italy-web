<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ITALKY â€¢ Glitch Hunter Neural Sync</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#050505; --cyan:#00ffff; --pink:#ff0055; --green:#00ff66; --purple:#bd00ff;
  --panel:rgba(10,20,20,.95); --border:rgba(0,255,255,.3); --text:#fff;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{margin:0;width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Outfit', sans-serif;color:var(--text)}

.app{position:relative;max-width:480px;height:100%;margin:0 auto;background:var(--panel);border:1px solid var(--border);display:flex;flex-direction:column;z-index:5}
@media(min-width:520px){.app{height:92vh;border-radius:24px;margin-top:4vh}}

.header{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 16px; border-bottom:1px solid var(--border)}
.title{font-size:16px; letter-spacing:1px; color:var(--cyan); font-weight:900;}
.pb-badge{font-size:10px;padding:4px 8px;background:var(--cyan);color:#000;font-weight:800;border-radius:4px}

.game{flex:1;padding:16px;display:none;flex-direction:column;justify-content:space-between; position: relative;}
.stats{display:flex;justify-content:space-between;font-size:11px;color:var(--cyan);font-weight:bold;margin-bottom:5px; text-transform: uppercase;}

.mom-bar-container { width: 100%; height: 4px; background: rgba(255,255,255,0.05); border-radius: 2px; margin-bottom: 10px; overflow: hidden; }
#momBarFill { width: 0%; height: 100%; background: var(--cyan); transition: 0.5s; }

.terminal{flex:1;border:2px solid var(--border);background:rgba(0,0,0,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;padding:25px;text-align:center;border-radius:20px;transition: 0.3s; cursor: pointer;}
.terminal.boss-mode { border-color: var(--pink); box-shadow: inset 0 0 30px rgba(255,0,85,0.2); }

@keyframes alarm { 0%, 100% { border-color: var(--border); } 50% { border-color: var(--pink); box-shadow: 0 0 20px var(--pink); } }
.terminal.alarm-active { animation: alarm 0.6s infinite; }

.boss-label { position: absolute; top: 10px; font-size: 10px; color: var(--pink); font-weight: 900; display: none; letter-spacing: 2px; }

.sentence{font-size:28px; color:#fff; line-height:1.3; font-weight:700;}

#correctionBox{font-size:14px; color:var(--green); margin-top:15px; font-weight:bold; opacity:0; transition:0.2s; background: rgba(0,255,102,0.1); padding: 12px; border-radius: 10px; width: 100%; border-left: 3px solid var(--green);}
.tr-text { color: var(--cyan); font-style: italic; font-weight: 500; margin-top: 5px; display: block; }
.tap-hint { font-size: 10px; color: var(--cyan); margin-top: 10px; opacity: 0.6; display: none; font-weight: 900;}

.controls{display:flex;gap:12px;height:100px;margin-top:20px}
.action{flex:1;border:3px solid var(--border);cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:.1s; font-weight:900;border-radius:16px;color:#fff; background: transparent;}
.bug { border-color: var(--pink); color: var(--pink); }
.ok { border-color: var(--green); color: var(--green); }
.action:active{transform:scale(.95)}

.modal{position:absolute;inset:0;background:rgba(0,0,0,.98);display:flex;align-items:center;justify-content:center;z-index:200}
.card{background:#0a0a0a;border:1px solid var(--cyan);padding:25px;width:90%;text-align:center;border-radius:28px; max-height: 90vh; overflow-y: auto;}
.mainbtn{width:100%;padding:18px;margin-top:10px;border:none;background:var(--cyan);color:#000;font-weight:900;cursor:pointer;font-size:16px;border-radius:14px}
.btn-sub { font-size: 9px; display: block; margin-top: 4px; opacity: 0.7; font-weight: 400; }

.lang-grid{display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin:15px 0}
.lang-btn{font-size:24px; padding:10px; background:rgba(255,255,255,0.05); border:2px solid #333; border-radius:12px; cursor:pointer;}
.lang-btn.active{border-color:var(--cyan); background:rgba(0,243,255,0.1)}

.hidden{display:none!important}
.glitch-anim{animation:shake 0.3s}
@keyframes shake{ 0%, 100% {transform: translateX(0)} 25% {transform: translateX(-8px)} 75% {transform: translateX(8px)} }
</style>
</head>

<body>
<div class="app" id="frame">
  <div class="header">
    <div style="cursor:pointer; color:var(--cyan); font-size:20px" onclick="location.href='/pages/game.html'">â†</div>
    <div class="title">GLITCH_HUNTER</div>
    <div id="pbBadge" class="pb-badge">PB: 0</div>
  </div>

  <div class="game" id="game">
    <div class="stats">
      <span>INTEGRITY: <b id="life">100%</b></span>
      <span>MOMENTUM: <b id="momVal">x1.00</b></span>
      <span id="setCounter">1/12</span>
    </div>
    <div class="mom-bar-container"><div id="momBarFill"></div></div>

    <div class="terminal" id="terminal">
      <div class="boss-label" id="bossLabel">/// BOSS CHECK ///</div>
      <div class="sentence" id="sentence">Initializing...</div>
      <div id="correctionBox">
        <span id="correctTxt"></span>
        <span id="trTxt" class="tr-text"></span>
        <div class="tap-hint" id="tapHint">DEVAM ET / DÃœZELTTÄ°M</div>
      </div>
    </div>

    <div class="controls">
      <button class="action bug" id="btnGlitch">ğŸ GLITCH</button>
      <button class="action ok" id="btnStable">ğŸ›¡ï¸ STABLE</button>
    </div>
  </div>
</div>

<div class="modal" id="start">
  <div class="card">
    <h2 style="color:var(--cyan); font-size:24px; margin-bottom: 5px;">Neural Sync</h2>
    <p style="opacity:.6; font-size:11px; margin-bottom: 15px;">Dili ayÄ±rt etme kasÄ±nÄ± Ã§alÄ±ÅŸtÄ±r baÅŸkanÄ±m.</p>
    
    <div class="lang-grid">
        <button data-lang="en" class="lang-btn active">ğŸ‡¬ğŸ‡§</button>
        <button data-lang="de" class="lang-btn">ğŸ‡©ğŸ‡ª</button>
        <button data-lang="fr" class="lang-btn">ğŸ‡«ğŸ‡·</button>
        <button data-lang="es" class="lang-btn">ğŸ‡ªğŸ‡¸</button>
        <button data-lang="it" class="lang-btn">ğŸ‡®ğŸ‡¹</button>
    </div>

    <button class="mainbtn" id="startBtn">BOOT SYSTEM</button>
    <div id="leaderboardBox" style="margin-top:20px; font-size:10px; text-align:left; color:rgba(255,255,255,0.4)"></div>
  </div>
</div>

<div class="modal hidden" id="end">
  <div class="card">
    <h2 id="endTitle" style="color:var(--green)">SYNC COMPLETE</h2>
    <div id="learningReport" style="color:var(--cyan); font-size:12px; margin-bottom:15px; font-weight:bold; line-height:1.5;"></div>
    <div id="bankFeedback" style="color:var(--pink); font-size:11px; margin-bottom:10px; font-weight:900; display:none;"></div>
    <p id="endStats" style="font-size:18px; margin-bottom: 20px"></p>
    
    <button class="mainbtn" id="btnContinue">CONTINUE <span class="btn-sub">HIZLI / KIRILGAN</span></button>
    <button class="mainbtn" id="btnBank" style="background:var(--pink); color:#fff">BACKUP <span class="btn-sub">GÃœVENLÄ° / YAVAÅ</span></button>
    <button class="mainbtn" style="background:#222;color:#fff" id="btnExit">SAVE & EXIT</button>
  </div>
</div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = id => document.getElementById(id);
let lang="en", totalScore=0, setScore=0, integrity=100, momentum=1.0, wordList=[], currentIndex=0, busy=false, currentItem=null, runActive=false, autoProceedTimer=null;
let statsCats = { missed:{}, hit:{} };
let flowStreak = 0;

const SET_SIZE = 12;

function speak(text, targetLang) {
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = { en:"en-US", de:"de-DE", fr:"fr-FR", es:"es-ES", it:"it-IT" }[targetLang] || "en-US";
  u.rate = 0.95;
  window.speechSynthesis.speak(u);
}

function updateLeaderboardUI() {
    const records = JSON.parse(localStorage.getItem('glitch_eternal_v63') || '[]');
    const pb = records.filter(r => r.lang === lang.toUpperCase()).reduce((max, r) => Math.max(max, r.score), 0);
    $("pbBadge").textContent = `PB: ${pb}`;
    $('leaderboardBox').innerHTML = records.slice(0,3).map((r,i)=> `<div>${i+1}. ${r.score} - ${r.lang}</div>`).join('');
}

document.querySelectorAll(".lang-btn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".lang-btn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    lang=b.dataset.lang;
    updateLeaderboardUI();
  };
});

$("startBtn").onclick=async()=>{
  $("start").classList.add("hidden"); 
  $("game").style.display="flex";
  if(!runActive) { totalScore=0; integrity=100; momentum=1.0; runActive=true; statsCats={ missed:{}, hit:{} }; flowStreak=0; }
  await initGame();
};

async function initGame(isBank = false) {
  currentIndex=0; setScore=0;
  if(isBank) { integrity = 100; momentum = 1.0; }
  const pool = await loadLangPool(lang);
  const randomizedItems = [...pool.items].sort(() => Math.random() - 0.5);
  const USED_KEY = `used_glitch_v63_${lang}`; // âœ… FIX 1: Versiyon anahtarÄ± senkronize edildi
  const {used, save} = createUsedSet(USED_KEY);

  wordList = pick({items: randomizedItems}, SET_SIZE, used, save, (it) => it.sentence && it.sentence.length > 5);
  
  if(wordList.length < SET_SIZE) { 
    localStorage.removeItem(USED_KEY); // âœ… FIX 1: DoÄŸru anahtar siliniyor
    return initGame(); 
  }

  // âœ… FIX 2: Used mÃ¼hÃ¼rÃ¼ eklendi
  try { save(wordList.map(x => x.w)); await Promise.resolve(); } catch(e){}

  nextRound();
}

function produceGlitch(original) {
  const rules = [
    { cat: "Subject-Verb", f: " am ", t: " is ", s: false },
    { cat: "Subject-Verb", f: " are ", t: " is ", s: false },
    { cat: "Article", f: " a ", t: " an ", s: true },
    { cat: "Tense", f: " did ", t: " do ", s: true },
    { cat: "Pronoun", f: " me ", t: " I ", s: true }
  ];
  let text = original;
  const applicable = rules.filter(r => text.toLowerCase().includes(r.f));
  if (applicable.length > 0) {
    const rule = applicable[Math.floor(Math.random() * applicable.length)];
    return { text: text.replace(new RegExp(rule.f, "i"), rule.t), category: rule.cat, subtle: rule.s };
  }
  return { text: text + "s", category: "Syntax", subtle: true };
}

function nextRound() {
  if(currentIndex >= wordList.length || integrity <= 0) { finish(integrity <= 0); return; }
  const item = wordList[currentIndex];
  const isBoss = currentIndex >= 10;
  
  if(isBoss) { $("terminal").classList.add("boss-mode"); $("bossLabel").style.display = "block"; }
  else { $("terminal").classList.remove("boss-mode"); $("bossLabel").style.display = "none"; }

  // âœ… Alarm pulse sadece boÅŸta beklerken aktif, feedback sÄ±rasÄ±nda border-color ezilecek baÅŸkanÄ±m
  if(integrity <= 25) $("terminal").classList.add("alarm-active");
  else $("terminal").classList.remove("alarm-active");

  const isOk = Math.random() > 0.5;
  const glitch = isOk ? { text: item.sentence, category: "Verified", subtle: false } : produceGlitch(item.sentence);

  currentItem = { text: glitch.text, original: item.sentence, isOk, category: glitch.category, subtle: glitch.subtle, tr: item.tr || "Anlam yÃ¼klenemedi." };
  $("sentence").textContent = currentItem.text;
  $("correctionBox").style.opacity = "0";
  $("tapHint").style.display = "none";
  $("setCounter").textContent = `${currentIndex + 1}/12`;
  
  const p = ((momentum - 1.0) / 0.6) * 100;
  $("momBarFill").style.width = p + "%";
  if(momentum < 1.25) $("momBarFill").style.background = "var(--cyan)";
  else if(momentum < 1.45) $("momBarFill").style.background = "var(--purple)";
  else $("momBarFill").style.background = "var(--pink)";
  
  $("momVal").textContent = `x${momentum.toFixed(2)}`;
  $("life").textContent = integrity + "%";
  $("life").style.color = integrity <= 25 ? "var(--pink)" : "var(--cyan)";
  $("terminal").style.borderColor = "var(--border)";
  busy=false;
}

$("terminal").onclick = () => { if(busy && autoProceedTimer) { clearTimeout(autoProceedTimer); proceedNext(); } };

function handleAnswer(userPick) {
  if(busy) return;
  busy = true;
  const correct = (userPick === currentItem.isOk);
  const isBoss = currentIndex >= 10;

  // âœ… FIX 3 & 4: DoÄŸru olsa da oku ve anlamÄ± gÃ¶ster baÅŸkanÄ±m
  speak(currentItem.original, lang);
  
  if(correct) {
    flowStreak++;
    statsCats.hit[currentItem.category] = (statsCats.hit[currentItem.category] || 0) + 1;
    const points = isBoss ? 150 : 100;
    totalScore += Math.round(points * momentum);
    setScore += points;
    momentum = Math.min(1.6, momentum + 0.05);
    
    // DoÄŸruda alarmÄ± geÃ§ici durdur baÅŸkanÄ±m
    $("terminal").classList.remove("alarm-active");
    $("terminal").style.borderColor = "var(--green)";
    
    // âœ… Mini Meaning Display (Flow'u bozmadan anlamÄ± fÄ±sÄ±lda baÅŸkanÄ±m)
    if(isBoss) $("sentence").innerHTML = `<span style="color:var(--green)">BOSS CLEARED</span>`;
    else if(flowStreak % 3 === 0) $("sentence").innerHTML = `<span style="color:var(--cyan)">FLOW +</span>`;
    
    $("trTxt").textContent = "AnlamÄ±: " + currentItem.tr;
    $("correctTxt").textContent = ""; // Temizle
    $("correctionBox").style.opacity = "1";

    autoProceedTimer = setTimeout(proceedNext, 850); // HÄ±zlÄ± geÃ§iÅŸ
  } else {
    flowStreak = 0;
    statsCats.missed[currentItem.category] = (statsCats.missed[currentItem.category] || 0) + 1;
    const damage = (currentItem.subtle || isBoss) ? 15 : 25;
    integrity -= damage;
    momentum = Math.max(1.0, momentum - 0.15);
    
    $("terminal").classList.remove("alarm-active");
    $("frame").classList.add("glitch-anim");
    $("terminal").style.borderColor = "var(--pink)";
    
    $("correctTxt").textContent = (damage === 15 ? "âš  NEAR MISS / " : "âœ– CORRUPTED / ") + currentItem.original;
    $("trTxt").textContent = "AnlamÄ±: " + currentItem.tr;
    $("correctionBox").style.opacity = "1";
    $("tapHint").style.display = "block";

    autoProceedTimer = setTimeout(proceedNext, 4500);
  }
  $("scoreDisp").textContent = totalScore;
}

function proceedNext() {
    autoProceedTimer = null; currentIndex++;
    $("frame").classList.remove("glitch-anim");
    nextRound();
}

$("btnGlitch").onclick = () => handleAnswer(false);
$("btnStable").onclick = () => handleAnswer(true);

function finish(died) {
  const records = JSON.parse(localStorage.getItem('glitch_eternal_v63') || '[]');
  records.push({score: totalScore, lang: lang.toUpperCase(), id: Date.now()});
  records.sort((a,b)=>b.score - a.score);
  localStorage.setItem('glitch_eternal_v63', JSON.stringify(records.slice(0,10)));
  updateLeaderboardUI();
  
  const worst = Object.entries(statsCats.missed).sort((a,b)=>b[1]-a[1])[0];
  const best = Object.entries(statsCats.hit).filter(x=>x[0]!=="Verified").sort((a,b)=>b[1]-a[1])[0];
  
  let report = worst ? `BUGÃœN EN Ã‡OK ${worst[0].toUpperCase()} KAÃ‡IRDIN.` : "RADARIN KUSURSUZDU!";
  if(best) report += `<br><span style="color:var(--green)">EN GÃœÃ‡LÃœ ALANIN: ${best[0].toUpperCase()}</span>`;
  $("learningReport").innerHTML = report;
  $("bankFeedback").style.display = "none";

  $("end").classList.remove("hidden");
  $("endTitle").textContent = died ? "SYSTEM CRASHED" : "SYNC COMPLETE";
  $("endTitle").style.color = died ? "var(--pink)" : "var(--green)";
  $("endStats").innerHTML = `SCORE: <b>${totalScore}</b> | MOM: <b>x${momentum.toFixed(2)}</b>`;
  
  if(died) { $("btnContinue").classList.add("hidden"); $("btnBank").classList.add("hidden"); runActive = false; } 
  else { $("btnContinue").classList.remove("hidden"); $("btnBank").classList.remove("hidden"); }
}

$("btnContinue").onclick = () => { $("end").classList.add("hidden"); initGame(false); };
$("btnBank").onclick = () => { 
    const bonus = Math.round(setScore * 0.05);
    totalScore += bonus;
    // âœ… FIX 8: Bank geri bildirimi artÄ±k modal Ã¼zerinde baÅŸkanÄ±m
    $("bankFeedback").style.display = "block";
    $("bankFeedback").innerHTML = `CASHED IN: +${bonus} | MOMENTUM RESET`;
    
    momentum = 1.0; setScore = 0; flowStreak = 0;
    setTimeout(() => { $("end").classList.add("hidden"); initGame(true); }, 1600);
};
$("btnExit").onclick = () => location.reload();

window.onload = updateLeaderboardUI;
</script>
</body>
</html>
