<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>italkyAI ‚Ä¢ HANGMAN 3D PRO</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #02000a;
      --neon-blue: #00f3ff;
      --neon-purple: #a855f7;
      --neon-red: #ff0033;
      --neon-green: #00ff9d;
      --ai-grad: linear-gradient(135deg, #a5b4fc 0%, #6366f1 100%);
      --border: rgba(255,255,255,.12);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { margin: 0; background: var(--bg); color: #fff; font-family: 'Outfit', sans-serif; height: 100dvh; overflow: hidden; }

    .cosmos-bg{ position:absolute; inset:0; z-index:0; background: radial-gradient(circle at 50% 35%, #0b0b2a 0%, #020205 60%, #010104 100%); }

    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 50% { transform: translateX(3px); } }
    .gallows-box.shake { animation: shake .25s linear 2; }

    .wrap{ width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom); }

    .nav-top{ display:flex; align-items:center; justify-content:space-between; padding: 15px 18px; }
    .back-btn{ color:#fff; text-decoration:none; font-weight:900; font-size:18px; opacity:.9; }
    .status-chip { background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; border: 1px solid var(--border); letter-spacing: 1px; }
    .pb-chip { font-size: 10px; color: var(--neon-pink); font-weight: 800; text-align: right; margin-top: 4px; }
    .mini-badge{ display:flex; align-items:center; height: 38px; padding: 0 12px; border-radius: 16px; background: rgba(255,255,255,.05); border: 1px solid var(--border); font-weight: 800; font-size: 11px; }
    .game-card{ background: rgba(255,255,255,.03); border: 1px solid var(--border); border-radius: 28px; backdrop-filter: blur(15px); padding: 20px; margin: 0 14px; position:relative; box-shadow: 0 30px 60px rgba(0,0,0,.5); }

    .gallows-box{ position:relative; width:120px; height:140px; margin: 0 auto 15px; }
    .g-line{ position:absolute; background: #fff; }
    .g-stand{ bottom:0; left:20px; width:80px; height:2px; }
    .g-post{ bottom:0; left:30px; width:2px; height:130px; }
    .g-top{ top:10px; left:30px; width:60px; height:2px; }
    .g-rope{ position:absolute; top:10px; right:30px; width:1px; height:20px; background: var(--neon-purple); box-shadow: 0 0 10px var(--neon-purple); }

    .man-part{ position:absolute; background: var(--neon-purple); box-shadow: 0 0 12px var(--neon-purple); opacity:0; transition: opacity .3s; }
    .p1{ top:28px; right:17px; width:26px; height:26px; border: 3px solid var(--neon-purple); border-radius:50%; background:transparent; }
    .p2{ top:56px; right:30px; width:2px; height:32px; }
    .p3{ top:62px; right:32px; width:16px; height:2px; transform: rotate(-30deg); transform-origin:left; }
    .p4{ top:62px; right:14px; width:16px; height:2px; transform: rotate(30deg); transform-origin:right; }
    .p5{ top:86px; right:30px; width:18px; height:2px; transform: rotate(45deg); transform-origin:left; }
    .p6{ top:86px; right:12px; width:18px; height:2px; transform: rotate(-45deg); transform-origin:right; }

    .word-box{ display:flex; flex-wrap:wrap; justify-content:center; gap: 8px; margin: 25px 0; }
    .letter-slot{ width: 32px; height: 42px; border-bottom: 2px solid var(--neon-blue); display:flex; align-items:center; justify-content:center; font-size: 24px; font-weight: 900; }

    .keyboard{ display:grid; grid-template-columns: repeat(6, 1fr); gap: 6px; }
    .key-btn{ aspect-ratio:1; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,.1); border: 1px solid var(--border); border-radius: 12px; color: #fff; font-weight: 800; cursor:pointer; }
    .key-btn.correct{ background: var(--neon-green) !important; color:#000; border:none; }
    .key-btn.wrong{ opacity: 0.2; pointer-events:none; }

    .modal-wrap{ position:absolute; inset:0; background: rgba(0,0,0,.96); z-index:999; display:flex; align-items:center; justify-content:center; padding: 20px; }
    .modal-card{ width:100%; max-width:360px; background: #08080c; border: 1px solid var(--border); border-radius: 36px; padding: 30px; text-align:center; overflow-y:auto; max-height:90vh; }

    .lvl-btn { width:100%; display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-radius: 18px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: #fff; font-weight: 900; cursor: pointer; margin-top: 8px; }

    .lang-btn{ font-size: 24px; padding: 10px; border-radius: 16px; background: rgba(255,255,255,0.05); border: 1px solid transparent; cursor:pointer; margin: 4px; }
    .lang-btn.active{ border-color: var(--neon-blue); background: rgba(0,243,255,0.15); }

    .btn-main{ width:100%; padding: 18px; background: var(--neon-green); color:#000; border:none; border-radius: 20px; font-weight: 900; cursor:pointer; margin-top: 10px; }

    #resInfo { font-size: 12px; color: var(--neon-blue); text-align: center; min-height: 18px; margin-bottom: 5px; font-weight: 700; opacity: 0; transition: 0.3s; }

    #mic-btn-bonus { display:none; background: var(--neon-green); color: #000; border: none; padding: 15px 25px; border-radius: 50px; font-weight: 900; margin-top: 20px; cursor: pointer; animation: pulse2 1.5s infinite; }
    @keyframes pulse2 { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
  </style>
</head>

<body>
  <div class="cosmos-bg"></div>

  <div class="wrap">
    <div class="nav-top">
      <a href="/pages/game.html" class="back-btn">‚Üê</a>
      <div style="text-align: center;">
        <div id="statusChip" class="status-chip">EN ‚Ä¢ KOLAY</div>
      </div>
      <div style="display:flex; gap:8px;">
        <div class="mini-badge">PUAN <span id="scoreDisplay" style="color:var(--neon-green); margin-left:6px;">0</span></div>
      </div>
    </div>

    <div class="game-card">
      <div class="gallows-box" id="gallowsBox">
        <div class="g-line g-stand"></div><div class="g-line g-post"></div><div class="g-line g-top"></div><div class="g-rope"></div>
        <div class="man-part p1"></div><div class="man-part p2"></div><div class="man-part p3"></div>
        <div class="man-part p4"></div><div class="man-part p5"></div><div class="man-part p6"></div>
      </div>

      <div id="resInfo"></div>
      <div id="hintMain" style="text-align:center; color:var(--neon-green); font-weight:900; font-size:18px; margin-bottom: 10px;"></div>

      <div id="wordBox" class="word-box"></div>
      <div class="keyboard" id="keyboard"></div>

      <button class="btn-main" style="background:linear-gradient(135deg,#6366f1,#a5b4fc); color:#fff" id="jokerBtn">‚ö° ƒ∞PUCU (<span id="jokerCount">1</span>)</button>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <h2 style="margin:0 0 15px;">HANGMAN 3D PRO</h2>

      <div style="margin-bottom:16px;">
        <button data-lang="en" class="lang-btn active">üá¨üáß</button>
        <button data-lang="de" class="lang-btn">üá©üá™</button>
        <button data-lang="fr" class="lang-btn">üá´üá∑</button>
        <button data-lang="es" class="lang-btn">üá™üá∏</button>
        <button data-lang="it" class="lang-btn">üáÆüáπ</button>
      </div>

      <div style="margin-bottom:10px; font-size:12px; opacity:.7; font-weight:800;">ZORLUK</div>
      <button class="lvl-btn" data-lives="8"><span>üå± KOLAY</span> <span>8 HAK</span></button>
      <button class="lvl-btn" data-lives="5" style="border-color: #701a75"><span>üíÄ ZOR</span> <span>5 HAK</span></button>

      <div style="margin:18px 0 8px; font-size:12px; opacity:.7; font-weight:800;">OYUNCULAR</div>
      <div id="pInputs">
        <input type="text" class="neon-input p-in" placeholder="Oyuncu Adƒ±" value="Oƒüuz">
      </div>
      <button onclick="addInput()" style="background:none; border:1px dashed #555; color:#aaa; padding:12px; border-radius:12px; width:100%; cursor:pointer;">+ OYUNCU EKLE</button>

      <button class="btn-main" id="btnStart">BA≈ûLA</button>
    </div>
  </div>

  <div class="modal-wrap" id="endModal" style="display:none">
    <div class="modal-card">
      <h2 id="endTitle">TUR Bƒ∞TTƒ∞</h2>
      <div id="endStats" style="text-align:left; margin:20px 0; font-size:15px; line-height:2;"></div>

      <button id="mic-btn-bonus" onclick="startMicChallenge()">üé§ S√ñYLE VE +1 HAK KAZAN!</button>
      <p id="mic-feedback" style="font-size:12px; color:var(--neon-purple); margin-top:10px;"></p>

      <button class="btn-main" id="btnNext" style="background:linear-gradient(135deg,#6366f1,#a5b4fc); color:#fff">SIRADAKƒ∞ OYUNCU</button>
      <button class="btn-main" id="btnRestart" style="background:rgba(255,255,255,0.06); color:#fff; border:1px solid var(--border)">YENƒ∞ OYUN</button>
    </div>
  </div>

<script type="module">
  import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

  const $ = (id) => document.getElementById(id);

  let currentLang = "en";
  let pool = null;

  let players = [];
  let curIdx = 0;

  let maxMistakes = 8;
  let mistakes = 0;

  let target = null;        // {w,tr,...}
  let currentWord = "";     // normalized uppercase letters only
  let discovered = [];      // boolean array
  let jokers = 1;

  let totalScore = 0;
  let isBusy = false;

  let usedPack = null; // createUsedSet

  // AUDIO
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playSfx(freq, type, dur) {
    try{
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.06, audioCtx.currentTime);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + dur);
    }catch{}
  }

  function speak(text) {
    try{
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance(text);
      const langMap = { en: 'en-US', de: 'de-DE', fr: 'fr-FR', es: 'es-ES', it: 'it-IT' };
      msg.lang = langMap[currentLang] || 'en-US';
      msg.rate = 0.85;
      window.speechSynthesis.speak(msg);
    }catch{}
  }

  // UI setup
  window.addInput = () => {
    const i = document.createElement('input');
    i.className = 'neon-input p-in';
    i.placeholder = 'Oyuncu Adƒ±';
    document.getElementById('pInputs').appendChild(i);
  };

  document.querySelectorAll(".lang-btn").forEach(btn=>{
    btn.onclick = () => {
      currentLang = btn.dataset.lang;
      document.querySelectorAll(".lang-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      // label update
      $("statusChip").textContent = `${currentLang.toUpperCase()} ‚Ä¢ ${maxMistakes===8 ? "KOLAY" : "ZOR"}`;
    };
  });

  document.querySelectorAll(".lvl-btn").forEach(btn=>{
    btn.onclick = () => {
      maxMistakes = Number(btn.dataset.lives || 8);
      $("statusChip").textContent = `${currentLang.toUpperCase()} ‚Ä¢ ${maxMistakes===8 ? "KOLAY" : "ZOR"}`;
      document.querySelectorAll(".lvl-btn").forEach(b=>b.style.opacity=".6");
      btn.style.opacity="1";
    };
  });

  $("btnStart").onclick = async () => {
    players = [];
    document.querySelectorAll('.p-in').forEach(i => {
      const name = (i.value || "").trim();
      if(name) players.push({ n: name, s: 0, r: maxMistakes }); // r = remaining rights
    });
    if(!players.length) return alert("ƒ∞sim yaz ba≈ükanƒ±m!");

    // load supabase pool
    pool = await loadLangPool(currentLang);
    const items = Array.isArray(pool) ? pool : (pool?.items || []);
    if(!items.length) return alert("Dil havuzu bo≈ü / y√ºklenemedi!");

    usedPack = createUsedSet(`used_hangman3d_v1_${currentLang}`);

    totalScore = 0;
    curIdx = 0;
    jokers = 1;
    $("scoreDisplay").textContent = "0";

    $("startModal").style.display = "none";
    $("endModal").style.display = "none";

    startRound();
  };

  function sanitizeWord(w){
    return String(w||"")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toUpperCase()
      .replace(/[^A-Z]/g,"");
  }

  function startRound() {
    const p = players[curIdx];
    if(!p) return;

    if(p.r <= 0){
      // skip dead player
      nextPlayerOrEnd();
      return;
    }

    isBusy = false;
    mistakes = 0;
    $("gallowsBox").classList.remove("shake");
    $("resInfo").style.opacity = "0";

    const items = Array.isArray(pool) ? pool : (pool?.items || []);

    // pick 1 word from pool, filter length for nicer gameplay
    let picked = pick({ items }, 1, usedPack.used, usedPack.save, (it) => {
      const ww = String(it?.w || "");
      const clean = sanitizeWord(ww);
      return clean.length >= 4 && clean.length <= 10 && it.tr;
    });

    // fallback if exhausted
    if(!picked || !picked[0]){
      localStorage.removeItem(`used_hangman3d_v1_${currentLang}`);
      usedPack = createUsedSet(`used_hangman3d_v1_${currentLang}`);
      picked = pick({ items }, 1, usedPack.used, usedPack.save, (it) => {
        const ww = String(it?.w || "");
        const clean = sanitizeWord(ww);
        return clean.length >= 4 && clean.length <= 10 && it.tr;
      });
    }

    if(!picked || !picked[0]){ alert("Havuz t√ºkendi!"); location.reload(); return; }

    target = picked[0];
    const raw = String(target.w || "").trim();
    currentWord = sanitizeWord(raw);

    discovered = new Array(currentWord.length).fill(false);

    $("hintMain").textContent = target.tr || "";
    renderWord();
    renderDynamicKeyboard();

    updateUI();
  }

  function updateUI() {
    const p = players[curIdx];
    $("scoreDisplay").textContent = totalScore;
    $("jokerCount").textContent = jokers;

    // show hangman parts
    const parts = document.querySelectorAll(".man-part");
    parts.forEach((pp,i)=>pp.style.opacity = (i < Math.min(mistakes,6)) ? "1" : "0");

    // lives display = remaining attempts for this player
    // using top right only score; remaining shown in resInfo for clarity
    $("resInfo").textContent = `${p.n} ‚Ä¢ HAK: ${p.r}/${maxMistakes} ‚Ä¢ HATA: ${mistakes}/${maxMistakes}`;
    $("resInfo").style.opacity = "1";
  }

  function renderWord() {
    const box = $("wordBox");
    box.innerHTML = "";
    currentWord.split("").forEach((ch,i)=>{
      const d = document.createElement("div");
      d.className = "letter-slot";
      d.textContent = discovered[i] ? ch : "";
      box.appendChild(d);
    });
  }

  function renderDynamicKeyboard() {
    const kb = $("keyboard");
    kb.innerHTML = "";

    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const wordChars = [...new Set(currentWord.split(""))];

    const wrongChars = alphabet.split("").filter(c => !wordChars.includes(c))
      .sort(() => Math.random() - 0.5).slice(0, 14);

    const finalKeys = [...new Set([...wordChars, ...wrongChars])].slice(0, 18)
      .sort(() => Math.random() - 0.5);

    finalKeys.forEach(char=>{
      const b = document.createElement("button");
      b.className = "key-btn";
      b.textContent = char;
      b.onclick = () => handleGuess(char, b);
      kb.appendChild(b);
    });
  }

  function handleGuess(char, btn) {
    if(isBusy || !btn || btn.disabled) return;
    btn.disabled = true;

    if(currentWord.includes(char)) {
      playSfx(900, "sine", 0.09);
      btn.classList.add("correct");
      currentWord.split("").forEach((c,i)=>{ if(c===char) discovered[i]=true; });
      renderWord();

      if(discovered.every(v=>v)) {
        isBusy = true;
        const roundPoints = Math.max(5, (maxMistakes - mistakes)) * 5;
        totalScore += roundPoints;
        players[curIdx].s += roundPoints;
        speak(String(target.w||""));

        setTimeout(()=> {
          isBusy = false;
          showEndModal(true);
        }, 900);
      }
    } else {
      playSfx(150, "sawtooth", 0.18);
      btn.classList.add("wrong");
      mistakes++;
      if(mistakes >= Math.min(maxMistakes, 6)) $("gallowsBox").classList.add("shake");

      if(mistakes >= maxMistakes) {
        isBusy = true;
        players[curIdx].r--; // lose 1 life
        speak(String(target.w||""));
        setTimeout(()=> {
          isBusy = false;
          showEndModal(false);
        }, 900);
      }
    }

    updateUI();
  }

  $("jokerBtn").onclick = () => {
    if(jokers <= 0 || isBusy) return;
    const hidden = discovered.map((v,i)=>v? -1 : i).filter(i=>i!==-1);
    if(hidden.length === 0) return;

    jokers--;
    const idx = hidden[Math.floor(Math.random()*hidden.length)];
    const char = currentWord[idx];
    // trigger on keyboard if exists
    const key = document.querySelector(`#keyboard .key-btn:not([disabled])`);
    // reveal char directly
    currentWord.split("").forEach((c,i)=>{ if(c===char) discovered[i]=true; });
    renderWord();
    updateUI();

    // if complete
    if(discovered.every(v=>v)) {
      isBusy = true;
      const roundPoints = Math.max(5, (maxMistakes - mistakes)) * 5;
      totalScore += roundPoints;
      players[curIdx].s += roundPoints;
      speak(String(target.w||""));
      setTimeout(()=>{ isBusy=false; showEndModal(true); }, 900);
    }
  };

  function showEndModal(win){
    $("endModal").style.display = "flex";
    $("endTitle").textContent = win ? "Bƒ∞LDƒ∞N! üèÜ" : "OLMADI! üíÄ";
    $("endTitle").style.color = win ? "var(--neon-green)" : "var(--neon-red)";

    $("endStats").innerHTML = `
      Oyuncu: <b>${players[curIdx].n}</b><br>
      Kelime: <b>${String(target.w||"")}</b><br>
      Anlam: <b>${String(target.tr||"")}</b><br>
      Hak: <b>${players[curIdx].r}/${maxMistakes}</b><br>
      Puan: <b>${players[curIdx].s}</b>
    `;

    // mic bonus only if win and speech recognition exists
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    $("mic-btn-bonus").style.display = (win && !!SR) ? "block" : "none";
    $("mic-feedback").textContent = (win && !!SR) ? "Hadi telaffuz et, +1 hak al!" : "";
  }

  window.startMicChallenge = async () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return alert("Bu cihazda mikrofon challenge yok.");

    const btn = $("mic-btn-bonus");
    const feedback = $("mic-feedback");

    const rec = new SR();
    const langMap = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };
    rec.lang = langMap[currentLang] || 'en-US';
    rec.interimResults = false;
    rec.maxAlternatives = 1;

    btn.textContent = "Dinliyorum...";
    btn.disabled = true;

    rec.onresult = (e) => {
      const result = String(e.results?.[0]?.[0]?.transcript || "").trim().toUpperCase();
      const targetWord = sanitizeWord(target.w).toUpperCase();

      if(sanitizeWord(result) === targetWord) {
        players[curIdx].r++; // bonus life
        feedback.textContent = "MUHTE≈ûEM! +1 HAK üéà";
        feedback.style.color = "var(--neon-green)";
        playSfx(1100, "sine", 0.25);
      } else {
        feedback.textContent = `Duyduƒüum: ${result} (hedef: ${targetWord})`;
        feedback.style.color = "var(--neon-purple)";
      }

      btn.style.display = "none";
      updateUI();
    };

    rec.onerror = () => {
      feedback.textContent = "Sesini alamadƒ±m. Tekrar dene.";
      btn.textContent = "üé§ TEKRAR DENE";
      btn.disabled = false;
    };

    rec.start();
  };

  $("btnNext").onclick = () => {
    $("endModal").style.display = "none";
    nextPlayerOrEnd();
  };

  $("btnRestart").onclick = () => location.reload();

  function nextPlayerOrEnd(){
    // if all players dead -> finish
    const alive = players.some(p => p.r > 0);
    if(!alive){
      alert("OYUN Bƒ∞TTƒ∞! üî• Toplam Puan: " + totalScore);
      location.reload();
      return;
    }
    // next alive player
    let tries = 0;
    do {
      curIdx = (curIdx + 1) % players.length;
      tries++;
      if(tries > players.length+2) break;
    } while(players[curIdx].r <= 0);

    startRound();
  }
</script>
</body>
</html>
