<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ITALKY • Hangman</title>
  <link rel="icon" href="data:,"/>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    /* --- TEMEL --- */
    :root {
      --bg-deep: #020205; 
      --text-main: #ffffff;
      --c-neon: #ff0055; /* Tehlike Rengi (Neon Kırmızı) */
      --c-safe: #00f3ff; /* Güvenli */
      --border: rgba(255, 255, 255, 0.1);
    }

    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; user-select:none; }
    html, body { margin:0; height:100dvh; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:var(--text-main); }

    .cosmos-bg { position:absolute; inset:0; background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%); z-index:0; }
    .star-dust { position: absolute; inset: 0; opacity: 0.3; background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 50px 50px; animation: dustMove 100s linear infinite; }
    @keyframes dustMove { from { transform: translateY(0); } to { transform: translateY(-500px); } }

    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; }

    /* NAV */
    .nav-layer { height:70px; padding:12px; display:flex; justify-content:space-between; align-items:center; }
    .nav-btn { height:40px; padding:0 14px; border-radius:12px; background:rgba(255,255,255,0.1); border:1px solid var(--border); color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:700; }
    .score-box { font-family:'Space Grotesk', sans-serif; font-size:18px; color:var(--c-safe); text-shadow:0 0 10px rgba(0,243,255,0.5); }

    /* OYUN ALANI */
    .stage { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding-top:10px; position:relative; }

    /* DAR AĞACI (SVG) */
    .hangman-draw {
      width: 180px; height: 180px;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 5px var(--c-neon));
    }
    .hangman-draw path, .hangman-draw line, .hangman-draw circle {
      fill: none; stroke: var(--c-neon); stroke-width: 4; stroke-linecap: round;
      opacity: 0; transition: opacity 0.3s; /* Başlangıçta gizli */
    }
    .hangman-draw .base { stroke: #555; opacity: 1; } /* Taban hep görünür */

    /* SORU ALANI */
    .word-container {
      display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; justify-content: center;
    }
    .letter-slot {
      width: 40px; height: 50px;
      border-bottom: 3px solid #fff;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px; font-weight: 800;
      text-align: center; line-height: 50px;
      text-transform: uppercase;
      color: #fff;
      transition: 0.3s;
    }
    .letter-slot.filled { border-bottom-color: var(--c-safe); color: var(--c-safe); animation: popIn 0.3s; }
    .letter-slot.missed { border-bottom-color: var(--c-neon); color: var(--c-neon); }

    .translation-box {
      font-size: 18px; color: rgba(255,255,255,0.6); font-weight: 500;
      background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 20px;
      margin-bottom: 20px;
    }

    /* KLAVYE ALANI (KARIŞIK HARFLER) */
    .keyboard-area {
      padding: 20px;
      display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;
      justify-items: center;
    }
    .key-btn {
      width: 50px; height: 50px; border-radius: 12px;
      background: rgba(255,255,255,0.1); border: 1px solid var(--border);
      color: #fff; font-size: 20px; font-weight: 700;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.5);
    }
    .key-btn:active { transform: translateY(4px); box-shadow: none; }
    .key-btn.used { opacity: 0.3; pointer-events: none; background: #000; border-color: transparent; box-shadow: none; transform: translateY(4px); }
    .key-btn.wrong { background: var(--c-neon); border-color: var(--c-neon); box-shadow: 0 0 15px var(--c-neon); }
    .key-btn.correct { background: var(--c-safe); border-color: var(--c-safe); color: #000; box-shadow: 0 0 15px var(--c-safe); }

    /* MODAL */
    .modal-wrap { position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(15px); }
    .modal-card { width:85%; background:#101014; border:1px solid var(--border); border-radius:24px; padding:24px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.8); animation: popIn 0.5s; }
    .modal-title { font-size:24px; font-weight:800; margin-bottom:12px; color: var(--c-neon); font-family:'Space Grotesk', sans-serif; }
    .btn-primary { width:100%; padding:16px; border-radius:16px; border:none; background:linear-gradient(135deg, #ff0055, #ff5500); color:#fff; font-weight:800; font-size:16px; cursor:pointer; }
    
    .loader { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--c-neon); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }

  </style>
</head>
<body>

  <div class="cosmos-bg"><div class="star-dust"></div></div>

  <div class="wrap">
    <div class="nav-layer">
      <button class="nav-btn" onclick="location.href='/pages/game.html'">←</button>
      <div class="brand-mini" style="font-weight:800; opacity:0.8">HANGMAN</div>
      <div class="score-box" id="scoreDisplay">0</div>
    </div>

    <div class="stage">
      <svg class="hangman-draw" viewBox="0 0 100 100">
        <line x1="10" y1="95" x2="90" y2="95" class="base" />
        <line x1="50" y1="95" x2="50" y2="5" class="part p1" /> <line x1="50" y1="5" x2="80" y2="5" class="part p2" /> <line x1="80" y1="5" x2="80" y2="20" class="part p3" /> <circle cx="80" cy="30" r="10" class="part p4" /> <line x1="80" y1="40" x2="80" y2="70" class="part p5" /> <line x1="80" y1="50" x2="65" y2="60" class="part p6" /> <line x1="80" y1="50" x2="95" y2="60" class="part p7" /> <line x1="80" y1="70" x2="65" y2="85" class="part p8" /> <line x1="80" y1="70" x2="95" y2="85" class="part p9" /> </svg>

      <div class="translation-box" id="hintBox">Yükleniyor...</div>

      <div class="word-container" id="wordBox"></div>
    </div>

    <div class="keyboard-area" id="keyboard"></div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <div class="modal-title">ADAM ASMACA ☠️</div>
      <div class="modal-p" style="opacity:0.7; margin-bottom:20px;">
        Türkçesi verilen kelimenin İngilizcesini yaz.<br>
        9 Hakkın var. Bilemezsen AI öğretir.
      </div>
      <div id="loading" style="display:none;margin-bottom:20px"><div class="loader"></div><div>Kelimeler Hazırlanıyor...</div></div>
      <button class="btn-primary" id="startBtn">OYUNA BAŞLA</button>
    </div>
  </div>

<script type="module">
import { BASE_DOMAIN } from "/js/config.js";
const $ = (id) => document.getElementById(id);
const apiBase = () => String(BASE_DOMAIN || "").replace(/\/+$/, "");

// SESLER
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const SFX = {
  click: () => {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.frequency.value = 800; o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.05, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
    o.start(); o.stop(audioCtx.currentTime + 0.1);
  },
  win: () => {
    // Pozitif Melodi
    [523, 659, 783, 1046].forEach((f, i) => {
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.frequency.value = f; o.connect(g); g.connect(audioCtx.destination);
      g.gain.setValueAtTime(0.05, audioCtx.currentTime + i*0.1); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i*0.1 + 0.3);
      o.start(audioCtx.currentTime + i*0.1); o.stop(audioCtx.currentTime + i*0.1 + 0.3);
    });
  },
  fail: () => {
    // Düşük Ton
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = 'sawtooth'; o.frequency.value = 100; o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
    o.start(); o.stop(audioCtx.currentTime + 0.5);
  }
};

let wordList = [];
let currentIndex = 0;
let currentWord = "";
let mistakes = 0;
let discovered = []; // Bulunan harflerin indexleri
let score = 0;
const MAX_ERRORS = 9;

// --- API ---
async function fetchWords() {
  $("loading").style.display = "block"; $("startBtn").style.display = "none";
  try {
    const prompt = `
      Bana İngilizce A2-B1 seviyesinde 10 adet isim veya fiil ver (Maksimum 7-8 harfli olsun).
      Türkçe karşılıklarını da yaz.
      JSON formatı: [["apple", "Elma"], ["run", "Koşmak"], ...]
    `;
    const res = await fetch(`${apiBase()}/api/chat`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: prompt, max_tokens: 1000 })
    });
    const data = await res.json();
    let raw = data.text.replace(/```json/g, "").replace(/```/g, "").trim();
    wordList = JSON.parse(raw);
    
    if(!Array.isArray(wordList)) throw 1;
    $("startModal").style.display = "none";
    startLevel();
  } catch(e) {
    wordList = [["Galaxy", "Galaksi"], ["Planet", "Gezegen"], ["Star", "Yıldız"]];
    $("startModal").style.display = "none";
    startLevel();
  }
}

// --- LEVEL BAŞLAT ---
function startLevel() {
  if(currentIndex >= wordList.length) {
    alert("Oyun Bitti! Skor: " + score);
    location.reload();
    return;
  }

  currentWord = wordList[currentIndex][0].toUpperCase();
  const trMean = wordList[currentIndex][1];
  
  mistakes = 0;
  discovered = new Array(currentWord.length).fill(false);
  
  // UI Sıfırla
  $("hintBox").textContent = trMean; // Türkçesini göster
  renderWord();
  renderHangman();
  generateKeyboard();
}

// --- KELİMEYİ ÇİZ ---
function renderWord() {
  const container = $("wordBox");
  container.innerHTML = "";
  for(let i=0; i<currentWord.length; i++) {
    const span = document.createElement("div");
    span.className = "letter-slot " + (discovered[i] ? "filled" : "");
    span.textContent = discovered[i] ? currentWord[i] : "_";
    container.appendChild(span);
  }
}

// --- KLAVYE OLUŞTUR (12-14 HARF) ---
function generateKeyboard() {
  const kb = $("keyboard");
  kb.innerHTML = "";
  
  // Doğru harfler
  let pool = currentWord.split("");
  // Yanlış harfler (A-Z arasından rastgele)
  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  while(pool.length < 14) {
    const rnd = alphabet[Math.floor(Math.random() * alphabet.length)];
    if(!pool.includes(rnd)) pool.push(rnd);
  }
  
  // Karıştır
  pool.sort(() => Math.random() - 0.5);
  
  pool.forEach(char => {
    const btn = document.createElement("div");
    btn.className = "key-btn";
    btn.textContent = char;
    btn.onclick = () => handleGuess(char, btn);
    kb.appendChild(btn);
  });
}

// --- TAHMİN MANTIĞI ---
function handleGuess(char, btnElement) {
  if(btnElement.classList.contains("used")) return;
  SFX.click();
  btnElement.classList.add("used");

  if(currentWord.includes(char)) {
    // DOĞRU
    btnElement.classList.add("correct");
    let foundCount = 0;
    for(let i=0; i<currentWord.length; i++) {
      if(currentWord[i] === char) discovered[i] = true;
      if(discovered[i]) foundCount++;
    }
    renderWord();
    
    // KAZANDI MI?
    if(foundCount === currentWord.length) {
      SFX.win();
      score += 10;
      $("scoreDisplay").textContent = score;
      setTimeout(() => {
        currentIndex++;
        startLevel();
      }, 1500);
    }
  } else {
    // YANLIŞ
    btnElement.classList.add("wrong");
    mistakes++;
    renderHangman();
    
    // KAYBETTİ Mİ?
    if(mistakes >= MAX_ERRORS) {
      SFX.fail();
      teacherSolve();
    }
  }
}

// --- ADAM ASMACA ÇİZİMİ ---
function renderHangman() {
  // Önce hepsini gizle (Base hariç)
  for(let i=1; i<=9; i++) {
    const el = document.querySelector(`.p${i}`);
    if(el) el.style.opacity = (i <= mistakes) ? 1 : 0;
  }
}

// --- ÖĞRETMEN MÜDAHALESİ ---
function teacherSolve() {
  // Harfleri doldur
  const slots = document.querySelectorAll(".letter-slot");
  for(let i=0; i<currentWord.length; i++) {
    if(!discovered[i]) {
      slots[i].textContent = currentWord[i];
      slots[i].classList.add("missed"); // Kırmızı renk
    }
  }
  
  // Sesli Oku: "Doğrusu Apple"
  const msg = `Correct answer is ${currentWord}`;
  const u = new SpeechSynthesisUtterance(msg);
  u.lang = "en-US";
  u.rate = 0.9;
  
  u.onend = () => {
    setTimeout(() => {
      currentIndex++;
      startLevel();
    }, 1000);
  };
  
  window.speechSynthesis.speak(u);
}

$("startBtn").onclick = fetchWords;

</script>
</body>
</html>
