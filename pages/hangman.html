<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = (id) => document.getElementById(id);
let currentLang = "en", currentDiff = "A2", wordList = [], currentIndex = 0;
let mistakes = 0, lives = 3, currentWord = "", currentRaw = "", discovered = [], jokers = 1, totalScore = 0;

function speak(text) {
  window.speechSynthesis.cancel();
  const msg = new SpeechSynthesisUtterance(text);
  const langMap = { en: 'en-US', de: 'de-DE', fr: 'fr-FR', es: 'es-ES', it: 'it-IT' };
  msg.lang = langMap[currentLang];
  msg.rate = 0.8;
  window.speechSynthesis.speak(msg);
}

window.setLang = (lang, btn) => {
  currentLang = lang;
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
};

window.selectLevel = (diff) => { currentDiff = diff; initGame(); };

async function initGame() {
  try {
    // 1. Havuzu yükle
    const rawPool = await loadLangPool(currentLang);
    
    // 2. ✅ HAVUZU ÖNCE KARIŞTIR: Her seferinde farklı sıra için
    const shuffledPool = rawPool.sort(() => Math.random() - 0.5);

    // 3. ✅ BENZERSİZ KULLANIM TAKİBİ: Bu dile ve seviyeye özel kayıt
    const { used, save } = createUsedSet(`used_hangman_v2_${currentLang}_${currentDiff}`);
    
    const cfg = { A2: { min:3, max:6 }, B1: { min:6, max:9 }, B2: { min:9, max:15 } }[currentDiff];

    // 4. Kelimeleri seç
    wordList = pick(shuffledPool, 25, used, save, (it) => {
      const itLvl = String(it.lvl || "").toUpperCase();
      const target = currentDiff.toUpperCase();
      const match = (target === "A2") ? ["A1","A2"].includes(itLvl) : itLvl === target;
      return match && it.w.length >= cfg.min && it.w.length <= cfg.max;
    });

    if (wordList.length === 0) {
        alert("Bu seviyede tüm kelimeleri bitirdiniz başkanım!");
        return;
    }

    $("startModal").style.display = "none";
    startRound();
  } catch (e) { alert("Sistem yüklenemedi."); }
}

function startRound() {
  if(currentIndex >= wordList.length || lives <= 0) return;
  const data = wordList[currentIndex];
  currentRaw = data.w;
  // ✅ Aksanlı harfleri temizle (Normalizasyon)
  currentWord = data.w.trim()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toUpperCase()
    .replace(/[^A-Z]/g, "");
    
  mistakes = 0;
  discovered = new Array(currentWord.length).fill(false);
  
  $("gallowsBox").classList.remove("shake");
  $("hintMain").textContent = data.tr;
  renderWord(); 
  renderDynamicKeyboard();
  renderHangman(); 
  updateUI();
}

// ... (Kalan handleGuess, renderWord, renderHangman ve updateUI fonksiyonları aynı) ...
</script>
