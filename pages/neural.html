<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ITALKY â€¢ Neural Match â€” Grand Master</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#05000a; --panel:rgba(20,0,30,.92); --pink:#ff00ff; --cyan:#00f3ff;
  --purple:#bd00ff; --green:#00e676; --red:#ff1744; --border:rgba(189,0,255,.3); --text:#fff;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{margin:0;width:100%;height:100%;background:var(--bg);font-family:Outfit,sans-serif;overflow:hidden;color:var(--text)}
.bg{position:absolute;inset:0;background:radial-gradient(circle at center,#1a002b 0%,#000 100%)}
.grid-bg{position:absolute;inset:0;background-image:linear-gradient(rgba(189,0,255,.1) 1px,transparent 1px),linear-gradient(90deg,rgba(189,0,255,.1) 1px,transparent 1px);background-size:40px 40px;opacity:.4}

.app{position:relative;max-width:480px;height:100%;margin:0 auto;border:1px solid var(--border);background:var(--panel);display:flex;flex-direction:column;z-index:5}
@media(min-width:520px){.app{height:92vh;border-radius:32px;margin-top:4vh}}

.header{height:70px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid var(--border)}
.title{font-family:Space Grotesk;font-weight:900;color:var(--pink);letter-spacing:1px;text-shadow:0 0 12px var(--pink)}
.pb-badge{font-size:10px;padding:4px 8px;border-radius:6px;background:var(--purple);color:#fff;font-weight:800}
.momentum-chip { font-size: 11px; background: var(--pink); color: #000; padding: 4px 10px; border-radius: 12px; font-weight: 900; box-shadow: 0 0 10px var(--pink); transition: 0.3s; }
.stats{display:flex;justify-content:space-between;padding:10px 16px;font-family:Space Grotesk;color:var(--cyan);border-bottom:1px dashed var(--border)}
.stats span b{color:#fff}

.game{flex:1;padding:12px;display:none;flex-direction:column}
.grid-cards{display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(4,1fr);gap:10px;flex:1}

.card{perspective:1000px;cursor:pointer}
.inner{width:100%;height:100%;transition:transform .4s;transform-style:preserve-3d;border-radius:14px}
.card.flipped .inner{transform:rotateY(180deg)}
.card.matched .inner{transform:rotateY(180deg);box-shadow:0 0 18px var(--green); animation: pulse 0.4s ease-out;}
@keyframes pulse { 0% { transform: rotateY(180deg) scale(1); } 50% { transform: rotateY(180deg) scale(1.05); } 100% { transform: rotateY(180deg) scale(1); } }

.face{position:absolute;inset:0;border-radius:14px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);backface-visibility:hidden}
.front{background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.01));color:var(--purple);font-size:22px}
.front::after{content:"ðŸ§ ";opacity:.5}
.back{background:rgba(30,0,50,.95);transform:rotateY(180deg);font-weight:800;font-size:11px;text-align:center;padding:6px;word-break:break-word}
.back.tr { color: var(--green); }
.back.fx { color: #fff; }

.modal{position:absolute;inset:0;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;z-index:20}
.card-modal{background:#10051a;border:1px solid var(--pink);border-radius:24px;padding:26px;text-align:center;width:85%;box-shadow:0 0 50px rgba(255,0,255,.25)}
.langs{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:16px 0}
.lang{padding:10px;border-radius:10px;border:1px solid var(--border);cursor:pointer;font-weight:900;font-size:12px}
.lang.active{background:var(--pink);color:#000}

.btn{width:100%;padding:14px;border:none;border-radius:14px;font-weight:900;margin-top:12px;background:var(--pink);color:#000;cursor:pointer;transition: 0.2s;}
.btn:disabled{opacity:0.3;cursor:default}
.btn.sec{background:transparent;border:1px solid #fff;color:#fff}
.hidden{display:none!important}

#resInfo { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); z-index: 10; padding: 10px 20px; background: var(--purple); color: #fff; border-radius: 24px; font-size: 13px; font-weight: 800; opacity: 0; transition: 0.3s; pointer-events: none; white-space: nowrap; box-shadow: 0 0 20px var(--purple); }
</style>
</head>

<body>
<div class="bg"></div>
<div class="grid-bg"></div>

<div class="app">
  <div class="header">
    <div class="title">NEURAL MATCH</div>
    <div id="pbBadge" class="pb-badge">PB: 0</div>
    <div id="momChip" class="momentum-chip">x1.00</div>
    <div id="soundBtn" style="cursor:pointer">ðŸ”Š</div>
  </div>

  <div class="stats">
    <span>HAMLE: <b id="moveVal">0</b></span>
    <span>SKOR: <b id="scoreVal">0</b></span>
    <span>EÅžLEÅžME: <b id="matchVal">0</b>/8</span>
  </div>

  <div id="resInfo">BAÅžARI!</div>

  <div class="game" id="game">
    <div class="grid-cards" id="grid"></div>
  </div>
</div>

<div class="modal" id="start">
  <div class="card-modal">
    <h2 style="color:var(--cyan);margin:0;font-family:Space Grotesk">NEURAL LINK</h2>
    <p style="opacity:.7;font-size:13px;margin:10px 0">HatasÄ±z eÅŸleÅŸme ile momentum kazan.</p>
    <div class="langs">
      <div class="lang active" data-lang="en">EN</div>
      <div class="lang" data-lang="de">DE</div>
      <div class="lang" data-lang="fr">FR</div>
      <div class="lang" data-lang="es">ES</div>
      <div class="lang" data-lang="it">IT</div>
    </div>
    <button class="btn" id="startBtn">BAÅžLA</button>
  </div>
</div>

<div class="modal hidden" id="end">
  <div class="card-modal">
    <h2 id="endTitle" style="color:var(--green);margin:0">SET TAMAMLANDI</h2>
    <p style="margin:12px 0">
      Toplam Skor: <b id="finalScore"></b><br>
      Set HatasÄ±: <b id="finalWrong"></b>
    </p>
    <button class="btn" id="btnContinue">DEVAM ET (MOMENTUM KORU)</button>
    <button class="btn" id="btnBank" style="background:var(--cyan)">BANKALA (<span id="bankBonusText">0</span> PUAN)</button>
    <button class="btn sec" id="btnFinish">BÄ°TÄ°R VE KAYDET</button>
  </div>
</div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = id => document.getElementById(id);

/* =========================
   GAMEKIT MIN (ONLY GATING)
   ========================= */
const DAILY_FREE_TOKENS = 25;

function isoDateLocal(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function getUser(){ try{ return JSON.parse(localStorage.getItem("italky_user_v1")||"{}"); }catch{ return {}; } }
function isPro(u){
  const p = String(u?.plan||"").toUpperCase().trim();
  return p==="PRO" || p==="PREMIUM" || p==="PLUS";
}
function uid(u){ return String(u.user_id||u.id||u.email||"guest").toLowerCase().trim(); }
function tokenKey(u){ return `italky_game_tokens::${uid(u)}::${isoDateLocal()}`; }
function tokenInitKey(u){ return `italky_game_tokens_init::${uid(u)}::${isoDateLocal()}`; }

function ensureDailyTokens(){
  const u=getUser();
  if(isPro(u)) return;
  if(localStorage.getItem(tokenInitKey(u))) return;
  localStorage.setItem(tokenKey(u), String(DAILY_FREE_TOKENS));
  localStorage.setItem(tokenInitKey(u), "1");
}
function getTokens(){
  const u=getUser();
  if(isPro(u)) return 9999;
  const v = Number(localStorage.getItem(tokenKey(u))||"0");
  return Number.isFinite(v) ? Math.max(0,v) : 0;
}
function spendToken(){
  const u=getUser();
  if(isPro(u)) return true;
  const t=getTokens();
  if(t<=0) return false;
  localStorage.setItem(tokenKey(u), String(t-1));
  return true;
}
/* ========================= */

let lang = "en";
let cards = [], flipped = [], matched = 0, moves = 0, wrongMoves = 0, locked = false;
let totalScore = 0, setScore = 0, momentum = 1.0;
let muted = false;

const LANGMAP = {en:"en-US", de:"de-DE", fr:"fr-FR", es:"es-ES", it:"it-IT"};

function shuffle(a) {
  const arr = [...a];
  for(let i=arr.length-1; i>0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function toastRes(msg, color = 'var(--purple)'){
  $("resInfo").textContent = msg;
  $("resInfo").style.background = color;
  $("resInfo").style.opacity = "1";
  clearTimeout(window.__resTo);
  window.__resTo = setTimeout(() => $("resInfo").style.opacity = "0", 1800);
}

function updatePBDisplay() {
  const pb = localStorage.getItem(`neural_pb_${lang}`) || 0;
  $("pbBadge").textContent = `PB (${lang.toUpperCase()}): ${pb}`;
}

document.querySelectorAll(".lang").forEach(b => {
  b.onclick = () => {
    document.querySelectorAll(".lang").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    lang = b.dataset.lang;
    updatePBDisplay();
  };
});

$("soundBtn").onclick = () => {
  muted = !muted;
  $("soundBtn").textContent = muted ? "ðŸ”‡" : "ðŸ”Š";
};

$("startBtn").onclick = async () => {
  // âœ… spend on ENTER
  ensureDailyTokens();
  const u=getUser();
  if(!isPro(u) && !spendToken()){
    alert("HakkÄ±n bitti. Hak kazan veya PROâ€™ya geÃ§.");
    location.href="/pages/game.html";
    return;
  }

  $("start").classList.add("hidden");
  $("game").style.display = "flex";
  totalScore = 0;
  momentum = 1.0;
  await initGame(true);
};

async function initGame(isNewRun = false) {
  $("btnContinue").disabled = false;
  $("btnBank").disabled = false;
  matched = 0; moves = 0; wrongMoves = 0; flipped = []; locked = false; setScore = 0;

  if (isNewRun) {
    totalScore = 0;
    momentum = 1.0;
  }

  updateStats();

  const pool = await loadLangPool(lang);
  const randomizedItems = shuffle([...pool.items]);
  const USED_KEY = `used_neural_v3_${lang}`;
  const {used, save} = createUsedSet(USED_KEY);

  let picked = pick({items: randomizedItems}, 8, used, save);

  if (picked.length < 8) {
    localStorage.removeItem(USED_KEY);
    return initGame(isNewRun);
  }

  try { save(picked.map(x => x.w)); } catch(e){}

  cards = [];
  picked.forEach((it, i) => {
    cards.push({pair: i, text: it.w, lang: lang});
    cards.push({pair: i, text: it.tr, lang: "tr"});
  });
  cards = shuffle(cards);
  render();
}

function render() {
  const g = $("grid"); g.innerHTML = "";
  cards.forEach((c, i) => {
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div class="inner">
        <div class="face front"></div>
        <div class="face back ${c.lang === "tr" ? "tr" : "fx"}">${c.text}</div>
      </div>`;
    el.onclick = () => clickCard(i, el);
    g.appendChild(el);
  });
}

function clickCard(i, el) {
  if (locked || el.classList.contains("flipped") || el.classList.contains("matched")) return;
  el.classList.add("flipped");
  flipped.push({i, data: cards[i], el});
  if (flipped.length === 2) { moves++; updateStats(); check(); }
}

function check() {
  locked = true;
  const [a, b] = flipped;
  if (a.data.pair === b.data.pair) {
    play("match");
    const speakCard = a.data.lang !== "tr" ? a.data : b.data;
    speak(speakCard.text, speakCard.lang);

    setTimeout(() => {
      a.el.classList.add("matched");
      b.el.classList.add("matched");
      matched++;
      const roundPoints = Math.round(Math.max(10, 60 - (wrongMoves * 6)) * momentum);
      setScore += roundPoints;
      totalScore += roundPoints;
      flipped = []; locked = false; updateStats();
      if (matched === 8) finish();
    }, 500);
  } else {
    play("error");
    wrongMoves++;
    momentum = Math.max(1.0, momentum - 0.10);
    updateStats();
    setTimeout(() => {
      a.el.classList.remove("flipped");
      b.el.classList.remove("flipped");
      flipped = []; locked = false;
    }, 800);
  }
}

function updateStats() {
  $("moveVal").textContent = moves;
  $("matchVal").textContent = matched;
  $("scoreVal").textContent = totalScore;
  $("momChip").textContent = `x${momentum.toFixed(2)}`;
}

function saveRecord() {
  const currentPB = parseInt(localStorage.getItem(`neural_pb_${lang}`) || 0);
  if (totalScore > currentPB) {
    localStorage.setItem(`neural_pb_${lang}`, totalScore);
    return true;
  }
  return false;
}

function finish() {
  play("win");
  const isPB = saveRecord();
  $("endTitle").textContent = isPB ? "YENÄ° REKOR! ðŸ‘‘" : "SET TAMAMLANDI";
  $("finalWrong").textContent = wrongMoves;
  $("finalScore").textContent = totalScore;

  $("bankBonusText").textContent = `+${Math.round(setScore * 0.05)}`;

  $("end").classList.remove("hidden");
  updatePBDisplay();
}

/* âœ… spend on CONTINUE */
$("btnContinue").onclick = () => {
  ensureDailyTokens();
  const u=getUser();
  if(!isPro(u) && !spendToken()){
    alert("HakkÄ±n bitti. Hak kazan veya PROâ€™ya geÃ§.");
    location.href="/pages/game.html";
    return;
  }

  $("btnContinue").disabled = true; $("btnBank").disabled = true;
  momentum = Math.min(1.6, momentum + 0.10);
  toastRes(`MOMENTUM: x${momentum.toFixed(2)} ðŸš€`, 'var(--purple)');
  $("end").classList.add("hidden");
  initGame(false);
};

/* âœ… spend on BANK */
$("btnBank").onclick = () => {
  ensureDailyTokens();
  const u=getUser();
  if(!isPro(u) && !spendToken()){
    alert("HakkÄ±n bitti. Hak kazan veya PROâ€™ya geÃ§.");
    location.href="/pages/game.html";
    return;
  }

  $("btnContinue").disabled = true; $("btnBank").disabled = true;
  const bonus = Math.round(setScore * 0.05);
  totalScore += bonus;
  momentum = 1.0;
  toastRes(`BANKA +${bonus} ðŸ’°`, 'var(--green)');
  $("end").classList.add("hidden");
  initGame(false);
};

$("btnFinish").onclick = () => {
  saveRecord();
  location.reload();
};

let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function play(t) {
  if (muted) return;
  if (audioCtx.state === "suspended") audioCtx.resume();
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  const now = audioCtx.currentTime;
  if (t === "match") { o.frequency.value = 600; g.gain.value = .08; o.start(now); o.stop(now + .25); }
  if (t === "error") { o.frequency.value = 140; g.gain.value = .1; o.start(now); o.stop(now + .2); }
  if (t === "win") { o.frequency.value = 800; g.gain.value = .1; o.start(now); o.stop(now + .6); }
}

function speak(txt, l) {
  if (muted) return;
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = l === "tr" ? "tr-TR" : LANGMAP[l] || "en-US";
  u.rate = 0.85;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

window.addEventListener('load', updatePBDisplay);
</script>
</body>
</html>
