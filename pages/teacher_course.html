<!-- FILE: /pages/teacher_course.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>italkyAI • Ders</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">

<style>
#pageContent{height:100%;overflow:hidden;}
.wrap{height:100%;padding:12px;display:flex;flex-direction:column;gap:12px;}

.top{display:flex;justify-content:space-between;}
.chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);font-weight:900;font-size:12px;color:#a5b4fc;}

.card{flex:1;border-radius:28px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03);backdrop-filter:blur(20px);padding:16px;display:flex;flex-direction:column;gap:12px;}

.chat{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;}
.bubble{max-width:90%;padding:10px 12px;border-radius:18px;border:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.2);}
.me{align-self:flex-end;background:rgba(99,102,241,.2);}
.teacher{align-self:flex-start;}
.bTop{font-size:12px;font-weight:900;margin-bottom:6px;}
.bTxt{font-size:13px;font-weight:900;white-space:pre-wrap;}
.bTr{margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.1);font-size:12px;color:rgba(255,255,255,.7);white-space:pre-wrap;}

.task{padding:10px;border-radius:18px;border:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.18);}
.inp{width:100%;height:46px;border-radius:14px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);color:#fff;padding:0 10px;font-weight:900;}

.btnRow{display:flex;gap:10px;}
.btn{flex:1;height:50px;border-radius:18px;border:none;font-weight:900;cursor:pointer;background:linear-gradient(135deg,#a5b4fc,#4f46e5);color:#fff;}
.ghost{flex:1;height:50px;border-radius:18px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#fff;font-weight:900;}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;padding:16px;z-index:999999;}
.overlay.show{display:flex;}
.modal{background:rgba(10,10,18,.95);border:1px solid rgba(255,255,255,.15);border-radius:28px;padding:16px;width:min(480px,100%);}
.modal h3{margin:0 0 10px;font-weight:900;}
.modal p{font-size:13px;font-weight:800;line-height:1.5;color:rgba(255,255,255,.8);}
.modal .btnRow{margin-top:12px;}
</style>
</head>

<body>
<main id="pageContent">
<div class="wrap">
<div class="top">
<div class="chip" id="whoChip">—</div>
<div class="chip" id="timerChip">15:00</div>
</div>

<div class="card">
<div class="chat" id="chat"></div>

<div class="task">
<input class="inp" id="answer" placeholder="Write one sentence..." />
</div>

<div class="btnRow">
<button class="btn" id="btnSend">Gönder</button>
<button class="ghost" id="btnFinish">Dersi Bitir</button>
<button class="ghost" id="btnExit">Çık</button>
</div>
</div>
</div>
</main>

<div class="overlay" id="modal">
<div class="modal">
<h3>Ders Tamamlandı</h3>
<p id="modalText">...</p>
<div class="btnRow">
<button class="btn" id="btnContinue">Devam Et (30 Jeton)</button>
<button class="ghost" id="btnStop">Bugünlük Yeter</button>
</div>
</div>
</div>

<script type="module">
import { mountShell,setHeaderTokens } from "/js/ui_shell.js";
import { bootPage } from "/js/ui_guard.js";
import { supabase } from "/js/supabase_client.js";

mountShell({scroll:"none"});
bootPage({protectedPage:true,header:{nameId:"userName",picId:"userPic"}});

const PLAN_MIN=15;
const RATE=2;
const CHARGE=30;

let sessionId=null;
let remaining=PLAN_MIN*60;
let timer=null;
let teacherId=localStorage.getItem("italky_teacher_pref");

function fmt(sec){
const m=String(Math.floor(sec/60)).padStart(2,"0");
const s=String(sec%60).padStart(2,"0");
return `${m}:${s}`;
}

async function startLesson(){
const {data,error}=await supabase.rpc("start_course_15min",{p_teacher_id:teacherId});
if(error){location.href="/pages/plan_select.html";return;}
sessionId=data?.[0]?.session_id;
remaining=PLAN_MIN*60;
runTimer();
}

function runTimer(){
document.getElementById("timerChip").textContent=fmt(remaining);
timer=setInterval(()=>{
remaining--;
document.getElementById("timerChip").textContent=fmt(remaining);
if(remaining<=0){clearInterval(timer);finishLesson(true);}
},1000);
}

async function finishLesson(auto=false){
const {data}=await supabase.rpc("end_course_with_refund",{p_session_id:sessionId});
await supabase.rpc("add_study_minutes",{p_teacher_id:teacherId,p_minutes:15});

const refund=data?.[0]?.refund_tokens||0;
const tokens=data?.[0]?.tokens_left||0;
setHeaderTokens(tokens);

const {data:profile}=await supabase.from("profiles").select("levels,study_minutes").single();
const level=profile?.levels?.[teacherId]||"A0";
const studied=profile?.study_minutes?.[teacherId]||0;

const {data:req}=await supabase.from("level_requirements").select("*").eq("level",level).single();
const needed=req?.minutes_required||0;
const remain=Math.max(0,needed-studied);

document.getElementById("modalText").textContent=
`Seviye: ${level}
Toplam Çalışma: ${Math.floor(studied/60)} saat
Bir Üst Seviyeye Kalan: ${Math.ceil(remain/60)} saat

İade: ${refund} Jeton`;

document.getElementById("modal").classList.add("show");
}

document.getElementById("btnSend").onclick=()=>{};
document.getElementById("btnFinish").onclick=()=>{clearInterval(timer);finishLesson(false);};
document.getElementById("btnExit").onclick=()=>location.href="/pages/home.html";

document.getElementById("btnContinue").onclick=async()=>{
document.getElementById("modal").classList.remove("show");
await startLesson();
};

document.getElementById("btnStop").onclick=()=>location.href="/pages/plan_select.html";

await startLesson();
</script>
</body>
</html>
