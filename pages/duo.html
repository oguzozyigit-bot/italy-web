<script type="module">
import { BASE_DOMAIN } from "/js/config.js";
const $ = (id) => document.getElementById(id);
const apiBase = () => String(BASE_DOMAIN || "").replace(/\/+$/, "");

// ----------------------------------------------------------------
// 1. DEVASA OFFLINE HAVUZ (HER DÄ°L Ä°Ã‡Ä°N 70+ KELÄ°ME)
// ----------------------------------------------------------------
const OFFLINE_DB = {
  en: [
    ["Victory","Zafer"],["Defeat","Yenilgi"],["Freedom","Ã–zgÃ¼rlÃ¼k"],["Justice","Adalet"],
    ["Warrior","SavaÅŸÃ§Ä±"],["Strength","GÃ¼Ã§"],["Speed","HÄ±z"],["Shadow","GÃ¶lge"],
    ["Secret","SÄ±r"],["Legend","Efsane"],["Empire","Ä°mparatorluk"],["Glory","Åan"],
    ["Honor","Onur"],["Courage","Cesaret"],["Fear","Korku"],["Dream","RÃ¼ya"],
    ["Galaxy","Galaksi"],["Future","Gelecek"],["Energy","Enerji"],["Planet","Gezegen"],
    ["Strategy","Strateji"],["Economy","Ekonomi"],["Politics","Siyaset"],["System","Sistem"],
    ["Theory","Teori"],["Method","YÃ¶ntem"],["Knowledge","Bilgi"],["Wisdom","Bilgelik"],
    ["Destiny","Kader"],["Memory","HafÄ±za"],["Emotion","Duygu"],["Reason","AkÄ±l"],
    ["Nature","DoÄŸa"],["Ocean","Okyanus"],["Mountain","DaÄŸ"],["Forest","Orman"],
    ["Bridge","KÃ¶prÃ¼"],["Island","Ada"],["River","Nehir"],["Valley","Vadi"],
    ["Storm","FÄ±rtÄ±na"],["Thunder","GÃ¶k GÃ¼rÃ¼ltÃ¼sÃ¼"],["Lightning","ÅimÅŸek"],["Rain","YaÄŸmur"],
    ["Wind","RÃ¼zgar"],["Fire","AteÅŸ"],["Water","Su"],["Earth","Toprak"],
    ["Friend","ArkadaÅŸ"],["Enemy","DÃ¼ÅŸman"],["Peace","BarÄ±ÅŸ"],["War","SavaÅŸ"],
    ["Life","Hayat"],["Death","Ã–lÃ¼m"],["Time","Zaman"],["Space","Uzay"],
    ["Light","IÅŸÄ±k"],["Darkness","KaranlÄ±k"],["Sound","Ses"],["Silence","Sessizlik"],
    ["Truth","GerÃ§ek"],["Lie","Yalan"],["Hope","Umut"],["Despair","Ã‡aresizlik"],
    ["Love","AÅŸk"],["Hate","Nefret"],["Joy","SevinÃ§"],["Pain","AcÄ±"]
  ],
  de: [
    ["Sieg","Zafer"],["Niederlage","Yenilgi"],["Freiheit","Ã–zgÃ¼rlÃ¼k"],["Gerechtigkeit","Adalet"],
    ["Krieger","SavaÅŸÃ§Ä±"],["Kraft","GÃ¼Ã§"],["Geschwindigkeit","HÄ±z"],["Schatten","GÃ¶lge"],
    ["Geheimnis","SÄ±r"],["Legende","Efsane"],["Reich","Ä°mparatorluk"],["Ruhm","Åan"],
    ["Ehre","Onur"],["Mut","Cesaret"],["Angst","Korku"],["Traum","RÃ¼ya"],
    ["Zukunft","Gelecek"],["Energie","Enerji"],["Strategie","Strateji"],["Wirtschaft","Ekonomi"],
    ["Politik","Siyaset"],["System","Sistem"],["Theorie","Teori"],["Methode","YÃ¶ntem"],
    ["Wissen","Bilgi"],["Weisheit","Bilgelik"],["Schicksal","Kader"],["Erinnerung","HafÄ±za"],
    ["GefÃ¼hl","Duygu"],["Vernunft","AkÄ±l"],["Natur","DoÄŸa"],["Ozean","Okyanus"],
    ["Berg","DaÄŸ"],["Wald","Orman"],["BrÃ¼cke","KÃ¶prÃ¼"],["Insel","Ada"],
    ["Fluss","Nehir"],["Tal","Vadi"],["Sturm","FÄ±rtÄ±na"],["Donner","GÃ¶k GÃ¼rÃ¼ltÃ¼sÃ¼"],
    ["Blitz","ÅimÅŸek"],["Regen","YaÄŸmur"],["Wind","RÃ¼zgar"],["Feuer","AteÅŸ"],
    ["Wasser","Su"],["Erde","Toprak"],["Freund","ArkadaÅŸ"],["Feind","DÃ¼ÅŸman"],
    ["Frieden","BarÄ±ÅŸ"],["Krieg","SavaÅŸ"],["Leben","Hayat"],["Tod","Ã–lÃ¼m"],
    ["Zeit","Zaman"],["Raum","Uzay"],["Licht","IÅŸÄ±k"],["Dunkelheit","KaranlÄ±k"],
    ["Klang","Ses"],["Stille","Sessizlik"],["Wahrheit","GerÃ§ek"],["LÃ¼ge","Yalan"],
    ["Hoffnung","Umut"],["Liebe","AÅŸk"],["Hass","Nefret"],["Schmerz","AcÄ±"]
  ],
  fr: [
    ["Victoire","Zafer"],["DÃ©faite","Yenilgi"],["LibertÃ©","Ã–zgÃ¼rlÃ¼k"],["Justice","Adalet"],
    ["Guerrier","SavaÅŸÃ§Ä±"],["Force","GÃ¼Ã§"],["Vitesse","HÄ±z"],["Ombre","GÃ¶lge"],
    ["Secret","SÄ±r"],["LÃ©gende","Efsane"],["Empire","Ä°mparatorluk"],["Gloire","Åan"],
    ["Honneur","Onur"],["Courage","Cesaret"],["Peur","Korku"],["RÃªve","RÃ¼ya"],
    ["Avenir","Gelecek"],["Ã‰nergie","Enerji"],["StratÃ©gie","Strateji"],["Ã‰conomie","Ekonomi"],
    ["Politique","Siyaset"],["SystÃ¨me","Sistem"],["ThÃ©orie","Teori"],["MÃ©thode","YÃ¶ntem"],
    ["Savoir","Bilgi"],["Sagesse","Bilgelik"],["Destin","Kader"],["MÃ©moire","HafÄ±za"],
    ["Ã‰motion","Duygu"],["Raison","AkÄ±l"],["Nature","DoÄŸa"],["OcÃ©an","Okyanus"],
    ["Montagne","DaÄŸ"],["ForÃªt","Orman"],["Pont","KÃ¶prÃ¼"],["Ãle","Ada"],
    ["RiviÃ¨re","Nehir"],["VallÃ©e","Vadi"],["TempÃªte","FÄ±rtÄ±na"],["Tonnerre","GÃ¶k GÃ¼rÃ¼ltÃ¼sÃ¼"],
    ["Ã‰clair","ÅimÅŸek"],["Pluie","YaÄŸmur"],["Vent","RÃ¼zgar"],["Feu","AteÅŸ"],
    ["Eau","Su"],["Terre","Toprak"],["Ami","ArkadaÅŸ"],["Ennemi","DÃ¼ÅŸman"],
    ["Paix","BarÄ±ÅŸ"],["Guerre","SavaÅŸ"],["Vie","Hayat"],["Mort","Ã–lÃ¼m"],
    ["Temps","Zaman"],["Espace","Uzay"],["LumiÃ¨re","IÅŸÄ±k"],["TÃ©nÃ¨bres","KaranlÄ±k"],
    ["Son","Ses"],["Silence","Sessizlik"],["VÃ©ritÃ©","GerÃ§ek"],["Mensonge","Yalan"],
    ["Espoir","Umut"],["Amour","AÅŸk"],["Haine","Nefret"],["Douleur","AcÄ±"]
  ],
  es: [
    ["Victoria","Zafer"],["Derrota","Yenilgi"],["Libertad","Ã–zgÃ¼rlÃ¼k"],["Justicia","Adalet"],
    ["Guerrero","SavaÅŸÃ§Ä±"],["Fuerza","GÃ¼Ã§"],["Velocidad","HÄ±z"],["Sombra","GÃ¶lge"],
    ["Secreto","SÄ±r"],["Leyenda","Efsane"],["Imperio","Ä°mparatorluk"],["Gloria","Åan"],
    ["Honor","Onur"],["Coraje","Cesaret"],["Miedo","Korku"],["SueÃ±o","RÃ¼ya"],
    ["Futuro","Gelecek"],["EnergÃ­a","Enerji"],["Estrategia","Strateji"],["EconomÃ­a","Ekonomi"],
    ["PolÃ­tica","Siyaset"],["Sistema","Sistem"],["TeorÃ­a","Teori"],["MÃ©todo","YÃ¶ntem"],
    ["Conocimiento","Bilgi"],["SabidurÃ­a","Bilgelik"],["Destino","Kader"],["Memoria","HafÄ±za"],
    ["EmociÃ³n","Duygu"],["RazÃ³n","AkÄ±l"],["Naturaleza","DoÄŸa"],["OcÃ©ano","Okyanus"],
    ["MontaÃ±a","DaÄŸ"],["Bosque","Orman"],["Puente","KÃ¶prÃ¼"],["Isla","Ada"],
    ["RÃ­o","Nehir"],["Valle","Vadi"],["Tormenta","FÄ±rtÄ±na"],["Trueno","GÃ¶k GÃ¼rÃ¼ltÃ¼sÃ¼"],
    ["RelÃ¡mpago","ÅimÅŸek"],["Lluvia","YaÄŸmur"],["Viento","RÃ¼zgar"],["Fuego","AteÅŸ"],
    ["Agua","Su"],["Tierra","Toprak"],["Amigo","ArkadaÅŸ"],["Enemigo","DÃ¼ÅŸman"],
    ["Paz","BarÄ±ÅŸ"],["Guerra","SavaÅŸ"],["Vida","Hayat"],["Muerte","Ã–lÃ¼m"],
    ["Tiempo","Zaman"],["Espacio","Uzay"],["Luz","IÅŸÄ±k"],["Oscuridad","KaranlÄ±k"],
    ["Sonido","Ses"],["Silencio","Sessizlik"],["Verdad","GerÃ§ek"],["Mentira","Yalan"],
    ["Esperanza","Umut"],["Amor","AÅŸk"],["Odio","Nefret"],["Dolor","AcÄ±"]
  ],
  it: [
    ["Vittoria","Zafer"],["Sconfitta","Yenilgi"],["LibertÃ ","Ã–zgÃ¼rlÃ¼k"],["Giustizia","Adalet"],
    ["Guerriero","SavaÅŸÃ§Ä±"],["Forza","GÃ¼Ã§"],["VelocitÃ ","HÄ±z"],["Ombra","GÃ¶lge"],
    ["Segreto","SÄ±r"],["Leggenda","Efsane"],["Impero","Ä°mparatorluk"],["Gloria","Åan"],
    ["Onore","Onur"],["Coraggio","Cesaret"],["Paura","Korku"],["Sogno","RÃ¼ya"],
    ["Futuro","Gelecek"],["Energia","Enerji"],["Strategia","Strateji"],["Economia","Ekonomi"],
    ["Politica","Siyaset"],["Sistema","Sistem"],["Teoria","Teori"],["Metodo","YÃ¶ntem"],
    ["Conoscenza","Bilgi"],["Saggezza","Bilgelik"],["Destino","Kader"],["Memoria","HafÄ±za"],
    ["Emozione","Duygu"],["Ragione","AkÄ±l"],["Natura","DoÄŸa"],["Oceano","Okyanus"],
    ["Montagna","DaÄŸ"],["Foresta","Orman"],["Ponte","KÃ¶prÃ¼"],["Isola","Ada"],
    ["Fiume","Nehir"],["Valle","Vadi"],["Tempesta","FÄ±rtÄ±na"],["Tuono","GÃ¶k GÃ¼rÃ¼ltÃ¼sÃ¼"],
    ["Fulmine","ÅimÅŸek"],["Pioggia","YaÄŸmur"],["Vento","RÃ¼zgar"],["Fuoco","AteÅŸ"],
    ["Acqua","Su"],["Terra","Toprak"],["Amico","ArkadaÅŸ"],["Nemico","DÃ¼ÅŸman"],
    ["Pace","BarÄ±ÅŸ"],["Guerra","SavaÅŸ"],["Vita","Hayat"],["Morte","Ã–lÃ¼m"],
    ["Tempo","Zaman"],["Spazio","Uzay"],["Luce","IÅŸÄ±k"],["OscuritÃ ","KaranlÄ±k"],
    ["Suono","Ses"],["Silenzio","Sessizlik"],["VeritÃ ","GerÃ§ek"],["Bugia","Yalan"],
    ["Speranza","Umut"],["Amore","AÅŸk"],["Odio","Nefret"],["Dolore","AcÄ±"]
  ]
};

// ----------------------------------------------------------------
// 2. SÄ°STEM AYARLARI
// ----------------------------------------------------------------
let currentLang = 'en';
const LANGS = {
  en: { code: 'en-US', name: 'Ä°ngilizce' },
  de: { code: 'de-DE', name: 'Almanca' },
  fr: { code: 'fr-FR', name: 'FransÄ±zca' },
  es: { code: 'es-ES', name: 'Ä°spanyolca' },
  it: { code: 'it-IT', name: 'Ä°talyanca' }
};

window.setLang = (l, el) => {
  currentLang = l;
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  if(el) el.classList.add('active');
  ensureAudio();
  loadPool();
};

const shuffle = (arr) => {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
};

function normalize(s){
  return String(s||"").toLowerCase().trim()
    .replace(/[.,!?]/g,"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function uniqWords(list){
  const seen = new Set();
  const out = [];
  for(const it of list){
    if(!Array.isArray(it) || it.length < 2) continue;
    const k = normalize(it[0]);
    if(!k || seen.has(k)) continue;
    seen.add(k);
    out.push([String(it[0]).trim(), String(it[1]).trim()]);
  }
  return out;
}

// ----------------------------------------------------------------
// 3. HAVUZ YÃ–NETÄ°MÄ°
// ----------------------------------------------------------------
const POOL_TARGET = 150; 
const POOL_KEY = (l) => `duobattle_pool_${l}`;
const USED_KEY = (l) => `duobattle_used_${l}`;

let pool = [];
let used = new Set();

function loadPool(){
  try{
    const p = JSON.parse(localStorage.getItem(POOL_KEY(currentLang)) || "[]");
    const u = JSON.parse(localStorage.getItem(USED_KEY(currentLang)) || "[]");
    pool = uniqWords(p); 
    used = new Set(u || []);
  } catch {
    pool = [];
    used = new Set();
  }
}

function savePool(){
  try{
    localStorage.setItem(POOL_KEY(currentLang), JSON.stringify(pool));
    localStorage.setItem(USED_KEY(currentLang), JSON.stringify([...used]));
  } catch {}
}

function pickN(n=20){
  const fresh = pool.filter(x => !used.has(normalize(x[0])));
  
  if(fresh.length < n){
    used = new Set();
    let chosen = shuffle(pool).slice(0, n);
    chosen.forEach(x => used.add(normalize(x[0])));
    savePool();
    return chosen;
  }

  let chosen = shuffle(fresh).slice(0, n);
  chosen.forEach(x => used.add(normalize(x[0])));
  savePool();
  return chosen;
}

// ----------------------------------------------------------------
// 4. VERÄ° Ã‡EKME (ZAMAN AYARLI)
// ----------------------------------------------------------------
async function fetchWordsFromAI() {
  $("loading").style.display="block";
  $("startBtn").style.display="none";
  setWave("idle","Rakip AranÄ±yor...");

  // 1. Ã–nce Lokal HafÄ±zaya Bak
  loadPool();
  used = new Set(); 
  savePool();

  // EÄŸer havuz doluysa, API ile hiÃ§ vakit kaybetme
  if(pool.length >= 120){
    wordList = pickN(20);
    $("startModal").style.display="none";
    await sleep(100);
    startGameLoop(true);
    return;
  }

  // 2. API BaÄŸlantÄ±sÄ±nÄ± Dene (Timeout KorumalÄ±)
  try {
    const lg = LANGS[currentLang];
    const seed = Math.floor(Math.random()*1e9);
    
    // Timeout KontrolcÃ¼sÃ¼ (4 Saniye sÃ¼re veriyoruz)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 4000);

    const res = await fetch(`${apiBase()}/api/chat`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      signal: controller.signal, // BaÄŸlantÄ± yavaÅŸsa iptal et
      body: JSON.stringify({
        text:`Bana ${lg.name} dilinde B1-B2 seviyesinde ${POOL_TARGET} FARKLI kelime (Soyut, Fiil, SÄ±fat karÄ±ÅŸÄ±k) ve TÃ¼rkÃ§e karÅŸÄ±lÄ±ÄŸÄ±nÄ± SADECE JSON array formatÄ±nda ver: [["Freedom","Ã–zgÃ¼rlÃ¼k"], ...] Seed:${seed}`,
        max_tokens: 2600
      })
    });
    
    clearTimeout(timeoutId); // BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa sayacÄ± durdur

    const data = await res.json();
    const incoming = uniqWords(safeParseWordList(data));
    pool = uniqWords([...pool, ...incoming]);

    // Eksikse Offline ile tamamla
    if(pool.length < 100){
      fallbackToOffline();
    } else {
      pool = shuffle(pool).slice(0, POOL_TARGET * 1.5);
      savePool();
      wordList = pickN(20);
    }

  } catch (e) {
    // 3. HATA ALIRSA (Timeout veya Server HatasÄ±) HEMEN OFFLINE'A GEÃ‡
    console.log("Offline moduna geÃ§ildi:", e);
    fallbackToOffline();
  }

  $("startModal").style.display="none";
  await sleep(100);
  startGameLoop(true);
}

function fallbackToOffline(){
  const fb = OFFLINE_DB[currentLang] || OFFLINE_DB.en;
  let filled = [...fb];
  // Havuzu ÅŸiÅŸir ki rastgelelik artsÄ±n
  while(filled.length < POOL_TARGET) filled = filled.concat(fb);
  pool = uniqWords(shuffle(filled)).slice(0, POOL_TARGET);
  savePool();
  wordList = pickN(20);
}

// ----------------------------------------------------------------
// 5. OYUN MOTORU
// ----------------------------------------------------------------
const BEST_ALL = "duobattle_best_all";
function updateBests(finalScore){
  const all = Number(localStorage.getItem(BEST_ALL)||0);
  if(finalScore>all) localStorage.setItem(BEST_ALL, String(finalScore));
}

let wordList=[], currentIndex=0, isBusy=false;
let stats={ correct:0, wrong:0 };
let score=0, combo=0, lives=3, turnStartedAt=0;
let reviveUsed = false;
let confettiOn = false;

function safeParseWordList(raw){
  let txt = "";
  if(typeof raw === "string") txt = raw;
  else if(raw && typeof raw === "object") txt = raw.text || raw.message || "";
  txt = String(txt||"").trim().replace(/```json/gi,"").replace(/```/g,"").trim();
  const a = txt.indexOf("["); const b = txt.lastIndexOf("]");
  if(a !== -1 && b !== -1) txt = txt.slice(a, b+1);
  try { return JSON.parse(txt); } catch { return []; }
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function setWave(s,t){ $("waveBox").className="wave-box "+(s||""); $("waveStatus").textContent=t||"HAZIR"; }

function startGameLoop(now=false){
  currentIndex=0; stats={correct:0, wrong:0}; score=0; combo=0; lives=3; reviveUsed=false;
  updateUI();
  if(now) teacherPhase(); else setTimeout(teacherPhase,600);
}

function updateUI(){
  if(currentIndex>=wordList.length){ endSet(); return; }
  
  const w=wordList[currentIndex];
  $("wordA").textContent=w[0]; $("meanA").textContent=w[1];
  $("wordB").textContent=w[0]; $("meanB").textContent=w[1];
  
  $("valCorrect").textContent=stats.correct;
  $("valWrong").textContent=stats.wrong;
  
  const hearts = lives > 0 ? "â¤ï¸".repeat(lives) + "ğŸ¤".repeat(3-lives) : "ğŸ’€ğŸ’€ğŸ’€";
  $("valScore").textContent = `${score} P â€¢ ${hearts}`;
  $("valScoreB").textContent = `${Math.floor(score * 0.85)} P`;

  const pct = ((currentIndex + 1)/wordList.length*100)+"%";
  $("fillA").style.width=pct; $("corrA").textContent=(currentIndex+1)+"/"+wordList.length;
  $("fillB").style.width=pct; $("corrB").textContent=(currentIndex+1)+"/"+wordList.length;
  
  $("turnA").textContent = "Bekliyor"; $("turnB").textContent = "Bekliyor";
  $("paneA").classList.remove("active"); $("paneB").classList.remove("active");
  $("micA").disabled=true; setWave("idle","HazÄ±r");
}

function speakBrowser(t, rate=0.9){
  return new Promise(r=>{
    // Ses takÄ±lÄ±rsa 2.5 saniyede zorla devam et
    const tm = setTimeout(()=>{ r(); }, 2500); 
    try{ window.speechSynthesis.cancel(); }catch{}
    const u=new SpeechSynthesisUtterance(String(t||""));
    u.lang=LANGS[currentLang].code; u.rate=rate;
    u.onend = () => { clearTimeout(tm); r(); };
    u.onerror = () => { clearTimeout(tm); r(); };
    try{ window.speechSynthesis.speak(u); } catch { clearTimeout(tm); r(); }
  });
}

async function teacherPhase(){
  if(isBusy) return; isBusy=true;
  turnStartedAt = Date.now();
  
  $("turnB").textContent = "Okuyor...";
  $("turnA").textContent = "Bekliyor";
  
  $("paneB").classList.add("active"); setWave("speaking","Rakip Hamlesi...");
  
  await speakBrowser(wordList[currentIndex][0]);
  
  $("paneB").classList.remove("active"); 
  $("paneA").classList.add("active");
  
  $("turnB").textContent = "Bekliyor";
  $("turnA").textContent = "SÄ±ra Sende";
  
  setWave("idle","SÄ±ra Sende"); 
  isBusy=false; 
  $("micA").disabled=false;
}

function similarity(a,b){
  a = normalize(a); b = normalize(b);
  if(!a || !b) return 0;
  if(a === b) return 1;
  const min = Math.min(a.length,b.length);
  let same=0;
  for(let i=0;i<min;i++){ if(a[i]===b[i]) same++; else break; }
  return same / Math.max(a.length,b.length);
}

function listen(){
  if(isBusy) return;
  if(!$("paneA").classList.contains("active")) return;

  const S=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!S)return alert("Desteklenmiyor");
  
  try{window.speechSynthesis.cancel();}catch{}
  isBusy=true; $("micA").disabled=true; setWave("listening","Dinleniyor...");
  
  const r=new S(); r.lang=LANGS[currentLang].code; r.interimResults=false;
  let got=false;
  
  const tm = setTimeout(() => { try{ r.stop(); }catch{} cleanup("ZAMAN AÅIMI"); }, 5000);

  r.onresult=e=>{ 
    clearTimeout(tm);
    got=true; 
    checkResult(e.results?.[0]?.[0]?.transcript||""); 
  };
  r.onerror=()=>{ clearTimeout(tm); cleanup("HATA / SES YOK"); };
  r.onend=()=>{ clearTimeout(tm); if(!got) cleanup("SES GELMEDÄ°"); };
  
  try{r.start();}catch{cleanup("HATA");}
}

function cleanup(msg){
  isBusy=false; 
  $("micA").disabled=false; 
  setWave("idle", msg || "SÄ±ra Sende");
}

async function checkResult(txt){
  const t=normalize(wordList[currentIndex][0]), s=normalize(txt);
  const isLate = currentIndex >= (wordList.length - 5);
  const simThreshold = isLate ? 0.72 : 0.6;
  const ok = ((" " + s + " ").includes(" " + t + " ")) || ((" " + t + " ").includes(" " + s + " ")) || similarity(s,t) >= simThreshold;
  const sec = (Date.now() - turnStartedAt) / 1000;
  const timeBonus = sec <= 2 ? 2 : sec <= 4 ? 1 : 0;

  if(ok){
    // HÄ°T EFEKTÄ°
    $("paneB").classList.add("flash-hit");
    setTimeout(()=>$("paneB").classList.remove("flash-hit"), 300);

    SFX.win(); stats.correct++; combo++;
    const comboBonus = combo >= 4 ? 3 : Math.max(0, combo-1);
    const gained = 5 + comboBonus + timeBonus; 
    score += gained;
    showResultOverlay(true, gained);
    if(combo === 3){ score += 5; setWave("idle","ğŸ”¥ KOMBÄ°NASYON!"); }
  } else {
    // SHAKE EFEKTÄ°
    $("paneA").classList.add("shake-hit");
    setTimeout(()=>$("paneA").classList.remove("shake-hit"), 500);

    SFX.fail(); stats.wrong++; combo=0; lives--;
    showResultOverlay(false, 0);
    await speakBrowser(wordList[currentIndex][0], 0.78);
    if(lives <= 0) { 
      if(!reviveUsed) {
        reviveUsed = true; lives = 1; setWave("idle","SON ROUND! ğŸ”¥"); updateUI();
      } else {
        endSet(true); return; 
      }
    } 
  }
  await sleep(1500); currentIndex++; updateUI();
  await sleep(500); isBusy=false; teacherPhase();
}

function showResultOverlay(ok, gained){
  const o=$("ovA");
  const extra = ok ? `<div style="margin-top:6px;font-weight:800;opacity:.9">+${gained}</div>` : "";
  o.innerHTML=`<div class="res-icon">${ok?'ğŸ¥Š':'ğŸ’¥'}</div><div class="res-text">${ok?'KROÅE!':'ISKA!'}</div>${extra}`;
  o.className="result-overlay show "+(ok?"ok":"bad");
  setTimeout(()=>o.classList.remove("show"),1100);
}

function endSet(isKO=false){
  try{ window.speechSynthesis.cancel(); }catch{}
  updateBests(score);
  $("endModal").style.display="flex";
  if(isKO){
    $("endResult").innerHTML = `<span style="color:var(--c-red);font-size:32px">NAKAVT! ğŸ˜µ</span><br>Skor: ${score}<br>DoÄŸru: ${stats.correct}`;
  } else if(score >= 100){
    $("endResult").innerHTML = `<span style="color:var(--c-green);font-size:32px">ÅAMPÄ°YON! ğŸ†</span><br>Skor: ${score}`;
    startConfetti();
  } else {
    $("endResult").innerHTML = `Skor: ${score}<br>DoÄŸru: ${stats.correct}`;
  }
  setWave("idle","Bitti");
}

$("retryBtn").onclick = () => {
  $("endModal").style.display = "none";
  $("startModal").style.display = "flex";
  fetchWordsFromAI();
};

let fwInterval=null; const cvs=$("effectCanvas"),ctx=cvs.getContext("2d"); let parts=[];
function startConfetti(){
  if(fwInterval) clearInterval(fwInterval);
  parts=[]; cvs.style.display="block"; cvs.width=window.innerWidth; cvs.height=window.innerHeight; 
  confettiOn = true;
  fwInterval=setInterval(()=>{ for(let i=0;i<5;i++) parts.push({x:Math.random()*cvs.width,y:cvs.height,vx:(Math.random()-.5)*5,vy:-(Math.random()*5+5),c:`hsl(${Math.random()*360},100%,50%)`,l:100}); },100); 
  requestAnimationFrame(loopConfetti);
  setTimeout(()=>{ if(fwInterval) clearInterval(fwInterval); fwInterval=null; confettiOn = false; cvs.style.display="none"; parts=[]; }, 5000);
}
function loopConfetti(){ 
  if(!confettiOn) return;
  ctx.clearRect(0,0,cvs.width,cvs.height); 
  for(let i=0;i<parts.length;i++){ let p=parts[i]; p.x+=p.vx; p.y+=p.vy; p.l--; ctx.beginPath(); ctx.arc(p.x,p.y,5,0,Math.PI*2); ctx.fillStyle=p.c; ctx.fill(); if(p.l<=0){parts.splice(i,1);i--} } 
  requestAnimationFrame(loopConfetti); 
}

$("startBtn").onclick=fetchWordsFromAI; $("micA").onclick=()=>{ ensureAudio(); listen(); };
</script>
