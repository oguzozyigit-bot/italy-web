<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>ITALKY ‚Ä¢ Duo Battle AI</title>
  <link rel="icon" href="data:,"/>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
  
  <style>
    :root { --bg-deep:#020205; --text-main:#fff; --c-cyan:#00f3ff; --c-green:#00e676; --c-red:#ff1744; --c-gold:#ffb800; --border:rgba(255,255,255,0.1); --safe-top:env(safe-area-inset-top,20px); --safe-bottom:env(safe-area-inset-bottom,20px); }
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; user-select:none; }
    html, body { margin:0; width:100%; height:100%; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:var(--text-main); position:fixed; }
    .cosmos-bg { position:absolute; inset:0; background:radial-gradient(circle at center, #1a1a2e 0%, #000 100%); z-index:0; }
    .star-dust { position:absolute; inset:0; opacity:0.4; background-image:radial-gradient(#fff 1px, transparent 1px); background-size:50px 50px; animation:dustMove 100s linear infinite; }
    #effectCanvas { position:absolute; inset:0; pointer-events:none; z-index:9999; display:none; }
    @keyframes dustMove { from{transform:translateY(0);} to{transform:translateY(-500px);} }
    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; padding-top:var(--safe-top); padding-bottom:var(--safe-bottom); }
    
    .game-logo-header { flex:0 0 auto; display:flex; flex-direction:column; align-items:center; justify-content:center; padding-top:10px; margin-bottom:-10px; position:relative; z-index:20; }
    .gl-brand { font-family:'Space Grotesk', sans-serif; font-size:12px; font-weight:700; color:rgba(255,255,255,0.6); letter-spacing:2px; margin-bottom:2px; }
    .gl-icon { font-size:28px; margin-bottom:0px; filter:drop-shadow(0 0 5px var(--c-cyan)); animation:pulseNeon 2s infinite alternate; }
    .gl-title { font-family:'Space Grotesk', sans-serif; font-weight:900; font-size:22px; letter-spacing:1px; background:linear-gradient(to right, var(--c-cyan), #0066ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-transform:uppercase; line-height:1; }
    .gl-sub { font-size:8px; letter-spacing:3px; color:var(--c-cyan); opacity:0.8; margin-top:2px; font-weight:700; }
    @keyframes pulseNeon { from{filter:drop-shadow(0 0 5px var(--c-cyan)); transform:scale(1);} to{filter:drop-shadow(0 0 15px var(--c-cyan)); transform:scale(1.05);} }

    .nav-layer { flex:0 0 50px; display:flex; justify-content:space-between; padding:0 12px; align-items:center; position:relative; z-index:30; }
    .nav-btn { width:40px; height:40px; border-radius:12px; background:rgba(0,0,0,0.4); border:1px solid var(--border); color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:700; font-size:14px; transition:0.2s; }
    .nav-btn:active { transform:scale(0.95); }
    
    .grid { flex:1; display:grid; grid-template-rows:1fr 60px 1fr; gap:8px; padding:0 10px 10px; overflow:hidden; }
    .pane { position:relative; border-radius:20px; border:1px solid var(--border); background:linear-gradient(160deg, rgba(255,255,255,0.03), rgba(0,0,0,0.4)); backdrop-filter:blur(10px); display:flex; flex-direction:column; overflow:hidden; transition:0.3s; min-height:0; }
    .pane.active { border-color:var(--c-cyan); box-shadow:0 0 20px rgba(0,243,255,0.15); }
    .pane.top { transform:rotate(180deg); } .pane.top > * { transform:rotate(180deg); } 
    
    .bar { flex:0 0 40px; padding:0 12px; background:rgba(0,0,0,0.3); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-family:'Space Grotesk', sans-serif; font-size:13px; }
    .score-stats { display:flex; gap:10px; align-items:center; font-weight:800; font-size:13px; }
    .stat-g { color:var(--c-green); } .stat-r { color:var(--c-red); }
    .stat-main { color:#fff; background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:6px; font-size:13px; white-space:nowrap; }

    .prog-wrap { flex:0 0 24px; padding:8px 12px 0; }
    .prog-track { height:4px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden; }
    .prog-fill { height:100%; width:0%; background:var(--c-green); transition:width 0.3s ease; }
    .prog-meta { display:flex; justify-content:space-between; margin-top:4px; font-size:10px; opacity:0.6; font-weight:600; text-transform:uppercase; }
    
    .body { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:2px; padding:4px 10px; min-height:0; overflow:hidden; }
    .word { font-size:clamp(22px, 6vw, 32px); font-weight:800; color:#fff; font-family:'Space Grotesk', sans-serif; text-align:center; line-height:1.1; }
    .meaning { font-size:clamp(14px, 4vw, 16px); color:rgba(255,255,255,0.6); font-weight:500; text-align:center; }
    .hint { font-size:10px; color:var(--c-cyan); font-weight:700; margin-top:6px; opacity:0; transition:0.3s; text-transform:uppercase; letter-spacing:1px; }
    .pane.active .hint { opacity:1; }
    
    .actions { flex:0 0 60px; padding:10px; display:flex; justify-content:center; align-items:center; }
    .mic-btn { width:100%; height:40px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,0.05); color:#fff; font-weight:700; font-size:14px; cursor:pointer; transition:0.2s; display:flex; align-items:center; justify-content:center; gap:6px; }
    .pane.active .mic-btn { background:linear-gradient(135deg, var(--c-cyan), #0066ff); border:none; box-shadow:0 5px 20px rgba(0,243,255,0.3); }
    .mic-btn:disabled { opacity:0.3; cursor:not-allowed; background:rgba(255,255,255,0.05) !important; box-shadow:none !important; }
    .mic-btn:active { transform:scale(0.96); }
    
    .wave-box { border-radius:16px; background:rgba(0,0,0,0.6); border:1px solid var(--border); backdrop-filter:blur(10px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; position:relative; overflow:hidden; }
    .wave-status { font-size:10px; font-weight:700; opacity:0.8; letter-spacing:1px; text-transform:uppercase; color:var(--c-cyan); }
    .bars { display:flex; gap:3px; height:16px; align-items:center; }
    .b { width:3px; height:6px; background:rgba(255,255,255,0.3); border-radius:4px; transition:0.2s; }
    .wave-box.speaking .b { background:var(--c-green); animation:bounce 0.6s infinite ease-in-out; }
    .wave-box.listening .b { background:var(--c-cyan); animation:bounce 0.5s infinite ease-in-out; }
    @keyframes bounce { 0%,100%{height:6px} 50%{height:16px} }
    .b:nth-child(1){animation-delay:0s} .b:nth-child(2){animation-delay:0.1s} .b:nth-child(3){animation-delay:0.2s} .b:nth-child(4){animation-delay:0.3s} .b:nth-child(5){animation-delay:0.4s}
    
    .result-overlay { position:absolute; inset:0; z-index:20; background:rgba(0,0,0,0.8); display:none; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(5px); animation:fadeIn 0.3s; }
    .result-overlay.show { display:flex; }
    .res-icon { font-size:48px; margin-bottom:8px; animation:popIn 0.4s; }
    .res-text { font-size:16px; font-weight:800; font-family:'Space Grotesk', sans-serif; text-transform:uppercase; letter-spacing:1px; }
    .ok .res-text { color:var(--c-green); } .bad .res-text { color:var(--c-red); }
    @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} } @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    
    .modal-wrap { position:absolute; inset:0; background:rgba(0,0,0,0.85); z-index:999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(15px); padding:20px; }
    .modal-card { width:100%; max-width:320px; background:#101014; border:1px solid var(--border); border-radius:24px; padding:20px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.8); animation:popIn 0.5s; max-height:80vh; overflow-y:auto; }
    .modal-title { font-size:20px; font-weight:800; margin-bottom:16px; font-family:'Space Grotesk', sans-serif; }
    .modal-p { font-size:13px; opacity:0.7; margin-bottom:20px; line-height:1.5; }
    .btn-primary { width:100%; padding:14px; border-radius:14px; border:none; background:linear-gradient(135deg, var(--c-cyan), #0066ff); color:#fff; font-weight:800; font-size:15px; cursor:pointer; box-shadow:0 10px 30px rgba(0,100,255,0.3); transition:0.2s; }
    .btn-primary:active { transform:scale(0.98); }
    .btn-sec { background:rgba(255,255,255,0.1); margin-top:10px; color:#fff; }
    
    .lang-grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:6px; margin-bottom:15px; }
    .lang-btn { background:rgba(255,255,255,0.1); border:1px solid var(--border); border-radius:8px; padding:8px 0; cursor:pointer; font-size:20px; transition:0.2s; display:flex; justify-content:center; }
    .lang-btn:active, .lang-btn.active { background:var(--c-cyan); border-color:var(--c-cyan); transform:scale(1.05); }
    
    .rules-box { background:rgba(255,255,255,0.05); padding:10px; border-radius:12px; margin-bottom:15px; font-size:11px; text-align:left; line-height:1.5; color:rgba(255,255,255,0.7); }
    .rules-box strong { color:var(--c-green); }
    .loader { border:3px solid rgba(255,255,255,0.1); border-top:3px solid var(--c-cyan); border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:0 auto 15px; }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
  </style>
</head>
<body>

  <div class="cosmos-bg"><div class="star-dust"></div></div>
  <canvas id="effectCanvas"></canvas>

  <div class="wrap">
    <div class="game-logo-header">
      <div class="gl-brand">ITALKY<span style="color:var(--c-cyan)">AI</span></div>
      <div class="gl-icon">ü•ä</div>
      <div class="gl-title">DUO BATTLE</div>
      <div class="gl-sub">ARENA</div>
    </div>

    <div class="nav-layer">
      <button class="nav-btn" onclick="window.location.href='/pages/game.html'">‚Üê</button>
      <button class="nav-btn" style="opacity:0">.</button>
    </div>

    <div class="grid">
      <section class="pane top" id="paneB">
        <div class="bar">
          <div class="p-name">√ñƒûRETMEN AI</div>
          <div class="score-stats"><span class="stat-main" id="valScoreB">0 P</span></div>
        </div>
        <div class="prog-wrap">
          <div class="prog-track"><div class="prog-fill" id="fillB"></div></div>
          <div class="prog-meta"><span id="corrB">0/20</span><span id="turnB">Bekliyor</span></div>
        </div>
        <div class="body">
          <div class="word" id="wordB">---</div>
          <div class="meaning" id="meanB">---</div>
          <div class="hint">OKUYOR...</div>
        </div>
        <div class="actions"><button class="mic-btn" id="micB" disabled>üéôÔ∏è</button></div>
      </section>

      <div class="wave-box" id="waveBox">
        <div class="wave-status" id="waveStatus">HAZIR</div>
        <div class="bars"><div class="b"></div><div class="b"></div><div class="b"></div><div class="b"></div><div class="b"></div></div>
      </div>

      <section class="pane" id="paneA">
        <div class="bar">
          <div class="p-name">SEN</div>
          <div class="score-stats">
            <span class="stat-g">‚úÖ <span id="valCorrect">0</span></span>
            <span class="stat-main" id="valScore">0 P ‚Ä¢ ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
            <span class="stat-r">‚ùå <span id="valWrong">0</span></span>
          </div>
        </div>
        <div class="prog-wrap">
          <div class="prog-track"><div class="prog-fill" id="fillA"></div></div>
          <div class="prog-meta"><span id="corrA">0/20</span><span id="turnA">Bekliyor</span></div>
        </div>
        <div class="body">
          <div class="word" id="wordA">---</div>
          <div class="meaning" id="meanA">---</div>
          <div class="hint">SENƒ∞N SIRAN</div>
        </div>
        <div class="actions"><button class="mic-btn" id="micA" disabled>üéôÔ∏è KONU≈û</button></div>
        <div class="result-overlay" id="ovA"></div>
      </section>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <div class="modal-title">DUO BATTLE AI ü•ä</div>
      <div class="modal-p">Hedef Dili Se√ß ve Ba≈üla:<br>20 Kelime ‚Ä¢ 100+ BONUS ‚Ä¢ 3 Can</div>
      <div class="lang-grid">
        <div class="lang-btn active" onclick="setLang('en', this)">üá¨üáß</div>
        <div class="lang-btn" onclick="setLang('de', this)">üá©üá™</div>
        <div class="lang-btn" onclick="setLang('fr', this)">üá´üá∑</div>
        <div class="lang-btn" onclick="setLang('es', this)">üá™üá∏</div>
        <div class="lang-btn" onclick="setLang('it', this)">üáÆüáπ</div>
      </div>
      <div class="rules-box">
        <strong>Sistem:</strong><br>
        ‚Ä¢ Her ma√ßta havuzdan 20 YENƒ∞ kelime se√ßilir.<br>
        ‚Ä¢ Asla aynƒ± kelime √ºst √ºste gelmez.<br>
        ‚Ä¢ Hƒ±z bonusu ve seri bonusu aktif! üöÄ
      </div>
      <div id="loading" style="display:none"><div class="loader"></div><div style="font-size:12px;opacity:0.6">Havuz Dolduruluyor...</div></div>
      <button class="btn-primary" id="startBtn">BA≈ûLA</button>
    </div>
  </div>

  <div class="modal-wrap" id="endModal" style="display:none">
    <div class="modal-card">
      <div class="modal-title">MA√á Bƒ∞TTƒ∞! üìù</div>
      <div class="modal-p" id="endResult"></div>
      <button class="btn-primary" id="retryBtn">TEKRAR</button>
      <button class="btn-primary btn-sec" onclick="location.href='/pages/game.html'">√áIKI≈û</button>
    </div>
  </div>

<script type="module">
import { BASE_DOMAIN } from "/js/config.js";
const $ = (id) => document.getElementById(id);
const apiBase = () => String(BASE_DOMAIN || "").replace(/\/+$/, "");

// ----------------------------------------------------------------
// 1. DEVASA OFFLINE HAVUZ (HER Dƒ∞L ƒ∞√áƒ∞N 100+ KELƒ∞ME)
// ----------------------------------------------------------------
const OFFLINE_DB = {
  en: [
    ["Galaxy","Galaksi"],["Planet","Gezegen"],["Energy","Enerji"],["Future","Gelecek"],["Dream","R√ºya"],
    ["Music","M√ºzik"],["Travel","Seyahat"],["Friend","Arkada≈ü"],["Summer","Yaz"],["School","Okul"],
    ["Market","Pazar"],["Garden","Bah√ße"],["Doctor","Doktor"],["Window","Pencere"],["Coffee","Kahve"],
    ["Bridge","K√∂pr√º"],["Island","Ada"],["Forest","Orman"],["Yellow","Sarƒ±"],["Purple","Mor"],
    ["History","Tarih"],["Science","Bilim"],["Nature","Doƒüa"],["Ocean","Okyanus"],["River","Nehir"],
    ["Mountain","Daƒü"],["Cloud","Bulut"],["Rain","Yaƒümur"],["Snow","Kar"],["Wind","R√ºzgar"],
    ["Fire","Ate≈ü"],["Water","Su"],["Earth","D√ºnya"],["Moon","Ay"],["Sun","G√ºne≈ü"],
    ["Star","Yƒ±ldƒ±z"],["Space","Uzay"],["Time","Zaman"],["Light","I≈üƒ±k"],["Sound","Ses"],
    ["Color","Renk"],["Shape","≈ûekil"],["Art","Sanat"],["Love","A≈ük"],["Peace","Barƒ±≈ü"],
    ["War","Sava≈ü"],["Life","Hayat"],["Death","√ñl√ºm"],["City","≈ûehir"],["Village","K√∂y"],
    ["Road","Yol"],["Street","Cadde"],["Car","Araba"],["Bus","Otob√ºs"],["Train","Tren"],
    ["Plane","U√ßak"],["Ship","Gemi"],["Bike","Bisiklet"],["House","Ev"],["Home","Yuva"],
    ["Room","Oda"],["Door","Kapƒ±"],["Table","Masa"],["Chair","Sandalye"],["Bed","Yatak"],
    ["Computer","Bilgisayar"],["Phone","Telefon"],["Book","Kitap"],["Pen","Kalem"],["Bag","√áanta"],
    ["Shoe","Ayakkabƒ±"],["Shirt","G√∂mlek"],["Pants","Pantolon"],["Hat","≈ûapka"],["Glass","Bardak"],
    ["Plate","Tabak"],["Food","Yemek"],["Fruit","Meyve"],["Apple","Elma"],["Banana","Muz"],
    ["Orange","Portakal"],["Bread","Ekmek"],["Milk","S√ºt"],["Cheese","Peynir"],["Meat","Et"],
    ["Fish","Balƒ±k"],["Bird","Ku≈ü"],["Cat","Kedi"],["Dog","K√∂pek"],["Horse","At"],
    ["Lion","Aslan"],["Tiger","Kaplan"],["Bear","Ayƒ±"],["Tree","Aƒüa√ß"],["Flower","√ái√ßek"],
    ["Red","Kƒ±rmƒ±zƒ±"],["Blue","Mavi"],["Green","Ye≈üil"],["Black","Siyah"],["White","Beyaz"]
  ],
  de: [
    ["Sonne","G√ºne≈ü"],["Mond","Ay"],["Wasser","Su"],["Freund","Arkada≈ü"],["Schule","Okul"],
    ["Arbeit","ƒ∞≈ü"],["Himmel","G√∂ky√ºz√º"],["Garten","Bah√ße"],["Familie","Aile"],["Reise","Seyahat"],
    ["Buch","Kitap"],["Stadt","≈ûehir"],["Lehrer","√ñƒüretmen"],["Sch√ºler","√ñƒürenci"],["Haus","Ev"],
    ["Auto","Araba"],["Zug","Tren"],["Flugzeug","U√ßak"],["Schiff","Gemi"],["Fahrrad","Bisiklet"],
    ["Stra√üe","Cadde"],["Weg","Yol"],["Br√ºcke","K√∂pr√º"],["Berg","Daƒü"],["Fluss","Nehir"],
    ["See","G√∂l"],["Meer","Deniz"],["Wald","Orman"],["Baum","Aƒüa√ß"],["Blume","√ái√ßek"],
    ["Tier","Hayvan"],["Hund","K√∂pek"],["Katze","Kedi"],["Vogel","Ku≈ü"],["Fisch","Balƒ±k"],
    ["Brot","Ekmek"],["Milch","S√ºt"],["Kaffee","Kahve"],["Tee","√áay"],["Bier","Bira"],
    ["Wein","≈ûarap"],["Wasser","Su"],["Saft","Meyve Suyu"],["Apfel","Elma"],["Banane","Muz"],
    ["Orange","Portakal"],["Kartoffel","Patates"],["Fleisch","Et"],["Ei","Yumurta"],["K√§se","Peynir"],
    ["Butter","Tereyaƒüƒ±"],["Zucker","≈ûeker"],["Salz","Tuz"],["Pfeffer","Biber"],["Tisch","Masa"],
    ["Stuhl","Sandalye"],["Bett","Yatak"],["Schrank","Dolap"],["Fenster","Pencere"],["T√ºr","Kapƒ±"],
    ["Zimmer","Oda"],["K√ºche","Mutfak"],["Bad","Banyo"],["Lampe","Lamba"],["Uhr","Saat"],
    ["Handy","Cep Telefonu"],["Computer","Bilgisayar"],["Bild","Resim"],["Musik","M√ºzik"],["Film","Film"],
    ["Geld","Para"],["Zeit","Zaman"],["Tag","G√ºn"],["Nacht","Gece"],["Morgen","Sabah"],
    ["Abend","Ak≈üam"],["Woche","Hafta"],["Monat","Ay"],["Jahr","Yƒ±l"],["Fr√ºhling","ƒ∞lkbahar"],
    ["Sommer","Yaz"],["Herbst","Sonbahar"],["Winter","Kƒ±≈ü"],["Farbe","Renk"],["Rot","Kƒ±rmƒ±zƒ±"],
    ["Blau","Mavi"],["Gr√ºn","Ye≈üil"],["Gelb","Sarƒ±"],["Schwarz","Siyah"],["Wei√ü","Beyaz"],
    ["Mensch","ƒ∞nsan"],["Mann","Adam"],["Frau","Kadƒ±n"],["Kind","√áocuk"],["Junge","Erkek √áocuk"]
  ],
  fr: [
    ["Soleil","G√ºne≈ü"],["Lune","Ay"],["Amour","A≈ük"],["Monde","D√ºnya"],["Fleur","√ái√ßek"],
    ["Temps","Zaman"],["Plage","Plaj"],["Livre","Kitap"],["Chien","K√∂pek"],["Maison","Ev"],
    ["Chat","Kedi"],["Oiseau","Ku≈ü"],["Poisson","Balƒ±k"],["Pain","Ekmek"],["Eau","Su"],
    ["Lait","S√ºt"],["Caf√©","Kahve"],["Th√©","√áay"],["Vin","≈ûarap"],["Bi√®re","Bira"],
    ["Homme","Adam"],["Femme","Kadƒ±n"],["Enfant","√áocuk"],["Ami","Arkada≈ü"],["Professeur","√ñƒüretmen"],
    ["√âtudiant","√ñƒürenci"],["√âcole","Okul"],["Travail","ƒ∞≈ü"],["Ville","≈ûehir"],["Pays","√úlke"],
    ["Rue","Cadde"],["Route","Yol"],["Voiture","Araba"],["Train","Tren"],["Avion","U√ßak"],
    ["Bateau","Gemi"],["V√©lo","Bisiklet"],["Montagne","Daƒü"],["Rivi√®re","Nehir"],["Mer","Deniz"],
    ["Ciel","G√∂ky√ºz√º"],["Nuage","Bulut"],["Pluie","Yaƒümur"],["Neige","Kar"],["Vent","R√ºzgar"],
    ["Feu","Ate≈ü"],["Terre","Toprak"],["Arbre","Aƒüa√ß"],["Jardin","Bah√ße"],["Parc","Park"],
    ["Cin√©ma","Sinema"],["Th√©√¢tre","Tiyatro"],["Musique","M√ºzik"],["Art","Sanat"],["Histoire","Tarih"],
    ["Science","Bilim"],["Langue","Dil"],["Mot","Kelime"],["Lettre","Mektup"],["Message","Mesaj"],
    ["T√©l√©phone","Telefon"],["Ordinateur","Bilgisayar"],["Table","Masa"],["Chaise","Sandalye"],["Lit","Yatak"],
    ["Fen√™tre","Pencere"],["Porte","Kapƒ±"],["Chambre","Oda"],["Cuisine","Mutfak"],["Salle de bain","Banyo"],
    ["Rouge","Kƒ±rmƒ±zƒ±"],["Bleu","Mavi"],["Vert","Ye≈üil"],["Jaune","Sarƒ±"],["Noir","Siyah"],
    ["Blanc","Beyaz"],["Grand","B√ºy√ºk"],["Petit","K√º√ß√ºk"],["Bon","ƒ∞yi"],["Mauvais","K√∂t√º"],
    ["Heureux","Mutlu"],["Triste","√úzg√ºn"],["Fort","G√º√ßl√º"],["Faible","Zayƒ±f"],["Nouveau","Yeni"]
  ],
  es: [
    ["Sol","G√ºne≈ü"],["Luna","Ay"],["Amigo","Arkada≈ü"],["Ciudad","≈ûehir"],["Playa","Plaj"],
    ["Libro","Kitap"],["Tiempo","Zaman"],["Gato","Kedi"],["Casa","Ev"],["Fiesta","Parti"],
    ["Perro","K√∂pek"],["P√°jaro","Ku≈ü"],["Pez","Balƒ±k"],["Pan","Ekmek"],["Agua","Su"],
    ["Leche","S√ºt"],["Caf√©","Kahve"],["T√©","√áay"],["Vino","≈ûarap"],["Cerveza","Bira"],
    ["Hombre","Adam"],["Mujer","Kadƒ±n"],["Ni√±o","√áocuk"],["Familia","Aile"],["Profesor","√ñƒüretmen"],
    ["Estudiante","√ñƒürenci"],["Escuela","Okul"],["Trabajo","ƒ∞≈ü"],["Calle","Cadde"],["Camino","Yol"],
    ["Coche","Araba"],["Tren","Tren"],["Avi√≥n","U√ßak"],["Barco","Gemi"],["Bicicleta","Bisiklet"],
    ["Monta√±a","Daƒü"],["R√≠o","Nehir"],["Mar","Deniz"],["Cielo","G√∂ky√ºz√º"],["Nube","Bulut"],
    ["Lluvia","Yaƒümur"],["Nieve","Kar"],["Viento","R√ºzgar"],["Fuego","Ate≈ü"],["Tierra","D√ºnya"],
    ["√Årbol","Aƒüa√ß"],["Flor","√ái√ßek"],["Jard√≠n","Bah√ße"],["Parque","Park"],["M√∫sica","M√ºzik"],
    ["Arte","Sanat"],["Historia","Tarih"],["Ciencia","Bilim"],["Idioma","Dil"],["Palabra","Kelime"],
    ["Tel√©fono","Telefon"],["Ordenador","Bilgisayar"],["Mesa","Masa"],["Silla","Sandalye"],["Cama","Yatak"],
    ["Ventana","Pencere"],["Puerta","Kapƒ±"],["Habitaci√≥n","Oda"],["Cocina","Mutfak"],["Ba√±o","Banyo"],
    ["Rojo","Kƒ±rmƒ±zƒ±"],["Azul","Mavi"],["Verde","Ye≈üil"],["Amarillo","Sarƒ±"],["Negro","Siyah"],
    ["Blanco","Beyaz"],["Grande","B√ºy√ºk"],["Peque√±o","K√º√ß√ºk"],["Bueno","ƒ∞yi"],["Malo","K√∂t√º"],
    ["Feliz","Mutlu"],["Triste","√úzg√ºn"],["Fuerte","G√º√ßl√º"],["Nuevo","Yeni"],["Viejo","Eski"],
    ["D√≠a","G√ºn"],["Noche","Gece"],["Ma√±ana","Sabah"],["Tarde","√ñƒüleden Sonra"],["Hoy","Bug√ºn"]
  ],
  it: [
    ["Sole","G√ºne≈ü"],["Luna","Ay"],["Amore","A≈ük"],["Mare","Deniz"],["Pizza","Pizza"],
    ["Tempo","Zaman"],["Citta","≈ûehir"],["Casa","Ev"],["Libro","Kitap"],["Gatto","Kedi"],
    ["Cane","K√∂pek"],["Uccello","Ku≈ü"],["Pesce","Balƒ±k"],["Pane","Ekmek"],["Acqua","Su"],
    ["Latte","S√ºt"],["Caff√®","Kahve"],["T√®","√áay"],["Vino","≈ûarap"],["Birra","Bira"],
    ["Uomo","Adam"],["Donna","Kadƒ±n"],["Bambino","√áocuk"],["Amico","Arkada≈ü"],["Insegnante","√ñƒüretmen"],
    ["Studente","√ñƒürenci"],["Scuola","Okul"],["Lavoro","ƒ∞≈ü"],["Strada","Cadde"],["Via","Yol"],
    ["Macchina","Araba"],["Treno","Tren"],["Aereo","U√ßak"],["Nave","Gemi"],["Bicicletta","Bisiklet"],
    ["Montagna","Daƒü"],["Fiume","Nehir"],["Lago","G√∂l"],["Cielo","G√∂ky√ºz√º"],["Nuvola","Bulut"],
    ["Pioggia","Yaƒümur"],["Neve","Kar"],["Vento","R√ºzgar"],["Fuoco","Ate≈ü"],["Terra","D√ºnya"],
    ["Albero","Aƒüa√ß"],["Fiore","√ái√ßek"],["Giardino","Bah√ße"],["Musica","M√ºzik"],["Arte","Sanat"],
    ["Storia","Tarih"],["Scienza","Bilim"],["Lingua","Dil"],["Parola","Kelime"],["Telefono","Telefon"],
    ["Computer","Bilgisayar"],["Tavolo","Masa"],["Sedia","Sandalye"],["Letto","Yatak"],["Finestra","Pencere"],
    ["Porta","Kapƒ±"],["Stanza","Oda"],["Cucina","Mutfak"],["Bagno","Banyo"],["Rosso","Kƒ±rmƒ±zƒ±"],
    ["Blu","Mavi"],["Verde","Ye≈üil"],["Giallo","Sarƒ±"],["Nero","Siyah"],["Bianco","Beyaz"],
    ["Grande","B√ºy√ºk"],["Piccolo","K√º√ß√ºk"],["Buono","ƒ∞yi"],["Cattivo","K√∂t√º"],["Felice","Mutlu"],
    ["Triste","√úzg√ºn"],["Nuovo","Yeni"],["Vecchio","Eski"],["Giorno","G√ºn"],["Notte","Gece"],
    ["Mattina","Sabah"],["Sera","Ak≈üam"],["Oggi","Bug√ºn"],["Domani","Yarƒ±n"],["Ieri","D√ºn"]
  ]
};

// ----------------------------------------------------------------
// 2. Sƒ∞STEM AYARLARI
// ----------------------------------------------------------------
let currentLang = 'en';
const LANGS = {
  en: { code: 'en-US', name: 'ƒ∞ngilizce' },
  de: { code: 'de-DE', name: 'Almanca' },
  fr: { code: 'fr-FR', name: 'Fransƒ±zca' },
  es: { code: 'es-ES', name: 'ƒ∞spanyolca' },
  it: { code: 'it-IT', name: 'ƒ∞talyanca' }
};

window.setLang = (l, el) => {
  currentLang = l;
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  if(el) el.classList.add('active');
  ensureAudio();
  loadPool();
};

const shuffle = (arr) => {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
};

function normalize(s){
  return String(s||"").toLowerCase().trim()
    .replace(/[.,!?]/g,"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function uniqWords(list){
  const seen = new Set();
  const out = [];
  for(const it of list){
    if(!Array.isArray(it) || it.length < 2) continue;
    const k = normalize(it[0]);
    if(!k || seen.has(k)) continue;
    seen.add(k);
    out.push([String(it[0]).trim(), String(it[1]).trim()]);
  }
  return out;
}

// ----------------------------------------------------------------
// 3. HAVUZ Y√ñNETƒ∞Mƒ∞ (POOL + USED)
// ----------------------------------------------------------------
const POOL_TARGET = 150; 
const POOL_KEY = (l) => `duobattle_pool_${l}`;
const USED_KEY = (l) => `duobattle_used_${l}`;

let pool = [];
let used = new Set();

function loadPool(){
  try{
    const p = JSON.parse(localStorage.getItem(POOL_KEY(currentLang)) || "[]");
    const u = JSON.parse(localStorage.getItem(USED_KEY(currentLang)) || "[]");
    pool = uniqWords(p); 
    used = new Set(u || []);
  } catch {
    pool = [];
    used = new Set();
  }
}

function savePool(){
  try{
    localStorage.setItem(POOL_KEY(currentLang), JSON.stringify(pool));
    localStorage.setItem(USED_KEY(currentLang), JSON.stringify([...used]));
  } catch {}
}

function pickN(n=20){
  const fresh = pool.filter(x => !used.has(normalize(x[0])));
  
  // Havuzda taze kelime kalmadƒ±ysa USED'ƒ± sƒ±fƒ±rla (Reset)
  if(fresh.length < n){
    used = new Set();
    let chosen = shuffle(pool).slice(0, n);
    chosen.forEach(x => used.add(normalize(x[0])));
    savePool();
    return chosen;
  }

  let chosen = shuffle(fresh).slice(0, n);
  chosen.forEach(x => used.add(normalize(x[0])));
  savePool();
  return chosen;
}

// ----------------------------------------------------------------
// 4. VERƒ∞ √áEKME (FETCH)
// ----------------------------------------------------------------
async function fetchWordsFromAI() {
  $("loading").style.display="block";
  $("startBtn").style.display="none";
  setWave("idle","Hazƒ±rlanƒ±yor...");

  loadPool();

  // YENƒ∞ MA√á ƒ∞√áƒ∞N RESET (Kullanƒ±lanlarƒ± unut, taze ba≈üla)
  used = new Set(); 
  savePool();

  // Havuz Doluluƒüunu Kontrol Et (120'den azsa Doldur)
  if(pool.length >= 120){
    wordList = pickN(20);
    $("startModal").style.display="none";
    await sleep(100);
    startGameLoop(true);
    return;
  }

  try {
    const lg = LANGS[currentLang];
    const seed = Math.floor(Math.random()*1e9);

    const res = await fetch(`${apiBase()}/api/chat`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        text:`Bana ${lg.name} dilinde A2-B1 seviyesinde ${POOL_TARGET} FARKLI kelime ve T√ºrk√ße kar≈üƒ±lƒ±ƒüƒ±nƒ± SADECE JSON array formatƒ±nda ver: [["apple","elma"], ...] Seed:${seed}`,
        max_tokens: 2600
      })
    });

    const data = await res.json();
    const incoming = uniqWords(safeParseWordList(data));

    pool = uniqWords([...pool, ...incoming]);

    // Yetmezse Offline'dan Takviye Yap
    if(pool.length < 100){
      const fb = OFFLINE_DB[currentLang] || OFFLINE_DB.en;
      let filled = [...fb];
      while(filled.length < POOL_TARGET) filled = filled.concat(fb);
      pool = uniqWords([...pool, ...filled]);
    }

    pool = shuffle(pool).slice(0, POOL_TARGET * 1.5);
    savePool();
    wordList = pickN(20);

  } catch (e) {
    // Tam Fallback: Sadece Offline Havuzu Kullan
    const fb = OFFLINE_DB[currentLang] || OFFLINE_DB.en;
    let filled = [...fb];
    while(filled.length < POOL_TARGET) filled = filled.concat(fb);
    pool = uniqWords(shuffle(filled)).slice(0, POOL_TARGET);
    savePool();
    wordList = pickN(20);
  }

  $("startModal").style.display="none";
  await sleep(100);
  startGameLoop(true);
}

// ----------------------------------------------------------------
// 5. OYUN MOTORU
// ----------------------------------------------------------------
const BEST_ALL = "duobattle_best_all";
function updateBests(finalScore){
  const all = Number(localStorage.getItem(BEST_ALL)||0);
  if(finalScore>all) localStorage.setItem(BEST_ALL, String(finalScore));
}

let wordList=[], currentIndex=0, isBusy=false;
let stats={ correct:0, wrong:0 };
let score=0, combo=0, lives=3, turnStartedAt=0;
let reviveUsed = false;
let confettiOn = false;

function safeParseWordList(raw){
  let txt = "";
  if(typeof raw === "string") txt = raw;
  else if(raw && typeof raw === "object") txt = raw.text || raw.message || "";
  txt = String(txt||"").trim().replace(/```json/gi,"").replace(/```/g,"").trim();
  const a = txt.indexOf("["); const b = txt.lastIndexOf("]");
  if(a !== -1 && b !== -1) txt = txt.slice(a, b+1);
  try { return JSON.parse(txt); } catch { return []; }
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function setWave(s,t){ $("waveBox").className="wave-box "+(s||""); $("waveStatus").textContent=t||"HAZIR"; }

function startGameLoop(now=false){
  currentIndex=0; stats={correct:0, wrong:0}; score=0; combo=0; lives=3; reviveUsed=false;
  updateUI();
  if(now) teacherPhase(); else setTimeout(teacherPhase,600);
}

function updateUI(){
  if(currentIndex>=wordList.length){ endSet(); return; }
  
  const w=wordList[currentIndex];
  $("wordA").textContent=w[0]; $("meanA").textContent=w[1];
  $("wordB").textContent=w[0]; $("meanB").textContent=w[1];
  
  $("valCorrect").textContent=stats.correct;
  $("valWrong").textContent=stats.wrong;
  
  const hearts = lives > 0 ? "‚ù§Ô∏è".repeat(lives) + "ü§ç".repeat(3-lives) : "üíÄüíÄüíÄ";
  $("valScore").textContent = `${score} P ‚Ä¢ ${hearts}`;
  
  const enemyScore = Math.max(0, Math.floor(score * 0.85));
  $("valScoreB").textContent = `${enemyScore} P`;

  const pct = ((currentIndex + 1)/wordList.length*100)+"%";
  $("fillA").style.width=pct;
  $("corrA").textContent=(currentIndex+1)+"/"+wordList.length;
  $("fillB").style.width=pct; 
  $("corrB").textContent=(currentIndex+1)+"/"+wordList.length;
  
  $("turnA").textContent = "Bekliyor";
  $("turnB").textContent = "Bekliyor";

  $("paneA").classList.remove("active"); $("paneB").classList.remove("active");
  $("micA").disabled=true; setWave("idle","Hazƒ±r");
}

function speakBrowser(t, rate=0.9){
  return new Promise(r=>{
    try{window.speechSynthesis.cancel();}catch{}
    const u=new SpeechSynthesisUtterance(String(t||""));
    u.lang=LANGS[currentLang].code; u.rate=rate;
    u.onend=r; u.onerror=r;
    try{window.speechSynthesis.speak(u);}catch{r();}
  });
}

async function teacherPhase(){
  if(isBusy)return; isBusy=true;
  turnStartedAt = Date.now();
  
  $("turnB").textContent = "Okuyor...";
  $("turnA").textContent = "Bekliyor";
  
  $("paneB").classList.add("active"); setWave("speaking","√ñƒüretmen...");
  await speakBrowser(wordList[currentIndex][0]);
  
  $("paneB").classList.remove("active"); 
  $("paneA").classList.add("active");
  
  $("turnB").textContent = "Bekliyor";
  $("turnA").textContent = "Sƒ±ra Sende";
  
  setWave("idle","Sƒ±ra Sende"); isBusy=false; $("micA").disabled=false;
}

function similarity(a,b){
  a = normalize(a); b = normalize(b);
  if(!a || !b) return 0;
  if(a === b) return 1;
  const min = Math.min(a.length,b.length);
  let same=0;
  for(let i=0;i<min;i++){ if(a[i]===b[i]) same++; else break; }
  return same / Math.max(a.length,b.length);
}

function listen(){
  if(isBusy) return;
  if(!$("paneA").classList.contains("active")) return;

  const S=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!S)return alert("Desteklenmiyor");
  
  try{window.speechSynthesis.cancel();}catch{}
  isBusy=true; $("micA").disabled=true; setWave("listening","Dinleniyor...");
  
  const r=new S(); r.lang=LANGS[currentLang].code; r.interimResults=false;
  let got=false;
  
  const tm = setTimeout(() => { try{ r.stop(); }catch{} cleanup("ZAMAN A≈ûIMI"); }, 5000);

  r.onresult=e=>{ 
    clearTimeout(tm);
    got=true; 
    checkResult(e.results?.[0]?.[0]?.transcript||""); 
  };
  r.onerror=()=>{ clearTimeout(tm); cleanup("HATA / SES YOK"); };
  r.onend=()=>{ clearTimeout(tm); if(!got) cleanup("SES GELMEDƒ∞"); };
  
  try{r.start();}catch{cleanup("HATA");}
}

function cleanup(msg){
  isBusy=false; 
  $("micA").disabled=false; 
  setWave("idle", msg || "Sƒ±ra Sende");
}

async function checkResult(txt){
  const t=normalize(wordList[currentIndex][0]), s=normalize(txt);
  
  const isLate = currentIndex >= (wordList.length - 5);
  const simThreshold = isLate ? 0.72 : 0.6;
  
  const ok = ((" " + s + " ").includes(" " + t + " ")) || 
             ((" " + t + " ").includes(" " + s + " ")) || 
             similarity(s,t) >= simThreshold;
  
  const sec = (Date.now() - turnStartedAt) / 1000;
  const timeBonus = sec <= 2 ? 2 : sec <= 4 ? 1 : 0;

  if(ok){
    SFX.win(); stats.correct++; combo++;
    const comboBonus = combo >= 4 ? 3 : Math.max(0, combo-1);
    const gained = 5 + comboBonus + timeBonus; 
    score += gained;
    showResultOverlay(true, gained);
    
    if(combo === 3){
      score += 5;
      setWave("idle","üî• 3'L√ú SERƒ∞ +5!");
    }

  } else {
    SFX.fail(); stats.wrong++; combo=0; lives--;
    showResultOverlay(false, 0);
    await speakBrowser(wordList[currentIndex][0], 0.78);

    if(lives <= 0) { 
      if(!reviveUsed) {
        reviveUsed = true;
        lives = 1;
        setWave("idle","SON ≈ûANS! üî•");
        updateUI();
      } else {
        endSet(true); 
        return; 
      }
    } 
  }
  
  await sleep(1500); currentIndex++; updateUI();
  await sleep(500); isBusy=false; teacherPhase();
}

function showResultOverlay(ok, gained){
  const o=$("ovA");
  const extra = ok ? `<div style="margin-top:6px;font-weight:800;opacity:.9">+${gained}</div>` : "";
  o.innerHTML=`<div class="res-icon">${ok?'‚úÖ':'‚ùå'}</div><div class="res-text">${ok?'HARƒ∞KA':'YANLI≈û'}</div>${extra}`;
  o.className="result-overlay show "+(ok?"ok":"bad");
  setTimeout(()=>o.classList.remove("show"),1100);
}

function endSet(isKO=false){
  try{ window.speechSynthesis.cancel(); }catch{}
  updateBests(score);
  
  $("endModal").style.display="flex";
  
  if(isKO){
    $("endResult").innerHTML = `<span style="color:var(--c-red);font-size:32px">NAKAVT! ü•ä</span><br>Skor: ${score}<br>Doƒüru: ${stats.correct}`;
  } else if(score >= 100){
    $("endResult").innerHTML = `<span style="color:var(--c-green);font-size:32px">EFSANE! üèÜ</span><br>Skor: ${score}`;
    startConfetti();
  } else {
    $("endResult").innerHTML = `Skor: ${score}<br>Doƒüru: ${stats.correct}`;
  }
  setWave("idle","Bitti");
}

// YENƒ∞DEN BA≈ûLA (Hafƒ±zalƒ±)
$("retryBtn").onclick = () => {
  $("endModal").style.display = "none";
  $("startModal").style.display = "flex";
  fetchWordsFromAI();
};

let fwInterval=null; const cvs=$("effectCanvas"),ctx=cvs.getContext("2d"); let parts=[];
function startConfetti(){
  if(fwInterval) clearInterval(fwInterval);
  parts=[]; cvs.style.display="block"; cvs.width=window.innerWidth; cvs.height=window.innerHeight; 
  confettiOn = true;
  fwInterval=setInterval(()=>{ for(let i=0;i<5;i++) parts.push({x:Math.random()*cvs.width,y:cvs.height,vx:(Math.random()-.5)*5,vy:-(Math.random()*5+5),c:`hsl(${Math.random()*360},100%,50%)`,l:100}); },100); 
  requestAnimationFrame(loopConfetti);
  setTimeout(()=>{ if(fwInterval) clearInterval(fwInterval); fwInterval=null; confettiOn = false; cvs.style.display="none"; parts=[]; }, 5000);
}
function loopConfetti(){ 
  if(!confettiOn) return;
  ctx.clearRect(0,0,cvs.width,cvs.height); 
  for(let i=0;i<parts.length;i++){ let p=parts[i]; p.x+=p.vx; p.y+=p.vy; p.l--; ctx.beginPath(); ctx.arc(p.x,p.y,5,0,Math.PI*2); ctx.fillStyle=p.c; ctx.fill(); if(p.l<=0){parts.splice(i,1);i--} } 
  requestAnimationFrame(loopConfetti); 
}

$("startBtn").onclick=fetchWordsFromAI; $("micA").onclick=()=>{ ensureAudio(); listen(); };
</script>
</body>
</html>
