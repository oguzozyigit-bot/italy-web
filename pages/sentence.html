<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI â€¢ Sentence Master v5.2 FINAL</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-deep:#020205; --c-neon-pink:#ff00ff; --c-neon-blue:#00f3ff;
      --c-neon-green:#00e676; --c-error:#ff1744; --border: rgba(255,255,255,.12);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    *{ box-sizing:border-box; outline:none; user-select:none; -webkit-tap-highlight-color:transparent; }
    html,body{ margin:0; width:100%; height:100%; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:#fff; position:fixed; }
    .cosmos-bg{ position:absolute; inset:0; z-index:0; background: radial-gradient(circle at 50% 35%, #0b0b2a 0%, #020205 60%, #010104 100%); }
    .wrap{ width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; padding: var(--safe-top) 0 env(safe-area-inset-bottom); }
    .nav-top{ display:flex; align-items:center; justify-content:space-between; padding: 15px 18px; }
    .back-btn{ display:flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:12px; background: rgba(255,255,255,.05); border: 1px solid var(--border); color:#fff; text-decoration:none; font-size:20px; }
    .mini-badge{ display:flex; align-items:center; height: 38px; padding: 0 12px; border-radius: 16px; background: rgba(255,255,255,.05); border: 1px solid var(--border); font-weight: 800; font-size: 11px; }

    @keyframes streakPop { 0% { transform:scale(1); } 50% { transform:scale(1.18); color:var(--c-neon-pink); } 100% { transform:scale(1); } }
    .streak-pop{ animation: streakPop 0.38s ease; }
    .streak-wrap{ text-align:center; margin-bottom:10px; opacity:0; transition:0.25s; font-weight:900; }
    .streak-active{ opacity:1; }

    .game-card{ background: rgba(255,255,255,.03); border: 1px solid var(--border); border-radius: 28px; backdrop-filter: blur(15px); padding: 22px 18px; margin: 0 14px; position:relative; box-shadow: 0 30px 60px rgba(0,0,0,.5); }
    .sentence-text{ font-size: 18px; font-weight: 800; line-height: 1.45; text-align: center; margin-bottom: 14px; text-transform: uppercase; min-height: 60px; }
    .translation-text{ font-size: 14px; color: var(--c-neon-green); font-style: italic; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; margin-bottom: 12px; }

    /* âœ… HARFLERÄ° BÃœYÃœTTÃœK */
    .word-box{ display:flex; flex-wrap:wrap; justify-content:center; gap: 8px; margin: 16px 0 14px; }
    .letter-slot{
      width: 34px; height: 46px;
      border-bottom: 3px solid var(--c-neon-blue);
      display:flex; align-items:center; justify-content:center;
      font-size: 26px; font-weight: 900; color: var(--c-neon-blue);
    }
    .letter-slot.filled{ border-bottom: none; color: #fff; text-shadow: 0 0 12px var(--c-neon-blue); }

    .keyboard{ display:grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .key-btn{
      aspect-ratio:1;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.10);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: #fff;
      font-weight: 900;
      cursor:pointer;
      font-size: 16px;
    }
    .key-btn.correct{ background: var(--c-neon-green); color:#000; }
    .key-btn.wrong{ opacity: 0.22; pointer-events:none; }

    .modal-wrap{ position:absolute; inset:0; background: rgba(0,0,0,.97); z-index:1000; display:flex; align-items:center; justify-content:center; padding: 20px; }
    .modal-card{ width:100%; max-width:340px; background: #08080c; border: 1px solid var(--border); border-radius: 30px; padding: 30px; text-align:center; }
    .btn-primary{ width:100%; padding: 16px; background: var(--c-neon-green); color:#000; border:none; border-radius: 18px; font-weight: 900; cursor:pointer; margin-top: 10px; }
    .btn-secondary{ width:100%; padding: 16px; background: rgba(255,255,255,.08); color:#fff; border: 1px solid var(--border); border-radius: 18px; font-weight: 900; cursor:pointer; margin-top: 10px; }
    .lang-grid{ display:grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
    .lang-btn{ font-size: 22px; padding: 8px; border-radius: 12px; background: rgba(255,255,255,.05); border: 1px solid transparent; cursor:pointer; }
    .lang-btn.active{ border-color: var(--c-neon-blue); background: rgba(0,243,255,0.1); }
  </style>
</head>

<body>
  <div class="cosmos-bg"></div>
  <div class="wrap">
    <div class="nav-top">
      <a href="/pages/game.html" class="back-btn">â†</a>
      <div style="font-size:24px; font-weight:900;">italky<span style="color:var(--c-neon-blue)">AI</span></div>
      <div style="display:flex; gap:8px;">
        <div class="mini-badge" id="lifeDisplay" style="color:var(--c-neon-pink);">â¤ï¸â¤ï¸â¤ï¸</div>
        <div class="mini-badge" id="scoreBadge">ğŸ† <span id="scoreDisplay">0</span></div>
      </div>
    </div>

    <div id="streakWrap" class="streak-wrap">
      ğŸ”¥ STREAK: <span id="streakCount">0</span>
    </div>

    <div class="game-card">
      <div id="sentenceDisplay" class="sentence-text"></div>
      <div id="translationDisplay" class="translation-text"></div>
      <div id="wordBox" class="word-box"></div>
      <div class="keyboard" id="keyboard"></div>
      <button class="btn-primary" style="background:linear-gradient(135deg,#6366f1,#a5b4fc); color:#fff; margin-top:14px" onclick="useJoker()">
        âš¡ REVEAL JOKER (<span id="jokerCount">2</span>)
      </button>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <h2 style="margin-bottom:20px">Sentence Master</h2>
      <div class="lang-grid">
        <button onclick="setLang('en', this)" class="lang-btn active">ğŸ‡¬ğŸ‡§</button>
        <button onclick="setLang('de', this)" class="lang-btn">ğŸ‡©ğŸ‡ª</button>
        <button onclick="setLang('fr', this)" class="lang-btn">ğŸ‡«ğŸ‡·</button>
        <button onclick="setLang('es', this)" class="lang-btn">ğŸ‡ªğŸ‡¸</button>
        <button onclick="setLang('it', this)" class="lang-btn">ğŸ‡®ğŸ‡¹</button>
      </div>
      <button class="btn-primary" onclick="selectLevel('A2')">A1 / A2 SEVÄ°YESÄ°</button>
      <button class="btn-primary" onclick="selectLevel('B1')">B1 SEVÄ°YESÄ°</button>
      <button class="btn-primary" onclick="selectLevel('B2')">B2 SEVÄ°YESÄ°</button>
    </div>
  </div>

  <div class="modal-wrap" id="endModal" style="display:none">
    <div class="modal-card">
      <h2 id="endTitle">SET TAMAMLANDI</h2>
      <p id="endStats" style="font-size:16px; margin:20px 0; opacity:0.8; line-height:1.6;"></p>

      <!-- âœ… BÄ°TÄ°NCE: YENÄ° SET / Ã‡IKIÅ -->
      <button class="btn-primary" id="endBtnMain">BÄ°R SET DAHA!</button>
      <button class="btn-secondary" id="endBtnExit">Ã‡IKIÅ</button>
    </div>
  </div>

<script type="module">
import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

const $ = (id) => document.getElementById(id);

let currentLang = "en", currentDiff = "A2", wordList = [], currentIndex = 0;
let mistakes = 0, lives = 3, currentWord = "", currentRaw = "", currentSentence = "", discovered = [], jokers = 2, totalScore = 0;

let streak = 0, maxStreak = 0, roundStartTime = 0, perfectCount = 0;
const SET_SIZE = 12;

function escapeRegExp(s){ return String(s ?? "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }
function stripDiacritics(s){
  return String(s ?? "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/ÃŸ/g, "ss");
}
function normalizeWordForGame(w){
  return stripDiacritics(w).toUpperCase();
}

/* âœ… Ses spam'ini azalt: Ã§ok hÄ±zlÄ± tÄ±klamalarda 250ms throttle */
let __lastSpeakAt = 0;
function speak(text) {
  const now = Date.now();
  if (now - __lastSpeakAt < 250) return;
  __lastSpeakAt = now;

  window.speechSynthesis.cancel();
  const msg = new SpeechSynthesisUtterance(text);

  const langMap = { en: "en-US", de: "de-DE", fr: "fr-FR", es: "es-ES", it: "it-IT" };
  msg.lang = langMap[currentLang] || "en-US";
  msg.rate = 0.85;

  window.speechSynthesis.speak(msg);
}

window.setLang = (lang, btn) => {
  currentLang = lang;
  document.querySelectorAll(".lang-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
};

window.selectLevel = (diff) => { currentDiff = diff; initGame(); };

async function initGame() {
  try {
    const rawPool = await loadLangPool(currentLang);
    const { used, save } = createUsedSet(`sentence_master_v52_${currentLang}_${currentDiff}`);

    wordList = pick(rawPool, SET_SIZE, used, save, (it) => {
      const itLvl = String(it.lvl || "").toUpperCase();
      const target = String(currentDiff || "").toUpperCase();
      const lvlMatch = (target === "A2") ? ["A1","A2"].includes(itLvl) : (itLvl === target);
      return lvlMatch && it.sentence && it.w;
    });

    $("startModal").style.display = "none";
    startRound();
  } catch (e) {
    alert("Havuz yÃ¼klenemedi baÅŸkanÄ±m!");
  }
}

function startRound() {
  if (currentIndex >= wordList.length || lives <= 0) { finishSet(); return; }

  const data = wordList[currentIndex];
  currentRaw = String(data.w ?? "").trim();
  currentSentence = String(data.sentence ?? "");
  mistakes = 0;

  const cleaned = normalizeWordForGame(currentRaw).replace(/[^A-ZÃ‡ÄÄ°Ã–ÅÃœ-]/g, "");
  currentWord = cleaned;

  discovered = new Array(currentWord.length).fill(false);
  roundStartTime = Date.now();

  const escaped = escapeRegExp(currentRaw);
  const sentenceUp = currentSentence.toUpperCase();
  let masked = sentenceUp.replace(new RegExp(`\\b${escaped}\\b`, "gi"), "____");

  if (masked === sentenceUp) {
    const raw2 = escapeRegExp(stripDiacritics(currentRaw));
    const sent2 = stripDiacritics(sentenceUp);
    const tryMask = sent2.replace(new RegExp(`\\b${raw2}\\b`, "gi"), "____");
    if (tryMask !== sent2) masked = tryMask;
  }

  $("sentenceDisplay").textContent = masked;
  $("translationDisplay").textContent = String(data.tr ?? "");

  renderWord();
  renderDynamicKeyboard();
  updateUI();
}

function renderWord() {
  const box = $("wordBox"); box.innerHTML = "";
  currentWord.split("").forEach((ch, i) => {
    const d = document.createElement("div");
    d.className = `letter-slot ${discovered[i] ? "filled" : ""}`;
    d.textContent = discovered[i] ? ch : "";
    box.appendChild(d);
  });
}

function getAlphabet() {
  return (currentLang === "en") ? "ABCDEFGHIJKLMNOPQRSTUVWXYZ" : "ABCÃ‡DEFGÄHIÄ°JKLMNOÃ–PRSÅTUÃœVYZ";
}

function renderDynamicKeyboard() {
  const kb = $("keyboard"); kb.innerHTML = "";
  const alphabet = getAlphabet();
  const wordChars = [...new Set(currentWord.split("").filter(Boolean))];

  const wrongChars = alphabet.split("")
    .filter(c => !wordChars.includes(c))
    .sort(() => Math.random() - 0.5)
    .slice(0, 12);

  const locale = (currentLang === "en") ? "en" : "tr";
  const finalKeys = [...wordChars, ...wrongChars].sort((a, b) => a.localeCompare(b, locale));

  finalKeys.forEach(char => {
    const b = document.createElement("button");
    b.className = "key-btn";
    b.textContent = char;
    b.onclick = () => handleGuess(char, b);
    kb.appendChild(b);
  });
}

/* âœ… DOÄRU / YANLIÅ HER Ä°KÄ°SÄ°NDE DE SES */
function speakOnAction(isCorrect){
  // EÄŸitim modu: cÃ¼mleyi okut
  // (Ä°stersen buraya kÄ±sa prefix ekleyebiliriz: "Correct." / "Wrong." ama ÅŸimdilik sade)
  speak(currentSentence);
}

function handleGuess(char, btn) {
  if (!btn || btn.disabled) return;
  btn.disabled = true;

  if (currentWord.includes(char)) {
    btn.classList.add("correct");
    speakOnAction(true);

    currentWord.split("").forEach((c, i) => { if (c === char) discovered[i] = true; });
    renderWord();

    if (discovered.every(v => v)) {
      calculatePuan();
      // Kelime bitince bir kez daha okut (pekiÅŸtirme)
      setTimeout(() => speak(currentSentence), 180);
      setTimeout(() => { currentIndex++; startRound(); }, 1100);
    }
  } else {
    btn.classList.add("wrong");
    speakOnAction(false);

    mistakes++;
    streak = Math.max(0, streak - 2);
    updateUI();

    if (mistakes >= 8) {
      lives--;
      if (lives <= 0) finishSet();
      else { currentIndex++; setTimeout(() => startRound(), 900); }
    }
  }
}

function calculatePuan() {
  streak++;
  if (streak > maxStreak) maxStreak = streak;

  const multiplier = (streak >= 5) ? 2 : (streak >= 3 ? 1.5 : 1);
  const base = (8 - mistakes) * 10;

  const timeUsed = (Date.now() - roundStartTime) / 1000;
  const speedBonus = timeUsed < 6 ? 10 : (timeUsed < 10 ? 5 : 0);

  const perfectBonus = (mistakes === 0) ? 25 : 0;
  if (mistakes === 0) perfectCount++;

  totalScore += Math.round((base * multiplier) + speedBonus + perfectBonus);

  $("streakWrap").classList.add("streak-pop");
  setTimeout(() => $("streakWrap").classList.remove("streak-pop"), 380);

  updateUI();
}

function updateUI() {
  $("lifeDisplay").textContent = "â¤ï¸".repeat(Math.max(0, lives));
  $("scoreDisplay").textContent = totalScore;
  $("jokerCount").textContent = jokers;
  $("streakCount").textContent = streak;

  if (streak >= 2) $("streakWrap").classList.add("streak-active");
  else $("streakWrap").classList.remove("streak-active");
}

function finishSet() {
  $("endModal").style.display = "flex";

  const bossBadge = (totalScore >= 1000 && lives > 0) ? "ğŸ‘‘ KING OF THE SET"
                    : (lives <= 0 ? "ğŸ’€ EÄÄ°TÄ°M BÄ°TTÄ°" : "SET TAMAMLANDI");
  $("endTitle").textContent = bossBadge;

  $("endStats").innerHTML = `
    Toplam Skor: <b>${totalScore}</b><br>
    En Ä°yi Seri: <b>ğŸ”¥ ${maxStreak}</b><br>
    Kusursuz Tur: <b>ğŸ† ${perfectCount}</b><br>
    Tamamlanan: <b>${Math.min(currentIndex, SET_SIZE)}/${SET_SIZE}</b>
  `;

  // âœ… Butonlar: Yeni Set/Tekrar + Ã‡Ä±kÄ±ÅŸ
  const main = $("endBtnMain");
  const exit = $("endBtnExit");

  exit.onclick = () => { location.href = "/pages/game.html"; };

  if (lives <= 0) {
    main.textContent = "TEKRAR DENE";
    main.onclick = () => location.reload();
  } else {
    main.textContent = "BÄ°R SET DAHA!";
    main.onclick = () => nextSet();
  }
}

window.nextSet = () => {
  $("endModal").style.display = "none";

  // set geÃ§iÅŸinde streak reset (adil)
  streak = 0;
  maxStreak = 0;
  perfectCount = 0;
  currentIndex = 0;

  // kÃ¼Ã§Ã¼k bonus
  jokers = Math.min(5, jokers + 1);

  initGame();
};

window.useJoker = () => {
  if (jokers <= 0) return;

  const hiddenIdx = discovered.map((v, i) => v ? -1 : i).filter(i => i !== -1);
  if (!hiddenIdx.length) return;

  const pickIdx = hiddenIdx[Math.floor(Math.random() * hiddenIdx.length)];
  const char = currentWord[pickIdx];

  jokers--;
  document.querySelectorAll(".key-btn").forEach(b => { if (b.textContent === char) handleGuess(char, b); });
  updateUI();
};
</script>
</body>
</html>
