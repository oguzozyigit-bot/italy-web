<!-- FILE: /pages/level_test.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>italkyAI • Seviye Sınavı</title>

<meta name="theme-color" content="#02000f">
<style>html,body{background:#02000f !important;}</style>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

<style>
  :root{ --bg:#02000f; --card: rgba(255,255,255,0.04); --border: rgba(255,255,255,0.10); --muted: rgba(255,255,255,0.65); }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
  #pageContent{ height: 100%; }

  .wrap{
    position:relative;
    max-width:480px;
    height:100%;
    margin:0 auto;
    padding: 12px 14px 14px;
    display:flex;
    flex-direction:column;
    gap:12px;
    background: rgba(10,10,30,0.18);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 26px;
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
  }

  .topbar{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
  .chip{
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.22);
    color: rgba(165,180,252,0.92);
    font-weight:1000;
    font-size:12px;
    white-space:nowrap;
  }
  .chip.timer{ color:#fff; border-color: rgba(255,255,255,0.12); }

  .card{
    flex:1;
    border-radius: 22px;
    border: 1px solid var(--border);
    background: var(--card);
    padding: 16px 14px;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }
  .card::-webkit-scrollbar{ display:none; }

  .q-meta{ display:flex; justify-content:space-between; gap:10px; margin-bottom:10px; }
  .meta{ font-size: 11px; font-weight: 900; color: rgba(255,255,255,0.55); }
  .q-text{ font-size: 18px; font-weight:1000; line-height:1.3; margin: 6px 0 14px; white-space:pre-wrap; }

  .opt{
    width:100%;
    padding: 14px;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.22);
    color:#fff;
    font-weight: 900;
    text-align:left;
    margin-bottom:10px;
    cursor:pointer;
    white-space:pre-wrap;
  }
  .opt:active{ transform: scale(.99); }
  .opt.sel{ background: rgba(99,102,241,0.55); border-color: rgba(99,102,241,0.75); }

  .nav{ display:flex; gap:10px; }
  .btn{
    flex:1;
    height: 52px;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color:#fff;
    font-weight:1000;
    cursor:pointer;
  }
  .btn-primary{ background:#fff; color:#000; border:none; }
  .btn:disabled{ opacity:.35; cursor:not-allowed; }

  .note{ font-size:12px; color:var(--muted); font-weight:800; line-height:1.45; }

  .errBox{
    border-radius: 18px;
    border: 1px solid rgba(255,90,140,0.35);
    background: rgba(255,0,90,0.10);
    padding: 12px 12px;
    color: rgba(255,255,255,0.92);
    font-weight: 900;
    font-size: 12px;
    line-height: 1.45;
    white-space: pre-wrap;
  }
  .infoBox{
    border-radius: 18px;
    border: 1px solid rgba(165,180,252,0.35);
    background: rgba(99,102,241,0.10);
    padding: 12px 12px;
    color: rgba(255,255,255,0.92);
    font-weight: 900;
    font-size: 12px;
    line-height: 1.45;
    white-space: pre-wrap;
  }

  .overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,0.60);
    backdrop-filter: blur(10px);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:999999;
  }
  .overlay.show{ display:flex; }
  .resultCard{
    width:min(520px, 100%);
    border-radius: 28px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(10,10,18,0.92);
    padding: 16px;
  }
  .rTitle{ font-size:16px; font-weight:1000; color:#fff; margin: 4px 0 10px; }
  .rLevel{ font-size:28px; font-weight:1000; color:#a5b4fc; margin: 0 0 10px; letter-spacing:-0.5px; }
  .rText{ font-size:13px; font-weight:900; color: rgba(255,255,255,0.78); line-height:1.55; white-space:pre-wrap; }
  .rBtns{ display:flex; gap:10px; margin-top: 12px; }
</style>
</head>

<body>
  <main id="pageContent">
    <div class="wrap">
      <div class="topbar">
        <div class="chip" id="langChip">Seviye Sınavı</div>
        <div class="chip timer" id="timerChip">40:00</div>
      </div>

      <div class="card" id="qCard"><div class="q-text">Yükleniyor…</div></div>

      <div class="nav">
        <button class="btn" id="btnPrev" disabled>GERİ</button>
        <button class="btn" id="btnSkip" disabled>ATLA</button>
        <button class="btn btn-primary" id="btnNext" disabled>İLERİ</button>
      </div>

      <div class="note">Bilmediğin soruyu <b>Atla</b>. Süre varsa atladıkların tekrar gelir. Her soru en fazla <b>2 tur</b> gösterilir.</div>
    </div>
  </main>

  <div class="overlay" id="resultOverlay">
    <div class="resultCard">
      <div class="rTitle">italkyAI • Sonuç</div>
      <div class="rLevel" id="rLevel">—</div>
      <div class="rText" id="rText">—</div>
      <div class="rBtns">
        <button class="btn btn-primary" id="rGo">Tamam</button>
        <button class="btn" id="rLater">Kapat</button>
      </div>
    </div>
  </div>

<script type="module">
  import { mountShell } from "/js/ui_shell.js";
  import { supabase } from "/js/supabase_client.js";

  mountShell({ scroll: "none" });

  const $ = (id)=>document.getElementById(id);
  const qCard = $("qCard");
  const btnPrev = $("btnPrev");
  const btnSkip = $("btnSkip");
  const btnNext = $("btnNext");

  function showError(title, detail){
    qCard.innerHTML = `<div class="errBox">${title}\n\n${detail || ""}</div>`;
    btnPrev.disabled = btnSkip.disabled = btnNext.disabled = true;
  }
  function showInfo(msg){
    qCard.innerHTML = `<div class="infoBox">${msg}</div>`;
  }
  function qs(k){ return new URLSearchParams(location.search).get(k); }

  const testId = String(qs("test_id")||"").trim();
  const langParamRaw = String(qs("lang")||"").trim().toLowerCase();

  if(!testId){
    showError("Test ID yok.", "Bu sayfa Seviye Tespit sayfasından açılmalı.");
    throw new Error("missing test_id");
  }

  // session gerekli
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session?.user){
    location.replace("/pages/login.html");
    throw new Error("no session");
  }

  // alias düzeltmeleri
  const LANG_ALIASES = { cn:"zh", jp:"ja", kr:"ko", sa:"ar", gr:"el", cz:"cs", rs:"sr", se:"sv", ua:"uk", ir:"fa" };
  const normLang = (l)=>{
    const x = String(l || "en").trim().toLowerCase();
    return LANG_ALIASES[x] || x;
  };

  const LANG_NAMES_TR = { en:"İngilizce", de:"Almanca", fr:"Fransızca", it:"İtalyanca", ru:"Rusça", es:"İspanyolca" };

  async function loadTestRow(){
    const { data, error } = await supabase
      .from("level_tests")
      .select("id, user_id, language_code, test_version, started_at, status")
      .eq("id", testId)
      .single();
    if(error) throw error;
    return data;
  }

  // ---------- OPTION CLEAN (A/B/C/D sök) ----------
  function stripChoiceLabel(s){
    let t = String(s ?? "").trim();
    // "A) xxx", "A. xxx", "A - xxx", "(A) xxx", "A: xxx"
    t = t.replace(/^\(?\s*[A-D]\s*[\)\.\:\-]\s*/i, "");
    t = t.replace(/^\(?\s*[A-D]\s*\)\s*/i, "");
    t = t.replace(/^\s*[A-D]\s+\s*/i, "");
    // "A )"
    t = t.replace(/^\s*[A-D]\s*\)\s*/i, "");
    return t.trim();
  }

  function shuffleIdx(n){
    const a = Array.from({length:n}, (_,i)=>i);
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function normalizeOneQuestion(q){
    const out = { ...q };
    const opts = Array.isArray(q?.options) ? q.options.map(stripChoiceLabel) : [];
    const corr = (q?.correct_index != null) ? Number(q.correct_index) : Number(q.correct ?? 0);

    if(opts.length === 4 && Number.isFinite(corr) && corr>=0 && corr<=3){
      const order = shuffleIdx(4);
      const newOpts = order.map(i=>opts[i]);
      const newCorrect = order.indexOf(corr);

      out.options = newOpts;
      out.correct_index = newCorrect;
      delete out.correct;
      return out;
    }

    // fallback
    out.options = opts;
    out.correct_index = (Number.isFinite(corr) ? corr : 0);
    delete out.correct;
    return out;
  }

  // ---------- STORAGE LOAD (v1..v5) ----------
  async function fetchJson(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error(`HTTP ${r.status}\n${t}`);
    }
    return await r.json();
  }

  async function loadFile(lang, v){
    const L = normLang(lang);
    const url = `https://auth.italky.ai/storage/v1/object/public/tests/level_tests/${encodeURIComponent(L)}_v${v}.json`;
    const j = await fetchJson(url);
    if(Array.isArray(j)) return j;
    if(j && Array.isArray(j.questions)) return j.questions;
    return [];
  }

  function qKey(q){
    const qq = String(q?.question||"").trim().toLowerCase().replace(/\s+/g," ");
    const opts = (Array.isArray(q?.options) ? q.options : [])
      .map(x=>String(x||"").trim().toLowerCase().replace(/\s+/g," "))
      .join("|");
    const lvl = String(q?.level||"").trim().toUpperCase();
    return `${lvl}::${qq}::${opts}`;
  }

  function poolUnique(all){
    const seen = new Set();
    const out = [];
    for(const q of all){
      if(!q || !q.question || !Array.isArray(q.options) || q.options.length !== 4) continue;
      const k = qKey(q);
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(q);
    }
    return out;
  }

  function pickByLevel(pool, level, need){
    const arr = pool.filter(q=>String(q.level||"").toUpperCase() === level);
    // shuffle
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr.slice(0, need);
  }

  function buildFinal50(pool){
    const levels = ["A1","A2","B1","B2","C1"];
    const chosen = [];
    const usedKeys = new Set();

    // 10 each
    for(const lv of levels){
      const block = pickByLevel(pool, lv, 10);
      for(const q of block){
        const k = qKey(q);
        if(usedKeys.has(k)) continue;
        usedKeys.add(k);
        chosen.push(q);
      }
    }

    // If any level shortage, fill from remaining pool (still unique) until 50
    if(chosen.length < 50){
      const rest = pool.slice();
      // shuffle rest
      for(let i=rest.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [rest[i],rest[j]]=[rest[j],rest[i]];
      }
      for(const q of rest){
        if(chosen.length >= 50) break;
        const k = qKey(q);
        if(usedKeys.has(k)) continue;
        usedKeys.add(k);
        chosen.push(q);
      }
    }

    return chosen.slice(0, 50);
  }

  showInfo("Test yükleniyor…");

  let testRow;
  try{
    testRow = await loadTestRow();
  }catch(e){
    showError("Test okunamadı.", e?.message || String(e));
    throw e;
  }

  const langCode = normLang(testRow?.language_code || langParamRaw || "en");
  const langNameTR = LANG_NAMES_TR[langCode] || langCode.toUpperCase();

  // test_version DB’den geliyorsa gösterelim (ama havuz seçiminde zorunlu değil)
  const testVer = Number(testRow?.test_version || 1) || 1;
  $("langChip").textContent = `${langCode.toUpperCase()} • Seviye Sınavı`;

  // 1) Havuzu indir
  let poolAll = [];
  try{
    showInfo("Sorular hazırlanıyor…\n\nTest havuzu yükleniyor (v1–v5).");
    const files = await Promise.all([1,2,3,4,5].map(v=>loadFile(langCode, v).catch(()=>[])));
    poolAll = files.flat();
  }catch(e){
    showError("Havuz indirilemedi.", e?.message || String(e));
    throw e;
  }

  // 2) Normalize + dedupe
  poolAll = poolAll.map(normalizeOneQuestion);
  const pool = poolUnique(poolAll);

  if(pool.length < 50){
    showError(
      "Havuz yetersiz.",
      `Bu dil için benzersiz soru sayısı: ${pool.length}\nEn az 50 olmalı.\n\nÇözüm:\n- v6 ekle\n- veya soruları yeniden üret.`
    );
    throw new Error("pool < 50");
  }

  // 3) Final 50
  let QUESTIONS = buildFinal50(pool);
  QUESTIONS = QUESTIONS.map(normalizeOneQuestion); // son kez garanti

  if(QUESTIONS.length < 50){
    showError("50 soru oluşturulamadı.", `Seçilen: ${QUESTIONS.length}\nHavuz: ${pool.length}`);
    throw new Error("final < 50");
  }

  // 4) DB’ye yaz (RLS takılmasın)
  try{
    const { error: attErr } = await supabase.rpc("attach_level_test_questions", {
      p_test_id: testId,
      p_questions: QUESTIONS,
      p_language_code: langCode
    });
    if(attErr) throw attErr;
  }catch(e){
    showError("Sorular DB’ye yazılamadı.", e?.message || String(e));
    throw e;
  }

  // --- TIMER (40 dk) ---
  const TOTAL_TIME = 40*60;
  const MAX_PASSES = 2;

  let remaining = TOTAL_TIME;
  try{
    const startedAt = testRow?.started_at ? new Date(testRow.started_at).getTime() : null;
    if(startedAt){
      const elapsed = Math.floor((Date.now() - startedAt)/1000);
      remaining = Math.max(0, TOTAL_TIME - elapsed);
    }
  }catch{}

  const answers = Array(QUESTIONS.length).fill(null);
  const passCount = Array(QUESTIONS.length).fill(0);
  const skipped = Array(QUESTIONS.length).fill(false);
  let idx = 0;

  function fmtTime(sec){
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }
  function updateTimer(){ $("timerChip").textContent = fmtTime(remaining); }

  function nextIndex(from){
    for(let i=from+1;i<QUESTIONS.length;i++){
      if(passCount[i] < MAX_PASSES && answers[i] === null) return i;
    }
    for(let i=0;i<QUESTIONS.length;i++){
      if(passCount[i] < MAX_PASSES && answers[i] === null) return i;
    }
    return -1;
  }

  function render(){
    const q = QUESTIONS[idx];
    if(!q){ showError("Soru yok.", `idx=${idx}`); return; }

    passCount[idx] = Math.min(MAX_PASSES, passCount[idx] + 1);

    const picked = answers[idx];
    const status = picked!==null ? "Cevaplandı" : (skipped[idx] ? "Atlandı" : "Bekliyor");
    const passInfo = `Tur: ${passCount[idx]}/${MAX_PASSES}`;

    const opts = Array.isArray(q.options) ? q.options : [];
    qCard.innerHTML = `
      <div class="q-meta">
        <div class="meta">Soru ${idx+1}/${QUESTIONS.length} • ${q.level || "-"}</div>
        <div class="meta">${status} • ${passInfo}</div>
      </div>
      <div class="q-text">${q.question || ""}</div>
      ${opts.map((opt,i)=>`<button class="opt ${picked===i?'sel':''}" data-i="${i}" type="button">${opt}</button>`).join("")}
    `;

    qCard.querySelectorAll(".opt").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.getAttribute("data-i"));
        answers[idx] = i;
        skipped[idx] = false;
        render();
      });
    });

    btnPrev.disabled = (idx===0);
    btnSkip.disabled = false;
    btnNext.disabled = false;
    btnNext.textContent = (nextIndex(idx)===-1) ? "SINAVI TAMAMLA" : "İLERİ";
  }

  let timer = null;

  function mustAnswerWarn(){
    // küçük, net uyarı
    showInfo("Lütfen bir şık seçin.\n\n(Şık seçmeden İleri’ye geçemezsiniz.)");
    setTimeout(()=>render(), 550);
  }

  async function finishExam(){
    try{ if(timer) clearInterval(timer); }catch{}

    const { data, error } = await supabase.rpc("finish_level_test", {
      p_test_id: testId,
      p_answers: answers,
      p_remaining_seconds: remaining
    });

    if(error){
      showError("Sonuç kaydedilemedi.", error.message || String(error));
      return;
    }

    const row = Array.isArray(data) ? (data[0] || null) : data;
    const level = row?.result_level || "A1";
    const correct = Number(row?.correct ?? 0);
    const total = Number(row?.total ?? 0);
    const percent = Number(row?.percent ?? 0);

    $("rLevel").textContent = `Seviye: ${level}`;
    $("rText").textContent =
`Dil: ${langNameTR}
Doğru: ${correct} / ${total}
Başarı: %${Math.round(percent*100)}

Sonuç profilinize işlendi.`;

    $("resultOverlay").classList.add("show");
    $("rGo").onclick = ()=>location.href="/pages/level_test_hub.html";
    $("rLater").onclick = ()=>location.href="/pages/home.html";
  }

  btnPrev.onclick = ()=>{ if(idx>0){ idx--; render(); } };

  btnSkip.onclick = ()=>{
    // 2. turda atlatma yok
    if(passCount[idx] >= 2){
      showInfo("Bu soru ikinci kez geldi.\n\nLütfen cevap veriniz.");
      setTimeout(()=>render(), 650);
      return;
    }

    skipped[idx]=true;
    answers[idx]=null;

    const ni = nextIndex(idx);
    if(ni===-1) finishExam(); else { idx=ni; render(); }
  };

  btnNext.onclick = ()=>{
    // şık seçmeden ilerleme yok
    if(answers[idx] === null){
      mustAnswerWarn();
      return;
    }

    const ni = nextIndex(idx);
    if(ni===-1) finishExam(); else { idx=ni; render(); }
  };

  updateTimer();
  timer = setInterval(()=>{
    remaining--;
    if(remaining<0) remaining=0;
    updateTimer();
    if(remaining===0){
      finishExam();
    }
  }, 1000);

  // hazır
  render();
</script>
</body>
</html>
