<!-- FILE: /pages/level_test.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>italkyAI • Seviye Sınavı</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">

<style>
  #pageContent { height: 100%; overflow: hidden; }
  .wrap { height: 100%; padding: 10px 16px 20px; display: flex; flex-direction: column; gap: 12px; }

  .topbar { display: flex; justify-content: space-between; gap:10px; }
  .chip {
    padding: 8px 12px; border-radius: 99px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    font-weight: 900;
    color: #a5b4fc;
    font-size: 11px;
    white-space: nowrap;
  }

  .card {
    flex: 1;
    border-radius: 32px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(20px);
    padding: 18px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .q-meta{ display:flex; justify-content:space-between; gap:10px; margin-top:4px; }
  .meta{ font-size: 11px; font-weight: 900; color: rgba(255,255,255,0.55); }

  .q-text {
    font-size: 18px;
    font-weight: 1000;
    color: #fff;
    margin: 14px 0 14px;
    line-height: 1.3;
  }

  .opt {
    width: 100%;
    padding: 14px;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(0,0,0,0.2);
    color: #fff;
    font-weight: 900;
    margin-bottom: 10px;
    text-align: left;
    cursor: pointer;
  }
  .opt.sel { background: #6366f1; border-color: rgba(255,255,255,0.0); }

  .nav { display: flex; gap: 10px; }
  .btn {
    flex: 1; height: 50px; border-radius: 16px;
    font-weight: 1000; cursor: pointer;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color: #fff;
  }
  .btn:active{ transform:scale(.99); }
  .btn-primary { background:#fff; color:#000; border:none; }
  .btn-muted { opacity:.65; cursor:not-allowed; }

  .note { margin-top:10px; font-size: 12px; color: rgba(255,255,255,0.55); font-weight: 800; line-height: 1.5; }

  .toast{
    position: fixed; left:50%; top:18px; transform:translateX(-50%) translateY(-120px);
    background:rgba(10,10,18,.92); border:1px solid rgba(165,180,252,.35);
    padding:10px 14px; border-radius:999px; color:#fff; z-index:99999;
    font-weight:900; font-size:12px; transition:.28s; backdrop-filter: blur(12px);
    pointer-events:none; max-width:min(92vw,520px); text-align:center;
  }
  .toast.show{ transform:translateX(-50%) translateY(0); }

  .overlay{
    position:fixed; inset:0; z-index:999999;
    display:none; align-items:center; justify-content:center;
    background: rgba(0,0,0,0.55); backdrop-filter: blur(10px);
    padding: 16px;
  }
  .overlay.show{ display:flex; }
  .resultCard{
    width:min(520px, 100%);
    border-radius: 28px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(10,10,18,0.92);
    padding: 16px;
  }
  .rTitle{ font-size:16px; font-weight:1000; color:#fff; margin: 4px 0 10px; }
  .rLevel{ font-size:28px; font-weight:1000; color:#a5b4fc; margin: 0 0 10px; letter-spacing:-0.5px; }
  .rText{ font-size:13px; font-weight:900; color: rgba(255,255,255,0.78); line-height:1.5; white-space:pre-wrap; }
  .rBtns{ display:flex; gap:10px; margin-top: 12px; }
</style>
</head>

<body>
<main id="pageContent">
  <div class="wrap">
    <div class="topbar">
      <div class="chip" id="langChip">Seviye Sınavı</div>
      <div class="chip" id="timerChip">40:00</div>
    </div>

    <div class="card" id="qCard"></div>

    <div class="nav">
      <button class="btn" id="btnPrev">GERİ</button>
      <button class="btn" id="btnSkip">ATLA</button>
      <button class="btn btn-primary" id="btnNext">İLERİ</button>
    </div>

    <div class="note">
      Bilmediğin soruyu <b>Atla</b>. Süre varsa atladıkların tekrar gelir. Her soru en fazla <b>2 tur</b> gösterilir.
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<div class="overlay" id="resultOverlay">
  <div class="resultCard">
    <div class="rTitle">Seviye Sonucu</div>
    <div class="rLevel" id="rLevel">—</div>
    <div class="rText" id="rText">—</div>
    <div class="rBtns">
      <button class="btn btn-primary" id="rGoLessons">Evet, Derslere Geç</button>
      <button class="btn" id="rLater">Şimdi Değil</button>
    </div>
  </div>
</div>

<script type="module">
  import { mountShell } from "/js/ui_shell.js";
  import { bootPage } from "/js/ui_guard.js";
  import { supabase } from "/js/supabase_client.js";

  mountShell({ scroll: "none" });
  bootPage({ protectedPage: true, header: { nameId: "userName", picId: "userPic" } });

  const $ = (id)=>document.getElementById(id);
  function toast(msg){
    const t = $("toast");
    t.textContent = String(msg||"");
    t.classList.add("show");
    clearTimeout(window.__to);
    window.__to = setTimeout(()=>t.classList.remove("show"), 1600);
  }

  const teacherId = (localStorage.getItem("italky_teacher_pref") || "").trim();
  if(!teacherId) location.href = "/pages/teacher_select.html";

  const LANGMAP = {
    dora:"İngilizce", ayda:"Almanca", jale:"Fransızca", ozan:"İspanyolca",
    sencer:"İtalyanca", sungur:"Rusça", huma:"Japonca", umay:"Çince",
    jack:"İngilizce", heidi:"Almanca", claire:"Fransızca", diego:"İspanyolca",
    marco:"İtalyanca", elena:"Rusça", kenji:"Japonca", mei:"Çince"
  };
  $("langChip").textContent = `${LANGMAP[teacherId] || "Dil"} • Seviye Sınavı`;

  const ENTRY_FEE = 40;
  const TOTAL_TIME = 40 * 60;
  const MAX_PASSES = 2;

  // ====== QUESTION BANK (50) ======
  const QUESTIONS = [
    {id:1,  lvl:"A1", w:1, q:"Choose the correct form: 'She ___ to the store yesterday.'", o:["go","goes","went","gone"], c:2},
    {id:2,  lvl:"A1", w:1, q:"Choose the correct article: 'I have ___ apple.'", o:["a","an","the","—"], c:1},
    {id:3,  lvl:"A1", w:1, q:"Choose the correct sentence.", o:["He are my friend.","He is my friend.","He am my friend.","He be my friend."], c:1},
    {id:4,  lvl:"A1", w:1, q:"Choose the correct plural: 'child' →", o:["childs","childes","children","childrens"], c:2},
    {id:5,  lvl:"A1", w:1, q:"Choose the correct preposition: 'I live ___ Istanbul.'", o:["in","on","at","to"], c:0},
    {id:6,  lvl:"A1", w:1, q:"Choose the correct question.", o:["Where you are?","Where are you?","Where is you?","Where you be?"], c:1},
    {id:7,  lvl:"A1", w:1, q:"Choose the correct negative: 'I ___ like coffee.'", o:["don't","doesn't","am not","isn't"], c:0},
    {id:8,  lvl:"A1", w:1, q:"Choose the correct time expression: 'I wake up ___ 7:00.'", o:["in","on","at","to"], c:2},
    {id:9,  lvl:"A1", w:1, q:"Choose the correct pronoun: '___ am happy.'", o:["He","She","I","They"], c:2},
    {id:10, lvl:"A1", w:1, q:"Choose the correct word: 'I ___ a book now.'", o:["read","reads","am reading","reading"], c:2},

    {id:11, lvl:"A2", w:2, q:"Choose the correct form: 'If it rains, we ___ at home.'", o:["stay","stayed","will stay","staying"], c:2},
    {id:12, lvl:"A2", w:2, q:"Choose the correct comparative: 'This car is ___ than that one.'", o:["fast","faster","fastest","more fast"], c:1},
    {id:13, lvl:"A2", w:2, q:"Choose the correct past form: 'They ___ dinner at 8 pm.'", o:["eat","eats","ate","eaten"], c:2},
    {id:14, lvl:"A2", w:2, q:"Choose the correct modal: 'You ___ wear a seatbelt.'", o:["must","can","may","might"], c:0},
    {id:15, lvl:"A2", w:2, q:"Choose the correct sentence.", o:["I have been to Paris last year.","I went to Paris last year.","I go to Paris last year.","I am going Paris last year."], c:1},
    {id:16, lvl:"A2", w:2, q:"Choose the correct preposition: 'I'm interested ___ music.'", o:["at","in","on","to"], c:1},
    {id:17, lvl:"A2", w:2, q:"Choose the correct form: 'There ___ many people here.'", o:["is","are","be","am"], c:1},
    {id:18, lvl:"A2", w:2, q:"Choose the correct future: 'I think it ___ tomorrow.'", o:["rains","rained","will rain","rain"], c:2},
    {id:19, lvl:"A2", w:2, q:"Choose the correct word order.", o:["Always I am late.","I always am late.","I am always late.","I late always am."], c:2},
    {id:20, lvl:"A2", w:2, q:"Choose the correct form: 'She is good ___ math.'", o:["at","in","on","to"], c:0},

    {id:21, lvl:"B1", w:3, q:"Choose the correct form: 'I ___ here since 2020.'", o:["live","lived","have lived","am living"], c:2},
    {id:22, lvl:"B1", w:3, q:"Choose the correct passive: 'The car ___ yesterday.'", o:["stole","was stolen","is stolen","stolen"], c:1},
    {id:23, lvl:"B1", w:3, q:"Choose the correct form: 'I wish I ___ more time.'", o:["have","had","will have","am having"], c:1},
    {id:24, lvl:"B1", w:3, q:"Choose the correct connector: 'I was tired, ___ I went to bed early.'", o:["because","so","but","although"], c:1},
    {id:25, lvl:"B1", w:3, q:"Choose the correct relative pronoun: 'The man ___ lives next door is a doctor.'", o:["who","which","where","when"], c:0},
    {id:26, lvl:"B1", w:3, q:"Choose the correct modal: 'You ___ have called me. I was worried.'", o:["should","can","may","must"], c:0},
    {id:27, lvl:"B1", w:3, q:"Choose the correct form: 'By the time we arrived, the movie ___.'", o:["starts","started","had started","has started"], c:2},
    {id:28, lvl:"B1", w:3, q:"Choose the correct sentence.", o:["I look forward to meet you.","I look forward to meeting you.","I look forward meet you.","I look forward to met you."], c:1},
    {id:29, lvl:"B1", w:3, q:"Choose the correct word: 'He apologized ___ being late.'", o:["for","to","at","with"], c:0},
    {id:30, lvl:"B1", w:3, q:"Choose the correct conditional: 'If I had known, I ___ you.'", o:["call","called","would call","would have called"], c:3},

    {id:31, lvl:"B2", w:4, q:"Choose the correct form: 'Hardly ___ when the phone rang.'", o:["had I sat down","I had sat down","did I sat down","I sat down"], c:0},
    {id:32, lvl:"B2", w:4, q:"Choose the correct form: 'She suggested that he ___ earlier.'", o:["leave","leaves","left","leaving"], c:0},
    {id:33, lvl:"B2", w:4, q:"Choose the correct phrase: 'It’s high time you ___.'", o:["go","went","have gone","going"], c:1},
    {id:34, lvl:"B2", w:4, q:"Choose the correct collocation: '___ research'", o:["make","do","take","get"], c:1},
    {id:35, lvl:"B2", w:4, q:"Choose the correct form: 'He denied ___ the document.'", o:["to sign","sign","signed","signing"], c:3},
    {id:36, lvl:"B2", w:4, q:"Choose the correct sentence.", o:["Despite of the rain, we went out.","Despite the rain, we went out.","Although of the rain, we went out.","In spite the rain, we went out."], c:1},
    {id:37, lvl:"B2", w:4, q:"Choose the correct reported speech.", o:["He said he will help.","He said he would help.","He said he helps.","He said he helped."], c:1},
    {id:38, lvl:"B2", w:4, q:"Choose the correct word: 'The results were ___ surprising.'", o:["highly","high","strongly","deeply"], c:0},
    {id:39, lvl:"B2", w:4, q:"Choose the correct form: 'Not only ___, but she also sings.'", o:["she dances","does she dance","she does dance","dances she"], c:1},
    {id:40, lvl:"B2", w:4, q:"Choose the correct form: 'I’d rather you ___ me earlier.'", o:["tell","told","have told","telling"], c:1},

    {id:41, lvl:"C1", w:5, q:"Meaning: 'to make a bold claim' means to…", o:["say something expensive","say something risky/confident","say something quietly","say something unclear"], c:1},
    {id:42, lvl:"C1", w:5, q:"Choose: 'Had it not been for your help, I ___.'", o:["fail","failed","would fail","would have failed"], c:3},
    {id:43, lvl:"C1", w:5, q:"Choose: 'The proposal was rejected ___ it lacked evidence.'", o:["owing to","despite","whereas","unless"], c:0},
    {id:44, lvl:"C1", w:5, q:"Choose: 'This policy may ___ unintended consequences.'", o:["trigger","sparkle","flutter","wander"], c:0},
    {id:45, lvl:"C1", w:5, q:"Choose: 'It is essential that he ___ informed.'", o:["is","be","was","being"], c:1},
    {id:46, lvl:"C1", w:5, q:"Paraphrase: 'He was reluctant to comply.'", o:["eager to help","unwilling to cooperate","ready to agree","excited to join"], c:1},
    {id:47, lvl:"C1", w:5, q:"Choose: 'No sooner ___ than it started snowing.'", o:["had we left","we had left","did we left","we left"], c:0},
    {id:48, lvl:"C1", w:5, q:"Choose: 'Her argument was ___ and convincing.'", o:["coherent","coastal","coarse","comic"], c:0},
    {id:49, lvl:"C1", w:5, q:"Choose: 'He spoke ___ the matter.'", o:["at length about","at length of","at lengths about","at long about"], c:0},
    {id:50, lvl:"C1", w:5, q:"Choose: 'The report is said ___ next week.'", o:["to publish","to be published","publishing","published"], c:1},
  ];

  // ====== STATE ======
  let idx = 0;
  let remaining = TOTAL_TIME;
  let timer = null;

  const answers = Array(QUESTIONS.length).fill(null);
  const passCount = Array(QUESTIONS.length).fill(0);
  const skipped = Array(QUESTIONS.length).fill(false);

  let testId = null;

  function fmtTime(sec){
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }
  function updateTimer(){ $("timerChip").textContent = fmtTime(remaining); }

  function nextIndex(from){
    for(let i=from+1;i<QUESTIONS.length;i++){
      if(passCount[i] < MAX_PASSES && answers[i] === null) return i;
    }
    for(let i=0;i<QUESTIONS.length;i++){
      if(passCount[i] < MAX_PASSES && answers[i] === null) return i;
    }
    return -1;
  }

  function render(){
    const q = QUESTIONS[idx];
    passCount[idx] = Math.min(MAX_PASSES, passCount[idx] + 1);

    const picked = answers[idx];
    const status = picked !== null ? "Cevaplandı" : (skipped[idx] ? "Atlandı" : "Bekliyor");
    const passInfo = `Tur: ${passCount[idx]}/${MAX_PASSES}`;

    $("qCard").innerHTML = `
      <div class="q-meta">
        <div class="meta">Soru ${idx+1}/${QUESTIONS.length} • ${q.lvl}</div>
        <div class="meta">${status} • ${passInfo}</div>
      </div>
      <div class="q-text">${q.q}</div>
      ${q.o.map((opt, i)=>`<button class="opt ${picked===i?'sel':''}" data-i="${i}">${opt}</button>`).join("")}
      <div class="note">Bilmediğin soruyu <b>Atla</b>. Süre varsa tekrar gelir. Her soru en fazla <b>2 tur</b> gösterilir.</div>
    `;

    $("qCard").querySelectorAll(".opt").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.getAttribute("data-i"));
        answers[idx] = i;
        skipped[idx] = false;
        render();
      });
    });

    const ni = nextIndex(idx);
    $("btnNext").textContent = (ni === -1) ? "SINAVI TAMAMLA" : "İLERİ";
  }

  function scoreWeighted(){
    let weighted = 0;
    for(let i=0;i<QUESTIONS.length;i++){
      if(answers[i] === QUESTIONS[i].c) weighted += QUESTIONS[i].w;
    }
    return weighted;
  }

  function computeLevel(weighted){
    if(weighted >= 175) return "C1";
    if(weighted >= 140) return "B2";
    if(weighted >= 105) return "B1";
    if(weighted >= 70)  return "A2";
    return "A1";
  }

  async function startExam(){
    const { data, error } = await supabase.rpc("start_level_test", { p_teacher_id: teacherId });
    if(error){
      if(String(error.message||"").includes("INSUFFICIENT_TOKENS")){
        toast("Yetersiz bakiye");
        location.href="/pages/level_test_intro.html";
        return;
      }
      toast("Sınav başlatılamadı");
      console.error(error);
      location.href="/pages/level_test_intro.html";
      return;
    }
    testId = data?.[0]?.test_id;
    const left = data?.[0]?.tokens_left;
    toast(`Sınav başladı • Jeton: ${left ?? "—"}`);

    updateTimer();
    timer = setInterval(()=>{
      remaining--;
      if(remaining < 0) remaining = 0;
      updateTimer();
      if(remaining === 0) finishExam();
    }, 1000);

    render();
  }

  async function finishExam(){
    if(timer) clearInterval(timer);

    const weighted = scoreWeighted();
    const level = computeLevel(weighted);

    // remaining_seconds server clamp eder
    const { data, error } = await supabase.rpc("finish_level_test", {
      p_test_id: testId,
      p_result_level: level,
      p_remaining_seconds: remaining
    });

    if(error){
      console.error(error);
      toast("Sonuç kaydedilemedi");
    }

    const refund = data?.[0]?.refund_tokens ?? 0;
    const tokensLeft = data?.[0]?.tokens_left ?? null;

    const langName = LANGMAP[teacherId] || "Dil";
    $("rLevel").textContent = `${langName} • ${level}`;
    $("rText").textContent =
      `Tebrikler! Seviyeniz: ${level}\n\n` +
      `İade: ${refund} Jeton\n` +
      (tokensLeft!=null ? `Kalan Jeton: ${tokensLeft}\n\n` : "\n") +
      `Önerimiz: 15 dakikalık derslerle başlayın.\n` +
      `italky Academy, seviyenize göre ders planınızı birlikte oluşturur.`;

    $("resultOverlay").classList.add("show");
  }

  $("btnPrev").onclick = ()=>{
    if(idx === 0) return;
    idx = Math.max(0, idx-1);
    render();
  };

  $("btnSkip").onclick = ()=>{
    skipped[idx] = true;
    answers[idx] = null;
    const ni = nextIndex(idx);
    if(ni === -1) finishExam();
    else { idx = ni; render(); }
  };

  $("btnNext").onclick = ()=>{
    const ni = nextIndex(idx);
    if(ni === -1) finishExam();
    else { idx = ni; render(); }
  };

  $("rGoLessons").onclick = ()=>{
    localStorage.setItem("italky_lesson_mins", "15");
    location.href = "/pages/plan_select.html";
  };
  $("rLater").onclick = ()=>location.href="/pages/home.html";

  // GO
  await startExam();
</script>
</body>
</html>
