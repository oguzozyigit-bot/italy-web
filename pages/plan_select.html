<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI ‚Ä¢ Pro Pratik</title>

  <meta name="theme-color" content="#000000">
  <style>html,body{background:#000 !important; margin:0; padding:0; overflow:hidden; font-family:'Outfit', sans-serif;}</style>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent: #6366f1;
      --glass: rgba(255, 255, 255, 0.04);
      --glass-border: rgba(255, 255, 255, 0.1);
      --ai-gradient: linear-gradient(135deg, #a5b4fc 0%, #6366f1 50%, #ec4899 100%);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

    #pageContent {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at 50% -20%, #1e1b4b 0%, #000 80%);
      padding: 10px 14px;
      /* ui_shell bo≈üluklarƒ± */
      padding-top: calc(env(safe-area-inset-top) + 60px); 
      padding-bottom: calc(env(safe-area-inset-bottom) + 80px);
    }

    .nebula {
      position: absolute; inset: -50%;
      background: radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.1) 0%, transparent 40%);
      filter: blur(60px); animation: drift 15s infinite alternate; z-index: 0; pointer-events: none;
    }
    @keyframes drift { from { transform: rotate(0deg) scale(1); } to { transform: rotate(10deg) scale(1.1); } }

    .main-card {
      position: relative; z-index: 1;
      flex: 1;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 30px;
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      display: flex; flex-direction: column;
      overflow: hidden;
      max-width: 480px; margin: 0 auto; width: 100%;
    }

    /* √úst Bilgi */
    .card-head {
      padding: 16px 20px 10px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .info-group h2 { font-size: 14px; color: #fff; margin: 0; font-weight: 800; opacity: 0.9; }
    .level-tag { font-size: 10px; color: var(--accent); font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }

    /* C√ºmle Alanƒ± - Orta Odak */
    .content-area {
      flex: 1;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      padding: 0 24px; text-align: center;
    }
    .sentence {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 24px; font-weight: 700; color: #fff;
      line-height: 1.2; margin-bottom: 12px;
    }
    .meaning-box {
      font-size: 14px; color: rgba(255,255,255,0.5);
      font-weight: 500; min-height: 20px;
    }

    /* Alt Kontrol Paneli */
    .control-panel {
      background: rgba(0,0,0,0.3);
      padding: 20px;
      border-top: 1px solid var(--glass-border);
    }

    /* Mini Aksiyonlar */
    .mini-actions {
      display: flex; gap: 8px; margin-bottom: 15px;
    }
    .m-btn {
      flex: 1; height: 38px; border-radius: 12px;
      border: 1px solid var(--glass-border); background: var(--glass);
      color: #fff; font-size: 12px; font-weight: 700;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .m-btn.prime { background: var(--ai-gradient); border: none; color: #000; }

    /* Ana Mikrofon ve Akƒ±≈ü */
    .main-actions {
      display: flex; justify-content: space-between; align-items: center; gap: 15px;
    }
    .side-btn {
      width: 48px; height: 48px; border-radius: 50%;
      background: var(--glass); border: 1px solid var(--glass-border);
      color: #fff; display: flex; align-items: center; justify-content: center;
    }
    .mic-btn {
      width: 72px; height: 72px; border-radius: 50%;
      background: #fff; color: #000; border: none;
      font-size: 28px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 20px rgba(99,102,241,0.4);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .mic-btn.rec { background: #ff4757; color: #fff; transform: scale(1.1); box-shadow: 0 0 30px rgba(255,71,87,0.5); }

    /* Analiz Paneli */
    .status-row {
      display: flex; gap: 10px; margin-top: 15px;
    }
    .stat-card {
      flex: 1; background: rgba(255,255,255,0.03);
      padding: 8px; border-radius: 12px; text-align: center;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .stat-label { font-size: 9px; color: rgba(255,255,255,0.4); text-transform: uppercase; margin-bottom: 2px; }
    .stat-val { font-size: 11px; font-weight: 800; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .stat-val.ok { color: #2ecc71; }
    .stat-val.bad { color: #ff4757; }

    /* Toast */
    .toast {
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-100px);
      background: #fff; color: #000; padding: 10px 20px; border-radius: 50px;
      font-weight: 800; font-size: 13px; z-index: 10000; transition: 0.4s;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }
  </style>
</head>

<body>
  <div class="nebula"></div>
  
  <main id="pageContent">
    <div class="main-card">
      <div class="card-head">
        <div class="info-group">
          <div class="level-tag" id="levelPill">Y√ºkleniyor...</div>
          <h2 id="langTitle">‚Äî</h2>
        </div>
        <div id="chipRight" style="font-size: 20px;">üåç</div>
      </div>

      <div class="content-area">
        <div class="sentence" id="sentence">C√ºmle hazƒ±rlanƒ±yor...</div>
        <div class="meaning-box" id="transBox">Anlam i√ßin butona bas.</div>
      </div>

      <div class="control-panel">
        <div class="mini-actions">
          <button class="m-btn" id="btnListenTop">üîä Dinlet</button>
          <button class="m-btn" id="btnMeaningTop">üìù Anlam</button>
          <button class="m-btn prime" id="btnSkipTop">‚ú® Atla</button>
        </div>

        <div class="main-actions">
          <button class="side-btn" id="btnRepeat" title="Tekrar">‚Üª</button>
          <button class="mic-btn" id="btnRec">üéôÔ∏è</button>
          <button class="side-btn" id="btnNext" disabled title="Sonraki">‚ûî</button>
        </div>

        <div class="status-row">
          <div class="stat-card">
            <div class="stat-label">Tanƒ±ma</div>
            <div class="stat-val" id="sttStatus">Hazƒ±r</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Benzerlik</div>
            <div class="stat-val" id="simStatus">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <div style="display:none;">
      <button id="btnPlay"></button>
      <div id="hint"></div>
      <button id="btnExit"></button>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { mountShell } from "/js/ui_shell.js";
    import { supabase } from "/js/supabase_client.js";

    mountShell({ scroll:"none" });

    const API_BASE = "https://italky-api.onrender.com";
    const PRACTICE_POOL_BASE = "https://auth.italky.ai/storage/v1/object/public/practice/pool";

    const $ = (id)=>document.getElementById(id);
    const toastEl = $("toast");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 2000);
    }

    function qs(k){ return new URLSearchParams(location.search).get(k); }
    const lang = String(qs("lang") || "en").toLowerCase();
    const levelQ = String(qs("level") || "").toUpperCase();

    const LANG_META = {
      en:{ name:"English", flag:"üá¨üáß" }, de:{ name:"German", flag:"üá©üá™" },
      fr:{ name:"French", flag:"üá´üá∑" }, it:{ name:"Italian", flag:"üáÆüáπ" },
      ru:{ name:"Russian", flag:"üá∑üá∫" }, es:{ name:"Spanish", flag:"üá™üá∏" }
    };
    const meta = LANG_META[lang] || { name: lang.toUpperCase(), flag:"üåç" };
    $("chipRight").textContent = meta.flag;
    $("langTitle").textContent = meta.name;

    const { data:{ session } } = await supabase.auth.getSession();
    if(!session?.user) location.replace("/pages/login.html");
    const userId = session.user.id;

    let fullName = "";
    let levels = {};
    const { data: prof } = await supabase.from("profiles").select("full_name, levels").eq("id", userId).maybeSingle();
    fullName = prof?.full_name || "Oƒüuz";
    levels = prof?.levels || {};

    const level = ["A1","A2","B1","B2","C1"].includes(levelQ) ? levelQ : (levels?.[lang] || "A1");
    $("levelPill").textContent = `Seviye: ${level}`;

    const THRESH = 0.95;
    let sessionQueue = [], sessionIndex = 0, currentText = "", currentTR = "";

    async function loadPool(){
      const r = await fetch(`${PRACTICE_POOL_BASE}/${encodeURIComponent(lang)}.json`);
      const j = await r.json();
      return j.levels || j;
    }

    function shuffle(arr){ return [...arr].sort(()=>Math.random()-0.5); }

    function nextSentence(){
      if(sessionIndex >= sessionQueue.length){ sessionQueue = shuffle(sessionQueue); sessionIndex = 0; }
      const it = sessionQueue[sessionIndex++];
      currentText = typeof it === "string" ? it : it.text;
      currentTR = typeof it === "object" ? (it.tr || it.meaning_tr || "") : "";
      
      $("sentence").textContent = currentText;
      $("sttStatus").textContent = "Hazƒ±r";
      $("simStatus").textContent = "‚Äî";
      $("simStatus").className = "stat-val";
      $("btnNext").disabled = true;
      $("transBox").textContent = "Anlam i√ßin butona bas.";
    }

    async function ttsSpeak(text){
      const r = await fetch(`${API_BASE}/api/tts`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ text, lang })
      });
      const j = await r.json();
      if(j.audio_base64) new Audio("data:audio/mpeg;base64," + j.audio_base64).play();
    }

    // STT Logic
    let mediaStream = null, recorder = null, chunks = [], recording = false;
    async function startRec(){
      if(!mediaStream) mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      chunks = [];
      recorder = new MediaRecorder(mediaStream);
      recorder.ondataavailable = (e)=> chunks.push(e.data);
      recorder.onstop = async ()=>{
        try {
          $("sttStatus").textContent = "Analiz...";
          const blob = new Blob(chunks, { type: "audio/webm" });
          const fd = new FormData(); fd.append("file", blob); fd.append("lang", lang);
          const r = await fetch(`${API_BASE}/api/stt`, { method:"POST", body: fd });
          const j = await r.json();
          const text = (j.text || "").trim();
          $("sttStatus").textContent = text || "?";
          
          const sim = calculateSimilarity(text, currentText);
          const pct = Math.round(sim * 100);
          $("simStatus").textContent = `%${pct}`;
          
          if(sim >= THRESH){
            $("simStatus").className = "stat-val ok";
            $("btnNext").disabled = false;
            setTimeout(()=> $("btnNext").click(), 800);
          } else {
            $("simStatus").className = "stat-val bad";
          }
        } catch(e){ $("sttStatus").textContent = "Hata"; }
        recording = false;
        $("btnRec").classList.remove("rec");
      };
      recorder.start();
      recording = true;
      $("btnRec").classList.add("rec");
      $("sttStatus").textContent = "Dinliyor...";
    }

    function calculateSimilarity(a, b) {
      const s1 = a.toLowerCase().replace(/[^\w\s]/g,'');
      const s2 = b.toLowerCase().replace(/[^\w\s]/g,'');
      if(s1 === s2) return 1;
      const len = Math.max(s1.length, s2.length);
      if(len === 0) return 1;
      let dist = 0;
      for(let i=0; i<Math.min(s1.length, s2.length); i++) if(s1[i] !== s2[i]) dist++;
      dist += Math.abs(s1.length - s2.length);
      return Math.max(0, 1 - (dist / len));
    }

    // Actions
    $("btnRec").onclick = () => !recording ? startRec() : recorder.stop();
    $("btnNext").onclick = () => { nextSentence(); setTimeout(()=>ttsSpeak(currentText), 300); };
    $("btnRepeat").onclick = () => ttsSpeak(currentText);
    $("btnListenTop").onclick = () => ttsSpeak(currentText);
    $("btnSkipTop").onclick = () => $("btnNext").click();
    
    $("btnMeaningTop").onclick = async () => {
      if(currentTR) { $("transBox").textContent = currentTR; return; }
      $("transBox").textContent = "√áevriliyor...";
      try {
        const r = await fetch(`${API_BASE}/api/translate_ai`, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ text: currentText, source_lang: lang, target_lang: "tr" })
        });
        const j = await r.json();
        $("transBox").textContent = j.text || "...";
      } catch(e){ $("transBox").textContent = "Hata"; }
    };

    // Init
    (async ()=>{
      try {
        const pool = await loadPool();
        const raw = pool[level] || pool["A1"];
        sessionQueue = shuffle(raw).slice(0, 100);
        nextSentence();
        setTimeout(()=>ttsSpeak(currentText), 500);
      } catch(e){ $("sentence").textContent = "Hata olu≈ütu."; }
    })();
  </script>
</body>
</html>
