<!-- FILE: /pages/plan_select.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>italkyAI â€¢ Ders PlanÄ±</title>

  <meta name="theme-color" content="#02000f">
  <style>html,body{background:#02000f !important;}</style>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --border: rgba(255,255,255,0.12);
      --card: rgba(255,255,255,0.05);
      --muted: rgba(255,255,255,0.70);
      --aiGrad: linear-gradient(135deg,#a5b4fc 0%,#6366f1 55%,#ec4899 100%);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
    #pageContent{ height:100%; }

    .wrap{
      height:100%;
      padding: 12px 14px calc(var(--footerH, 92px) + env(safe-area-inset-bottom) + 22px);
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
      max-width: 560px;
      margin:0 auto;
    }

    .panel{
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 16px 14px;
      position:relative;
      overflow:hidden;
    }

    /* yumuÅŸak nebula */
    .panel:before{
      content:"";
      position:absolute; inset:-35%;
      background:
        radial-gradient(circle at 20% 20%, rgba(99,102,241,.22) 0%, transparent 45%),
        radial-gradient(circle at 80% 30%, rgba(236,72,153,.18) 0%, transparent 42%),
        radial-gradient(circle at 50% 80%, rgba(168,85,247,.14) 0%, transparent 45%);
      filter: blur(34px);
      opacity:.85;
      animation: drift 10s ease-in-out infinite alternate;
      pointer-events:none;
    }
    @keyframes drift{
      from{ transform: translate3d(-10px,-8px,0) scale(1); }
      to{ transform: translate3d(10px,8px,0) scale(1.06); }
    }
    .panel > *{ position:relative; z-index:2; }

    .head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .title{
      font-family:"Space Grotesk",system-ui,sans-serif;
      font-weight:1000;
      font-size:18px;
      margin:0;
    }
    .chip{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      font-weight:1000;
      font-size:12px;
      color: rgba(255,255,255,0.86);
      white-space:nowrap;
      display:flex; gap:8px; align-items:center;
    }
    .chip b{
      background: var(--aiGrad);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    .sub{
      font-size:12px;
      font-weight:900;
      color: rgba(255,255,255,0.70);
      line-height:1.45;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px 12px;
      margin-top: 12px;
    }
    .k{
      font-size:12px;
      font-weight:1000;
      color: rgba(165,180,252,0.95);
      letter-spacing:1px;
      text-transform: uppercase;
    }
    .v{ font-size:16px; font-weight:1000; color:#fff; }

    .divider{
      height:1px;
      background: rgba(255,255,255,0.10);
      margin: 14px 0;
    }

    /* daktilo kartÄ± */
    .scriptBox{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding: 14px 12px;
      min-height: 142px;
    }
    .scriptTitle{
      font-size:11px;
      font-weight:1000;
      color: rgba(165,180,252,0.95);
      letter-spacing:1px;
      text-transform: uppercase;
      margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .miniBtn{
      height: 30px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-weight: 1000;
      font-size: 11px;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; gap:6px;
      white-space:nowrap;
    }
    .miniBtn:active{ transform: scale(.99); }

    .typeLine{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      font-weight: 800;
      color: rgba(255,255,255,0.92);
      line-height: 1.55;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 92px;
    }
    .cursor{
      display:inline-block;
      width: 9px;
      height: 16px;
      margin-left: 2px;
      background: rgba(165,180,252,0.9);
      vertical-align: -3px;
      animation: blink 0.9s infinite;
      border-radius: 2px;
    }
    @keyframes blink{ 0%,49%{opacity:1} 50%,100%{opacity:0} }

    .warn{
      border-radius: 18px;
      border: 1px solid rgba(255,90,140,0.35);
      background: rgba(255,0,90,0.10);
      padding: 12px 12px;
      color: rgba(255,255,255,0.92);
      font-weight: 900;
      font-size: 12px;
      line-height: 1.45;
      display:none;
      white-space:pre-wrap;
      margin-top: 10px;
    }

    .btnRow{
      margin-top:auto;
      display:flex;
      gap:10px;
    }
    .btn{
      height:56px;
      border-radius: 20px;
      border: none;
      cursor:pointer;
      font-weight:1000;
      font-size:14px;
      user-select:none;
      padding: 0 14px;
    }
    .btn:active{ transform: scale(.99); }
    .btn-main{
      background: var(--aiGrad);
      color:#050510;
      flex: 1;
    }
    .btn-ghost{
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color:#fff;
      width: 110px;
    }

    .toast{
      position: fixed;
      left:50%;
      top:18px;
      transform:translateX(-50%) translateY(-120px);
      background:rgba(10,10,18,.92);
      border:1px solid rgba(165,180,252,.35);
      padding:10px 14px;
      border-radius:999px;
      color:#fff;
      z-index:99999;
      font-weight:900;
      font-size:12px;
      transition:.28s;
      backdrop-filter: blur(12px);
      pointer-events:none;
      max-width:min(92vw,560px);
      text-align:center;
    }
    .toast.show{ transform:translateX(-50%) translateY(0); }
  </style>
</head>

<body>
<main id="pageContent">
  <div class="wrap">

    <div class="panel">
      <div class="head">
        <h2 class="title">Ders PlanÄ±</h2>
        <div class="chip"><b>15 dk</b> â€¢ Oturum</div>
      </div>

      <div class="sub">
        Bu ders <b>15 dakika</b> sÃ¼rer. SÃ¼re bitince devam edebilir ya da ara verebilirsin.
      </div>

      <div class="kv">
        <div class="k">DERS</div><div class="v" id="kvCourse">â€”</div>
        <div class="k">SEVÄ°YE</div><div class="v" id="kvLevel">â€”</div>
        <div class="k">HEDEF</div><div class="v" id="kvGoal">A2</div>
      </div>

      <div class="divider"></div>

      <div class="scriptBox">
        <div class="scriptTitle">
          <span>AI KOÃ‡ â€¢ BRÄ°FÄ°NG</span>
          <button class="miniBtn" id="btnReplay" type="button">ğŸ”Š Tekrar Dinlet</button>
        </div>

        <div class="typeLine" id="typeBox">HazÄ±rlanÄ±yor<span class="cursor"></span></div>

        <div class="warn" id="warnBox"></div>
      </div>
    </div>

    <div class="btnRow">
      <button class="btn btn-ghost" id="btnBack" type="button">Geri</button>
      <button class="btn btn-main" id="btnStart" type="button">Dersi BaÅŸlat</button>
    </div>

    <div class="toast" id="toast"></div>
  </div>
</main>

<script type="module">
  import { mountShell, setHeaderTokens } from "/js/ui_shell.js";
  import { supabase } from "/js/supabase_client.js";

  mountShell({ scroll:"none" });

  const API_BASE = "https://italky-api.onrender.com";

  const $ = (id)=>document.getElementById(id);
  const warn = $("warnBox");
  const btnStart = $("btnStart");

  function toast(msg){
    const t = $("toast");
    if(!t) return;
    t.textContent = String(msg||"");
    t.classList.add("show");
    clearTimeout(window.__to);
    window.__to = setTimeout(()=>t.classList.remove("show"), 1400);
  }

  // --- teacher id: ?t > localStorage (akÄ±ÅŸ bozulmasÄ±n diye duruyor)
  const params = new URLSearchParams(location.search);
  const teacherId = String(params.get("t") || localStorage.getItem("italky_teacher_pref") || "").trim();
  if(!teacherId) location.replace("/pages/teacher_select.html");
  localStorage.setItem("italky_teacher_pref", teacherId);

  // --- dil / seviye
  const lang = String(params.get("lang") || "en").trim().toLowerCase();
  const levelFromUrl = String(params.get("level") || "").trim().toUpperCase();

  const LANG_NAMES_TR = {
    en:"Ä°ngilizce", de:"Almanca", fr:"FransÄ±zca", it:"Ä°talyanca", ru:"RusÃ§a", es:"Ä°spanyolca"
  };
  const courseName = LANG_NAMES_TR[lang] ? `${LANG_NAMES_TR[lang]} Dersi` : "Dil Dersi";
  $("kvCourse").textContent = courseName;

  // --- session gate
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session?.user) location.replace("/pages/login.html");
  const userId = session.user.id;

  // --- profile read
  let prof = null;
  try{
    const { data, error } = await supabase
      .from("profiles")
      .select("tokens, full_name, levels")
      .eq("id", userId)
      .maybeSingle();
    if(!error) prof = data || null;
  }catch{}

  const tokens = Number(prof?.tokens ?? 0);
  try{ setHeaderTokens(tokens); }catch{}

  // adÄ± soyadÄ± kÄ±rp: tek kelimeyse o, birden fazlaysa son kelimeyi at
  function firstNameNoSurname(full){
    const s = String(full||"").trim();
    if(!s) return "";
    const parts = s.split(/\s+/).filter(Boolean);
    if(parts.length === 1) return parts[0];
    return parts.slice(0, -1).join(" ");
  }
  const firstName = firstNameNoSurname(prof?.full_name) || "OÄŸuz";

  // level belirle: url > profiles.levels[lang] > A1
  const levels = (prof?.levels && typeof prof.levels==="object") ? prof.levels : {};
  const level = (["A1","A2","B1","B2","C1"].includes(levelFromUrl) ? levelFromUrl : (levels?.[lang] || "A1"));
  $("kvLevel").textContent = level;

  // hedef: basit kural
  const goal = (level === "A1") ? "A2" : (level === "A2" ? "B1" : (level === "B1" ? "B2" : (level === "B2" ? "C1" : "C1")));
  $("kvGoal").textContent = goal;

  // --- token yoksa (ders giriÅŸ kuralÄ±n)
  function showNoTokens(){
    warn.style.display = "block";
    warn.textContent =
`Derse katÄ±labilmeniz iÃ§in hesabÄ±nÄ±zda yeterli jeton bulunmamaktadÄ±r.
LÃ¼tfen jeton yÃ¼kleyerek eÄŸitiminize devam edin.`;
    btnStart.textContent = "Jeton YÃ¼kle";
    btnStart.onclick = ()=>location.href="/pages/profile.html";
  }
  if(tokens <= 0) showNoTokens();

  $("btnBack").onclick = ()=>history.back();

  // --- brifing metni (deÄŸiÅŸkenli)
  const scriptText =
`Selam ${firstName}. Seninle 15 dakika boyunca ${courseName.replace(" Dersi","")} dersinde birlikte Ã§alÄ±ÅŸacaÄŸÄ±z.
15 dakika sonunda devam edebilirsin ya da ara verebilirsin.
Benim sana tavsiyem gÃ¼nde en az 60 dakikalÄ±k derslere katÄ±lmandÄ±r.
Bu sayede seviyeni kÄ±sa sÃ¼rede ${level} seviyesinden ${goal} seviyesine Ã§Ä±kartabiliriz.
Ders harici mutlaka â€œAI ile Pratik Yapâ€ ve â€œEÄŸlenerek Ã–ÄŸrenâ€ oyunlarÄ± ile hem eÄŸlen hem Ã¶ÄŸren.
HazÄ±rsan dersi baÅŸlatabilirsin.`;

  // --- daktilo efekti
  async function typeWrite(text){
    const box = $("typeBox");
    const cursor = `<span class="cursor"></span>`;
    let out = "";
    box.innerHTML = cursor;

    // hÄ±zlÄ± ama â€œAI hissiâ€ veren hÄ±z
    const minDelay = 8, maxDelay = 22;

    for(let i=0;i<text.length;i++){
      out += text[i];
      const safe = out
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");

      box.innerHTML = safe + cursor;

      const ch = text[i];
      let d = minDelay + Math.random()*(maxDelay-minDelay);
      if(ch === "." || ch === "!" || ch === "?") d += 120;
      if(ch === "\n") d += 90;

      await new Promise(r=>setTimeout(r, d));
    }
  }

  // --- TTS (backend: google yoksa openai fallback olacak)
  let currentAudio = null;
  async function speak(text){
    try{
      // aynÄ± anda Ã¼st Ã¼ste basÄ±lÄ±nca karÄ±ÅŸmasÄ±n
      if(currentAudio){
        try{ currentAudio.pause(); }catch{}
        currentAudio = null;
      }

      const r = await fetch(`${API_BASE}/api/tts`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text, lang })
      });

      const j = await r.json().catch(()=>null);
      if(!r.ok || !j){
        throw new Error(`TTS HTTP ${r.status}`);
      }
      if(!j.ok || !j.audio_base64){
        throw new Error(j.error || "TTS_UNAVAILABLE");
      }

      const audio = new Audio("data:audio/mpeg;base64," + j.audio_base64);
      currentAudio = audio;
      await audio.play();
      audio.onended = ()=>{ if(currentAudio===audio) currentAudio=null; };

    }catch(e){
      toast("Ses ÅŸu an kullanÄ±lamÄ±yor");
    }
  }

  // otomatik yaz + oku
  (async ()=>{
    await typeWrite(scriptText);
    await speak(scriptText);
  })();

  $("btnReplay").onclick = ()=>speak(scriptText);

  // --- baÅŸlat
  btnStart.onclick = async ()=>{
    // token kontrolÃ¼ (yeniden)
    try{
      const { data } = await supabase.from("profiles").select("tokens").eq("id", userId).maybeSingle();
      const nowTokens = Number(data?.tokens ?? 0);
      if(nowTokens <= 0){
        showNoTokens();
        return;
      }
    }catch{}

    // ders context (teacher prefs artÄ±k yok)
    try{
      localStorage.setItem("italky_lesson_mins", "15");
      localStorage.setItem("italky_course_lang", lang);
      localStorage.setItem("italky_course_level", level);
      localStorage.setItem("italky_teacher_pref", teacherId);
    }catch{}

    toast("Ders baÅŸlÄ±yorâ€¦");
    setTimeout(()=>location.href="/pages/teacher_course.html", 260);
  };
</script>
</body>
</html>
