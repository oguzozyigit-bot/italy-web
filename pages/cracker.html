<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ITALKY ‚Ä¢ Word Cracker</title>
  <link rel="icon" href="data:," />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    /* --- TEMA: MATRIX HACKER --- */
    :root {
      --bg-deep: #000500;
      --matrix: #00ff41; /* Hacker Ye≈üili */
      --matrix-dim: rgba(0, 255, 65, 0.15);
      --error: #ff1744;
      --text: #ffffff;
      --border: rgba(0, 255, 65, 0.4);
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
    html, body { margin: 0; width: 100%; height: 100%; overflow: hidden; position: fixed; font-family: 'Outfit', sans-serif; background: var(--bg-deep); color: var(--text); display: flex; align-items: center; justify-content: center; }

    /* Arka Plan Efekti */
    .cosmos-bg { position: absolute; inset: 0; background: radial-gradient(circle at center, #001a00 0%, #000 100%); z-index: 0; }
    .grid-lines {
      position: absolute; inset: 0;
      background-image: linear-gradient(var(--matrix-dim) 1px, transparent 1px), linear-gradient(90deg, var(--matrix-dim) 1px, transparent 1px);
      background-size: 30px 30px; opacity: 0.3;
    }

    .mobile-frame {
      width: 100%; max-width: 480px; height: 100%; position: relative; z-index: 10;
      display: flex; flex-direction: column; background: rgba(0, 10, 0, 0.9);
      backdrop-filter: blur(15px); border: 1px solid var(--border); overflow: hidden;
      box-shadow: 0 0 30px var(--matrix-dim);
      transition: box-shadow .2s ease;
    }
    @media(min-width: 520px) { .mobile-frame { height: 92vh; border-radius: 24px; } }

    /* HEADER */
    .header { flex: 0 0 70px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
    .nav-btn { width: 40px; height: 40px; border-radius: 8px; background: rgba(0,255,65,0.1); border: 1px solid var(--border); color: var(--matrix); display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; transition:0.2s; }
    .nav-btn:active { background: var(--matrix); color: #000; }

    .page-title { font-family: 'Share Tech Mono', monospace; font-size: 20px; letter-spacing: 2px; color: var(--matrix); text-shadow: 0 0 10px var(--matrix); }
    .lang-badge { font-size: 10px; padding: 2px 6px; background: var(--matrix); color:#000; border-radius: 4px; margin-left: 8px; vertical-align: middle; }

    /* OYUN ALANI */
    .game-area { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

    /* STATS */
    .stats-bar { display: flex; justify-content: space-between; font-family: 'Share Tech Mono', monospace; color: var(--matrix); font-size: 14px; padding-bottom: 10px; border-bottom: 1px dashed var(--border); }

    /* SORU KARTI (T√úRK√áE) */
    .hint-box {
      width: 100%; padding: 15px;
      background: rgba(0, 255, 65, 0.05);
      border: 1px solid var(--matrix);
      border-radius: 12px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .hint-box::before { content:'HEDEF ANLAM'; position:absolute; top:2px; left:5px; font-size:8px; color:var(--matrix); opacity:0.5; }
    .hint-text { font-size: 20px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; }

    /* SLOTLAR (HEDEF) */
    .slots-container {
      display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; margin: 10px 0; min-height: 60px; align-content: center;
    }
    .slot {
      width: 40px; height: 50px;
      border: 1px solid var(--matrix);
      background: rgba(0,20,0,0.5);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Share Tech Mono', monospace;
      font-size: 28px; font-weight: bold; color: var(--matrix);
      text-shadow: 0 0 5px var(--matrix);
      cursor: pointer; transition: 0.1s; border-radius: 6px;
    }
    .slot.empty { border-color: rgba(0,255,65,0.2); color: transparent; text-shadow: none; animation: pulseBorder 2s infinite; }
    .slot.wrong { border-color: var(--error); color: var(--error); text-shadow: 0 0 10px var(--error); animation: shake 0.4s; }
    @keyframes pulseBorder { 0%{border-color:rgba(0,255,65,0.2)} 50%{border-color:rgba(0,255,65,0.6)} 100%{border-color:rgba(0,255,65,0.2)} }

    /* KLAVYE (KARI≈ûIK HARFLER) */
    .keyboard {
      flex: 1; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-content: center;
    }
    .key-btn {
      width: 48px; height: 48px;
      background: rgba(0, 255, 65, 0.15);
      border: 1px solid var(--matrix);
      border-radius: 8px;
      color: #fff; font-size: 20px; font-weight: bold; font-family: 'Space Grotesk', sans-serif;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 0 rgba(0, 50, 0, 0.8);
      transition: 0.1s;
    }
    .key-btn:active { transform: translateY(4px); box-shadow: none; }
    .key-btn.used { opacity: 0; pointer-events: none; transform: scale(0.5); background: transparent; border-color: rgba(0,255,65,0.1); box-shadow: none; }

    /* MODAL */
    .modal-wrap { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 99; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    .modal-card { width: 85%; max-width: 320px; background: #050505; border: 1px solid var(--matrix); padding: 25px; text-align: center; border-radius: 16px; box-shadow: 0 0 40px var(--matrix-dim); }

    .lang-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
    .lang-btn {
      background: rgba(0,255,65,0.1); border: 1px solid var(--matrix); color: #fff;
      padding: 10px; border-radius: 8px; font-family: 'Share Tech Mono', monospace;
      cursor: pointer; transition: 0.2s;
    }
    .lang-btn:active, .lang-btn:hover { background: var(--matrix); color: #000; box-shadow: 0 0 15px var(--matrix); }

    .btn-main {
      width: 100%; padding: 14px; margin-top: 20px;
      background: var(--matrix); color: #000; font-weight: 900; font-size: 16px;
      border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; font-family: 'Share Tech Mono', monospace;
      box-shadow: 0 0 20px rgba(0,255,65,0.4);
    }
    .btn-sec { background: transparent; border: 1px solid var(--border); color: #fff; margin-top: 10px; box-shadow: none; }

    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
  </style>
</head>
<body>

  <div class="cosmos-bg"><div class="grid-lines"></div></div>

  <div class="mobile-frame" id="frame">
    <div class="header">
      <div class="nav-btn" onclick="location.href='/pages/game.html'">‚Üê</div>
      <div class="page-title">WORD_CRACKER <span id="langBadge" class="lang-badge">EN</span></div>
      <div class="nav-btn" onclick="toggleSound()" id="soundIcon">üîä</div>
    </div>

    <div class="game-area" id="gameScreen" style="display:none">
      <div class="stats-bar">
        <span>SCORE: <span id="scoreVal">0</span></span>
        <span>LIVES: <span id="livesVal">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></span>
      </div>

      <div class="hint-box">
        <div class="hint-text" id="hintText">...</div>
      </div>

      <div class="slots-container" id="slotsArea"></div>

      <div class="keyboard" id="keyboardArea"></div>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <h2 style="color:var(--matrix); font-family:'Share Tech Mono'; margin:0">SYSTEM READY</h2>
      <p style="color:#fff; opacity:0.7; font-size:13px; margin-top:10px">Hedef dili se√ß ve ≈üifreleri √ß√∂z.<br>3 Hata = Sistem Kilitlenir.</p>

      <div class="lang-grid">
        <div class="lang-btn" onclick="selectLang('en')">EN</div>
        <div class="lang-btn" onclick="selectLang('de')">DE</div>
        <div class="lang-btn" onclick="selectLang('fr')">FR</div>
        <div class="lang-btn" onclick="selectLang('es')">ES</div>
        <div class="lang-btn" onclick="selectLang('it')">IT</div>
      </div>
    </div>
  </div>

  <div class="modal-wrap" id="endModal" style="display:none">
    <div class="modal-card">
      <h2 id="endTitle" style="color:var(--matrix); font-family:'Share Tech Mono'">ACCESS DENIED</h2>
      <div id="endDesc" style="color:#fff; opacity:0.9; margin:15px 0; font-size:14px; line-height:1.5;">...</div>

      <button class="btn-main" onclick="restartGame()">RETRY (R)</button>
      <button class="btn-main btn-sec" onclick="location.href='/pages/game.html'">EXIT (X)</button>
    </div>
  </div>

  <script type="module">
    import { loadLangPool, createUsedSet, pick } from "/js/langpool.js";

    /* =========================
       STATE
       ========================= */
    let currentLang = "en";
    let poolCache = null;        // {lang,version,items}
    let runList = [];            // batch kelimeler
    let runIndex = 0;            // batch i√ßi index

    let currentWordObj = null;   // {w,tr,pos,lvl,sentence}
    let targetChars = [];
    let userChars = [];
    let shuffledChars = [];

    let score = 0;
    let lives = 3;
    let isMuted = false;

    // BOSS MODE
    let streak = 0;
    let isBossRound = false;
    const bossEvery = 5;
    const baseDecoys = 2;
    const bossExtraDecoys = 2;

    /* =========================
       UI HELPERS
       ========================= */
    const $ = (id) => document.getElementById(id);

    function updateStats() {
      $("scoreVal").innerText = score;
      let hearts = "";
      for (let i = 0; i < 3; i++) hearts += (i < lives ? "‚ù§Ô∏è" : "üíÄ");
      $("livesVal").innerText = hearts;
    }

    function normalizeCharString(s){
      let t = String(s || "");
      t = t.replace(/√ü/g, "ss").replace(/√Ü/g, "AE").replace(/√¶/g, "ae").replace(/≈í/g, "OE").replace(/≈ì/g, "oe");
      t = t.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      return t.toUpperCase();
    }

    /* =========================
       SES Sƒ∞STEMƒ∞
       ========================= */
    const synth = window.speechSynthesis;
    let audioCtx = null;

    function ensureAudio(){
      if(!audioCtx){
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = AC ? new AC() : null;
      }
      if (audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
      return audioCtx;
    }

    window.toggleSound = function toggleSound() {
      isMuted = !isMuted;
      $("soundIcon").innerText = isMuted ? "üîá" : "üîä";
      if (!isMuted) ensureAudio();
    };

    function playSFX(type) {
      if (isMuted) return;
      const c = ensureAudio();
      if(!c) return;

      const osc = c.createOscillator();
      const gain = c.createGain();
      osc.connect(gain);
      gain.connect(c.destination);

      if (type === "type") {
        osc.frequency.value = 800; osc.type = "square";
        gain.gain.setValueAtTime(0.05, c.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, c.currentTime + 0.05);
        osc.start(); osc.stop(c.currentTime + 0.05);
      } else if (type === "win") {
        osc.type = "sawtooth";
        osc.frequency.setValueAtTime(440, c.currentTime);
        osc.frequency.linearRampToValueAtTime(880, c.currentTime + 0.2);
        gain.gain.setValueAtTime(0.10, c.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, c.currentTime + 0.30);
        osc.start(); osc.stop(c.currentTime + 0.30);
      } else if (type === "error") {
        osc.type = "sawtooth";
        osc.frequency.value = 100;
        gain.gain.setValueAtTime(0.20, c.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, c.currentTime + 0.20);
        osc.start(); osc.stop(c.currentTime + 0.20);
      }
    }

    function pickVoiceFor(langCode){
      try{
        const voices = synth?.getVoices?.() || [];
        if(!voices.length) return null;
        const lc = String(langCode||"").toLowerCase();
        let v = voices.find(x => (x.lang||"").toLowerCase() === lc);
        if(v) return v;
        const short = lc.split("-")[0];
        v = voices.find(x => (x.lang||"").toLowerCase().startsWith(short));
        return v || null;
      }catch{ return null; }
    }

    function speak(text) {
      if (isMuted) return;
      if (!("speechSynthesis" in window) || !("SpeechSynthesisUtterance" in window)) return;

      try {
        synth.cancel();
        const u = new SpeechSynthesisUtterance(String(text || "").trim());
        const langMap = { en: "en-US", de: "de-DE", fr: "fr-FR", es: "es-ES", it: "it-IT" };
        u.lang = langMap[currentLang] || "en-US";
        u.rate = 0.8;

        const v = pickVoiceFor(u.lang);
        if (v) u.voice = v;

        synth.speak(u);
      } catch {}
    }

    try { synth.onvoiceschanged = () => {}; } catch {}

    /* =========================
       LANG POOL / BATCH
       ========================= */
    async function ensureRunList() {
      poolCache = await loadLangPool(currentLang);

      if (!poolCache?.items?.length) {
        alert("Dil havuzu bo≈ü. /assets/lang dosyalarƒ±nƒ± kontrol et.");
        return false;
      }

      const usedKey = `used_wordcracker_${currentLang}`;
      const { used, save } = createUsedSet(usedKey);

      // filtre: 4-8 harf (daha keyifli)
      const filterFn = (it) => {
        const w = normalizeCharString(it.w).replace(/[^A-Z]/g, "");
        return w.length >= 4 && w.length <= 8;
      };

      const picked = pick(poolCache, 30, used, save, filterFn);
      if (!picked.length) {
        alert("Bu dil i√ßin uygun kelime bulunamadƒ±. Havuzu geni≈ület.");
        return false;
      }

      runList = picked.map(it => ({
        w: String(it.w || "").trim(),
        tr: String(it.tr || "").trim(),
        pos: String(it.pos || "").trim(),
        lvl: String(it.lvl || "").trim(),
        sentence: String(it.sentence || "").trim()
      }));

      runIndex = 0;
      return true;
    }

    /* =========================
       Dƒ∞L SE√áƒ∞Mƒ∞ (GLOBAL)
       ========================= */
    window.selectLang = async function selectLang(l) {
      currentLang = l;
      $("langBadge").innerText = l.toUpperCase();

      $("startModal").style.display = "none";
      $("gameScreen").style.display = "flex";

      ensureAudio();

      const ok = await ensureRunList();
      if(!ok) return;

      restartGame();
    };

    /* =========================
       OYUN BA≈ûLATMA (GLOBAL)
       ========================= */
    window.restartGame = function restartGame() {
      $("endModal").style.display = "none";
      score = 0;
      lives = 3;
      streak = 0;
      runIndex = 0;
      updateStats();
      loadLevel();
    };

    /* =========================
       SEVƒ∞YE Y√úKLEME
       ========================= */
    async function loadLevel() {
      // batch bitti ‚Üí yeni batch
      if (runIndex >= runList.length) {
        const ok = await ensureRunList();
        if(!ok) return;
      }

      isBossRound = ((runIndex + 1) % bossEvery === 0);

      currentWordObj = runList[runIndex];
      const rawWord = currentWordObj.w;
      const hint = currentWordObj.tr || "...";

      const hintUpper = String(hint).toUpperCase();
      $("hintText").innerText = isBossRound ? `‚ö†Ô∏è BOSS: ${hintUpper}` : hintUpper;

      // frame glow
      const frame = $("frame");
      if (frame) frame.style.boxShadow = isBossRound
        ? "0 0 55px rgba(0,255,65,0.22)"
        : "0 0 30px rgba(0,255,65,0.15)";

      // hedef kelime: normalize + A-Z
      const cleaned = normalizeCharString(rawWord).replace(/[^A-Z]/g, "");
      targetChars = cleaned.split("");

      userChars = new Array(targetChars.length).fill(null);

      // klavye: hedef harfler + decoy
      const base = targetChars.map((char, idx) => ({ id: `t${idx}`, char }));
      const decoyCount = isBossRound ? (baseDecoys + bossExtraDecoys) : baseDecoys;
      const decoys = makeDecoys(targetChars, decoyCount);

      shuffledChars = base.concat(decoys).sort(() => Math.random() - 0.5);

      renderUI();
    }

    function makeDecoys(targetArr, n){
      const set = new Set(targetArr);
      const common = "ETAOINSHRDLUCMPFGYWBVKXJQZ";
      const out = [];
      let guard = 0;
      while(out.length < n && guard < 300){
        const ch = common[Math.floor(Math.random()*common.length)];
        if(!set.has(ch)){
          set.add(ch);
          out.push({ id: `d${out.length}_${guard}`, char: ch });
        }
        guard++;
      }
      return out;
    }

    /* =========================
       ARAY√úZ √áƒ∞Zƒ∞Mƒ∞
       ========================= */
    function renderUI() {
      const slotsArea = $("slotsArea");
      const keyboardArea = $("keyboardArea");

      // slots
      slotsArea.innerHTML = "";
      userChars.forEach((char, idx) => {
        const slot = document.createElement("div");
        slot.className = char ? "slot" : "slot empty";
        slot.innerText = char ? char.char : "_";

        // boss round'da da geri alabilsin istersen kaldƒ±rma, istemezsen !isBossRound yap
        if (char) slot.onclick = () => removeChar(idx);

        slotsArea.appendChild(slot);
      });

      // keyboard
      keyboardArea.innerHTML = "";
      shuffledChars.forEach((item) => {
        const btn = document.createElement("div");
        const isUsed = userChars.some(u => u && u.id === item.id);
        btn.className = isUsed ? "key-btn used" : "key-btn";
        btn.innerText = item.char;
        btn.onclick = () => typeChar(item);
        keyboardArea.appendChild(btn);
      });
    }

    /* =========================
       OYUN MANTIƒûI
       ========================= */
    function typeChar(item) {
      const emptyIndex = userChars.findIndex(c => c === null);
      if (emptyIndex === -1) return;

      userChars[emptyIndex] = item;
      playSFX("type");
      renderUI();

      if (!userChars.includes(null)) checkWord();
    }

    function removeChar(index) {
      userChars[index] = null;
      playSFX("type");
      renderUI();
    }

    function checkWord() {
      const currentString = userChars.map(u => u.char).join("");
      const targetString = targetChars.join("");

      if (currentString === targetString) {
        playSFX("win");

        const roundBase = 100;
        const bossMulti = isBossRound ? 2 : 1;
        const streakBonus = Math.min(50, streak * 10);
        score += (roundBase * bossMulti) + streakBonus;

        streak++;

        // boss √∂d√ºl√º: +1 can (max 3)
        if (isBossRound) lives = Math.min(3, lives + 1);

        updateStats();

        const say = (currentWordObj.sentence || targetString).trim();
        speak(say);

        setTimeout(() => {
          runIndex++;
          loadLevel();
        }, 900);

      } else {
        // yanlƒ±≈üsa streak kƒ±rƒ±lƒ±r
        streak = 0;

        playSFX("error");
        lives--;
        updateStats();

        const slots = document.querySelectorAll(".slot");
        slots.forEach(s => s.classList.add("wrong"));

        setTimeout(() => {
          slots.forEach(s => s.classList.remove("wrong"));
          userChars.fill(null);
          renderUI();
          if (lives <= 0) endGame();
        }, 500);
      }
    }

    /* =========================
       OYUN SONU
       ========================= */
    function endGame() {
      $("endModal").style.display = "flex";
      $("endTitle").innerText = "SYSTEM FAILURE";

      const correctWordRaw = (currentWordObj?.w || "").trim();
      const correctWordClean = normalizeCharString(correctWordRaw).replace(/[^A-Z]/g,"");

      $("endDesc").innerHTML = `
        Toplam Puan: <strong style="color:#00ff41">${score}</strong><br>
        SON STREAK: <strong style="color:#00ff41">${streak}</strong><br><br>
        DOƒûRU KELƒ∞ME:<br>
        <strong style="color:#fff; font-size:24px; letter-spacing:2px">${correctWordClean}</strong>
      `;

      speak(correctWordRaw);
    }
  </script>
</body>
</html>
