<!-- FILE: /pages/practice_ai_session.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI ‚Ä¢ AI Pratik Oturumu</title>

  <meta name="theme-color" content="#02000f">
  <style>html,body{background:#02000f !important;}</style>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --border: rgba(255,255,255,0.12);
      --card: rgba(255,255,255,0.05);
      --muted: rgba(255,255,255,0.70);
      --ok: rgba(34,197,94,0.95);
      --bad: rgba(255,90,140,0.95);
      --aiGrad: linear-gradient(135deg,#a5b4fc 0%,#6366f1 50%,#ec4899 100%);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
    #pageContent{ height:100%; }

    .wrap{
      position:relative;
      max-width:480px;
      height:100%;
      margin:0 auto;
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      background: rgba(10,10,30,0.18);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 26px;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
    }

    .topbar{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .chip{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.92);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
      display:flex; gap:8px; align-items:center;
    }
    .chip .ai{
      background: var(--aiGrad);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      font-weight:1000;
    }

    .panel{
      flex:1;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: var(--card);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
      position: relative;
    }

    .panel:before{
      content:"";
      position:absolute; inset:-30%;
      background:
        radial-gradient(circle at 20% 20%, rgba(99,102,241,.25) 0%, transparent 45%),
        radial-gradient(circle at 80% 30%, rgba(236,72,153,.18) 0%, transparent 42%),
        radial-gradient(circle at 50% 80%, rgba(168,85,247,.16) 0%, transparent 45%);
      filter: blur(34px);
      opacity:.85;
      animation: drift 10s ease-in-out infinite alternate;
      pointer-events:none;
    }
    @keyframes drift{
      from{ transform: translate3d(-10px,-8px,0) scale(1); }
      to{ transform: translate3d(10px,8px,0) scale(1.06); }
    }
    .panel > *{ position:relative; z-index:2; }

    .titleRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .h{
      font-family:"Space Grotesk",system-ui,sans-serif;
      font-weight:1000;
      font-size:14px;
      margin:0;
      color:#fff;
      letter-spacing:-.2px;
    }
    .lvl{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      font-weight: 1000;
      font-size: 12px;
      color: rgba(165,180,252,0.95);
      white-space: nowrap;
    }

    .miniRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top: -2px;
    }
    .miniBtn{
      flex:1;
      height: 44px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .miniBtn:active{ transform: scale(.99); }
    .miniBtn.primary{
      background: var(--aiGrad);
      color:#000;
      border:none;
    }

    .sentenceBox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding: 12px;
      min-height: 112px;
    }
    .sentence{
      font-size: 16px;
      font-weight: 1000;
      line-height: 1.35;
      color:#fff;
      white-space: pre-wrap;
    }
    .hint{
      margin-top: 8px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,0.70);
      line-height:1.35;
    }
    .hint b{ color:#fff; }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .btn{
      height: 52px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      padding: 0 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
    }
    .btn:disabled{ opacity:.35; cursor:not-allowed; }

    .btn-primary{
      background:#fff;
      color:#000;
      border:none;
    }

    .mic{
      width: 52px; min-width:52px;
      height: 52px;
      border-radius: 18px;
      border: none;
      background: var(--aiGrad);
      color:#000;
      font-weight:1000;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 30px rgba(99,102,241,0.25);
    }
    .mic:active{ transform: scale(.99); }
    .mic.rec{
      background: linear-gradient(135deg, rgba(255,90,140,1) 0%, rgba(236,72,153,1) 60%, rgba(165,180,252,1) 100%);
    }

    .statusBox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      padding: 12px;
      min-height: 92px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .statusBox::-webkit-scrollbar{ display:none; }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .k{
      font-size: 11px;
      font-weight: 900;
      color: rgba(255,255,255,0.55);
      letter-spacing:.5px;
      text-transform: uppercase;
    }
    .v{
      font-size: 12px;
      font-weight: 1000;
      color:#fff;
      text-align:right;
      max-width: 65%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .v.ok{ color: var(--ok); }
    .v.bad{ color: var(--bad); }

    .trans{
      margin-top: 8px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,0.82);
      white-space: pre-wrap;
      line-height: 1.45;
    }
    .trans .muted{ color: rgba(255,255,255,0.60); }

    .toast{
      position: fixed;
      left:50%;
      top:18px;
      transform: translateX(-50%) translateY(-120px);
      background: rgba(10,10,18,0.95);
      border: 1px solid rgba(165,180,252,0.35);
      padding: 10px 14px;
      border-radius: 999px;
      color:#fff;
      z-index: 999999;
      font-weight: 1000;
      font-size: 12px;
      transition: .25s;
      backdrop-filter: blur(12px);
      pointer-events:none;
      max-width: min(92vw, 520px);
      text-align:center;
    }
    .toast.show{ transform: translateX(-50%) translateY(0); }
  </style>
</head>

<body>
  <main id="pageContent">
    <div class="wrap">
      <div class="topbar">
        <div class="chip"><span class="ai">AI</span> Pratik</div>
        <div class="chip" id="chipRight">‚Äî</div>
      </div>

      <section class="panel">
        <div class="titleRow">
          <h2 class="h" id="langTitle">‚Äî</h2>
          <div class="lvl" id="levelPill">‚Äî</div>
        </div>

        <div class="miniRow">
          <button class="miniBtn" id="btnListenTop" type="button">üîä Dinlet</button>
          <button class="miniBtn" id="btnMeaningTop" type="button">üìù Anlam</button>
          <button class="miniBtn primary" id="btnSkipTop" type="button">‚ú® Ge√ß</button>
        </div>

        <div class="sentenceBox">
          <div class="sentence" id="sentence">Y√ºkleniyor‚Ä¶</div>
          <div class="hint" id="hint">‚Äî</div>
        </div>

        <div class="actions">
          <button class="btn" id="btnPlay" type="button">üîä Dinlet</button>
          <button class="mic" id="btnRec" type="button" title="Kayƒ±t">üéôÔ∏è</button>
          <button class="btn btn-primary" id="btnNext" type="button" disabled>Sonraki</button>
        </div>

        <div class="statusBox">
          <div class="row">
            <div class="k">Tanƒ±ma</div>
            <div class="v" id="sttStatus">Hazƒ±r</div>
          </div>
          <div class="row">
            <div class="k">Benzerlik</div>
            <div class="v" id="simStatus">‚Äî</div>
          </div>
          <div class="trans" id="transBox">
            <span class="muted">Anlamƒ± g√∂rmek i√ßin</span> ‚ÄúAnlam‚Äù <span class="muted">butonuna bas.</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnRepeat" type="button">‚Üª Tekrar</button>
          <button class="btn" id="btnExit" type="button">√áƒ±k</button>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { mountShell } from "/js/ui_shell.js";
    import { supabase } from "/js/supabase_client.js";

    mountShell({ scroll:"none" });

    const API_BASE = "https://italky-api.onrender.com";
    const PRACTICE_POOL_BASE = "https://auth.italky.ai/storage/v1/object/public/practice/pool";

    const $ = (id)=>document.getElementById(id);
    const toastEl = $("toast");

    function toast(msg){
      toastEl.textContent = String(msg||"");
      toastEl.classList.add("show");
      clearTimeout(window.__to);
      window.__to = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function qs(k){ return new URLSearchParams(location.search).get(k); }

    const lang = String(qs("lang") || "en").trim().toLowerCase();
    const levelQ = String(qs("level") || "").trim().toUpperCase();

    const LANG_META = {
      en:{ name:"English",  flag:"üá¨üáß" },
      de:{ name:"German",   flag:"üá©üá™" },
      fr:{ name:"French",   flag:"üá´üá∑" },
      it:{ name:"Italian",  flag:"üáÆüáπ" },
      ru:{ name:"Russian",  flag:"üá∑üá∫" },
      es:{ name:"Spanish",  flag:"üá™üá∏" },
    };
    const meta = LANG_META[lang] || { name: lang.toUpperCase(), flag:"üåç" };
    $("chipRight").textContent = `${meta.flag} ${lang.toUpperCase()}`;
    $("langTitle").textContent = `${meta.name} ‚Ä¢ Konu≈üma Pratiƒüi`;

    // auth check + profile
    const { data:{ session } } = await supabase.auth.getSession();
    if(!session?.user){
      location.replace("/pages/login.html");
      throw new Error("no session");
    }
    const userId = session.user.id;

    let fullName = "";
    let levels = {};
    try{
      const { data: prof } = await supabase
        .from("profiles")
        .select("full_name, levels")
        .eq("id", userId)
        .maybeSingle();
      fullName = String(prof?.full_name || "").trim();
      levels = (prof?.levels && typeof prof.levels === "object") ? prof.levels : {};
    }catch{}

    function firstName(full){
      const s = String(full||"").trim();
      if(!s) return "";
      const parts = s.split(/\s+/).filter(Boolean);
      if(parts.length <= 2) return s;
      return parts.slice(0, -1).join(" ");
    }
    const who = firstName(fullName) || "Oƒüuz";

    function pickLevel(lv){
      if(["A1","A2","B1","B2","C1"].includes(lv)) return lv;
      return "A1";
    }
    const level = pickLevel(levelQ || (levels?.[lang] || "A1"));
    $("levelPill").textContent = `Seviye: ${level}`;

    // ‚úÖ %95 kuralƒ±
    const THRESH = 0.95;

    async function loadPool(){
      const url = `${PRACTICE_POOL_BASE}/${encodeURIComponent(lang)}.json`;
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`practice pool yok: ${lang}.json (HTTP ${r.status})\n${t}`);
      }
      const j = await r.json().catch(()=>null);
      if(!j) throw new Error("practice pool json okunamadƒ±");
      if(j.levels && typeof j.levels === "object") return j.levels;
      return j;
    }

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function pickFromPool(pool, lv){
      const byLevel = pool?.[lv];
      if(Array.isArray(byLevel) && byLevel.length) return byLevel;
      const a1 = pool?.A1;
      if(Array.isArray(a1) && a1.length) return a1;
      for(const k of ["A2","B1","B2","C1"]){
        if(Array.isArray(pool?.[k]) && pool[k].length) return pool[k];
      }
      return [];
    }

    // ‚úÖ item normalize: string veya object
    function normalizeItem(item){
      if(typeof item === "string") return { text: item, tr: "" };
      if(item && typeof item === "object"){
        const text = String(item.text || item.sentence || item.phrase || item.value || "").trim();
        const tr = String(item.tr || item.meaning_tr || item.meaning || item.translation_tr || "").trim();
        return { text, tr };
      }
      return { text:"", tr:"" };
    }

    function normText(s){
      return String(s||"")
        .toLowerCase()
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^\p{L}\p{N}\s']/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function levenshtein(a, b){
      a = normText(a); b = normText(b);
      const m = a.length, n = b.length;
      if(!m && !n) return 0;
      const dp = Array.from({length:m+1}, ()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i;
      for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }

    function similarity(a, b){
      a = normText(a); b = normText(b);
      if(!a && !b) return 1;
      const dist = levenshtein(a,b);
      const maxLen = Math.max(a.length, b.length) || 1;
      return Math.max(0, 1 - (dist / maxLen));
    }

    function setSimilarityUI(sim){
      const pct = Math.round(sim * 100);
      if(sim >= THRESH){
        $("simStatus").textContent = `%${pct} ‚Ä¢ Ba≈üarƒ±lƒ±`;
        $("simStatus").className = "v ok";
        $("btnNext").disabled = false;

        // otomatik sonraki
        setTimeout(()=>{
          try{ if(!$("btnNext").disabled) $("btnNext").click(); }catch{}
        }, 650);

      }else{
        $("simStatus").textContent = `%${pct} ‚Ä¢ Tekrar`;
        $("simStatus").className = "v bad";
        $("btnNext").disabled = true;
      }
    }

    function setGreeting(){
      const greet = {
        en: `Hello <b>${who}</b>! You are <b>${level}</b>. Tap <b>Dinlet</b>, then repeat.`,
        de: `Hallo <b>${who}</b>! Du bist <b>${level}</b>. Erst <b>Dinlet</b>, dann wiederholen.`,
        fr: `Salut <b>${who}</b> ! Niveau <b>${level}</b>. D‚Äôabord <b>Dinlet</b>, puis r√©p√®te.`,
        it: `Ciao <b>${who}</b>! Livello <b>${level}</b>. Prima <b>Dinlet</b>, poi ripeti.`,
        es: `Hola <b>${who}</b>! Nivel <b>${level}</b>. Primero <b>Dinlet</b>, luego repite.`,
        ru: `–ü—Ä–∏–≤–µ—Ç, <b>${who}</b>! –£—Ä–æ–≤–µ–Ω—å <b>${level}</b>. –ù–∞–∂–º–∏ <b>Dinlet</b>, –∑–∞—Ç–µ–º –ø–æ–≤—Ç–æ—Ä–∏.`
      };
      $("hint").innerHTML = greet[lang] || `Selam <b>${who}</b>! ≈ûu an <b>${level}</b>. Dinlet ‚Üí tekrar et.`;
    }

    function setSentenceUI(text){
      $("sentence").textContent = text || "‚Äî";
      $("sttStatus").textContent = "Hazƒ±r";
      $("simStatus").textContent = "‚Äî";
      $("simStatus").className = "v";
      $("btnNext").disabled = true;
      $("transBox").innerHTML = `<span class="muted">Anlam i√ßin</span> ‚ÄúAnlam‚Äù <span class="muted">butonuna bas.</span>`;
    }

    // session queue (no repeats within session)
    let sessionQueue = [];
    let sessionIndex = 0;

    // current item
    let currentText = "";
    let currentTR = "";

    function nextSentence(){
      if(sessionIndex >= sessionQueue.length){
        sessionQueue = shuffle(sessionQueue);
        sessionIndex = 0;
      }
      const it = normalizeItem(sessionQueue[sessionIndex]);
      sessionIndex++;

      currentText = it.text;
      currentTR = it.tr;

      setSentenceUI(currentText);
    }

    // ---- TTS ----
    async function ttsSpeak(text){
      const r = await fetch(`${API_BASE}/api/tts`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text, lang })
      });

      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`TTS HTTP ${r.status} ${t}`);
      }

      const j = await r.json().catch(()=>null);
      if(!j?.ok || !j?.audio_base64){
        throw new Error(j?.error || "TTS_UNAVAILABLE");
      }

      const src = "data:audio/mpeg;base64," + j.audio_base64;
      const audio = new Audio(src);
      await audio.play();
      return true;
    }

    // ---- STT ----
    let mediaStream = null;
    let recorder = null;
    let chunks = [];
    let recording = false;

    async function ensureMic(){
      if(mediaStream) return mediaStream;
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      return mediaStream;
    }

    function pickMime(){
      const candidates = [
        "audio/webm;codecs=opus","audio/webm",
        "audio/ogg;codecs=opus","audio/ogg"
      ];
      for(const c of candidates){
        if(window.MediaRecorder?.isTypeSupported && MediaRecorder.isTypeSupported(c)) return c;
      }
      return "";
    }

    async function sttSend(blob){
      const fd = new FormData();
      fd.append("file", blob, "speech.webm");
      fd.append("lang", lang);

      const r = await fetch(`${API_BASE}/api/stt`, { method:"POST", body: fd });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`STT HTTP ${r.status} ${t}`);
      }
      const j = await r.json().catch(()=>null);
      const text = (j?.text || j?.transcript || j?.result || "").toString().trim();
      if(!text) throw new Error("STT bo≈ü d√∂nd√º");
      return text;
    }

    async function startRec(){
      await ensureMic();
      chunks = [];
      const mime = pickMime();
      recorder = new MediaRecorder(mediaStream, mime ? { mimeType: mime } : undefined);

      recorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) chunks.push(e.data); };
      recorder.onstop = async ()=>{
        try{
          const blob = new Blob(chunks, { type: chunks[0]?.type || "audio/webm" });
          $("sttStatus").textContent = "√á√∂z√ºmleniyor‚Ä¶";
          const text = await sttSend(blob);
          $("sttStatus").textContent = text;

          const sim = similarity(text, currentText);
          setSimilarityUI(sim);
        }catch(err){
          $("sttStatus").textContent = "STT hata";
          toast(err?.message || String(err));
          $("btnNext").disabled = true;
          $("simStatus").textContent = "‚Äî";
          $("simStatus").className = "v";
        } finally {
          recording = false;
          $("btnRec").classList.remove("rec");
          $("btnRec").textContent = "üéôÔ∏è";
        }
      };

      recording = true;
      $("btnRec").classList.add("rec");
      $("btnRec").textContent = "‚è∫";
      $("sttStatus").textContent = "Dinliyorum‚Ä¶";
      $("simStatus").textContent = "‚Äî";
      $("simStatus").className = "v";
      $("btnNext").disabled = true;

      recorder.start();
    }

    function stopRec(){
      try{ if(recorder && recorder.state !== "inactive") recorder.stop(); }catch{}
    }

    // ---- Meaning ----
    async function translateMeaning(){
      // 1) havuzda TR varsa direkt g√∂ster
      if(currentTR){
        $("transBox").textContent = currentTR;
        return;
      }

      // 2) yoksa translate_ai
      const payload = { text: currentText, source_lang: lang, target_lang: "tr" };
      try{
        $("transBox").innerHTML = `<span class="muted">√áeviriliyor‚Ä¶</span>`;
        const r = await fetch(`${API_BASE}/api/translate_ai`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(!r.ok){
          const t = await r.text().catch(()=> "");
          throw new Error(`Translate HTTP ${r.status} ${t}`);
        }
        const j = await r.json().catch(()=>null);
        const out = (j?.text || j?.translation || j?.result || "").toString().trim();
        if(!out) throw new Error("√áeviri bo≈ü d√∂nd√º");
        $("transBox").textContent = out;
      }catch(e){
        $("transBox").innerHTML = `<span class="muted">√áeviri ≈üu an kullanƒ±lamƒ±yor.</span>`;
        toast(e?.message || String(e));
      }
    }

    // ---- Buttons ----
    async function playNow(){
      try{
        $("btnPlay").disabled = true;
        $("btnListenTop").disabled = true;
        await ttsSpeak(currentText);
      }catch(e){
        toast(e?.message || String(e));
      }finally{
        $("btnPlay").disabled = false;
        $("btnListenTop").disabled = false;
      }
    }

    $("btnPlay").onclick = playNow;
    $("btnListenTop").onclick = playNow;

    $("btnMeaningTop").onclick = translateMeaning;
    $("btnMeaningTop").addEventListener("touchend", (e)=>{ e.preventDefault(); translateMeaning(); }, {passive:false});

    $("btnSkipTop").onclick = ()=>{
      // ‚ÄúGe√ß‚Äù = sonraki c√ºmle (sadece havuz akƒ±≈üƒ±)
      $("btnNext").disabled = false;
      $("btnNext").click();
    };

    $("btnRepeat").onclick = async ()=>{
      $("btnNext").disabled = true;
      $("sttStatus").textContent = "Hazƒ±r";
      $("simStatus").textContent = "‚Äî";
      $("simStatus").className = "v";
      await playNow();
    };

    $("btnRec").onclick = async ()=>{
      try{
        if(!recording) await startRec();
        else stopRec();
      }catch(e){
        recording = false;
        $("btnRec").classList.remove("rec");
        $("btnRec").textContent = "üéôÔ∏è";
        toast(e?.message || String(e));
      }
    };

    $("btnNext").onclick = ()=>{
      nextSentence();
      setTimeout(()=>{ try{ playNow(); }catch{} }, 250);
    };

    $("btnExit").onclick = ()=>location.href="/pages/practice_ai.html";

    // ---- init ----
    try{
      setGreeting();
      $("sentence").textContent = "Havuz y√ºkleniyor‚Ä¶";

      const pool = await loadPool();
      const raw = pickFromPool(pool, level);

      sessionQueue = shuffle(raw).slice(0, Math.max(60, Math.min(200, raw.length)));
      sessionIndex = 0;

      if(!sessionQueue.length) throw new Error("Havuz bo≈ü g√∂r√ºn√ºyor.");

      nextSentence();
      setTimeout(()=>{ try{ playNow(); }catch{} }, 350);

    }catch(e){
      $("sentence").textContent = "Havuz y√ºklenemedi.";
      toast(e?.message || String(e));
      $("btnPlay").disabled = true;
      $("btnListenTop").disabled = true;
      $("btnRec").disabled = true;
      $("btnNext").disabled = true;
    }
  </script>
</body>
</html>
