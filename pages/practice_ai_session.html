<!-- FILE: /pages/practice_ai_session.html -->
<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<title>italkyAI ‚Ä¢ AI Pratik Oturumu</title>

<meta name="theme-color" content="#02000f">
<style>html,body{background:#02000f!important;margin:0}</style>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

<style>
:root{
  --border:rgba(255,255,255,.12);
  --card:rgba(255,255,255,.05);
  --ok:#22c55e;
  --bad:#ff5a8c;
  --ai:linear-gradient(135deg,#a5b4fc 0%,#6366f1 50%,#ec4899 100%);
}
*{box-sizing:border-box;font-family:'Outfit',sans-serif;color:#fff}
.wrap{
  max-width:480px;margin:auto;height:100vh;padding:14px;
  display:flex;flex-direction:column;gap:14px;
}
.panel{
  flex:1;border-radius:22px;
  background:var(--card);border:1px solid var(--border);
  padding:14px;display:flex;flex-direction:column;gap:14px;
}
.topbar{display:flex;justify-content:space-between}
.chip{padding:8px 12px;border-radius:999px;background:#0003;border:1px solid var(--border);font-weight:900;font-size:12px}
.ai{background:var(--ai);-webkit-background-clip:text;-webkit-text-fill-color:transparent}

.sentenceBox{background:#0004;border-radius:18px;padding:14px;min-height:90px}
.sentence{font-size:16px;font-weight:900}

.actions{display:flex;gap:10px}
.btn,.mic{
  height:52px;border-radius:18px;font-weight:900;cursor:pointer;
  border:1px solid var(--border);background:#fff1;padding:0 14px;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.btn-primary{background:#fff;color:#000;border:none}
.mic{background:var(--ai);color:#000;width:52px;min-width:52px}
.mic.rec{background:linear-gradient(135deg,#ff5a8c,#ec4899)}

.statusBox{background:#0003;border-radius:18px;padding:12px}
.row{display:flex;justify-content:space-between;margin-bottom:8px;font-size:12px;font-weight:900}
.v.ok{color:var(--ok)}
.v.bad{color:var(--bad)}
.toast{
 position:fixed;top:20px;left:50%;transform:translateX(-50%);
 background:#000c;padding:10px 16px;border-radius:999px;
 border:1px solid var(--border);font-size:12px;font-weight:900;
 display:none
}
.toast.show{display:block}
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="chip"><span class="ai">AI</span> Pratik</div>
    <div class="chip" id="langChip">‚Äî</div>
  </div>

  <div class="panel">
    <div class="sentenceBox">
      <div class="sentence" id="sentence">Y√ºkleniyor‚Ä¶</div>
    </div>

    <div class="actions">
      <button class="btn" id="btnPlay">üîä Dinlet</button>
      <button class="mic" id="btnRec">üéôÔ∏è</button>
      <button class="btn btn-primary" id="btnNext" disabled>Sonraki</button>
    </div>

    <div class="statusBox">
      <div class="row">
        <div>Tanƒ±ma</div>
        <div id="sttStatus">Hazƒ±r</div>
      </div>
      <div class="row">
        <div>Benzerlik</div>
        <div id="simStatus">‚Äî</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="btnRepeat">‚Üª Tekrar</button>
      <button class="btn" id="btnExit">√áƒ±k</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { mountShell } from "/js/ui_shell.js";
import { supabase } from "/js/supabase_client.js";
mountShell({scroll:"none"});

const API_BASE="https://italky-api.onrender.com";
const $=id=>document.getElementById(id);
const toast=(m)=>{const t=$("toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1500);};

const params=new URLSearchParams(location.search);
const lang=params.get("lang")||"en";
const level=(params.get("level")||"A1").toUpperCase();

$("langChip").textContent=`${lang.toUpperCase()} ‚Ä¢ ${level}`;

const THRESH={A1:.70,A2:.75,B1:.78,B2:.82,C1:.85};
const threshold=THRESH[level]||.75;

let pool=[];
let used=[];
let current="";
let autoNextTimer=null;
const AUTO_NEXT_MS=2200;

function cancelAutoNext(){ if(autoNextTimer) clearTimeout(autoNextTimer); autoNextTimer=null; }

async function loadPool(){
  const r=await fetch(`https://auth.italky.ai/storage/v1/object/public/practice/${lang}_${level}.json`);
  const j=await r.json();
  pool=j.sentences||[];
}
function nextSentence(){
  cancelAutoNext();
  if(used.length>=pool.length) used=[];
  const remaining=pool.filter(x=>!used.includes(x));
  current=remaining[Math.floor(Math.random()*remaining.length)];
  used.push(current);
  $("sentence").textContent=current;
  $("btnNext").disabled=true;
  $("simStatus").textContent="‚Äî";
  $("sttStatus").textContent="Hazƒ±r";
  setTimeout(()=>$("btnPlay").click(),300);
}

function norm(s){return s.toLowerCase().replace(/[^\p{L}\p{N}\s']/gu," ").replace(/\s+/g," ").trim();}
function levenshtein(a,b){
  a=norm(a);b=norm(b);
  const m=a.length,n=b.length;
  const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++)dp[i][0]=i;
  for(let j=0;j<=n;j++)dp[0][j]=j;
  for(let i=1;i<=m;i++)
    for(let j=1;j<=n;j++)
      dp[i][j]=Math.min(
        dp[i-1][j]+1,
        dp[i][j-1]+1,
        dp[i-1][j-1]+(a[i-1]==b[j-1]?0:1)
      );
  return dp[m][n];
}
function similarity(a,b){
  const dist=levenshtein(a,b);
  const max=Math.max(norm(a).length,norm(b).length)||1;
  return 1-(dist/max);
}

function setSimilarityUI(sim){
  cancelAutoNext();
  const pct=Math.round(sim*100);
  if(sim>=threshold){
    $("simStatus").textContent=`%${pct} ‚Ä¢ Ba≈üarƒ±lƒ±`;
    $("simStatus").className="v ok";
    $("btnNext").disabled=false;
    autoNextTimer=setTimeout(()=>{$("btnNext").click();},AUTO_NEXT_MS);
  }else{
    $("simStatus").textContent=`%${pct} ‚Ä¢ Tekrar`;
    $("simStatus").className="v bad";
    $("btnNext").disabled=true;
  }
}

async function ttsSpeak(text){
  const r=await fetch(`${API_BASE}/api/tts`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text,lang})
  });
  const blob=await r.blob();
  const url=URL.createObjectURL(blob);
  const audio=new Audio(url);
  audio.play();
}

let mediaStream=null,recorder=null,chunks=[],recording=false;

async function startRec(){
  cancelAutoNext();
  mediaStream=await navigator.mediaDevices.getUserMedia({audio:true});
  recorder=new MediaRecorder(mediaStream);
  chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=async()=>{
    const blob=new Blob(chunks,{type:"audio/webm"});
    const fd=new FormData();
    fd.append("file",blob);
    fd.append("lang",lang);
    const r=await fetch(`${API_BASE}/api/stt`,{method:"POST",body:fd});
    const j=await r.json();
    const text=j.text||"";
    $("sttStatus").textContent=text;
    const sim=similarity(text,current);
    setSimilarityUI(sim);
    recording=false;
    $("btnRec").classList.remove("rec");
  };
  recorder.start();
  recording=true;
  $("btnRec").classList.add("rec");
}
function stopRec(){if(recorder)recorder.stop();}

$("btnPlay").onclick=()=>{cancelAutoNext();ttsSpeak(current);}
$("btnRepeat").onclick=()=>{cancelAutoNext();ttsSpeak(current);}
$("btnRec").onclick=()=>recording?stopRec():startRec();
$("btnNext").onclick=()=>{cancelAutoNext();nextSentence();}
$("btnExit").onclick=()=>{cancelAutoNext();location.href="/pages/practice_ai.html";}

await loadPool();
nextSentence();
</script>
</body>
</html>
