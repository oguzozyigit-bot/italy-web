<!-- FILE: /pages/practice_ai_session.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI â€¢ AI Pratik Oturumu</title>

  <meta name="theme-color" content="#02000f">
  <style>html,body{background:#02000f !important;}</style>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --border: rgba(255,255,255,0.12);
      --card: rgba(255,255,255,0.06);
      --muted: rgba(255,255,255,0.70);
      --ok: rgba(34,197,94,0.95);
      --bad: rgba(255,90,140,0.95);
      --aiGrad: linear-gradient(135deg,#a5b4fc 0%,#6366f1 50%,#ec4899 100%);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
    #pageContent{ height:100%; }

    .wrap{
      position:relative;
      max-width:480px;
      height:100%;
      margin:0 auto;
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      background: rgba(10,10,30,0.18);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 26px;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
    }

    .topbar{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .chip{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.92);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
      display:flex; gap:8px; align-items:center;
    }
    .chip .ai{
      background: var(--aiGrad);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      font-weight:1000;
    }

    .panel{
      flex:1;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: var(--card);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
      position: relative;
    }

    .panel:before{
      content:"";
      position:absolute; inset:-30%;
      background:
        radial-gradient(circle at 20% 20%, rgba(99,102,241,.25) 0%, transparent 45%),
        radial-gradient(circle at 80% 30%, rgba(236,72,153,.18) 0%, transparent 42%),
        radial-gradient(circle at 50% 80%, rgba(168,85,247,.16) 0%, transparent 45%);
      filter: blur(34px);
      opacity:.85;
      animation: drift 10s ease-in-out infinite alternate;
      pointer-events:none;
    }
    @keyframes drift{
      from{ transform: translate3d(-10px,-8px,0) scale(1); }
      to{ transform: translate3d(10px,8px,0) scale(1.06); }
    }
    .panel > *{ position:relative; z-index:2; }

    .titleRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .h{
      font-family:"Space Grotesk",system-ui,sans-serif;
      font-weight:1000;
      font-size:14px;
      margin:0;
      color:#fff;
      letter-spacing:-.2px;
    }
    .lvl{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      font-weight: 1000;
      font-size: 12px;
      color: rgba(165,180,252,0.95);
      white-space: nowrap;
    }

    .greetBox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,0.85);
      line-height: 1.45;
    }
    .greetBox b{
      background: var(--aiGrad);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    .sentenceBox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding: 12px;
      min-height: 120px;
    }
    .sentence{
      font-size: 16px;
      font-weight: 1000;
      line-height: 1.35;
      color:#fff;
      white-space: pre-wrap;
    }
    .hint{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 900;
      color: rgba(255,255,255,0.62);
      line-height:1.35;
    }

    .actions{ display:flex; gap:10px; align-items:center; justify-content:space-between; }

    .btn{
      height: 52px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      padding: 0 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      flex:1;
    }
    .btn:disabled{ opacity:.35; cursor:not-allowed; }

    .btn-primary{
      background:#fff;
      color:#000;
      border:none;
    }

    .btn-sound{
      background: rgba(255,255,255,0.08);
      border-color: rgba(165,180,252,0.35);
      position:relative;
      overflow:hidden;
    }
    .btn-sound:before{
      content:"";
      position:absolute; inset:-60%;
      background: conic-gradient(from 0deg, rgba(165,180,252,.0), rgba(165,180,252,.35), rgba(236,72,153,.0));
      animation: spin 1.8s linear infinite;
      opacity:.75;
    }
    .btn-sound span{ position:relative; z-index:2; }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .mic{
      width: 52px; min-width:52px;
      height: 52px;
      border-radius: 18px;
      border: none;
      background: var(--aiGrad);
      color:#000;
      font-weight:1000;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 30px rgba(99,102,241,0.25);
      flex:0 0 auto;
    }
    .mic:active{ transform: scale(.99); }
    .mic.rec{
      background: linear-gradient(135deg, rgba(255,90,140,1) 0%, rgba(236,72,153,1) 60%, rgba(165,180,252,1) 100%);
    }

    .statusBox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      padding: 12px;
      min-height: 92px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .statusBox::-webkit-scrollbar{ display:none; }

    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 8px; }
    .k{ font-size: 11px; font-weight: 900; color: rgba(255,255,255,0.55); letter-spacing:.5px; text-transform: uppercase; }
    .v{ font-size: 12px; font-weight: 1000; color:#fff; text-align:right; max-width: 65%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .v.ok{ color: var(--ok); }
    .v.bad{ color: var(--bad); }

    .trans{
      margin-top: 8px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,0.82);
      white-space: pre-wrap;
      line-height: 1.45;
    }
    .trans .muted{ color: rgba(255,255,255,0.60); }

    .toast{
      position: fixed;
      left:50%;
      top:18px;
      transform: translateX(-50%) translateY(-120px);
      background: rgba(10,10,18,0.95);
      border: 1px solid rgba(165,180,252,0.35);
      padding: 10px 14px;
      border-radius: 999px;
      color:#fff;
      z-index: 999999;
      font-weight: 1000;
      font-size: 12px;
      transition: .25s;
      backdrop-filter: blur(12px);
      pointer-events:none;
      max-width: min(92vw, 520px);
      text-align:center;
    }
    .toast.show{ transform: translateX(-50%) translateY(0); }

    @media (max-height: 740px){
      .sentence{ font-size: 15px; }
      .sentenceBox{ min-height: 100px; }
      .btn{ height: 50px; }
      .mic{ width:50px; min-width:50px; height:50px; }
    }
  </style>
</head>

<body>
  <main id="pageContent">
    <div class="wrap">
      <div class="topbar">
        <div class="chip"><span class="ai">AI</span> Pratik</div>
        <div class="chip" id="chipRight">â€”</div>
      </div>

      <section class="panel">
        <div class="titleRow">
          <h2 class="h" id="langTitle">â€”</h2>
          <div class="lvl" id="levelPill">â€”</div>
        </div>

        <div class="greetBox" id="greetBox">â€”</div>

        <div class="sentenceBox">
          <div class="sentence" id="sentence">Havuz yÃ¼kleniyorâ€¦</div>
          <div class="hint" id="hint">1) Dinlet  2) Mikrofon  3) Benzerlik geÃ§erse Sonraki</div>
        </div>

        <div class="actions">
          <button class="btn btn-sound" id="btnPlay" type="button"><span>ğŸ”Š Dinlet</span></button>
          <button class="mic" id="btnRec" type="button" title="KayÄ±t">ğŸ™ï¸</button>
          <button class="btn btn-primary" id="btnNext" type="button" disabled>Sonraki</button>
        </div>

        <div class="statusBox">
          <div class="row">
            <div class="k">TanÄ±ma</div>
            <div class="v" id="sttStatus">HazÄ±r</div>
          </div>
          <div class="row">
            <div class="k">Benzerlik</div>
            <div class="v" id="simStatus">â€”</div>
          </div>
          <div class="trans" id="transBox">
            <span class="muted">Anlam iÃ§in</span> â€œğŸ“ Anlamâ€ <span class="muted">butonuna bas.</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnMeaning" type="button">ğŸ“ Anlam</button>
          <button class="btn" id="btnRepeat" type="button">â†» Tekrar</button>
          <button class="btn" id="btnExit" type="button">Ã‡Ä±k</button>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { mountShell } from "/js/ui_shell.js";
    import { supabase } from "/js/supabase_client.js";

    mountShell({ scroll:"none" });

    const API_BASE = "https://italky-api.onrender.com";
    const PRACTICE_POOL_BASE = "https://auth.italky.ai/storage/v1/object/public/practice/pool";

    const $ = (id)=>document.getElementById(id);
    const toastEl = $("toast");

    function toast(msg){
      toastEl.textContent = String(msg||"");
      toastEl.classList.add("show");
      clearTimeout(window.__to);
      window.__to = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function qs(k){ return new URLSearchParams(location.search).get(k); }

    const lang = String(qs("lang") || "en").trim().toLowerCase();
    const levelQ = String(qs("level") || "").trim().toUpperCase();

    const LANG_META = {
      en:{ name:"English",  flag:"ğŸ‡¬ğŸ‡§" },
      de:{ name:"German",   flag:"ğŸ‡©ğŸ‡ª" },
      fr:{ name:"French",   flag:"ğŸ‡«ğŸ‡·" },
      it:{ name:"Italian",  flag:"ğŸ‡®ğŸ‡¹" },
      ru:{ name:"Russian",  flag:"ğŸ‡·ğŸ‡º" },
      es:{ name:"Spanish",  flag:"ğŸ‡ªğŸ‡¸" },
    };
    const meta = LANG_META[lang] || { name: lang.toUpperCase(), flag:"ğŸŒ" };

    $("chipRight").textContent = `${meta.flag} ${lang.toUpperCase()}`;
    $("langTitle").textContent = `${meta.name} â€¢ KonuÅŸma PratiÄŸi`;

    const { data:{ session } } = await supabase.auth.getSession();
    if(!session?.user){
      location.replace("/pages/login.html");
      throw new Error("no session");
    }
    const userId = session.user.id;

    let fullName = "";
    let levels = {};
    try{
      const { data: prof } = await supabase
        .from("profiles")
        .select("full_name, levels")
        .eq("id", userId)
        .maybeSingle();
      fullName = String(prof?.full_name || "").trim();
      levels = (prof?.levels && typeof prof.levels === "object") ? prof.levels : {};
    }catch{}

    function firstName(full){
      const s = String(full||"").trim();
      if(!s) return "";
      const parts = s.split(/\s+/).filter(Boolean);
      if(parts.length <= 2) return s;
      return parts.slice(0, -1).join(" ");
    }
    const who = firstName(fullName) || "OÄŸuz";

    function pickLevel(lv){
      if(["A1","A2","B1","B2","C1"].includes(lv)) return lv;
      return "A1";
    }
    const level = pickLevel(levelQ || (levels?.[lang] || "A1"));
    $("levelPill").textContent = `Seviye: ${level}`;

    const THRESH = { A1:0.72, A2:0.75, B1:0.78, B2:0.82, C1:0.85 };

    function setGreeting(){
      const greet = {
        en: `Hello <b>${who}</b>! You are <b>${level}</b>. Tap â€œDinletâ€, then repeat.`,
        de: `Hallo <b>${who}</b>! Niveau <b>${level}</b>. â€œDinletâ€ â†’ tekrar.`,
        fr: `Salut <b>${who}</b> ! Niveau <b>${level}</b>. â€œDinletâ€ â†’ rÃ©pÃ¨te.`,
        it: `Ciao <b>${who}</b>! Livello <b>${level}</b>. â€œDinletâ€ â†’ ripeti.`,
        es: `Hola <b>${who}</b>! Nivel <b>${level}</b>. â€œDinletâ€ â†’ repite.`,
        ru: `ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, <b>${who}</b>! Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ <b>${level}</b>. â€œDinletâ€ â†’ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸.`
      };
      $("greetBox").innerHTML = greet[lang] || `Selam <b>${who}</b>! Seviye <b>${level}</b>. â€œDinletâ€e dokun ve tekrar et.`;
    }

    async function loadPool(){
      const url = `${PRACTICE_POOL_BASE}/${encodeURIComponent(lang)}.json`;
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`practice pool yok: ${lang}.json (HTTP ${r.status})\n${t}`);
      }
      const j = await r.json().catch(()=>null);
      if(!j) throw new Error("practice pool json okunamadÄ±");
      if(j.levels && typeof j.levels === "object") return j.levels;
      return j;
    }

    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function pickFromPool(pool, lv){
      const byLevel = pool?.[lv];
      if(Array.isArray(byLevel) && byLevel.length) return byLevel;
      const a1 = pool?.A1;
      if(Array.isArray(a1) && a1.length) return a1;
      for(const k of ["A2","B1","B2","C1"]){
        if(Array.isArray(pool?.[k]) && pool[k].length) return pool[k];
      }
      return [];
    }

    // âœ… item normalize (object -> text)
    function normalizeItem(item){
      if(item == null) return { text:"", tr:"" };

      if(typeof item === "string"){
        return { text: item.trim(), tr:"" };
      }

      if(typeof item === "object"){
        const text = String(
          item.text || item.sentence || item.phrase || item.prompt || item.q || ""
        ).trim();
        const tr = String(item.tr || item.meaning_tr || item.translation_tr || "").trim();
        return { text, tr };
      }

      return { text: String(item).trim(), tr:"" };
    }

    let sessionQueue = [];
    let sessionIndex = 0;

    let current = { text:"", tr:"" };
    let recording = false;
    let mediaStream = null;
    let recorder = null;
    let chunks = [];

    const ttsCache = new Map(); // text -> base64

    function setSentenceUI(){
      $("sentence").textContent = current.text || "â€”";
      $("sttStatus").textContent = "HazÄ±r";
      $("simStatus").textContent = "â€”";
      $("simStatus").className = "v";
      $("btnNext").disabled = true;
      $("transBox").innerHTML = `<span class="muted">Anlam iÃ§in</span> â€œğŸ“ Anlamâ€ <span class="muted">butonuna bas.</span>`;
    }

    function nextSentence(){
      if(sessionQueue.length === 0){
        throw new Error("Havuz boÅŸ. DosyayÄ± kontrol edin.");
      }

      if(sessionIndex >= sessionQueue.length){
        sessionQueue = shuffle(sessionQueue);
        sessionIndex = 0;
      }

      current = normalizeItem(sessionQueue[sessionIndex]);
      sessionIndex++;

      if(!current.text){
        // boÅŸ geldiyse bir sonraki dene
        return nextSentence();
      }

      setSentenceUI();
    }

    function normText(s){
      return String(s||"")
        .toLowerCase()
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^\p{L}\p{N}\s']/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function levenshtein(a, b){
      a = normText(a); b = normText(b);
      const m = a.length, n = b.length;
      if(!m && !n) return 0;
      const dp = Array.from({length:m+1}, ()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i;
      for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }

    function similarity(a, b){
      a = normText(a); b = normText(b);
      if(!a && !b) return 1;
      const dist = levenshtein(a,b);
      const maxLen = Math.max(a.length, b.length) || 1;
      return Math.max(0, 1 - (dist / maxLen));
    }

    function setSimilarityUI(sim){
      const t = THRESH[level] ?? 0.75;
      const pct = Math.round(sim * 100);
      if(sim >= t){
        $("simStatus").textContent = `%${pct} â€¢ BaÅŸarÄ±lÄ± âœ…`;
        $("simStatus").className = "v ok";
        $("btnNext").disabled = false;

        // otomatik sonraki
        setTimeout(()=>{
          try{ if(!$("btnNext").disabled) $("btnNext").click(); }catch{}
        }, 650);
      }else{
        $("simStatus").textContent = `%${pct} â€¢ Tekrar â—`;
        $("simStatus").className = "v bad";
        $("btnNext").disabled = true;
      }
    }

    async function ttsSpeak(text){
      const key = String(text||"").trim();
      if(!key) return;

      if(ttsCache.has(key)){
        const b64 = ttsCache.get(key);
        const audio = new Audio("data:audio/mp3;base64," + b64);
        await audio.play();
        return;
      }

      const r = await fetch(`${API_BASE}/api/tts`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text: key, lang })
      });

      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`TTS HTTP ${r.status} ${t}`);
      }

      const j = await r.json().catch(()=>null);
      const b64 = (j?.audio_base64 || "").toString().trim();
      if(!j?.ok || !b64){
        throw new Error(j?.error || "TTS_UNAVAILABLE");
      }

      ttsCache.set(key, b64);
      const audio = new Audio("data:audio/mp3;base64," + b64);
      await audio.play();
    }

    async function ensureMic(){
      if(mediaStream) return mediaStream;
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      return mediaStream;
    }

    function pickMime(){
      const candidates = ["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg"];
      for(const c of candidates){
        if(window.MediaRecorder?.isTypeSupported?.(c)) return c;
      }
      return "";
    }

    async function sttSend(blob){
      const fd = new FormData();
      fd.append("file", blob, "speech.webm");
      fd.append("lang", lang);

      const r = await fetch(`${API_BASE}/api/stt`, { method:"POST", body: fd });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`STT HTTP ${r.status} ${t}`);
      }
      const j = await r.json().catch(()=>null);
      const text = (j?.text || j?.transcript || j?.result || "").toString().trim();
      if(!text) throw new Error("STT boÅŸ dÃ¶ndÃ¼");
      return text;
    }

    async function startRec(){
      await ensureMic();
      chunks = [];
      const mime = pickMime();
      recorder = new MediaRecorder(mediaStream, mime ? { mimeType: mime } : undefined);

      recorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) chunks.push(e.data); };
      recorder.onstop = async ()=>{
        try{
          const blob = new Blob(chunks, { type: chunks[0]?.type || "audio/webm" });
          $("sttStatus").textContent = "Ã‡Ã¶zÃ¼mleniyorâ€¦";
          const text = await sttSend(blob);
          $("sttStatus").textContent = text;

          const sim = similarity(text, current.text);
          setSimilarityUI(sim);

        }catch(err){
          $("sttStatus").textContent = "STT hata";
          toast(err?.message || String(err));
          $("btnNext").disabled = true;
          $("simStatus").textContent = "â€”";
          $("simStatus").className = "v";
        } finally {
          recording = false;
          $("btnRec").classList.remove("rec");
          $("btnRec").textContent = "ğŸ™ï¸";
        }
      };

      recording = true;
      $("btnRec").classList.add("rec");
      $("btnRec").textContent = "âº";
      $("sttStatus").textContent = "Dinliyorumâ€¦";
      $("simStatus").textContent = "â€”";
      $("simStatus").className = "v";
      $("btnNext").disabled = true;

      recorder.start();
    }

    function stopRec(){
      try{ if(recorder && recorder.state !== "inactive") recorder.stop(); }catch{}
    }

    // âœ… Anlam: havuzda tr varsa direkt gÃ¶ster. Yoksa Googleâ†’OpenAI fallback.
    async function translateMeaning(){
      if(current.tr){
        $("transBox").textContent = current.tr;
        return;
      }

      $("transBox").innerHTML = `<span class="muted">Ã‡eviriliyorâ€¦</span>`;

      const payload = { text: current.text, source_lang: lang, target_lang: "tr" };

      // 1) Google/normal translate endpoint (varsa)
      try{
        const r1 = await fetch(`${API_BASE}/api/translate`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(r1.ok){
          const j1 = await r1.json().catch(()=>null);
          const out1 = (j1?.text || j1?.translation || j1?.result || "").toString().trim();
          if(out1){
            $("transBox").textContent = out1;
            return;
          }
        }
      }catch{}

      // 2) OpenAI translate_ai fallback
      try{
        const r2 = await fetch(`${API_BASE}/api/translate_ai`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(!r2.ok){
          const t = await r2.text().catch(()=> "");
          throw new Error(`Translate HTTP ${r2.status} ${t}`);
        }
        const j2 = await r2.json().catch(()=>null);
        const out2 = (j2?.text || j2?.translation || j2?.result || "").toString().trim();
        if(!out2) throw new Error("Ã‡eviri boÅŸ dÃ¶ndÃ¼");
        $("transBox").textContent = out2;
      }catch(e){
        $("transBox").innerHTML = `<span class="muted">Ã‡eviri ÅŸu an kullanÄ±lamÄ±yor.</span>`;
        toast(e?.message || String(e));
      }
    }

    $("btnPlay").onclick = async ()=>{
      try{
        $("btnPlay").disabled = true;
        await ttsSpeak(current.text);
      }catch(e){
        toast(e?.message || "Ses ÅŸu an kullanÄ±lamÄ±yor.");
      }finally{
        $("btnPlay").disabled = false;
      }
    };

    $("btnRepeat").onclick = async ()=>{
      try{
        $("btnNext").disabled = true;
        $("sttStatus").textContent = "HazÄ±r";
        $("simStatus").textContent = "â€”";
        $("simStatus").className = "v";
        await ttsSpeak(current.text);
      }catch(e){
        toast(e?.message || "Ses ÅŸu an kullanÄ±lamÄ±yor.");
      }
    };

    $("btnMeaning").onclick = ()=>translateMeaning();

    $("btnRec").onclick = async ()=>{
      try{
        if(!recording) await startRec();
        else stopRec();
      }catch(e){
        recording = false;
        $("btnRec").classList.remove("rec");
        $("btnRec").textContent = "ğŸ™ï¸";
        toast(e?.message || String(e));
      }
    };

    $("btnNext").onclick = ()=>{
      try{
        nextSentence();
        toast("HazÄ±rsan â€œDinletâ€e dokun.");
      }catch(e){
        toast(e?.message || "Sonraki getirilemedi.");
      }
    };

    $("btnExit").onclick = ()=>{ location.href = "/pages/practice_ai.html"; };

    // init
    try{
      setGreeting();

      const pool = await loadPool();          // {A1:[...],...}
      const raw = pickFromPool(pool, level);  // level array

      // âœ… normalize + boÅŸlarÄ± at
      sessionQueue = shuffle(raw).map(normalizeItem).filter(x=>x.text);

      // Ã§ok uzamasÄ±n ama kÄ±sa da olmasÄ±n
      if(sessionQueue.length > 200) sessionQueue = sessionQueue.slice(0, 200);

      if(!sessionQueue.length){
        throw new Error("Havuz boÅŸ gÃ¶rÃ¼nÃ¼yor. Dosyalarda text alanÄ±nÄ± kontrol et.");
      }

      sessionIndex = 0;
      nextSentence();
      toast("BaÅŸlamak iÃ§in â€œDinletâ€e dokun.");

    }catch(e){
      $("sentence").textContent = "Havuz yÃ¼klenemedi.";
      toast(e?.message || String(e));
      $("btnPlay").disabled = true;
      $("btnRec").disabled = true;
      $("btnNext").disabled = true;
    }
  </script>
</body>
</html>
