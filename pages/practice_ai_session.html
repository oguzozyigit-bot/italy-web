<!-- FILE: /pages/practice_ai_session.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI ‚Ä¢ AI Pratik Oturumu</title>

  <meta name="theme-color" content="#02000f">
  <style>html,body{background:#02000f !important;}</style>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --border: rgba(255,255,255,0.12);
      --card: rgba(255,255,255,0.05);
      --muted: rgba(255,255,255,0.70);
      --ok: rgba(34,197,94,0.95);
      --bad: rgba(255,90,140,0.95);
      --aiGrad: linear-gradient(135deg,#a5b4fc 0%,#6366f1 50%,#ec4899 100%);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
    #pageContent{ height:100%; }

    .wrap{
      position:relative;
      max-width:480px;
      height:100%;
      margin:0 auto;
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      background: rgba(10,10,30,0.18);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 26px;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .topbar{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .chip{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.92);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
      display:flex; gap:8px; align-items:center;
    }
    .chip .ai{
      background: var(--aiGrad);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      font-weight:1000;
    }

    .panel{
      flex:1;
      border-radius: 22px;
      border: 1px solid var(--border);
      background: var(--card);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
      position: relative;
    }

    /* k√º√ß√ºk nebula anim */
    .panel:before{
      content:"";
      position:absolute; inset:-30%;
      background:
        radial-gradient(circle at 20% 20%, rgba(99,102,241,.25) 0%, transparent 45%),
        radial-gradient(circle at 80% 30%, rgba(236,72,153,.18) 0%, transparent 42%),
        radial-gradient(circle at 50% 80%, rgba(168,85,247,.16) 0%, transparent 45%);
      filter: blur(34px);
      opacity:.85;
      animation: drift 10s ease-in-out infinite alternate;
      pointer-events:none;
    }
    @keyframes drift{
      from{ transform: translate3d(-10px,-8px,0) scale(1); }
      to{ transform: translate3d(10px,8px,0) scale(1.06); }
    }
    .panel > *{ position:relative; z-index:2; }

    .titleRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .h{
      font-family:"Space Grotesk",system-ui,sans-serif;
      font-weight:1000;
      font-size:14px;
      margin:0;
      color:#fff;
      letter-spacing:-.2px;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 72%;
    }
    .lvl{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      font-weight: 1000;
      font-size: 12px;
      color: rgba(165,180,252,0.95);
      white-space: nowrap;
    }

    .sentenceBox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding: 12px;
      min-height: 96px;
    }
    .sentence{
      font-size: 16px;
      font-weight: 1000;
      line-height: 1.35;
      color:#fff;
      white-space: pre-wrap;
    }
    .hint{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 900;
      color: rgba(255,255,255,0.62);
      line-height:1.35;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .btn{
      height: 52px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      padding: 0 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      flex: 1;
      min-width: 0;
      white-space:nowrap;
    }
    .btn.small{ flex: 0 0 auto; min-width: 110px; }
    .btn:disabled{ opacity:.35; cursor:not-allowed; }

    .btn-primary{
      background:#fff;
      color:#000;
      border:none;
    }

    .mic{
      width: 52px; min-width:52px;
      height: 52px;
      border-radius: 18px;
      border: none;
      background: var(--aiGrad);
      color:#000;
      font-weight:1000;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 30px rgba(99,102,241,0.25);
      flex: 0 0 auto;
    }
    .mic:active{ transform: scale(.99); }
    .mic.rec{
      background: linear-gradient(135deg, rgba(255,90,140,1) 0%, rgba(236,72,153,1) 60%, rgba(165,180,252,1) 100%);
    }

    .statusBox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      padding: 12px;
      min-height: 84px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .statusBox::-webkit-scrollbar{ display:none; }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .k{
      font-size: 11px;
      font-weight: 900;
      color: rgba(255,255,255,0.55);
      letter-spacing:.5px;
      text-transform: uppercase;
      flex:0 0 auto;
    }
    .v{
      font-size: 12px;
      font-weight: 1000;
      color:#fff;
      text-align:right;
      max-width: 65%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .v.ok{ color: var(--ok); }
    .v.bad{ color: var(--bad); }

    .trans{
      margin-top: 8px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,0.82);
      white-space: pre-wrap;
      line-height: 1.45;
    }
    .trans .muted{ color: rgba(255,255,255,0.60); }

    .note{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.45;
    }

    .toast{
      position: fixed;
      left:50%;
      top:18px;
      transform: translateX(-50%) translateY(-120px);
      background: rgba(10,10,18,0.95);
      border: 1px solid rgba(165,180,252,0.35);
      padding: 10px 14px;
      border-radius: 999px;
      color:#fff;
      z-index: 999999;
      font-weight: 1000;
      font-size: 12px;
      transition: .25s;
      backdrop-filter: blur(12px);
      pointer-events:none;
      max-width: min(92vw, 520px);
      text-align:center;
    }
    .toast.show{ transform: translateX(-50%) translateY(0); }

    @media (max-height: 740px){
      .sentence{ font-size: 15px; }
      .sentenceBox{ min-height: 86px; }
      .btn{ height: 50px; }
      .mic{ width:50px; min-width:50px; height:50px; }
    }
  </style>
</head>

<body>
  <main id="pageContent">
    <div class="wrap">
      <div class="topbar">
        <div class="chip" id="chipLeft"><span class="ai">AI</span> Pratik</div>
        <div class="chip" id="chipRight">‚Äî</div>
      </div>

      <section class="panel">
        <div class="titleRow">
          <h2 class="h" id="langTitle">‚Äî</h2>
          <div class="lvl" id="levelPill">‚Äî</div>
        </div>

        <div class="sentenceBox">
          <div class="sentence" id="sentence">Y√ºkleniyor‚Ä¶</div>
          <div class="hint" id="hint">√ñnce dinle, sonra mikrofona basƒ±p tekrar et.</div>
        </div>

        <div class="actions">
          <button class="btn" id="btnPlay" type="button">üîä Dinlet</button>
          <button class="mic" id="btnRec" type="button" title="Kayƒ±t">üéôÔ∏è</button>
          <button class="btn btn-primary" id="btnNext" type="button" disabled>Sonraki</button>
        </div>

        <div class="statusBox">
          <div class="row">
            <div class="k">Tanƒ±ma</div>
            <div class="v" id="sttStatus">Hazƒ±r</div>
          </div>
          <div class="row">
            <div class="k">Benzerlik</div>
            <div class="v" id="simStatus">‚Äî</div>
          </div>
          <div class="trans" id="transBox">
            <span class="muted">Anlamƒ± g√∂rmek i√ßin</span> ‚ÄúAnlam‚Äù <span class="muted">butonuna bas.</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnMeaning" type="button">üìù Anlam</button>
          <button class="btn" id="btnRepeat" type="button">‚Üª Tekrar</button>
          <button class="btn" id="btnExit" type="button">√áƒ±k</button>
        </div>

        <div class="note" id="note">
          ‚Ä¢ Seviye bazlƒ± e≈üik uygulanƒ±r. Benzerlik yeterliyse ‚ÄúSonraki‚Äù a√ßƒ±lƒ±r.<br/>
          ‚Ä¢ Maliyet d√º≈ü√ºk: STT/TTS + isteƒüe baƒülƒ± anlam (translate).
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { mountShell } from "/js/ui_shell.js";
    import { supabase } from "/js/supabase_client.js";

    mountShell({ scroll:"none" });

    const API_BASE = "https://italky-api.onrender.com";

    const $ = (id)=>document.getElementById(id);
    const toastEl = $("toast");

    function toast(msg){
      toastEl.textContent = String(msg||"");
      toastEl.classList.add("show");
      clearTimeout(window.__to);
      window.__to = setTimeout(()=>toastEl.classList.remove("show"), 1600);
    }

    function qs(k){ return new URLSearchParams(location.search).get(k); }

    // params
    const lang = String(qs("lang") || "en").trim().toLowerCase();
    const level = String(qs("level") || "A1").trim().toUpperCase();
    const teacher = String(qs("t") || "").trim();

    // UI labels
    const LANG_META = {
      en:{ name:"English",  flag:"üá¨üáß" },
      de:{ name:"German",   flag:"üá©üá™" },
      fr:{ name:"French",   flag:"üá´üá∑" },
      it:{ name:"Italian",  flag:"üáÆüáπ" },
      ru:{ name:"Russian",  flag:"üá∑üá∫" },
      es:{ name:"Spanish",  flag:"üá™üá∏" },
    };
    const meta = LANG_META[lang] || { name: lang.toUpperCase(), flag:"üåç" };

    $("chipRight").textContent = `${meta.flag} ${lang.toUpperCase()}`;
    $("langTitle").textContent = `${meta.name} ‚Ä¢ Konu≈üma Pratiƒüi`;
    $("levelPill").textContent = (["A1","A2","B1","B2","C1"].includes(level)) ? `Seviye: ${level}` : "Seviye: A1";

    // Auth check + isim al (ki≈üiselle≈ütirme)
    const { data:{ session } } = await supabase.auth.getSession();
    const userId = session?.user?.id || null;
    if(!userId){
      location.replace("/pages/login.html");
      throw new Error("no session");
    }

    // Profil adƒ± (hitap)
    let displayName = "Kullanƒ±cƒ±";
    try{
      const { data: prof } = await supabase.from("profiles").select("full_name").eq("id", userId).maybeSingle();
      const full = String(prof?.full_name || "").trim();
      if(full) displayName = full.split(/\s+/)[0] || full;
    }catch{}

    // ---- Phrase pool (≈üimdilik g√∂m√ºl√º demo) ----
    // Not: Yakƒ±nda storage‚Äôdan pool √ßekeceƒüiz. ≈ûimdilik stabil √ßalƒ±≈üsƒ±n.
    const POOL = {
      en:{
        A1:["My name is {name}.","I drink coffee every morning.","Where is the bus stop?","I like to read books.","I live in a small house."],
        A2:["I went to the market yesterday.","Can you help me, please?","I am learning English these days.","We will meet at seven o‚Äôclock.","I usually cook at home."],
        B1:["I‚Äôve been working here for two years.","If I had time, I would travel more.","Could you tell me how to get there?","I‚Äôm trying to improve my pronunciation.","I didn‚Äôt expect it to be so difficult."],
        B2:["I wish I had studied earlier.","The reason I‚Äôm late is the traffic.","I‚Äôd rather stay home than go out tonight.","I‚Äôm looking forward to hearing from you.","This topic is more complex than it seems."],
        C1:["Although it sounds simple, it requires careful planning.","I can‚Äôt recall exactly how it happened.","It‚Äôs essential to consider the long-term impact.","I‚Äôm not convinced that this approach will work.","Let‚Äôs clarify the assumptions before we proceed."]
      },
      fr:{
        A1:["Je m‚Äôappelle {name}.","O√π est la station de m√©tro ?","J‚Äôaime boire du th√©.","C‚Äôest une bonne id√©e.","Je vais √† l‚Äô√©cole tous les jours."],
        A2:["Hier, je suis all√© au march√©.","Peux-tu m‚Äôaider, s‚Äôil te pla√Æt ?","Je suis en train d‚Äôapprendre le fran√ßais.","On se voit √† sept heures.","Je cuisine souvent √† la maison."],
        B1:["Je travaille ici depuis deux ans.","Si j‚Äôavais le temps, je voyagerais plus.","Peux-tu m‚Äôexpliquer comment y aller ?","J‚Äôessaie d‚Äôam√©liorer ma prononciation.","Je ne m‚Äôattendais pas √† √ßa."],
        B2:["J‚Äôaimerais mieux rester √† la maison ce soir.","La raison, c‚Äôest qu‚Äôil y avait des embouteillages.","Je suis impatient d‚Äôavoir de tes nouvelles.","Ce sujet est plus complexe qu‚Äôil n‚Äôy para√Æt.","Il faut trouver une solution rapidement."],
        C1:["M√™me si cela para√Æt simple, il faut bien s‚Äôorganiser.","Il est essentiel d‚Äô√©valuer les cons√©quences √† long terme.","Je ne suis pas convaincu que cette m√©thode soit efficace.","Clarifions les hypoth√®ses avant de continuer.","Je n‚Äôarrive pas √† me souvenir des d√©tails."]
      },
      de:{
        A1:["Mein Name ist {name}.","Wo ist die Bushaltestelle?","Ich trinke jeden Morgen Kaffee.","Das ist sehr gut.","Ich wohne in einem kleinen Haus."],
        A2:["Gestern bin ich zum Markt gegangen.","Kannst du mir bitte helfen?","Ich lerne gerade Deutsch.","Wir treffen uns um sieben Uhr.","Ich koche oft zu Hause."],
        B1:["Ich arbeite seit zwei Jahren hier.","Wenn ich Zeit h√§tte, w√ºrde ich mehr reisen.","Kannst du mir erkl√§ren, wie ich dahin komme?","Ich versuche, meine Aussprache zu verbessern.","Ich habe nicht damit gerechnet."],
        B2:["Ich w√§re lieber zu Hause geblieben.","Der Grund ist der starke Verkehr.","Ich freue mich darauf, von dir zu h√∂ren.","Dieses Thema ist komplizierter, als es scheint.","Wir m√ºssen schnell eine L√∂sung finden."],
        C1:["Auch wenn es einfach klingt, erfordert es gute Planung.","Es ist wichtig, die langfristigen Folgen zu ber√ºcksichtigen.","Ich bin nicht √ºberzeugt, dass dieser Ansatz funktioniert.","Lass uns die Annahmen zuerst kl√§ren.","Ich kann mich nicht genau erinnern, wie es passiert ist."]
      },
      it:{
        A1:["Mi chiamo {name}.","Dov‚Äô√® la fermata dell‚Äôautobus?","Bevo caff√® ogni mattina.","√à una buona idea.","Vivo in una piccola casa."],
        A2:["Ieri sono andato al mercato.","Puoi aiutarmi, per favore?","Sto imparando l‚Äôitaliano.","Ci vediamo alle sette.","Cucino spesso a casa."],
        B1:["Lavoro qui da due anni.","Se avessi tempo, viaggerei di pi√π.","Puoi spiegarmi come arrivare l√¨?","Cerco di migliorare la pronuncia.","Non me lo aspettavo."],
        B2:["Preferirei restare a casa stasera.","Il motivo √® il traffico.","Non vedo l‚Äôora di avere tue notizie.","Questo argomento √® pi√π complesso di quanto sembri.","Dobbiamo trovare una soluzione in fretta."],
        C1:["Anche se sembra semplice, richiede una buona pianificazione.","√à essenziale considerare l‚Äôimpatto a lungo termine.","Non sono convinto che questo approccio funzioni.","Chiariamo le ipotesi prima di continuare.","Non ricordo esattamente come sia successo."]
      },
      es:{
        A1:["Me llamo {name}.","¬øD√≥nde est√° la parada de autob√∫s?","Bebo caf√© cada ma√±ana.","Es una buena idea.","Vivo en una casa peque√±a."],
        A2:["Ayer fui al mercado.","¬øPuedes ayudarme, por favor?","Estoy aprendiendo espa√±ol.","Nos vemos a las siete.","Cocino a menudo en casa."],
        B1:["He estado trabajando aqu√≠ durante dos a√±os.","Si tuviera tiempo, viajar√≠a m√°s.","¬øPodr√≠as decirme c√≥mo llegar all√≠?","Estoy intentando mejorar mi pronunciaci√≥n.","No me lo esperaba."],
        B2:["Preferir√≠a quedarme en casa esta noche.","La raz√≥n es el tr√°fico.","Tengo ganas de saber de ti.","Este tema es m√°s complejo de lo que parece.","Necesitamos encontrar una soluci√≥n pronto."],
        C1:["Aunque suene simple, requiere una planificaci√≥n cuidadosa.","Es esencial considerar el impacto a largo plazo.","No estoy convencido de que este enfoque funcione.","Aclaremos las suposiciones antes de seguir.","No recuerdo exactamente c√≥mo ocurri√≥."]
      },
      ru:{
        A1:["–ú–µ–Ω—è –∑–æ–≤—É—Ç {name}.","–ì–¥–µ –∞–≤—Ç–æ–±—É—Å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞?","–Ø –ø—å—é –∫–æ—Ñ–µ –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ.","–≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –∏–¥–µ—è.","–Ø –∂–∏–≤—É –≤ –º–∞–ª–µ–Ω—å–∫–æ–º –¥–æ–º–µ."],
        A2:["–í—á–µ—Ä–∞ —è —Ö–æ–¥–∏–ª –Ω–∞ —Ä—ã–Ω–æ–∫.","–¢—ã –º–æ–∂–µ—à—å –º–Ω–µ –ø–æ–º–æ—á—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞?","–Ø —Å–µ–π—á–∞—Å —É—á—É —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.","–£–≤–∏–¥–∏–º—Å—è –≤ —Å–µ–º—å —á–∞—Å–æ–≤.","–Ø —á–∞—Å—Ç–æ –≥–æ—Ç–æ–≤–ª—é –¥–æ–º–∞."],
        B1:["–Ø —Ä–∞–±–æ—Ç–∞—é –∑–¥–µ—Å—å —É–∂–µ –¥–≤–∞ –≥–æ–¥–∞.","–ï—Å–ª–∏ –±—ã —É –º–µ–Ω—è –±—ã–ª–æ –≤—Ä–µ–º—è, —è –±—ã –±–æ–ª—å—à–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞–ª.","–¢—ã –º–æ–∂–µ—à—å –æ–±—ä—è—Å–Ω–∏—Ç—å, –∫–∞–∫ —Ç—É–¥–∞ –¥–æ–±—Ä–∞—Ç—å—Å—è?","–Ø –ø—ã—Ç–∞—é—Å—å —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ.","–Ø —ç—Ç–æ–≥–æ –Ω–µ –æ–∂–∏–¥–∞–ª."],
        B2:["–Ø –±—ã –ø—Ä–µ–¥–ø–æ—á—ë–ª –æ—Å—Ç–∞—Ç—å—Å—è –¥–æ–º–∞ —Å–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä–æ–º.","–ü—Ä–∏—á–∏–Ω–∞ ‚Äî –ø—Ä–æ–±–∫–∏.","–Ø —Å –Ω–µ—Ç–µ—Ä–ø–µ–Ω–∏–µ–º –∂–¥—É —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞.","–≠—Ç–∞ —Ç–µ–º–∞ —Å–ª–æ–∂–Ω–µ–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è.","–ù–∞–º –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ —Ä–µ—à–µ–Ω–∏–µ."],
        C1:["–•–æ—Ç—è —ç—Ç–æ –∑–≤—É—á–∏—Ç –ø—Ä–æ—Å—Ç–æ, —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.","–í–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è.","–Ø –Ω–µ —É–≤–µ—Ä–µ–Ω, —á—Ç–æ —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.","–î–∞–≤–∞–π —É—Ç–æ—á–Ω–∏–º –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.","–Ø –Ω–µ –º–æ–≥—É —Ç–æ—á–Ω–æ –≤—Å–ø–æ–º–Ω–∏—Ç—å, –∫–∞–∫ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ."]
      }
    };

    function pickLevel(lv){
      if(["A1","A2","B1","B2","C1"].includes(lv)) return lv;
      return "A1";
    }
    const LV = pickLevel(level);

    // thresholds by level
    const THRESH = { A1:0.72, A2:0.75, B1:0.78, B2:0.82, C1:0.85 };

    // state
    let current = "";
    let lastRecognized = "";
    let lastSimilarity = 0;

    function randItem(arr){
      return arr[Math.floor(Math.random() * arr.length)];
    }

    // Avoid immediate repeats in a session
    const seen = new Set();
    function nextSentence(){
      const pool = POOL[lang] || POOL.en;
      const arr = (pool[LV] || pool.A1).map(s => s.replace("{name}", displayName));

      if(seen.size >= Math.min(arr.length, 12)) seen.clear();

      let pick = randItem(arr);
      let guard=0;
      while(seen.has(pick) && guard<20){
        pick = randItem(arr);
        guard++;
      }
      seen.add(pick);

      current = pick;
      lastRecognized = "";
      lastSimilarity = 0;

      $("sentence").textContent = current;
      $("sttStatus").textContent = "Hazƒ±r";
      $("simStatus").textContent = "‚Äî";
      $("simStatus").className = "v";
      $("btnNext").disabled = true;
      $("transBox").innerHTML = `<span class="muted">Anlamƒ± g√∂rmek i√ßin</span> ‚ÄúAnlam‚Äù <span class="muted">butonuna bas.</span>`;
    }

    // ---- Similarity ----
    function normText(s){
      return String(s||"")
        .toLowerCase()
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^\p{L}\p{N}\s']/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function levenshtein(a, b){
      a = normText(a); b = normText(b);
      const m = a.length, n = b.length;
      if(!m && !n) return 0;
      const dp = Array.from({length:m+1}, ()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i;
      for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }

    function similarity(a, b){
      a = normText(a); b = normText(b);
      if(!a && !b) return 1;
      const dist = levenshtein(a,b);
      const maxLen = Math.max(a.length, b.length) || 1;
      return Math.max(0, 1 - (dist / maxLen));
    }

    function setSimilarityUI(sim){
      lastSimilarity = sim;
      const t = THRESH[LV] ?? 0.75;
      const pct = Math.round(sim * 100);
      if(sim >= t){
        $("simStatus").textContent = `%${pct} ‚Ä¢ Ba≈üarƒ±lƒ±`;
        $("simStatus").className = "v ok";
        $("btnNext").disabled = false;
      }else{
        $("simStatus").textContent = `%${pct} ‚Ä¢ Tekrar`;
        $("simStatus").className = "v bad";
        $("btnNext").disabled = true;
      }
    }

    // ---- TTS (backend /api/tts) ----
    let audioObj = null;
    function stopAudio(){
      try{
        if(audioObj){
          audioObj.pause();
          audioObj.currentTime = 0;
        }
      }catch{}
      audioObj = null;
    }

    async function ttsSpeak(text){
      const t = String(text||"").trim();
      if(!t) return;

      stopAudio();

      const res = await fetch(`${API_BASE}/api/tts`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        credentials:"include",
        body: JSON.stringify({ text: t, lang })
      });

      if(!res.ok){
        const msg = await res.text().catch(()=> "");
        throw new Error(`TTS HTTP ${res.status} ${msg}`);
      }

      const data = await res.json().catch(()=>null);
      // Senin backend: { ok, audio_base64, provider_used }
      if(!data?.ok || !data.audio_base64){
        throw new Error("TTS unavailable");
      }

      const bin = atob(data.audio_base64);
      const bytes = new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);

      const blob = new Blob([bytes], { type:"audio/mpeg" });
      const url = URL.createObjectURL(blob);

      audioObj = new Audio(url);
      audioObj.playsInline = true;
      audioObj.onended = ()=>{ try{ URL.revokeObjectURL(url); }catch{} };
      audioObj.onerror = ()=>{ try{ URL.revokeObjectURL(url); }catch{} };

      await audioObj.play();
    }

    // ---- STT (record -> /api/stt) ----
    let mediaStream = null;
    let recorder = null;
    let chunks = [];
    let recording = false;

    async function ensureMic(){
      if(mediaStream) return mediaStream;
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      return mediaStream;
    }

    function pickMime(){
      const candidates = ["audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg"];
      for(const c of candidates){
        try{ if(MediaRecorder.isTypeSupported(c)) return c; }catch{}
      }
      return "";
    }

    async function sttSend(blob){
      const fd = new FormData();
      fd.append("file", blob, "speech.webm");
      fd.append("lang", lang);

      const r = await fetch(`${API_BASE}/api/stt`, { method:"POST", body: fd, credentials:"include" });
      if(!r.ok){
        const t = await r.text().catch(()=> "");
        throw new Error(`STT HTTP ${r.status} ${t}`);
      }
      const j = await r.json().catch(()=>null);
      const text = (j?.text || j?.transcript || j?.result || "").toString().trim();
      if(!text) throw new Error("STT bo≈ü d√∂nd√º");
      return text;
    }

    async function startRec(){
      await ensureMic();
      chunks = [];
      const mime = pickMime();
      recorder = new MediaRecorder(mediaStream, mime ? { mimeType: mime } : undefined);

      recorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) chunks.push(e.data); };
      recorder.onstop = async ()=>{
        try{
          const blob = new Blob(chunks, { type: recorder?.mimeType || "audio/webm" });
          $("sttStatus").textContent = "√á√∂z√ºmleniyor‚Ä¶";
          const text = await sttSend(blob);
          lastRecognized = text;
          $("sttStatus").textContent = text;
          const sim = similarity(text, current);
          setSimilarityUI(sim);
        }catch(err){
          $("sttStatus").textContent = "STT hata";
          toast(err?.message || String(err));
          $("btnNext").disabled = true;
          $("simStatus").textContent = "‚Äî";
          $("simStatus").className = "v";
        }finally{
          recording = false;
          $("btnRec").classList.remove("rec");
          $("btnRec").textContent = "üéôÔ∏è";
        }
      };

      recording = true;
      $("btnRec").classList.add("rec");
      $("btnRec").textContent = "‚è∫";
      $("sttStatus").textContent = "Dinliyorum‚Ä¶";
      $("simStatus").textContent = "‚Äî";
      $("simStatus").className = "v";
      $("btnNext").disabled = true;

      recorder.start();
      // auto-stop 10s
      setTimeout(()=>{ try{ if(recording) stopRec(); }catch{} }, 10000);
    }

    function stopRec(){
      try{
        if(recorder && recorder.state !== "inactive") recorder.stop();
      }catch{}
    }

    // ---- Meaning (optional) ----
    async function translateMeaning(){
      try{
        $("transBox").innerHTML = `<span class="muted">√áeviriliyor‚Ä¶</span>`;
        const r = await fetch(`${API_BASE}/api/translate_ai`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          credentials:"include",
          body: JSON.stringify({
            text: current,
            from_lang: lang,
            to_lang: "tr",
            style:"fast",
            provider:"auto",
            strict:true,
            no_extra:true
          })
        });
        if(!r.ok){
          const t = await r.text().catch(()=> "");
          throw new Error(`Translate HTTP ${r.status} ${t}`);
        }
        const j = await r.json().catch(()=>null);
        const out = (j?.translated || j?.text || j?.result || "").toString().trim();
        if(!out) throw new Error("√áeviri bo≈ü d√∂nd√º");
        $("transBox").textContent = out;
      }catch(e){
        $("transBox").innerHTML = `<span class="muted">√áeviri ≈üu an kullanƒ±lamƒ±yor.</span>`;
        toast(e?.message || String(e));
      }
    }

    // ---- UI hooks ----
    $("btnPlay").onclick = async ()=>{
      try{
        $("btnPlay").disabled = true;
        await ttsSpeak(current);
      }catch(e){
        toast(e?.message || String(e));
      }finally{
        $("btnPlay").disabled = false;
      }
    };

    $("btnRepeat").onclick = async ()=>{
      try{
        $("btnNext").disabled = true;
        $("sttStatus").textContent = "Hazƒ±r";
        $("simStatus").textContent = "‚Äî";
        $("simStatus").className = "v";
        await ttsSpeak(current);
      }catch(e){
        toast(e?.message || String(e));
      }
    };

    $("btnMeaning").onclick = ()=>translateMeaning();

    $("btnRec").onclick = async ()=>{
      try{
        if(!recording) await startRec();
        else stopRec();
      }catch(e){
        recording = false;
        $("btnRec").classList.remove("rec");
        $("btnRec").textContent = "üéôÔ∏è";
        toast(e?.message || String(e));
      }
    };

    $("btnNext").onclick = ()=>{
      nextSentence();
      // mini ‚ÄúAI hissi‚Äù
      setTimeout(()=>{ try{ $("btnPlay").click(); }catch{} }, 220);
    };

    $("btnExit").onclick = ()=>{
      stopAudio();
      try{ mediaStream?.getTracks?.().forEach(t=>t.stop()); }catch{}
      location.href = "/pages/practice_ai.html";
    };

    // init
    nextSentence();
    // ilk dinletme
    setTimeout(()=>{ try{ $("btnPlay").click(); }catch{} }, 350);
  </script>
</body>
</html>
