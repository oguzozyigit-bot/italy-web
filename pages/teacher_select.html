// âœ… teacher_select.html iÃ§indeki module script'in TAMAMI (ESKÄ°SÄ°NÄ° SÄ°L, BUNU KOY)
import { mountShell } from "/js/ui_shell.js";
import { supabase } from "/js/supabase_client.js";

mountShell({ scroll:"auto" });

const $ = (id)=>document.getElementById(id);
function toast(msg){
  const t = $("toast");
  if(!t) return;
  t.textContent = String(msg||"");
  t.classList.add("show");
  clearTimeout(window.__to);
  window.__to = setTimeout(()=>t.classList.remove("show"), 1400);
}

const { data:{ session } } = await supabase.auth.getSession();
if(!session?.user){
  location.replace("/pages/login.html");
}

let levels = {};
try{
  const { data: prof } = await supabase
    .from("profiles")
    .select("levels")
    .eq("id", session.user.id)
    .maybeSingle();

  levels = (prof?.levels && typeof prof.levels === "object") ? prof.levels : {};
}catch{}

// âœ… 34 dil
const TOP = ["en","fr","de","es","it","ru"];
const LANGS = [
  { code:"en", name:"English",      flag:"ğŸ‡¬ğŸ‡§" },
  { code:"fr", name:"French",       flag:"ğŸ‡«ğŸ‡·" },
  { code:"de", name:"German",       flag:"ğŸ‡©ğŸ‡ª" },
  { code:"es", name:"Spanish",      flag:"ğŸ‡ªğŸ‡¸" },
  { code:"it", name:"Italian",      flag:"ğŸ‡®ğŸ‡¹" },
  { code:"ru", name:"Russian",      flag:"ğŸ‡·ğŸ‡º" },

  { code:"tr", name:"Turkish",      flag:"ğŸ‡¹ğŸ‡·" },
  { code:"az", name:"Azerbaijani",  flag:"ğŸ‡¦ğŸ‡¿" },
  { code:"kk", name:"Kazakh",       flag:"ğŸ‡°ğŸ‡¿" },
  { code:"ky", name:"Kyrgyz",       flag:"ğŸ‡°ğŸ‡¬" },
  { code:"uz", name:"Uzbek",        flag:"ğŸ‡ºğŸ‡¿" },
  { code:"tk", name:"Turkmen",      flag:"ğŸ‡¹ğŸ‡²" },

  { code:"ar", name:"Arabic",       flag:"ğŸ‡¸ğŸ‡¦" },
  { code:"fa", name:"Persian",      flag:"ğŸ‡®ğŸ‡·" },
  { code:"he", name:"Hebrew",       flag:"ğŸ‡®ğŸ‡±" },

  { code:"nl", name:"Dutch",        flag:"ğŸ‡³ğŸ‡±" },
  { code:"sv", name:"Swedish",      flag:"ğŸ‡¸ğŸ‡ª" },
  { code:"no", name:"Norwegian",    flag:"ğŸ‡³ğŸ‡´" },
  { code:"da", name:"Danish",       flag:"ğŸ‡©ğŸ‡°" },
  { code:"fi", name:"Finnish",      flag:"ğŸ‡«ğŸ‡®" },
  { code:"pl", name:"Polish",       flag:"ğŸ‡µğŸ‡±" },
  { code:"cs", name:"Czech",        flag:"ğŸ‡¨ğŸ‡¿" },
  { code:"sk", name:"Slovak",       flag:"ğŸ‡¸ğŸ‡°" },
  { code:"hu", name:"Hungarian",    flag:"ğŸ‡­ğŸ‡º" },
  { code:"ro", name:"Romanian",     flag:"ğŸ‡·ğŸ‡´" },
  { code:"bg", name:"Bulgarian",    flag:"ğŸ‡§ğŸ‡¬" },
  { code:"el", name:"Greek",        flag:"ğŸ‡¬ğŸ‡·" },
  { code:"uk", name:"Ukrainian",    flag:"ğŸ‡ºğŸ‡¦" },
  { code:"sr", name:"Serbian",      flag:"ğŸ‡·ğŸ‡¸" },
  { code:"hr", name:"Croatian",     flag:"ğŸ‡­ğŸ‡·" },

  { code:"pt", name:"Portuguese",   flag:"ğŸ‡µğŸ‡¹" },
  { code:"zh", name:"Chinese",      flag:"ğŸ‡¨ğŸ‡³" },
  { code:"ja", name:"Japanese",     flag:"ğŸ‡¯ğŸ‡µ" },
  { code:"ko", name:"Korean",       flag:"ğŸ‡°ğŸ‡·" },
  { code:"th", name:"Thai",         flag:"ğŸ‡¹ğŸ‡­" },
];

function orderLangs(){
  const map = new Map(LANGS.map(x=>[x.code,x]));
  const top = TOP.map(c=>map.get(c)).filter(Boolean);
  const rest = LANGS.filter(x=>!TOP.includes(x.code))
    .sort((a,b)=>a.name.localeCompare(b.name, "en", { sensitivity:"base" }));
  return [...top, ...rest];
}

const grid = document.getElementById("langGrid");
grid.innerHTML = orderLangs().map(l=>{
  const lv = levels?.[l.code] || "";
  const mini = lv ? `Seviyeniz: ${lv}` : `HenÃ¼z sÄ±nava katÄ±lmadÄ±nÄ±z`;
  return `
    <button class="card" type="button" data-code="${l.code}">
      <div class="mini" style="display:inline-flex">${mini}</div>
      <div class="flagBox"><div class="flag">${l.flag}</div></div>
      <div class="lang">${l.code.toUpperCase()}</div>
      <div class="local">${l.name}</div>
    </button>
  `;
}).join("");

grid.querySelectorAll(".card").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const code = String(btn.getAttribute("data-code")||"").trim();
    if(!code) return;

    localStorage.setItem("italky_language_code", code);

    const lv = levels?.[code] || "";
    if(lv){
      toast("Ders planÄ±na geÃ§iliyorâ€¦");
      setTimeout(()=>location.href=`/pages/plan_select.html?lang=${encodeURIComponent(code)}`, 120);
    }else{
      toast("Ã–nce seviye tespitâ€¦");
      setTimeout(()=>location.href=`/pages/academy_level_required.html?lang=${encodeURIComponent(code)}`, 120);
    }
  }, { passive:true });
});
