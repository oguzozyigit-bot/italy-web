<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ITALKY ‚Ä¢ Duo Friend</title>
  <link rel="icon" href="data:,"/>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    /* --- RENK PALETƒ∞ --- */
    :root {
      --bg-deep: #020205; 
      --text-main: #ffffff;
      
      /* OYUNCU A (AI - Turkuaz) */
      --c-p1: #00f3ff;
      --c-p1-dark: #0099aa;
      
      /* OYUNCU B (BORDO - Rakip) */
      --c-p2: #a50b5e; 
      --c-p2-light: #ff0066;

      --c-green: #00e676; /* Parlak Ye≈üil */
      --c-red: #ff1744;   /* Parlak Kƒ±rmƒ±zƒ± */
      --border: rgba(255, 255, 255, 0.1);
    }

    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; user-select:none; }
    html, body { margin:0; height:100dvh; overflow:hidden; font-family:'Outfit', sans-serif; background:var(--bg-deep); color:var(--text-main); }

    /* ATMOSFER */
    .cosmos-bg { position:absolute; inset:0; background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%); z-index:0; }
    .star-dust { position: absolute; inset: 0; opacity: 0.3; background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 50px 50px; animation: dustMove 100s linear infinite; }
    #fireworksCanvas { position: absolute; inset: 0; pointer-events: none; z-index: 9999; display: none; }
    
    @keyframes dustMove { from { transform: translateY(0); } to { transform: translateY(-500px); } }

    .wrap { width:100%; max-width:480px; height:100%; margin:0 auto; position:relative; z-index:10; display:flex; flex-direction:column; }

    /* NAV */
    .nav-layer { position:absolute; top:0; left:0; width:100%; height:70px; z-index:50; display:flex; justify-content:space-between; padding:12px; pointer-events:none; }
    .nav-btn { pointer-events:auto; height:44px; padding:0 16px; border-radius:14px; background:rgba(0,0,0,0.4); border:1px solid var(--border); color:#fff; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px); cursor:pointer; font-weight:700; font-size:14px; gap:6px; transition:0.2s; }
    .nav-btn:active { transform:scale(0.95); }
    .brand-mini { pointer-events:auto; display:flex; flex-direction:column; align-items:center; cursor:pointer; }
    .brand-mini span { font-family:'Space Grotesk', sans-serif; font-weight:700; font-size:20px; line-height:1; }
    .brand-mini small { font-size:9px; letter-spacing:3px; opacity:0.6; }

    /* GRID */
    .grid { flex:1; display:grid; grid-template-rows: 1fr 80px 1fr; gap:12px; padding:70px 12px 20px; }

    /* --- OYUNCU KARTLARI --- */
    .pane {
      position:relative; border-radius:24px; border:1px solid var(--border);
      background: linear-gradient(160deg, rgba(255,255,255,0.03), rgba(0,0,0,0.4));
      backdrop-filter:blur(10px);
      display:flex; flex-direction:column; overflow:hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      transition: all 0.3s ease;
    }

    /* OYUNCU A (TURKUAZ) */
    #paneA.active { border-color:var(--c-p1); box-shadow: 0 0 40px rgba(0, 243, 255, 0.2); }
    #paneA .p-score { color:var(--c-p1); }
    #paneA .mic-btn.active-mic { background: linear-gradient(135deg, var(--c-p1), #0066ff); box-shadow: 0 10px 30px rgba(0,243,255,0.3); border:none; }

    /* OYUNCU B (BORDO) */
    #paneB { transform: rotate(180deg); }
    #paneB.active { border-color:var(--c-p2-light); box-shadow: 0 0 40px rgba(165, 11, 94, 0.4); }
    #paneB .p-score { color:var(--c-p2-light); }
    #paneB .mic-btn.active-mic { background: linear-gradient(135deg, var(--c-p2-light), var(--c-p2)); box-shadow: 0 10px 30px rgba(165, 11, 94, 0.4); border:none; }
    #paneB::before { content:''; position:absolute; inset:0; background:radial-gradient(circle at center, rgba(128, 0, 32, 0.3), transparent 70%); z-index:-1; opacity:0; transition:0.3s; }
    #paneB.active::before { opacity:1; }

    /* KART ƒ∞√áERƒ∞ƒûƒ∞ */
    .bar { padding:12px 16px; background:rgba(0,0,0,0.3); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-family:'Space Grotesk', sans-serif; }
    
    /* SKOR DETAYLARI */
    .score-stats { display: flex; gap: 10px; align-items: center; font-weight: 800; font-size: 13px; }
    .stat-g { color: var(--c-green); }
    .stat-r { color: var(--c-red); }
    .p-name { font-weight:700; font-size:15px; letter-spacing:0.5px; opacity:0.9; }
    .p-score { font-weight:700; font-size:16px; }

    .body { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:6px; padding:10px; }
    .word { font-size:32px; font-weight:800; color:#fff; font-family:'Space Grotesk', sans-serif; text-align:center; transition:0.3s; }
    .meaning { font-size:16px; color:rgba(255,255,255,0.6); font-weight:500; transition:0.3s; }
    .hint { font-size:12px; font-weight:700; margin-top:8px; opacity:0; transition:0.3s; text-transform:uppercase; letter-spacing:1px; color:#fff; }
    .pane.active .hint { opacity:0.7; }

    .actions { padding:16px; display:flex; justify-content:center; }
    .mic-btn {
      width:100%; padding:14px; border-radius:16px; border:1px solid var(--border);
      background:rgba(255,255,255,0.05); color:#fff; font-weight:700; font-size:16px;
      cursor:pointer; transition:0.2s; display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .mic-btn:disabled { opacity:0.3; cursor:not-allowed; }
    .mic-btn:active { transform:scale(0.96); }

    /* WAVE BOX */
    .wave-box { border-radius:20px; background:rgba(0,0,0,0.6); border:1px solid var(--border); backdrop-filter:blur(10px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; position:relative; overflow:hidden; }
    .wave-status { font-size:12px; font-weight:700; opacity:0.8; letter-spacing:1px; text-transform:uppercase; color:var(--c-p1); }
    .bars { display:flex; gap:4px; height:24px; align-items:center; }
    .b { width:4px; height:8px; background:rgba(255,255,255,0.3); border-radius:4px; transition:0.2s; }
    .wave-box.speaking .b { background:var(--c-green); animation: bounce 0.6s infinite ease-in-out; }
    .wave-box.listening .b { background:var(--c-p1); animation: bounce 0.5s infinite ease-in-out; }
    @keyframes bounce { 0%,100%{height:8px} 50%{height:24px} }
    .b:nth-child(1){animation-delay:0s} .b:nth-child(2){animation-delay:0.1s} .b:nth-child(3){animation-delay:0.2s} .b:nth-child(4){animation-delay:0.3s} .b:nth-child(5){animation-delay:0.4s}

    /* RESULT OVERLAY */
    .result-overlay { position:absolute; inset:0; z-index:20; background:rgba(0,0,0,0.85); display:none; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(8px); animation:fadeIn 0.3s; text-align:center; padding:20px; }
    .result-overlay.show { display:flex; }
    .res-icon { font-size:64px; margin-bottom:16px; animation:popIn 0.4s; }
    .res-text { font-size:24px; font-weight:900; font-family:'Space Grotesk', sans-serif; text-transform:uppercase; letter-spacing:1px; line-height:1.4; text-shadow: 0 5px 20px rgba(0,0,0,0.5); }
    
    .ok .res-text { color:var(--c-green); }
    .bad .res-text { color:var(--c-red); }
    .learn .res-text { color: #fff; }

    @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    /* MODALS */
    .modal-wrap { position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(20px); }
    .modal-card { width:85%; background:#101014; border:1px solid var(--border); border-radius:32px; padding:32px; text-align:center; box-shadow:0 30px 80px rgba(0,0,0,1); animation: popIn 0.5s; }
    .modal-title { font-size:24px; font-weight:800; margin-bottom:12px; font-family:'Space Grotesk', sans-serif; background:linear-gradient(to right, #fff, #aaa); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .modal-p { font-size:15px; opacity:0.7; margin-bottom:32px; line-height:1.6; }
    
    .mode-btn { 
      width:100%; padding:20px; border-radius:20px; border:none; margin-bottom:12px;
      font-weight:800; font-size:16px; cursor:pointer; transition:0.2s; position:relative; overflow:hidden;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .mode-btn:active { transform:scale(0.98); }
    
    /* Mod Renkleri */
    .mode-pronounce { background:linear-gradient(135deg, #00f3ff, #0066ff); color:#000; box-shadow:0 10px 30px rgba(0,243,255,0.2); }
    .mode-vocab { background:linear-gradient(135deg, #ff00aa, #800020); color:#fff; box-shadow:0 10px 30px rgba(165,11,94,0.3); }

    .loader { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--c-p1); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <div class="cosmos-bg"><div class="star-dust"></div></div>
  <canvas id="fireworksCanvas"></canvas>

  <div class="wrap">
    <div class="nav-layer">
      <button class="nav-btn" onclick="window.location.href='/pages/game.html'">‚Üê</button>
      <div class="brand-mini" onclick="window.location.href='/pages/home.html'">
        <span>italky<span style="color:var(--c-p1)">AI</span></span>
        <small>CHAMPIONS</small>
      </div>
      <button class="nav-btn" id="langBtn">üåç EN</button>
    </div>

    <div class="grid">
      <section class="pane top" id="paneB">
        <div class="bar">
          <div class="p-name">OYUNCU B</div>
          <div class="score-stats">
            <span class="stat-g" title="Doƒüru">‚úÖ <span id="corrB">0</span></span>
            <span class="stat-r" title="Yanlƒ±≈ü">‚ùå <span id="wrongB">0</span></span>
            <span class="p-score" id="scoreB">SET: 0</span>
          </div>
        </div>
        <div class="body">
          <div class="word" id="wordB">---</div>
          <div class="meaning" id="meanB">---</div>
          <div class="hint">SENƒ∞N SIRAN</div>
        </div>
        <div class="actions"><button class="mic-btn" id="micB" disabled>üéôÔ∏è CEVAPLA</button></div>
        <div class="result-overlay" id="ovB"></div>
      </section>

      <div class="wave-box" id="waveBox">
        <div class="wave-status" id="waveStatus">HAZIR</div>
        <div class="bars"><div class="b"></div><div class="b"></div><div class="b"></div><div class="b"></div><div class="b"></div></div>
      </div>

      <section class="pane" id="paneA">
        <div class="bar">
          <div class="p-name">OYUNCU A</div>
          <div class="score-stats">
            <span class="stat-g" title="Doƒüru">‚úÖ <span id="corrA">0</span></span>
            <span class="stat-r" title="Yanlƒ±≈ü">‚ùå <span id="wrongA">0</span></span>
            <span class="p-score" id="scoreA">SET: 0</span>
          </div>
        </div>
        <div class="body">
          <div class="word" id="wordA">---</div>
          <div class="meaning" id="meanA">---</div>
          <div class="hint">SENƒ∞N SIRAN</div>
        </div>
        <div class="actions"><button class="mic-btn" id="micA" disabled>üéôÔ∏è CEVAPLA</button></div>
        <div class="result-overlay" id="ovA"></div>
      </section>
    </div>
  </div>

  <div class="modal-wrap" id="startModal">
    <div class="modal-card">
      <div class="modal-title">≈ûAMPƒ∞YONLAR Lƒ∞Gƒ∞ üèÜ</div>
      <div class="modal-p">
        5 Setlik Ma√ß (3 alan kazanƒ±r)<br>
        100 Puan √úzerinden Deƒüerlendirme
      </div>
      <button class="mode-btn mode-pronounce" onclick="selectMode('pronunciation')">
        üó£Ô∏è TELAFFUZ Lƒ∞Gƒ∞
      </button>
      <button class="mode-btn mode-vocab" onclick="selectMode('vocabulary')">
        üß† KELƒ∞ME Lƒ∞Gƒ∞
      </button>
      <div id="loading" style="display:none; margin-top:20px;">
        <div class="loader"></div>
        <div style="font-size:12px;opacity:0.6">Set Hazƒ±rlanƒ±yor...</div>
      </div>
    </div>
  </div>

  <div class="modal-wrap" id="setModal" style="display:none">
    <div class="modal-card">
      <div class="modal-title" id="setTitle">SET Bƒ∞TTƒ∞!</div>
      <div class="modal-p" id="setResult"></div>
      <button class="mode-btn mode-pronounce" id="nextSetBtn">SONRAKƒ∞ SET</button>
    </div>
  </div>

  <div class="modal-wrap" id="matchModal" style="display:none; background:transparent">
    <div class="modal-card" style="margin-top:200px">
      <div class="modal-title" style="font-size:32px">≈ûAMPƒ∞YON! üëë</div>
      <div class="modal-p" id="matchResult" style="font-size:18px; font-weight:bold; color:var(--c-green)"></div>
      <button class="mode-btn" style="background:rgba(255,255,255,0.2)" onclick="location.reload()">TEKRAR OYNA</button>
      <button class="mode-btn" style="background:rgba(0,0,0,0.5)" onclick="location.href='/pages/game.html'">√áIKI≈û</button>
    </div>
  </div>

<script type="module">
import { BASE_DOMAIN } from "/js/config.js";

const $ = (id) => document.getElementById(id);
const apiBase = () => String(BASE_DOMAIN || "").replace(/\/+$/, "");

// SES (Lazy Load)
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = AC ? new AC() : null;
  }
  if(audioCtx && audioCtx.state === "suspended"){
    audioCtx.resume().catch(()=>{});
  }
  return audioCtx;
}

const SFX = {
  correct: () => {
    const ctx = ensureAudio(); if(!ctx) return;
    const now = ctx.currentTime;
    [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
      const osc = ctx.createOscillator(); const gain = ctx.createGain();
      osc.frequency.value = freq; osc.connect(gain); gain.connect(ctx.destination);
      gain.gain.setValueAtTime(0.05, now + i*0.1); gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.4);
      osc.start(now + i*0.1); osc.stop(now + i*0.1 + 0.4);
    });
  },
  wrong: () => {
    const ctx = ensureAudio(); if(!ctx) return;
    const now = ctx.currentTime;
    const osc = ctx.createOscillator(); const gain = ctx.createGain();
    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3);
    osc.connect(gain); gain.connect(ctx.destination);
    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
    osc.start(now); osc.stop(now + 0.4);
  }
};

// OYUN
const TARGET_SETS = 3;
const WORDS_PER_SET = 20;

let gameMode = "";
let wordList = [];
let currentIndex = 0;
let turn = "A";
let isBusy = false;
let vocabAttempt = 0;

// ƒ∞STATƒ∞STƒ∞KLER (Set bazlƒ±)
let setStats = {
  A: { correct: 0, wrong: 0 },
  B: { correct: 0, wrong: 0 }
};
let setsWon = { A: 0, B: 0 };

window.selectMode = async (mode) => {
  gameMode = mode;
  ensureAudio(); // Ses motorunu uyandƒ±r
  $("startModal").querySelector(".modal-p").style.display = "none";
  document.querySelectorAll(".mode-btn").forEach(b => b.style.display = "none");
  $("loading").style.display = "block";
  await fetchWordsFromAI();
}

async function fetchWordsFromAI() {
  try {
    let prompt = "";
    if (gameMode === 'pronunciation') {
      prompt = `Bana ƒ∞ngilizce B1 seviyesinde ${WORDS_PER_SET} adet kelime/c√ºmle ve T√ºrk√ße kar≈üƒ±lƒ±klarƒ±nƒ± JSON listesi olarak ver: [["apple", "elma"], ...]`;
    } else {
      prompt = `Bana ƒ∞ngilizce B1 seviyesinde ${WORDS_PER_SET} adet somut nesne/fiil ve T√ºrk√ße kar≈üƒ±lƒ±klarƒ±nƒ± JSON listesi olarak ver. [["apple", "elma"], ...]`;
    }

    const res = await fetch(`${apiBase()}/api/chat`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: prompt, max_tokens: 1500 })
    });

    const data = await res.json();
    let raw = data.text.replace(/```json/g, "").replace(/```/g, "").trim();
    wordList = JSON.parse(raw);

    if (!Array.isArray(wordList) || wordList.length < 5) throw new Error("Az kelime");

    $("startModal").style.display = "none";
    $("setModal").style.display = "none";
    startSetLoop();

  } catch (err) {
    wordList = [["Apple","Elma"],["Sun","G√ºne≈ü"],["Car","Araba"],["Blue","Mavi"],["Red","Kƒ±rmƒ±zƒ±"],["Time","Zaman"]]; 
    $("startModal").style.display = "none";
    $("setModal").style.display = "none";
    startSetLoop();
  }
}

function startSetLoop() {
  currentIndex = 0;
  // Set istatistiklerini sƒ±fƒ±rla
  setStats = { A: { correct: 0, wrong: 0 }, B: { correct: 0, wrong: 0 } };
  vocabAttempt = 0;
  updateUI();
  
  if (gameMode === 'pronunciation') setTimeout(teacherPhase, 1000);
  else { setWave("idle", "SIRA: OYUNCU " + turn); enableTurnButtons(); }
}

function updateUI() {
  if (currentIndex >= wordList.length) { handleSetEnd(); return; }

  const w = wordList[currentIndex];
  if (gameMode === 'pronunciation') {
    $("wordA").textContent = w[0]; $("meanA").textContent = w[1];
    $("wordB").textContent = w[0]; $("meanB").textContent = w[1];
  } else {
    $("wordA").textContent = w[0]; $("meanA").textContent = "???";
    $("wordB").textContent = w[0]; $("meanB").textContent = "???";
  }
  
  // SKORLARI G√úNCELLE
  $("scoreA").textContent = `SET: ${setsWon.A}`;
  $("corrA").textContent = setStats.A.correct;
  $("wrongA").textContent = setStats.A.wrong;

  $("scoreB").textContent = `SET: ${setsWon.B}`;
  $("corrB").textContent = setStats.B.correct;
  $("wrongB").textContent = setStats.B.wrong;

  // G√∂rsellik
  $("paneA").classList.remove("active"); $("paneB").classList.remove("active");
  $("micA").classList.remove("active-mic"); $("micB").classList.remove("active-mic");
  $("micA").disabled = true; $("micB").disabled = true;

  if (turn === "A") { $("paneA").classList.add("active"); $("micA").classList.add("active-mic"); } 
  else { $("paneB").classList.add("active"); $("micB").classList.add("active-mic"); }
}

function handleSetEnd() {
  // Puan Hesapla: (Doƒüru Sayƒ±sƒ± x 5)
  const scoreA = setStats.A.correct * 5;
  const scoreB = setStats.B.correct * 5;
  
  let winner = "";
  if (scoreA > scoreB) { winner = "A"; setsWon.A++; }
  else if (scoreB > scoreA) { winner = "B"; setsWon.B++; }
  else { winner = "BERABERE"; }

  if (setsWon.A >= TARGET_SETS || setsWon.B >= TARGET_SETS) {
    handleMatchOver();
    return;
  }

  $("setModal").style.display = "flex";
  $("setTitle").textContent = winner === "BERABERE" ? "SET BERABERE!" : `SETƒ∞ OYUNCU ${winner} KAZANDI!`;
  $("setResult").innerHTML = `
    OYUNCU A: ${scoreA} Puan<br>
    OYUNCU B: ${scoreB} Puan<br>
    <small>Durum: ${setsWon.A} - ${setsWon.B}</small>
  `;
  
  $("nextSetBtn").onclick = async () => {
    $("setModal").querySelector(".modal-title").textContent = "YENƒ∞ KELƒ∞MELER...";
    await fetchWordsFromAI();
  };
}

function handleMatchOver() {
  const champ = setsWon.A > setsWon.B ? "OYUNCU A" : "OYUNCU B";
  $("matchModal").style.display = "flex";
  $("matchResult").textContent = `${champ} KAZANDI!`;
  startFireworks();
  setTimeout(() => { stopFireworks(); }, 15000);
}

function enableTurnButtons() {
  if (isBusy) return;
  if (turn === "A") $("micA").disabled = false; else $("micB").disabled = false;
}

function speakBrowser(text, lang) {
  return new Promise(resolve => {
    try{ window.speechSynthesis.cancel(); }catch{}
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang; u.rate = 0.9;
    u.onend = resolve; u.onerror = resolve;
    try{ window.speechSynthesis.speak(u); }catch{ resolve(); }
  });
}

async function teacherPhase() {
  isBusy = true;
  $("micA").disabled = true; $("micB").disabled = true;
  const w = wordList[currentIndex][0];
  setWave("speaking", "Dƒ∞NLE...");
  await speakBrowser(w, "en-US");
  setWave("idle", "SIRA: OYUNCU " + turn);
  isBusy = false;
  enableTurnButtons();
}

window.listen = (player) => {
  if (isBusy || player !== turn) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert("Tarayƒ±cƒ± desteklemiyor."); return; }
  
  try{ window.speechSynthesis.cancel(); }catch{}
  isBusy = true;
  $("micA").disabled = true; $("micB").disabled = true;
  setWave("listening", "Dƒ∞NLƒ∞YOR...");
  
  const rec = new SR();
  rec.lang = (gameMode === 'pronunciation') ? "en-US" : "tr-TR";
  rec.interimResults = false;
  let gotResult = false;
  
  rec.onresult = (e) => {
    gotResult = true;
    try{ rec.stop(); }catch{}
    checkResult(player, e.results[0][0].transcript);
  };
  
  rec.onerror = () => { cleanup(); };
  rec.onend = () => { if(!gotResult) cleanup(); };
  
  try{ rec.start(); }catch{ cleanup(); }
}

function cleanup() {
  isBusy = false;
  setWave("idle", "TEKRAR DENE");
  enableTurnButtons();
}

$("micA").onclick = () => listen("A"); $("micB").onclick = () => listen("B");

async function checkResult(player, text) {
  let target = (gameMode === 'pronunciation') ? wordList[currentIndex][0] : wordList[currentIndex][1];
  const tClean = target.toLowerCase().replace(/[.,!?]/g,"");
  const iClean = text.toLowerCase().replace(/[.,!?]/g,"");
  // Toleranslƒ± kontrol
  const isCorrect = iClean.includes(tClean) || tClean.includes(iClean);
  
  if (isCorrect) {
    SFX.correct();
    showResultOverlay(player, true, "HARƒ∞KA!", "+5 PUAN");
    setStats[player].correct++;
    
    turn = turn === "A" ? "B" : "A"; 
    vocabAttempt = 0;
    
    await new Promise(r => setTimeout(r, 1500));
    currentIndex++;
    updateUI();
    
    if (gameMode === 'pronunciation') setTimeout(teacherPhase, 1000);
    else enableTurnButtons();

  } else {
    SFX.wrong();
    showResultOverlay(player, false, "YANLI≈û!", "SIRA GE√áTƒ∞");
    setStats[player].wrong++;
    
    await new Promise(r => setTimeout(r, 2000));
    turn = turn === "A" ? "B" : "A";
    updateUI();

    if (gameMode === 'vocabulary') {
      if (vocabAttempt === 0) { vocabAttempt = 1; enableTurnButtons(); }
      else { await teachBoth(); }
    } else {
      setTimeout(teacherPhase, 500);
    }
  }
}

async function teachBoth() {
  const w = wordList[currentIndex];
  ["ovA", "ovB"].forEach(id => {
    const el = $(id);
    el.innerHTML = `<div class="res-text" style="font-size:24px">${w[0]}</div><div class="res-text" style="color:var(--c-green)">= ${w[1]}</div>`;
    el.className = "result-overlay show learn";
  });
  
  await speakBrowser(`${w[0]}, ${w[1]}`, "tr-TR");
  await new Promise(r => setTimeout(r, 1500));
  
  ["ovA", "ovB"].forEach(id => $(id).classList.remove("show"));
  currentIndex++;
  vocabAttempt = 0;
  updateUI();
  enableTurnButtons();
}

function showResultOverlay(player, isOk, title, sub) {
  const ov = $(player === "A" ? "ovA" : "ovB");
  ov.innerHTML = `<div class="res-icon">${isOk ? '‚úÖ' : '‚ùå'}</div><div class="res-text">${title}</div><div class="res-sub">${sub}</div>`;
  ov.className = "result-overlay show " + (isOk ? "ok" : "bad");
  setTimeout(() => { ov.classList.remove("show"); }, 1500);
}

function setWave(state, text) {
  $("waveBox").className = "wave-box " + state;
  $("waveStatus").textContent = text;
}

// BALON/HAVAƒ∞ Fƒ∞≈ûEK
let fwInterval=null; const cvs=$("fireworksCanvas"), ctx=cvs.getContext("2d"); let particles=[];
function startFireworks() {
  cvs.style.display="block"; cvs.width=window.innerWidth; cvs.height=window.innerHeight;
  fwInterval = setInterval(()=>{
    const x = Math.random()*cvs.width, y = cvs.height;
    const color = `hsl(${Math.random()*360}, 100%, 50%)`;
    for(let i=0;i<30;i++) particles.push({x:x, y:cvs.height*0.3+Math.random()*cvs.height*0.4, vx:(Math.random()-.5)*10, vy:(Math.random()-.5)*10, life:100, color, alpha:1});
  }, 800);
  requestAnimationFrame(loopFireworks);
}
function stopFireworks() { clearInterval(fwInterval); particles=[]; cvs.style.display="none"; }
function loopFireworks() {
  if (cvs.style.display === "none") return;
  ctx.globalCompositeOperation='destination-out'; ctx.fillStyle='rgba(0,0,0,0.1)'; ctx.fillRect(0,0,cvs.width,cvs.height);
  ctx.globalCompositeOperation='lighter';
  for(let i=0; i<particles.length; i++) {
    let p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.life--; p.alpha=p.life/100;
    ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fillStyle=p.color; ctx.globalAlpha=p.alpha; ctx.fill();
    if(p.life<=0){ particles.splice(i,1); i--; }
  }
  requestAnimationFrame(loopFireworks);
}
window.addEventListener('resize', () => { cvs.width=window.innerWidth; cvs.height=window.innerHeight; });

$("nextSetBtn").onclick = async () => {
  $("setModal").querySelector(".modal-title").textContent = "YENƒ∞ KELƒ∞MELER...";
  await fetchWordsFromAI();
};

</script>
</body>
</html>
