<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>ITALKY ‚Ä¢ Arena V18 Architect</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #030305;
      --border: rgba(255,255,255,0.1);
      --pA: #00f0ff; --pB: #ff0055;
      --green: #00e676; --red: #ff1744; --gold: #ffd700;
      --font-main: 'Outfit', sans-serif;
      --font-display: 'Space Grotesk', sans-serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); font-family: var(--font-main); color: #fff; overflow: hidden; position: fixed; }

    /* FX & HEADER */
    .bg-fx { position: absolute; inset: 0; z-index: 0; background: radial-gradient(circle at 50% 50%, #0a0a12 0%, #000 100%); }
    .app-header { position: absolute; top: 0; left: 0; right: 0; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; pointer-events: none; }
    .header-logo { font-family: var(--font-display); font-weight: 700; font-size: 18px; opacity: 0.8; pointer-events: auto; }
    .header-back { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 12px; background: rgba(255,255,255,0.1); text-decoration: none; color: #fff; font-size: 20px; pointer-events: auto; border: 1px solid rgba(255,255,255,0.1); }

    /* OYUN ALANI */
    .arena-wrap { position: relative; z-index: 10; width: 100%; height: 100dvh; display: flex; flex-direction: column; }
    
    .player-zone { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; transition: all 0.4s ease; overflow: hidden; opacity: 0.4; filter: blur(3px) grayscale(0.8); pointer-events: none; }
    .player-zone.active { opacity: 1; filter: blur(0) grayscale(0); pointer-events: auto; background: radial-gradient(circle at center, rgba(255,255,255,0.04) 0%, transparent 70%); }
    
    #zoneB { border-bottom: 1px solid var(--border); align-items: flex-end; padding-bottom: 20px; }
    #zoneB .card-content { transform: rotate(180deg); }
    #zoneA { border-top: 1px solid var(--border); align-items: flex-end; padding-bottom: 40px; }

    .card-content { width: 88%; max-width: 360px; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
    
    .main-word { font-family: var(--font-display); font-size: 40px; font-weight: 700; line-height: 1.1; margin: 5px 0; letter-spacing: -1px; }
    .sub-word { font-size: 18px; color: rgba(255,255,255,0.6); margin-bottom: 30px; font-weight: 500; min-height: 24px; }

    .player-header { display: flex; align-items: center; gap: 10px; margin-top:10px; margin-bottom: 10px; }
    .player-label { font-size: 12px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; }
    .var-indicator { font-size: 10px; background: rgba(255,215,0,0.2); color: var(--gold); padding: 3px 8px; border-radius: 6px; font-weight: 800; border: 1px solid rgba(255,215,0,0.3); opacity: 0.5; transition: 0.3s; }
    .var-indicator.active { opacity: 1; box-shadow: 0 0 10px rgba(255,215,0,0.2); }

    #zoneA .player-label { color: var(--pA); } #zoneB .player-label { color: var(--pB); }

    /* CONTROLS */
    .controls { display: flex; gap: 12px; width: 100%; margin-top: auto; }
    .btn { border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.06); color: #fff; padding: 16px 0; border-radius: 18px; font-family: var(--font-display); font-weight: 700; font-size: 13px; cursor: pointer; flex: 1; transition: 0.15s; }
    .btn:active { transform: scale(0.95); }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; filter: grayscale(1); }
    
    .btn-mic { flex: 1.8; background: rgba(255,255,255,0.12); }
    .btn.listening { background: #fff !important; color: #000 !important; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: 0 0 0 15px rgba(255,255,255,0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } }

    .btn-var { flex: 0.7; color: var(--gold); border-color: rgba(255,215,0,0.3); }

    /* CENTER */
    .arena-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 140px; height: 56px; background: #000; border: 1px solid var(--border); border-radius: 28px; display: flex; align-items: center; justify-content: space-evenly; z-index: 20; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
    .score-txt { font-family: var(--font-display); font-size: 24px; font-weight: 700; }
    .round-badge { position: absolute; font-size: 10px; font-weight: 800; color: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; }
    #zoneA .round-badge { bottom: 0; } #zoneB .round-badge { top: 0; }

    /* MODAL */
    .modal { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
    .modal:not(.hidden) { opacity: 1; pointer-events: auto; }
    .modal-box { width: 90%; max-width: 360px; background: #121216; border: 1px solid var(--border); border-radius: 32px; padding: 30px; text-align: center; }
    
    .mode-select { display: flex; gap: 10px; margin-bottom: 20px; }
    .mode-btn { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: #fff; cursor: pointer; font-weight: 700; opacity: 0.6; transition: 0.2s; }
    .mode-btn.active { opacity: 1; background: var(--pA); color: #000; border-color: var(--pA); }
    .mode-btn.vocab.active { background: var(--pB); border-color: var(--pB); }

    .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
    .name-input { width: 100%; background: #1a1a20; border: 1px solid var(--border); color: #fff; padding: 14px; border-radius: 12px; font-weight: 700; text-align: center; }
    
    .lang-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 25px; }
    .lang-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #fff; border-radius: 12px; padding: 10px 0; font-size: 20px; cursor: pointer; }
    .lang-btn.active { background: #fff; color: #000; }

    .btn-block { width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 800; font-size: 16px; cursor: pointer; background: #fff; color: #000; }

    /* OVERLAY */
    .result-overlay { position: absolute; inset: -20px; z-index: 50; background: rgba(8, 8, 10, 0.96); backdrop-filter: blur(12px); display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 24px; opacity: 0; pointer-events: none; transform: scale(0.9); transition: 0.25s; }
    .result-overlay.show { opacity: 1; transform: scale(1); }
    .res-title { font-size: 42px; font-weight: 800; font-family: var(--font-display); margin:0; line-height:1; }
    .res-sub { margin-top: 10px; font-size: 16px; color:#ccc; }
    .badge { margin-top: 15px; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 700; background: rgba(255,255,255,0.1); }
  </style>
</head>
<body>

  <div class="bg-fx"></div>
  <div class="app-header">
    <a href="game.html" class="header-back">‚úï</a>
    <div class="header-logo">italkyAI</div>
    <div style="width:40px"></div>
  </div>

  <div class="arena-wrap">
    <div class="player-zone" id="zoneB">
      <div class="card-content">
        <div class="result-overlay" id="ovB"><div class="res-title"></div><div class="res-sub"></div><div class="badge"></div></div>
        <div class="controls">
          <button class="btn btn-var" id="varB" onclick="game.action('var', 'B')">VAR</button>
          <button class="btn" id="passB" onclick="game.action('pass', 'B')">PAS</button>
          <button class="btn btn-mic" id="micB" onclick="game.action('mic', 'B')">üéôÔ∏è CEVAPLA</button>
        </div>
        <div style="margin: auto 0;">
          <div class="main-word" id="wB">...</div>
          <div class="sub-word" id="mB">...</div>
        </div>
        <div class="player-header">
          <div class="player-label" id="lblB">OYUNCU B</div>
          <div class="var-indicator" id="indB">VAR: 1</div>
        </div>
        <div class="round-badge" id="rndB">R1</div>
      </div>
    </div>

    <div class="arena-center">
      <span class="score-txt" style="color:var(--pB)" id="sB">0</span>
      <div style="width:1px; height:20px; background:rgba(255,255,255,0.2)"></div>
      <span class="score-txt" style="color:var(--pA)" id="sA">0</span>
    </div>

    <div class="player-zone" id="zoneA">
      <div class="card-content">
        <div class="result-overlay" id="ovA"><div class="res-title"></div><div class="res-sub"></div><div class="badge"></div></div>
        <div class="player-header">
          <div class="player-label" id="lblA">OYUNCU A</div>
          <div class="var-indicator" id="indA">VAR: 1</div>
        </div>
        <div style="margin: auto 0;">
          <div class="main-word" id="wA">...</div>
          <div class="sub-word" id="mA">...</div>
        </div>
        <div class="controls">
          <button class="btn" id="passA" onclick="game.action('pass', 'A')">PAS</button>
          <button class="btn btn-mic" id="micA" onclick="game.action('mic', 'A')">üéôÔ∏è CEVAPLA</button>
          <button class="btn btn-var" id="varA" onclick="game.action('var', 'A')">VAR</button>
        </div>
        <div class="round-badge" id="rndA">R1</div>
      </div>
    </div>
  </div>

  <div class="modal" id="setupModal">
    <div class="modal-box">
      <div class="header-logo" style="font-size:24px; margin-bottom:20px;">ARENA SETUP</div>
      
      <div class="mode-select">
        <div class="mode-btn active" onclick="setup.setMode('pron')" id="btnModePron">üéôÔ∏è TELAFFUZ<br><span style="font-size:10px; opacity:0.7">Oku & Puanla</span></div>
        <div class="mode-btn vocab" onclick="setup.setMode('vocab')" id="btnModeVocab">üß† KELƒ∞ME<br><span style="font-size:10px; opacity:0.7">Bil & S√∂yle</span></div>
      </div>

      <div class="input-group">
        <input type="text" class="name-input" id="inpA" placeholder="Oyuncu A">
        <input type="text" class="name-input p2" id="inpB" placeholder="Oyuncu B">
      </div>

      <div class="lang-grid">
        <button class="lang-btn active" data-lang="en">üá¨üáß</button>
        <button class="lang-btn" data-lang="de">üá©üá™</button>
        <button class="lang-btn" data-lang="fr">üá´üá∑</button>
        <button class="lang-btn" data-lang="es">üá™üá∏</button>
        <button class="lang-btn" data-lang="it">üáÆüáπ</button>
      </div>

      <button class="btn-block" onclick="game.init()">BA≈ûLA</button>
    </div>
  </div>

<script>
// --- GLOBAL UTILS ---
function normalize(str) { 
  return str.toLowerCase().replace(/√ü/g, "ss").normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9 ]/g, "").trim(); 
}

function getBestMatchScore(target, spoken) {
  const normTarget = normalize(target);
  const normSpoken = normalize(spoken);
  // Basit check: i√ßeriyor mu?
  if (normSpoken.includes(normTarget)) return 100;
  
  // Detaylƒ± check
  let bestScore = similarity(normTarget, normSpoken);
  normSpoken.split(" ").forEach(w => {
    const score = similarity(normTarget, w);
    if (score > bestScore) bestScore = score;
  });
  return Math.floor(bestScore * 100);
}

function similarity(s1, s2) {
  let longer = s1, shorter = s2;
  if (s1.length < s2.length) { longer = s2; shorter = s1; }
  const longerLength = longer.length;
  if (longerLength === 0) return 1.0;
  return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
}

function editDistance(s1, s2) {
  const costs = new Array();
  for (let i = 0; i <= s1.length; i++) {
    let lastValue = i;
    for (let j = 0; j <= s2.length; j++) {
      if (i == 0) costs[j] = j;
      else if (j > 0) {
        let newValue = costs[j - 1];
        if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
        costs[j - 1] = lastValue;
        lastValue = newValue;
      }
    }
    if (i > 0) costs[s2.length] = lastValue;
  }
  return costs[s2.length];
}

// --- DATA ---
const DB = {
  en: [{w:"Excellent",tr:"M√ºkemmel"},{w:"Challenge",tr:"Meydan Okuma"},{w:"Opportunity",tr:"Fƒ±rsat"},{w:"Journey",tr:"Yolculuk"},{w:"Environment",tr:"√áevre"},{w:"Necessary",tr:"Gerekli"},{w:"Dangerous",tr:"Tehlikeli"},{w:"Knowledge",tr:"Bilgi"},{w:"Experience",tr:"Deneyim"},{w:"Incredible",tr:"ƒ∞nanƒ±lmaz"},{w:"Understand",tr:"Anlamak"},{w:"Remember",tr:"Hatƒ±rlamak"},{w:"Solution",tr:"√á√∂z√ºm"},{w:"Together",tr:"Birlikte"},{w:"Success",tr:"Ba≈üarƒ±"},{w:"Future",tr:"Gelecek"},{w:"Freedom",tr:"√ñzg√ºrl√ºk"}],
  de: [{w:"Entscheidung",tr:"Karar"},{w:"M√∂glichkeit",tr:"ƒ∞mkan"},{w:"Erfahrung",tr:"Deneyim"},{w:"Nat√ºrlich",tr:"Doƒüal"},{w:"Wichtig",tr:"√ñnemli"},{w:"Zusammen",tr:"Birlikte"},{w:"Schmetterling",tr:"Kelebek"},{w:"Gef√§hrlich",tr:"Tehlikeli"},{w:"Entschuldigung",tr:"√ñz√ºr Dilerim"}],
  fr: [{w:"Bonjour",tr:"Merhaba"},{w:"Amour",tr:"A≈ük"},{w:"Voiture",tr:"Araba"},{w:"Maison",tr:"Ev"},{w:"Magnifique",tr:"Muhte≈üem"},{w:"Toujours",tr:"Her zaman"}],
  es: [{w:"Coraz√≥n",tr:"Kalp"},{w:"Amigo",tr:"Arkada≈ü"},{w:"Tiempo",tr:"Zaman"},{w:"Vida",tr:"Hayat"},{w:"Felicidad",tr:"Mutluluk"},{w:"Peligroso",tr:"Tehlikeli"}],
  it: [{w:"Ciao",tr:"Merhaba"},{w:"Grazie",tr:"Te≈üekk√ºrler"},{w:"Famiglia",tr:"Aile"},{w:"Piccolo",tr:"K√º√ß√ºk"},{w:"Mangiare",tr:"Yemek"},{w:"Dormire",tr:"Uyumak"}]
};

// --- SETUP LOGIC ---
const setup = {
  mode: 'pron', // pron | vocab
  lang: 'en',
  setMode: function(m) {
    this.mode = m;
    document.getElementById('btnModePron').className = `mode-btn ${m==='pron'?'active':''}`;
    document.getElementById('btnModeVocab').className = `mode-btn vocab ${m==='vocab'?'active':''}`;
  }
};

document.querySelectorAll('.lang-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    setup.lang = btn.getAttribute('data-lang');
  }
});

// --- GAME ENGINE (STATE MACHINE) ---
const STATE = { IDLE:0, LISTENING:1, RESOLVING:2, PAUSED:3 };

const game = {
  state: STATE.IDLE,
  turn: 'A',
  words: [],
  idx: 0,
  scores: { A:0, B:0 },
  varRights: { A:1, B:1 },
  names: { A:'A', B:'B' },
  activeMicId: null,
  watchdog: null,

  init: function() {
    const nA = document.getElementById('inpA').value.trim();
    const nB = document.getElementById('inpB').value.trim();
    if(!nA || !nB) { alert("L√ºtfen isimleri giriniz."); return; }
    
    this.names = { A:nA, B:nB };
    this.loadWords();
    this.idx = 0;
    this.scores = {A:0, B:0};
    this.varRights = {A:1, B:1};
    this.state = STATE.IDLE;
    
    document.getElementById('lblA').innerText = nA;
    document.getElementById('lblB').innerText = nB;
    document.getElementById('setupModal').classList.add('hidden');
    
    this.render();
  },

  loadWords: function() {
    let raw = DB[setup.lang] || DB.en;
    // 3 katƒ±na √ßƒ±kar ve karƒ±≈ütƒ±r
    this.words = [...raw, ...raw, ...raw].sort(()=>Math.random()-0.5);
  },

  action: function(type, p) {
    // Sadece IDLE durumunda ve sƒ±ra sendeyse i≈ülem yapabilirsin
    if (this.state !== STATE.IDLE) return;
    if (this.turn !== p) return;

    if (type === 'pass') {
      this.nextTurn();
    } else if (type === 'var') {
      this.useVar(p);
    } else if (type === 'mic') {
      this.startListening(p);
    }
  },

  startListening: function(p) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) { alert("Tarayƒ±cƒ± desteklemiyor"); return; }

    this.state = STATE.LISTENING;
    this.updateControls(); // Butonlarƒ± kilitle

    const btn = document.getElementById(`mic${p}`);
    btn.classList.add('listening');
    this.activeMicId = `mic${p}`;

    const rec = new SR();
    rec.lang = (setup.lang === 'en') ? 'en-US' : (setup.lang==='de'?'de-DE':(setup.lang==='fr'?'fr-FR':(setup.lang==='es'?'es-ES':'it-IT')));
    rec.interimResults = false;
    rec.maxAlternatives = 1;

    // EMNƒ∞YET Sƒ∞GORTASI: 8sn ses gelmezse resetle
    this.watchdog = setTimeout(() => {
      rec.stop(); this.resetState();
    }, 8000);

    rec.onresult = (e) => {
      clearTimeout(this.watchdog);
      const txt = e.results[0][0].transcript;
      this.checkAnswer(txt, p);
    };

    rec.onerror = () => { clearTimeout(this.watchdog); this.resetState(); };
    rec.onend = () => { /* Watchdog halleder */ };
    rec.start();
  },

  checkAnswer: function(spoken, p) {
    const target = this.words[this.idx].w;
    const score = getBestMatchScore(target, spoken);
    // ADƒ∞L ZORLUK: %90
    const isCorrect = score >= 90;
    
    // State Resolving'e ge√ßiyor
    this.state = STATE.RESOLVING;
    // G√∂rsel temizlik
    if(this.activeMicId) document.getElementById(this.activeMicId).classList.remove('listening');
    
    this.showOverlay(p, isCorrect, score, target);
  },

  useVar: function(p) {
    if (this.varRights[p] <= 0) return;
    this.varRights[p]--;
    this.state = STATE.RESOLVING;
    this.showOverlay(p, true, 100, this.words[this.idx].w, true);
  },

  showOverlay: function(p, isCorrect, score, target, isVar = false) {
    const el = document.getElementById(`ov${p}`);
    const title = el.querySelector('.res-title');
    const sub = el.querySelector('.res-sub');
    const badge = el.querySelector('.badge');

    el.classList.add('show');
    badge.innerText = isVar ? "HAKEM KARARI" : `%${score} BENZERLƒ∞K`;

    if (isCorrect) {
      title.innerText = "HARƒ∞KA!"; title.style.color = "var(--green)";
      let pts = (score >= 98 && !isVar) ? 2 : 1;
      sub.innerText = `+${pts} PUAN`;
      this.scores[p] += pts;
      badge.style.color = "var(--green)";
      setTimeout(() => this.finishRound(), 1500);
    } else {
      title.innerText = "OLMADI"; title.style.color = "var(--red)";
      sub.innerText = `Doƒürusu: ${target}`;
      badge.style.color = "var(--red)";
      setTimeout(() => this.finishRound(), 2500);
    }
  },

  finishRound: function() {
    // Overlay kapat
    document.querySelectorAll('.result-overlay').forEach(el => el.classList.remove('show'));
    this.nextTurn();
  },

  nextTurn: function() {
    this.idx++;
    if(this.idx >= this.words.length) { this.loadWords(); this.idx = 0; }
    
    this.turn = (this.turn === 'A') ? 'B' : 'A';
    this.resetState(); // IDLE'a d√∂n ve √ßiz
  },

  resetState: function() {
    clearTimeout(this.watchdog);
    if(this.activeMicId) document.getElementById(this.activeMicId).classList.remove('listening');
    this.state = STATE.IDLE;
    this.render();
  },

  render: function() {
    // 1. Zone Aktifliƒüi (Spotlight)
    const zA = document.getElementById('zoneA');
    const zB = document.getElementById('zoneB');
    if (this.turn === 'A') { zA.classList.add('active'); zB.classList.remove('active'); }
    else { zB.classList.add('active'); zA.classList.remove('active'); }

    // 2. Kelimeler (MODA G√ñRE)
    const item = this.words[this.idx];
    const wA = document.getElementById('wA'); const mA = document.getElementById('mA');
    const wB = document.getElementById('wB'); const mB = document.getElementById('mB');

    if (setup.mode === 'pron') {
      // Telaffuz Modu: Ana kelime ƒ∞ngilizce, altƒ± T√ºrk√ße
      wA.innerText = item.w; mA.innerText = item.tr;
      wB.innerText = item.w; mB.innerText = item.tr;
    } else {
      // Kelime Modu: Ana kelime T√ºrk√ße, altƒ± ???
      wA.innerText = item.tr; mA.innerText = "???";
      wB.innerText = item.tr; mB.innerText = "???";
    }

    // 3. Skorlar & VAR
    document.getElementById('sA').innerText = this.scores.A;
    document.getElementById('sB').innerText = this.scores.B;
    
    const indA = document.getElementById('indA'); const indB = document.getElementById('indB');
    indA.innerText = `VAR: ${this.varRights.A}`; indA.className = `var-indicator ${this.varRights.A>0?'active':''}`;
    indB.innerText = `VAR: ${this.varRights.B}`; indB.className = `var-indicator ${this.varRights.B>0?'active':''}`;

    // 4. Butonlarƒ± Y√∂net
    this.updateControls();
  },

  updateControls: function() {
    // T√ºm butonlarƒ± bul
    const allBtns = document.querySelectorAll('.btn');
    
    if (this.state !== STATE.IDLE) {
      // Oyun me≈ügulse (dinliyor veya sonu√ß g√∂steriyor) HEPSƒ∞Nƒ∞ kilitle
      allBtns.forEach(b => b.disabled = true);
      return;
    }

    // IDLE ise: Sadece sƒ±rasƒ± gelenin butonlarƒ±nƒ± a√ß
    allBtns.forEach(b => b.disabled = true); // √ñnce hepsi kilitli

    // Aktif oyuncunun butonlarƒ±nƒ± a√ß
    const p = this.turn;
    document.getElementById(`mic${p}`).disabled = false;
    document.getElementById(`pass${p}`).disabled = false;
    
    // VAR butonu hakkƒ± varsa a√ßƒ±lƒ±r
    if (this.varRights[p] > 0) document.getElementById(`var${p}`).disabled = false;
  }
};
</script>
</body>
</html>
