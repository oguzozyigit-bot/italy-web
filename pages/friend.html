<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>ITALKY ‚Ä¢ Arena V17 Unstoppable</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #030305;
      --border: rgba(255,255,255,0.08);
      --glass: rgba(255, 255, 255, 0.03);
      --pA: #00f0ff; /* Cyber Cyan */
      --pB: #ff0055; /* Neon Pink */
      --green: #00e676; --red: #ff1744; --gold: #ffd700;
      --font-main: 'Outfit', sans-serif;
      --font-display: 'Space Grotesk', sans-serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
    
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      background: var(--bg); font-family: var(--font-main);
      color: #fff; overflow: hidden; position: fixed;
    }

    /* ARKA PLAN */
    .bg-fx { position: absolute; inset: 0; z-index: 0; background: radial-gradient(circle at 50% 50%, #0a0a12 0%, #000 100%); }
    .nebula { position: absolute; width: 600px; height: 600px; border-radius: 50%; filter: blur(90px); opacity: 0.15; animation: breathe 10s infinite alternate; }
    .nebula-a { background: var(--pA); top: -200px; left: -100px; }
    .nebula-b { background: var(--pB); bottom: -200px; right: -100px; animation-delay: -5s; }
    @keyframes breathe { 0% { transform: scale(1); opacity: 0.1; } 100% { transform: scale(1.2); opacity: 0.2; } }

    /* HEADER */
    .app-header {
      position: absolute; top: 0; left: 0; right: 0; height: 60px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; z-index: 100; pointer-events: none;
    }
    .header-logo { font-family: var(--font-display); font-weight: 700; font-size: 18px; letter-spacing: -0.5px; opacity: 0.8; pointer-events: auto; }
    .header-back {
      width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
      border-radius: 12px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
      text-decoration: none; color: #fff; font-size: 20px; pointer-events: auto;
      border: 1px solid rgba(255,255,255,0.1); transition: 0.2s;
    }
    .header-back:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

    /* OYUN ALANI */
    .arena-wrap { position: relative; z-index: 10; width: 100%; height: 100dvh; display: flex; flex-direction: column; }
    
    .player-zone {
      flex: 1; position: relative; display: flex; justify-content: center; align-items: center;
      transition: all 0.4s ease-out; overflow: hidden;
      opacity: 0.4; filter: blur(3px) grayscale(0.8); pointer-events: none;
    }
    /* Aktif oyuncu parlar, diƒüeri s√∂ner */
    .player-zone.active {
      opacity: 1; filter: blur(0) grayscale(0); pointer-events: auto;
      background: radial-gradient(circle at center, rgba(255,255,255,0.04) 0%, transparent 70%);
    }
    
    #zoneB { border-bottom: 1px solid var(--border); align-items: flex-end; padding-bottom: 20px; }
    #zoneB .card-content { transform: rotate(180deg); }
    #zoneA { border-top: 1px solid var(--border); align-items: flex-end; padding-bottom: 40px; }

    .card-content { width: 88%; max-width: 360px; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
    
    .player-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
    .player-label { font-size: 12px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; }
    .var-indicator { 
      font-size: 10px; background: rgba(255,215,0,0.2); color: var(--gold); 
      padding: 3px 8px; border-radius: 6px; font-weight: 800; border: 1px solid rgba(255,215,0,0.3);
      opacity: 0.5; transition: 0.3s;
    }
    .var-indicator.has-rights { opacity: 1; box-shadow: 0 0 10px rgba(255,215,0,0.2); }

    #zoneA .player-label { color: var(--pA); text-shadow: 0 0 15px rgba(0, 240, 255, 0.4); }
    #zoneB .player-label { color: var(--pB); text-shadow: 0 0 15px rgba(255, 0, 85, 0.4); }

    .main-word { font-family: var(--font-display); font-size: 40px; font-weight: 700; line-height: 1.1; margin: 5px 0; letter-spacing: -1px; }
    .sub-word { font-size: 18px; color: rgba(255,255,255,0.6); margin-bottom: 30px; font-weight: 500; min-height: 24px; }

    .controls { display: flex; gap: 12px; width: 100%; margin-top: auto; }
    .btn {
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.06); backdrop-filter: blur(10px);
      color: #fff; padding: 16px 0; border-radius: 18px;
      font-family: var(--font-display); font-weight: 700; font-size: 13px; letter-spacing: 0.5px;
      cursor: pointer; flex: 1; transition: all 0.15s;
    }
    .btn:active { transform: scale(0.94); background: rgba(255,255,255,0.12); }
    
    /* Disabled stili sadece ger√ßekten kilitliyken */
    .btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); transform: none; }

    .btn-mic { flex: 1.8; background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.25); }
    .btn-var { flex: 0.7; color: var(--gold); border-color: rgba(255, 215, 0, 0.3); background: rgba(255, 215, 0, 0.05); }

    .btn.listening { background: #fff !important; color: #000 !important; box-shadow: 0 0 20px rgba(255,255,255,0.5); border-color: #fff; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

    .round-badge { position: absolute; font-size: 10px; font-weight: 800; letter-spacing: 1.5px; color: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; }
    #zoneA .round-badge { bottom: 0; }
    #zoneB .round-badge { top: 0; }

    .arena-center {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 140px; height: 56px; background: #000; border: 1px solid var(--border); border-radius: 28px;
      display: flex; align-items: center; justify-content: space-evenly; z-index: 20; box-shadow: 0 0 40px rgba(0,0,0,0.8);
    }
    .score-txt { font-family: var(--font-display); font-size: 24px; font-weight: 700; }
    .vs-line { width: 1px; height: 20px; background: rgba(255,255,255,0.15); }

    .modal { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.85); backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
    .modal:not(.hidden) { opacity: 1; pointer-events: auto; }
    .modal-box { width: 90%; max-width: 360px; background: #121216; border: 1px solid var(--border); border-radius: 32px; padding: 32px 24px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.6); transform: scale(0.95); transition: 0.3s; }
    .modal:not(.hidden) .modal-box { transform: scale(1); }

    .input-group { display: flex; gap: 12px; margin-bottom: 25px; }
    .name-input { width: 100%; background: #1a1a20; border: 1px solid var(--border); color: #fff; padding: 14px; border-radius: 14px; font-family: var(--font-main); font-weight: 600; text-align: center; font-size: 15px; }
    .name-input:focus { background: #222; border-color: var(--pA); outline:none; }
    .name-input.p2:focus { border-color: var(--pB); }

    .lang-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 25px; }
    .lang-btn { background: rgba(255,255,255,0.04); border: 1px solid var(--border); color: rgba(255,255,255,0.6); border-radius: 12px; padding: 10px 0; font-size: 20px; cursor: pointer; transition: 0.2s; }
    .lang-btn.active { background: #fff; color: #000; border-color: #fff; transform: scale(1.05); }

    .btn-block { width: 100%; padding: 18px; margin-top: 10px; border-radius: 16px; border: none; font-weight: 700; font-family: var(--font-display); font-size: 16px; cursor: pointer; letter-spacing: 0.5px; }
    .set-stat-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 15px; }

    /* OVERLAY */
    .result-overlay { position: absolute; inset: -20px; z-index: 50; background: rgba(8, 8, 10, 0.96); backdrop-filter: blur(12px); display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 24px; opacity: 0; pointer-events: none; transform: scale(0.9); transition: 0.25s; }
    .result-overlay.show { opacity: 1; transform: scale(1); }
    .res-val { font-size: 14px; font-weight: 600; opacity: 0.7; letter-spacing: 1px; margin-bottom: 5px; text-transform: uppercase; }
    .res-title { font-size: 42px; font-weight: 800; margin: 0; line-height: 1; font-family: var(--font-display); }
    .res-sub { margin-top: 10px; font-size: 16px; opacity: 0.8; }
    .badge { margin-top: 15px; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 700; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); }
  </style>
</head>
<body>

  <div class="bg-fx"></div>
  <div class="nebula nebula-a"></div>
  <div class="nebula nebula-b"></div>

  <div class="app-header">
    <a href="game.html" class="header-back">‚úï</a>
    <div class="header-logo">italkyAI</div>
    <div style="width:40px"></div>
  </div>

  <div class="arena-wrap">
    
    <div class="player-zone" id="zoneB">
      <div class="card-content">
        <div class="result-overlay" id="ovB"><div class="res-val">SONU√á</div><div class="res-title"></div><div class="res-sub"></div><div class="badge"></div></div>
        
        <div class="controls">
          <button class="btn btn-var" id="varB" onclick="game.useVar('B')">VAR</button>
          <button class="btn btn-pass" id="passB" onclick="game.pass('B')">PAS</button>
          <button class="btn btn-mic" id="micB" onclick="game.listen('B')">üéôÔ∏è CEVAPLA</button>
        </div>
        
        <div style="margin: auto 0;">
          <div class="main-word" id="wB">...</div>
          <div class="sub-word" id="mB">...</div>
        </div>
        
        <div class="player-header" style="justify-content:center; margin-top:20px;">
          <div class="player-label" id="lblB">OYUNCU B</div>
          <div class="var-indicator" id="indB">VAR: 1</div>
        </div>
        <div class="round-badge" id="rndB">ROUND 1</div>
      </div>
    </div>

    <div class="arena-center">
      <span class="score-txt" style="color:var(--pB)" id="sB">0</span>
      <div class="vs-line"></div>
      <span class="score-txt" style="color:var(--pA)" id="sA">0</span>
    </div>

    <div class="player-zone" id="zoneA">
      <div class="card-content">
        <div class="result-overlay" id="ovA"><div class="res-val">SONU√á</div><div class="res-title"></div><div class="res-sub"></div><div class="badge"></div></div>
        
        <div class="player-header" style="justify-content:center; margin-bottom:20px;">
          <div class="player-label" id="lblA">OYUNCU A</div>
          <div class="var-indicator" id="indA">VAR: 1</div>
        </div>

        <div style="margin: auto 0;">
          <div class="main-word" id="wA">...</div>
          <div class="sub-word" id="mA">...</div>
        </div>

        <div class="controls">
          <button class="btn btn-pass" id="passA" onclick="game.pass('A')">PAS</button>
          <button class="btn btn-mic" id="micA" onclick="game.listen('A')">üéôÔ∏è CEVAPLA</button>
          <button class="btn btn-var" id="varA" onclick="game.useVar('A')">VAR</button>
        </div>
        <div class="round-badge" id="rndA">ROUND 1</div>
      </div>
    </div>
  </div>

  <div class="modal" id="setupModal">
    <div class="modal-box">
      <div class="header-logo" style="font-size:26px; margin-bottom:20px;">italkyAI ARENA</div>
      <div class="input-group">
        <input type="text" class="name-input" id="inpA" placeholder="Oyuncu A">
        <input type="text" class="name-input p2" id="inpB" placeholder="Oyuncu B">
      </div>
      <div class="lang-grid">
        <button class="lang-btn active" data-lang="en">üá¨üáß</button>
        <button class="lang-btn" data-lang="de">üá©üá™</button>
        <button class="lang-btn" data-lang="fr">üá´üá∑</button>
        <button class="lang-btn" data-lang="es">üá™üá∏</button>
        <button class="lang-btn" data-lang="it">üáÆüáπ</button>
      </div>
      <button class="btn-block" style="background:var(--pA); color:#000" onclick="game.init()">BA≈ûLA</button>
    </div>
  </div>

  <div class="modal hidden" id="pauseModal">
    <div class="modal-box">
      <div style="font-family:var(--font-display); font-weight:700; font-size:20px; margin-bottom:15px; color:#fff;">SET √ñZETƒ∞</div>
      <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:16px; margin-bottom:20px;">
        <div class="set-stat-row"><span style="color:var(--pA); font-weight:700" id="statNameA">A</span><span id="statScoreA">0</span></div>
        <div class="set-stat-row" style="border:none; padding-bottom:0;"><span style="color:var(--pB); font-weight:700" id="statNameB">B</span><span id="statScoreB">0</span></div>
      </div>
      <div style="font-size:22px; font-weight:800; color:var(--gold); margin-bottom:25px; font-family:var(--font-display);" id="setWinnerMsg">...</div>
      <button class="btn-block" style="background:var(--green); color:#000" onclick="game.continueGame()">DEVAM ET</button>
      <button class="btn-block" style="background:rgba(255,255,255,0.1); color:#fff" onclick="location.href='game.html'">√áIKI≈û</button>
    </div>
  </div>

<script>
const RAW_DB = {
  en: [{w:"Excellent",tr:"M√ºkemmel"},{w:"Decision",tr:"Karar"},{w:"Challenge",tr:"Meydan Okuma"},{w:"Opportunity",tr:"Fƒ±rsat"},{w:"Journey",tr:"Yolculuk"},{w:"Environment",tr:"√áevre"},{w:"Development",tr:"Geli≈üim"},{w:"Necessary",tr:"Gerekli"},{w:"Beautiful",tr:"G√ºzel"},{w:"Dangerous",tr:"Tehlikeli"},{w:"Knowledge",tr:"Bilgi"},{w:"Experience",tr:"Deneyim"},{w:"Incredible",tr:"ƒ∞nanƒ±lmaz"},{w:"Understand",tr:"Anlamak"},{w:"Remember",tr:"Hatƒ±rlamak"},{w:"Question",tr:"Soru"},{w:"Solution",tr:"√á√∂z√ºm"},{w:"Language",tr:"Dil"},{w:"Computer",tr:"Bilgisayar"},{w:"History",tr:"Tarih"},{w:"Together",tr:"Birlikte"},{w:"Family",tr:"Aile"},{w:"Friend",tr:"Arkada≈ü"},{w:"Success",tr:"Ba≈üarƒ±"}],
  de: [{w:"Entscheidung",tr:"Karar"},{w:"M√∂glichkeit",tr:"ƒ∞mkan"},{w:"Erfahrung",tr:"Deneyim"},{w:"Nat√ºrlich",tr:"Doƒüal"},{w:"Wichtig",tr:"√ñnemli"},{w:"Zusammen",tr:"Birlikte"},{w:"Schmetterling",tr:"Kelebek"},{w:"Gef√§hrlich",tr:"Tehlikeli"},{w:"Entschuldigung",tr:"√ñz√ºr Dilerim"}],
  fr: [{w:"Bonjour",tr:"Merhaba"},{w:"Amour",tr:"A≈ük"},{w:"Voiture",tr:"Araba"},{w:"Maison",tr:"Ev"},{w:"Magnifique",tr:"Muhte≈üem"},{w:"Toujours",tr:"Her zaman"}],
  es: [{w:"Coraz√≥n",tr:"Kalp"},{w:"Amigo",tr:"Arkada≈ü"},{w:"Tiempo",tr:"Zaman"},{w:"Vida",tr:"Hayat"},{w:"Felicidad",tr:"Mutluluk"},{w:"Peligroso",tr:"Tehlikeli"}],
  it: [{w:"Ciao",tr:"Merhaba"},{w:"Grazie",tr:"Te≈üekk√ºrler"},{w:"Famiglia",tr:"Aile"},{w:"Piccolo",tr:"K√º√ß√ºk"},{w:"Mangiare",tr:"Yemek"},{w:"Dormire",tr:"Uyumak"}]
};

let selLang = 'en';
document.querySelectorAll('.lang-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selLang = btn.getAttribute('data-lang');
  });
});

// TEK VE G√ú√áL√ú NORMALIZE
function normalize(str) { return str.toLowerCase().replace(/√ü/g, "ss").normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9 ]/g, "").trim(); }

function getBestMatchScore(target, spoken) {
  const normTarget = normalize(target);
  const normSpoken = normalize(spoken);
  let bestScore = similarity(normTarget, normSpoken);
  normSpoken.split(" ").forEach(w => {
    const score = similarity(normTarget, w);
    if (score > bestScore) bestScore = score;
  });
  return Math.floor(bestScore * 100);
}

function similarity(s1, s2) {
  let longer = s1, shorter = s2;
  if (s1.length < s2.length) { longer = s2; shorter = s1; }
  const longerLength = longer.length;
  if (longerLength === 0) return 1.0;
  return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
}

function editDistance(s1, s2) {
  const costs = new Array();
  for (let i = 0; i <= s1.length; i++) {
    let lastValue = i;
    for (let j = 0; j <= s2.length; j++) {
      if (i == 0) costs[j] = j;
      else if (j > 0) {
        let newValue = costs[j - 1];
        if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
        costs[j - 1] = lastValue;
        lastValue = newValue;
      }
    }
    if (i > 0) costs[s2.length] = lastValue;
  }
  return costs[s2.length];
}

const SFX = {
  ctx: null,
  init: function() { window.AudioContext = window.AudioContext || window.webkitAudioContext; this.ctx = new AudioContext(); },
  play: function(type) {
    if(!this.ctx) this.init(); if(this.ctx.state === 'suspended') this.ctx.resume();
    const osc = this.ctx.createOscillator(), gain = this.ctx.createGain();
    osc.connect(gain); gain.connect(this.ctx.destination);
    if(type === 'correct') {
      osc.type = 'sine'; osc.frequency.setValueAtTime(600, this.ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, this.ctx.currentTime+0.1);
      gain.gain.setValueAtTime(0.2, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+0.4);
      osc.start(); osc.stop(this.ctx.currentTime+0.4);
    } else {
      osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, this.ctx.currentTime); osc.frequency.linearRampToValueAtTime(100, this.ctx.currentTime+0.2);
      gain.gain.setValueAtTime(0.2, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+0.3);
      osc.start(); osc.stop(this.ctx.currentTime+0.3);
    }
  }
};

const game = {
  words: [], idx: 0, moveCount: 0, lastPauseCheck: 0, setNumber: 1, 
  turn: 'A', score: { A:0, B:0 }, setScore: { A:0, B:0 }, names: { A:'A', B:'B' }, 
  busy: false, inputLocked: false, isPaused: false, currentSnapshot: null, 
  varRights: { A:1, B:1 }, activeMicId: null,

  init: function() {
    const nA = document.getElementById('inpA').value.trim();
    const nB = document.getElementById('inpB').value.trim();
    if (!nA || !nB) { alert("L√ºtfen oyuncu isimlerini giriniz!"); return; }

    this.names.A = nA; this.names.B = nB;
    document.getElementById('lblA').innerText = this.names.A;
    document.getElementById('lblB').innerText = this.names.B;
    this.fillPool();
    this.idx = 0; this.moveCount = 0; this.lastPauseCheck = 0; this.setNumber = 1;
    this.score = {A:0, B:0}; this.setScore = {A:0, B:0}; this.varRights = {A:1, B:1};
    this.turn = Math.random()>0.5 ? 'A' : 'B';
    document.getElementById('setupModal').classList.add('hidden');
    SFX.init(); this.updateUI(); this.startTurn();
  },

  fillPool: function() {
    let raw = RAW_DB[selLang] || RAW_DB.en;
    this.words = [...raw, ...raw, ...raw].sort(() => Math.random() - 0.5);
  },

  startTurn: function() {
    if (this.moveCount > 0 && this.moveCount % 20 === 0 && this.lastPauseCheck !== this.moveCount) {
      this.lastPauseCheck = this.moveCount; this.pauseGame(); return;
    }
    if (this.idx >= this.words.length) { this.fillPool(); this.idx = 0; }

    this.renderTurn();
    const item = this.words[this.idx];
    setTimeout(() => { if(!this.busy && !this.inputLocked && !this.isPaused) this.speak(item.w, 0.9); }, 600);
  },

  // UI STATE Y√ñNETƒ∞Mƒ∞
  updateUI: function() {
    // Skorlar ve VAR haklarƒ±
    document.getElementById('sA').innerText = this.score.A;
    document.getElementById('sB').innerText = this.score.B;
    
    document.getElementById('indA').innerText = `VAR: ${this.varRights.A}`;
    document.getElementById('indB').innerText = `VAR: ${this.varRights.B}`;
    document.getElementById('indA').classList.toggle('has-rights', this.varRights.A > 0);
    document.getElementById('indB').classList.toggle('has-rights', this.varRights.B > 0);

    // Buton aktiflik (Akƒ±llƒ± Kilit)
    const activeA = (!this.busy && !this.inputLocked && this.turn === 'A');
    const activeB = (!this.busy && !this.inputLocked && this.turn === 'B');

    // ZONE A Butonlarƒ±
    document.getElementById('micA').disabled = !activeA;
    document.getElementById('passA').disabled = !activeA;
    document.getElementById('varA').disabled = !(activeA && this.varRights.A > 0);
    
    // ZONE B Butonlarƒ±
    document.getElementById('micB').disabled = !activeB;
    document.getElementById('passB').disabled = !activeB;
    document.getElementById('varB').disabled = !(activeB && this.varRights.B > 0);
  },

  renderTurn: function() {
    document.getElementById('zoneA').className = `player-zone ${this.turn==='A'?'active':''}`;
    document.getElementById('zoneB').className = `player-zone ${this.turn==='B'?'active':''}`;
    const currentRound = Math.floor(this.moveCount / 2) + 1;
    document.getElementById('rndA').innerText = `SET ${this.setNumber} ‚Ä¢ ROUND ${currentRound}`;
    document.getElementById('rndB').innerText = `SET ${this.setNumber} ‚Ä¢ ROUND ${currentRound}`;
    
    const item = this.words[this.idx];
    document.getElementById('wA').innerText = item.w; document.getElementById('mA').innerText = item.tr;
    document.getElementById('wB').innerText = item.w; document.getElementById('mB').innerText = item.tr;
    
    this.updateUI();
  },

  listen: function(p) {
    if(this.busy || this.inputLocked || p !== this.turn) return;
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) { alert("Tarayƒ±cƒ± desteklemiyor."); return; }

    this.busy = true; this.updateUI(); window.speechSynthesis.cancel();
    
    this.activeMicId = `mic${p}`;
    const btn = document.getElementById(this.activeMicId);
    btn.innerText = "üëÇ..."; btn.classList.add('listening');

    this.currentSnapshot = { targetWord: this.words[this.idx].w, moveId: this.moveCount, player: p };

    const rec = new SR();
    const langMap = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };
    rec.lang = langMap[selLang]; rec.interimResults = false; rec.maxAlternatives = 1;

    rec.onresult = (e) => {
      const txt = e.results[0][0].transcript;
      this.stopMicVisuals();
      this.check(txt);
    };
    rec.onerror = () => { this.resetToIdle(); };
    rec.onend = () => { if(this.busy) this.resetToIdle(); };
    rec.start();
  },

  stopMicVisuals: function() {
    if (this.activeMicId) {
      const btn = document.getElementById(this.activeMicId);
      if(btn) { btn.innerText = "üéôÔ∏è CEVAPLA"; btn.classList.remove('listening'); }
      this.activeMicId = null;
    }
  },

  resetToIdle: function() {
    this.stopMicVisuals(); this.busy = false; this.inputLocked = false; this.currentSnapshot = null;
    this.updateUI();
  },

  check: function(spoken) {
    if (!this.currentSnapshot || this.currentSnapshot.moveId !== this.moveCount) { this.resetToIdle(); return; }

    const { targetWord, player } = this.currentSnapshot;
    const score = getBestMatchScore(targetWord, spoken);
    // E≈ûƒ∞K %90
    const isCorrect = score >= 90; 
    this.showResult(player, isCorrect, score, targetWord);
  },

  useVar: function(p) {
    if(this.busy || this.inputLocked || this.varRights[p] <= 0) return;
    
    // VAR basƒ±ldƒ±ƒüƒ± an dinlemeyi iptal et (HATA √á√ñZ√úM√ú)
    this.stopMicVisuals();
    this.busy = false; 
    
    this.varRights[p]--;
    const targetWord = this.words[this.idx].w;
    this.showResult(p, true, 100, targetWord, true);
  },

  showResult: function(p, isCorrect, percent, targetWord, isVar = false) {
    this.inputLocked = true; this.updateUI();

    const el = document.getElementById(`ov${p}`);
    const title = el.querySelector('.res-title');
    const sub = el.querySelector('.res-sub');
    const badge = el.querySelector('.accuracy-badge');

    el.classList.add('show');
    badge.innerText = isVar ? "HAKEM KARARI" : `%${percent} BENZERLƒ∞K`;

    if(isCorrect) {
      SFX.play('correct');
      title.innerText = "HARƒ∞KA!"; title.style.color = "var(--green)";
      let pts = 1; if (!isVar && percent >= 98) pts = 2; 
      sub.innerText = `+${pts} PUAN`; badge.style.color = "var(--green)";
      this.score[p] += pts; this.setScore[p] += pts;
      setTimeout(() => { this.finishResult(el); }, 1200);
    } else {
      SFX.play('wrong');
      title.innerText = "OLMADI"; title.style.color = "var(--red)";
      sub.innerText = `Doƒürusu: ${targetWord}`; badge.style.color = "var(--red)";
      setTimeout(() => { this.finishResult(el); }, 2000);
    }
  },

  finishResult: function(el) {
    el.classList.remove('show');
    this.resetToIdle();
    this.next();
  },

  pass: function(p) { 
    if(!this.inputLocked && !this.busy && this.turn === p) this.next(); 
  },

  next: function() {
    this.idx++; this.moveCount++;
    this.turn = this.turn === 'A' ? 'B' : 'A';
    this.currentSnapshot = null;
    this.startTurn();
  },

  speak: function(txt, rate = 1.0) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(txt);
    const langMap = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };
    u.lang = langMap[selLang]; u.rate = rate;
    window.speechSynthesis.speak(u);
  },

  pauseGame: function() {
    this.isPaused = true;
    document.getElementById('pauseModal').classList.remove('hidden');
    document.getElementById('setResultTitle').innerText = `${this.setNumber}. SET SONUCU`;
    document.getElementById('statNameA').innerText = this.names.A;
    document.getElementById('statScoreA').innerText = `${this.setScore.A} Puan`;
    document.getElementById('statNameB').innerText = this.names.B;
    document.getElementById('statScoreB').innerText = `${this.setScore.B} Puan`;
    let msg = "BERABERE!"; let color = "#fff";
    if (this.setScore.A > this.setScore.B) { msg = `${this.names.A} KAZANDI!`; color = "var(--pA)"; }
    if (this.setScore.B > this.setScore.A) { msg = `${this.names.B} KAZANDI!`; color = "var(--pB)"; }
    const wEl = document.getElementById('setWinnerMsg'); wEl.innerText = msg; wEl.style.color = color;
  },

  continueGame: function() {
    this.isPaused = false;
    document.getElementById('pauseModal').classList.add('hidden');
    this.setNumber++; this.setScore = {A:0, B:0}; this.varRights = {A:1, B:1};
    this.startTurn();
  }
};
</script>
</body>
</html>
