<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>ITALKY ‚Ä¢ Arena Final (Rules-Compliant)</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#030305; --border: rgba(255,255,255,0.12);
      --p0:#00f0ff; --p1:#ff0055; --p2:#00e676; --p3:#ffd700;
      --green:#00e676; --red:#ff1744; --gold:#ffd700;
      --font-main:'Outfit',sans-serif; --font-display:'Space Grotesk',sans-serif;
    }
    *{box-sizing:border-box; user-select:none; -webkit-tap-highlight-color:transparent; outline:none}
    html,body{margin:0; padding:0; width:100%; height:100%; background:var(--bg); font-family:var(--font-main); color:#fff; overflow:hidden; position:fixed}

    .bg-fx{position:absolute; inset:0; z-index:0; background: radial-gradient(circle at 50% 50%, #0a0a12 0%, #000 100%)}
    .nebula{position:absolute; width:100%; height:100%; filter:blur(90px); opacity:.15; animation:pulseBg 10s infinite alternate}
    @keyframes pulseBg{0%{opacity:.1}100%{opacity:.2}}

    .app-header{position:absolute; top:0; left:0; right:0; height:60px; display:flex; align-items:center; justify-content:space-between; padding:0 20px; z-index:100; pointer-events:none}
    .header-logo{font-family:var(--font-display); font-weight:700; font-size:18px; opacity:.85; pointer-events:auto}
    .header-back{width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:10px; background:rgba(255,255,255,.1); text-decoration:none; color:#fff; font-size:18px; pointer-events:auto; border:1px solid rgba(255,255,255,.1)}

    .arena-wrap{position:relative; z-index:10; width:100%; height:100dvh; display:flex; flex-direction:column; justify-content:center; align-items:center}
    .active-card-container{
      width:90%; max-width:380px; height:65%;
      position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:30px;
      backdrop-filter: blur(12px); padding:20px;
      transition:all .35s ease; box-shadow:0 20px 50px rgba(0,0,0,.5);
    }
    .active-card-container.p0{border-color:var(--p0); box-shadow:0 0 40px rgba(0,240,255,.15)}
    .active-card-container.p1{border-color:var(--p1); box-shadow:0 0 40px rgba(255,0,85,.15)}
    .active-card-container.p2{border-color:var(--p2); box-shadow:0 0 40px rgba(0,230,118,.15)}
    .active-card-container.p3{border-color:var(--p3); box-shadow:0 0 40px rgba(255,215,0,.15)}

    .player-header{width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:16px}
    .player-name{font-family:var(--font-display); font-size:22px; font-weight:700; text-transform:uppercase}
    .turn-badge{font-size:12px; font-weight:800; background:rgba(255,255,255,.1); padding:4px 10px; border-radius:8px; letter-spacing:1px}

    .word-display{width:100%; flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center}
    .main-word{font-family:var(--font-display); font-size:40px; font-weight:700; line-height:1.1; margin:0 0 6px}
    .sub-word{font-size:18px; color:rgba(255,255,255,.65); font-weight:500; min-height:24px}
    .letter-slots{display:none; font-family:monospace; font-size:32px; letter-spacing:4px; color:var(--gold); margin-top:14px; text-shadow:0 0 10px rgba(255,215,0,.25)}
    .hint-info{display:none; font-size:10px; opacity:.55; margin-top:6px; letter-spacing:1px}

    .controls{display:flex; gap:10px; width:100%; margin-top:auto; height:60px}
    .btn{border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); color:#fff; border-radius:16px; font-family:var(--font-display); font-weight:700; font-size:13px; cursor:pointer; flex:1; transition:.12s}
    .btn:active{transform:scale(.95)}
    .btn:disabled{opacity:.3; cursor:not-allowed; filter:grayscale(1)}
    .btn-mic{flex:2; background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.25); font-size:15px}
    .btn-hint{flex:.7; color:var(--green); border-color:rgba(0,230,118,.35); background:rgba(0,230,118,.06)}
    .btn.listening{background:#fff!important; color:#000!important; animation:pulse 1s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,255,255,.4)}100%{box-shadow:0 0 0 15px rgba(255,255,255,0)}}

    .bottom-bar{
      position:absolute; bottom:20px; left:10px; right:10px; height:70px;
      background:#080808; border:1px solid var(--border); border-radius:20px;
      display:flex; align-items:center; justify-content:space-around; padding:0 6px; z-index:20;
    }
    .mini-score{display:flex; flex-direction:column; align-items:center; opacity:.4; transition:.25s; transform:scale(.9)}
    .mini-score.active{opacity:1; transform:scale(1.1)}
    .ms-name{font-size:9px; font-weight:700; margin-bottom:3px; text-transform:uppercase}
    .ms-val{font-family:var(--font-display); font-size:18px; font-weight:700; line-height:1}
    .ms-sets{font-size:8px; color:var(--gold); font-weight:700; margin-top:2px}

    .result-overlay{
      position:absolute; inset:-1px; z-index:50; background:rgba(5,5,8,.98); backdrop-filter:blur(15px);
      display:flex; flex-direction:column; align-items:center; justify-content:center; border-radius:30px;
      opacity:0; pointer-events:none; transform:scale(.95); transition:.2s;
    }
    .result-overlay.show{opacity:1; transform:scale(1); pointer-events:auto}
    .res-title{font-size:40px; font-weight:800; font-family:var(--font-display); margin:0; line-height:1}
    .res-sub{margin-top:10px; font-size:16px; color:#ccc; margin-bottom:22px}
    .overlay-actions{display:none; gap:10px; width:85%}
    .btn-var-action{padding:16px; border-radius:12px; font-weight:800; flex:1; border:none; cursor:pointer; font-size:14px}
    .btn-object{background:var(--gold); color:#000; box-shadow:0 0 25px rgba(255,215,0,.25)}
    .btn-continue{background:rgba(255,255,255,.1); color:#fff; border:1px solid rgba(255,255,255,.2)}
    .badge{display:none; margin-top:15px; padding:6px 14px; border-radius:20px; font-size:13px; font-weight:700; background:rgba(255,255,255,.1)}

    .modal{position:fixed; inset:0; z-index:200; background:rgba(0,0,0,.95); backdrop-filter:blur(15px); display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:.25s}
    .modal:not(.hidden){opacity:1; pointer-events:auto}
    .modal-box{width:90%; max-width:360px; background:#121216; border:1px solid var(--border); border-radius:32px; padding:30px; text-align:center; max-height:90vh; overflow-y:auto}
    .toggle-grp{display:flex; background:rgba(255,255,255,.05); padding:4px; border-radius:12px; margin-bottom:20px}
    .toggle-btn{flex:1; padding:10px; border-radius:8px; cursor:pointer; text-align:center; font-size:13px; font-weight:700; opacity:.6; transition:.2s}
    .toggle-btn.active{background:#fff; color:#000; opacity:1}
    .btn-block{width:100%; padding:18px; margin-top:10px; border-radius:16px; border:none; font-weight:800; font-size:16px; cursor:pointer; background:#fff; color:#000}
    .name-input{width:100%; background:#1a1a20; border:1px solid var(--border); color:#fff; padding:12px; border-radius:10px; font-family:var(--font-main); font-weight:600; text-align:center; margin-bottom:8px}
    .lang-grid{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-bottom:16px}
    .lang-btn{background:rgba(255,255,255,.05); border:1px solid var(--border); color:#fff; border-radius:12px; padding:10px 0; font-size:20px; cursor:pointer}
    .lang-btn.active{background:#fff; color:#000}
  </style>
</head>
<body>

<div class="bg-fx"></div>
<div class="nebula" style="background:var(--p0); top:-20%; left:-20%;"></div>

<div class="app-header">
  <a href="game.html" class="header-back">‚úï</a>
  <div class="header-logo">italkyAI</div>
  <div style="width:36px"></div>
</div>

<div class="arena-wrap">
  <div class="active-card-container" id="gameCard">
    <div class="result-overlay" id="overlay">
      <div class="res-title" id="ovTitle">...</div>
      <div class="res-sub" id="ovSub">...</div>

      <div class="overlay-actions" id="varActions">
        <button class="btn-var-action btn-object" id="btnVarObjection">ƒ∞Tƒ∞RAZ (VAR)</button>
        <button class="btn-var-action btn-continue" id="btnVarContinue">DEVAM ET</button>
      </div>

      <div class="badge" id="ovBadge"></div>
    </div>

    <div class="player-header">
      <div class="player-name" id="pName">OYUNCU</div>
      <div class="turn-badge" id="pCounter">0/20</div>
    </div>

    <div class="word-display">
      <div class="main-word" id="wMain">...</div>
      <div class="sub-word" id="wSub">...</div>
      <div class="letter-slots" id="wSlots">_ _ _</div>
      <div class="hint-info" id="wHintInfo"></div>
    </div>

    <div class="controls">
      <button class="btn btn-hint" id="btnHint" style="display:none">HARF (5)</button>
      <button class="btn" id="btnPass">PAS (1)</button>
      <button class="btn btn-mic" id="btnMic">üéôÔ∏è CEVAPLA</button>
    </div>
  </div>
</div>

<div class="bottom-bar" id="scoreBar"></div>

<div class="modal" id="setupModal">
  <div class="modal-box">
    <div class="header-logo" style="font-size:24px; margin-bottom:20px;">CHAMPIONSHIP</div>

    <div style="font-size:12px; opacity:.6; margin-bottom:5px">OYUNCU SAYISI</div>
    <div class="toggle-grp" id="grpPlayers">
      <div class="toggle-btn active" data-n="2">2 Ki≈üi</div>
      <div class="toggle-btn" data-n="3">3 Ki≈üi</div>
      <div class="toggle-btn" data-n="4">4 Ki≈üi</div>
    </div>

    <div id="nameInputs">
      <input type="text" class="name-input" id="inp0" value="Oyuncu 1" style="border-color:var(--p0)">
      <input type="text" class="name-input" id="inp1" value="Oyuncu 2" style="border-color:var(--p1)">
    </div>

    <div style="font-size:12px; opacity:.6; margin:15px 0 6px">Dƒ∞L</div>
    <div class="lang-grid" id="grpLang">
      <button class="lang-btn active" data-lang="en">üá¨üáß</button>
      <button class="lang-btn" data-lang="de">üá©üá™</button>
      <button class="lang-btn" data-lang="fr">üá´üá∑</button>
      <button class="lang-btn" data-lang="es">üá™üá∏</button>
      <button class="lang-btn" data-lang="it">üáÆüáπ</button>
    </div>

    <div style="font-size:12px; opacity:.6; margin:10px 0 6px">MOD</div>
    <div class="toggle-grp" id="grpMode">
      <div class="toggle-btn active" data-mode="pron">üéôÔ∏è Telaffuz</div>
      <div class="toggle-btn" data-mode="vocab">üß† Kelime</div>
    </div>

    <button class="btn-block" id="btnStart">BA≈ûLA (3 SET)</button>
  </div>
</div>

<div class="modal hidden" id="pauseModal">
  <div class="modal-box">
    <div style="font-family:var(--font-display); font-weight:800; font-size:20px; margin-bottom:12px" id="pauseTitle">SET SONUCU</div>
    <div id="setStats" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; margin-bottom:16px; text-align:left;"></div>
    <div style="font-size:20px; font-weight:800; color:var(--gold); margin-bottom:16px;" id="setWinnerMsg">...</div>
    <button class="btn-block" style="background:var(--green); color:#000" id="btnContinueSet">DEVAM ET</button>
    <button class="btn-block" style="background:rgba(255,255,255,0.1); color:#fff" onclick="location.href='game.html'">√áIKI≈û</button>
  </div>
</div>

<script>
/* ========= RULE-COMPLIANT ENGINE ========= */

const DB = {
  en: [
    {w:"Excellent",tr:"M√ºkemmel"},{w:"Challenge",tr:"Meydan Okuma"},{w:"Opportunity",tr:"Fƒ±rsat"},{w:"Journey",tr:"Yolculuk"},
    {w:"Environment",tr:"√áevre"},{w:"Necessary",tr:"Gerekli"},{w:"Dangerous",tr:"Tehlikeli"},{w:"Knowledge",tr:"Bilgi"},
    {w:"Experience",tr:"Deneyim"},{w:"Incredible",tr:"ƒ∞nanƒ±lmaz"},{w:"Understand",tr:"Anlamak"},{w:"Remember",tr:"Hatƒ±rlamak"},
    {w:"Solution",tr:"√á√∂z√ºm"},{w:"Together",tr:"Birlikte"},{w:"Success",tr:"Ba≈üarƒ±"},{w:"Future",tr:"Gelecek"},
    {w:"Freedom",tr:"√ñzg√ºrl√ºk"},{w:"Victory",tr:"Zafer"},{w:"Quality",tr:"Kalite"},{w:"Ambition",tr:"Hƒ±rs"}
  ],
  de: [{w:"Entscheidung",tr:"Karar"},{w:"M√∂glichkeit",tr:"ƒ∞mkan"},{w:"Erfahrung",tr:"Deneyim"},{w:"Nat√ºrlich",tr:"Doƒüal"},{w:"Wichtig",tr:"√ñnemli"},{w:"Zusammen",tr:"Birlikte"},{w:"Schmetterling",tr:"Kelebek"},{w:"Gef√§hrlich",tr:"Tehlikeli"},{w:"Entschuldigung",tr:"√ñz√ºr Dilerim"}],
  fr: [{w:"Bonjour",tr:"Merhaba"},{w:"Amour",tr:"A≈ük"},{w:"Voiture",tr:"Araba"},{w:"Maison",tr:"Ev"},{w:"Magnifique",tr:"Muhte≈üem"},{w:"Toujours",tr:"Her zaman"}],
  es: [{w:"Coraz√≥n",tr:"Kalp"},{w:"Amigo",tr:"Arkada≈ü"},{w:"Tiempo",tr:"Zaman"},{w:"Vida",tr:"Hayat"},{w:"Felicidad",tr:"Mutluluk"},{w:"Peligroso",tr:"Tehlikeli"}],
  it: [{w:"Ciao",tr:"Merhaba"},{w:"Grazie",tr:"Te≈üekk√ºrler"},{w:"Famiglia",tr:"Aile"},{w:"Piccolo",tr:"K√º√ß√ºk"},{w:"Mangiare",tr:"Yemek"},{w:"Dormire",tr:"Uyumak"}]
};

const LANG_CODES = { en:'en-US', de:'de-DE', fr:'fr-FR', es:'es-ES', it:'it-IT' };

function normalize(s){
  return String(s||"")
    .toLowerCase()
    .replace(/√ü/g, "ss")
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9 ]/g, "")
    .trim();
}

// Levenshtein similarity (0-100)
function similarityScore(a,b){
  const s1 = normalize(a), s2 = normalize(b);
  if(!s1 && !s2) return 100;
  if(!s1 || !s2) return 0;
  if(s2.includes(s1)) return 100;

  const longer = s1.length >= s2.length ? s1 : s2;
  const shorter = s1.length >= s2.length ? s2 : s1;

  const dist = editDistance(longer, shorter);
  const score = (longer.length - dist) / longer.length;
  return Math.max(0, Math.min(100, Math.floor(score*100)));
}

function editDistance(s1, s2){
  const costs = new Array(s2.length+1);
  for(let j=0;j<=s2.length;j++) costs[j]=j;
  for(let i=1;i<=s1.length;i++){
    let prev = i-1;
    costs[0]=i;
    for(let j=1;j<=s2.length;j++){
      const tmp = costs[j];
      let val = Math.min(costs[j]+1, costs[j-1]+1, prev + (s1[i-1]===s2[j-1]?0:1));
      costs[j]=val;
      prev=tmp;
    }
  }
  return costs[s2.length];
}

const STATE = { IDLE:0, SPEAKING:1, LISTENING:2, RESOLVING:3, PAUSED:4, END:5 };

const setup = {
  playerCount: 2,
  mode: 'pron', // pron | vocab
  lang: 'en',
};

function $(id){ return document.getElementById(id); }

function toast(msg){
  // minimal non-blocking: reuse ovBadge when overlay hidden
  const b = $("ovBadge");
  b.style.display = "block";
  b.textContent = msg;
  b.style.color = "#fff";
  setTimeout(()=>{ if(!$("overlay").classList.contains("show")) b.style.display="none"; }, 1200);
}

const game = {
  state: STATE.IDLE,
  players: [],
  turnIndex: 0,

  // current word object
  current: null,
  // pool (shuffled)
  pool: [],
  poolPos: 0,
  usedWords: new Set(), // per set, normalized word

  // per wrong attempt for VAR window (deferred commit)
  pendingWrong: null, // { playerId, wordKey, targetWord, scoreDelta:-1, wordsDelta:+1 }

  init(){
    // build players
    this.players = [];
    for(let i=0;i<setup.playerCount;i++){
      const name = ($(`inp${i}`)?.value || `Oyuncu ${i+1}`).trim() || `Oyuncu ${i+1}`;
      this.players.push({
        id:i, name,
        score:0, setWins:0,
        wordsPlayed:0,
        passRight:1, varRight:1,
        hintRight:5, // match-long
        // vocab per-word state:
        slots:null,
        hintUsedThisWord:false,
      });
    }

    // reset match state
    this.turnIndex = Math.floor(Math.random()*this.players.length);
    this.startNewSet(true);
    $("setupModal").classList.add("hidden");
  },

  startNewSet(isFirst=false){
    // per-set resets
    this.players.forEach(p=>{
      p.score = 0;
      p.wordsPlayed = 0;
      p.passRight = 1;
      p.varRight = 1;
      p.slots = null;
      p.hintUsedThisWord = false;
      // hintRight NOT reset (match-long)
    });
    this.usedWords.clear();
    this.pendingWrong = null;

    // build pool
    const raw = DB[setup.lang] || DB.en;
    // shuffle copy; NOT duplicating excessively to avoid repeats; rely on re-shuffle if needed
    this.pool = raw.slice().sort(()=>Math.random()-0.5);
    this.poolPos = 0;

    // pick first word
    this.pickNextWordStrict();
    this.state = STATE.IDLE;
    this.updateUI();
    this.startTurnFlow();
  },

  // strict: no repeats within set; if pool insufficient, we reshuffle and if still insufficient, we allow repeats only after warning
  pickNextWordStrict(){
    const needKey = () => normalize(this.pool[this.poolPos]?.w);

    let tries = 0;
    while(tries < this.pool.length){
      if(this.poolPos >= this.pool.length){
        // reshuffle once
        this.pool = this.pool.slice().sort(()=>Math.random()-0.5);
        this.poolPos = 0;
      }
      const item = this.pool[this.poolPos++];
      const key = normalize(item.w);
      if(!this.usedWords.has(key)){
        this.usedWords.add(key);
        this.current = item;
        return;
      }
      tries++;
    }

    // fallback: pool exhausted (DB too small). We must not freeze.
    // Clear set and warn.
    this.usedWords.clear();
    toast("Havuz bitti ‚Ä¢ Tekrarlar ba≈ülayabilir");
    // pick first available
    if(this.poolPos >= this.pool.length){
      this.pool = (DB[setup.lang]||DB.en).slice().sort(()=>Math.random()-0.5);
      this.poolPos = 0;
    }
    this.current = this.pool[this.poolPos++] || (DB[setup.lang]||DB.en)[0];
    this.usedWords.add(normalize(this.current.w));
  },

  // called at start of each turn/word
  startTurnFlow(){
    // set end?
    if(this.players.every(p=>p.wordsPlayed>=20)){
      this.endSet();
      return;
    }
    // if current player already finished quota, advance to next eligible
    if(this.players[this.turnIndex].wordsPlayed>=20){
      this.nextPlayer(true);
      return;
    }

    // clear per-word vocab state if new word just picked
    const p = this.players[this.turnIndex];
    if(setup.mode === 'vocab'){
      // create slots on demand for THIS word (keep during VAR retry)
      if(!p.slots){
        p.slots = this.current.w.split("").map((ch,i)=> i===0 ? ch : "_");
        p.hintUsedThisWord = false;
      }
    } else {
      // pron mode doesn't use slots
      p.slots = null;
      p.hintUsedThisWord = false;
    }

    // TTS gate in pron mode
    if(setup.mode === 'pron'){
      this.state = STATE.SPEAKING;
      this.updateUI();
      this.speak(this.current.w, () => {
        this.state = STATE.IDLE;
        this.updateUI();
      });
    } else {
      this.state = STATE.IDLE;
      this.updateUI();
    }
  },

  updateUI(){
    const p = this.players[this.turnIndex];
    $("gameCard").className = `active-card-container p${p.id}`;
    $("pName").textContent = p.name;
    $("pName").style.color = `var(--p${p.id})`;
    $("pCounter").textContent = `${p.wordsPlayed}/20`;

    // word display
    if(setup.mode === 'pron'){
      $("wMain").textContent = this.current.w;
      $("wSub").textContent = this.current.tr;
      $("wSlots").style.display = "none";
      $("wHintInfo").style.display = "none";
      $("btnHint").style.display = "none";
    } else {
      $("wMain").textContent = this.current.tr;
      $("wSub").textContent = "???";
      $("wSlots").style.display = "block";
      $("wHintInfo").style.display = "block";
      $("btnHint").style.display = "block";

      const slots = p.slots || this.current.w.split("").map((ch,i)=> i===0 ? ch : "_");
      const revealed = slots.filter(x=>x!=="_").length;
      $("wSlots").textContent = slots.join(" ");
      $("wHintInfo").textContent = `A√áILAN HARF: ${revealed}/${this.current.w.length}`;
    }

    // button texts
    $("btnPass").textContent = `PAS (${p.passRight})`;
    $("btnHint").textContent = `HARF (${p.hintRight})`;
    $("btnMic").textContent = "üéôÔ∏è CEVAPLA";

    // buttons enabled/disabled by state
    const all = [$("btnHint"), $("btnPass"), $("btnMic")];
    if(this.state === STATE.LISTENING){
      all.forEach(b=> b.disabled = true);
      $("btnMic").classList.add("listening");
      $("btnMic").textContent = "üëÇ...";
    } else {
      $("btnMic").classList.remove("listening");
    }

    if(this.state === STATE.SPEAKING || this.state === STATE.RESOLVING || this.state === STATE.PAUSED || this.state === STATE.END){
      all.forEach(b=> b.disabled = true);
    } else if(this.state === STATE.IDLE){
      // enable mic always in idle
      $("btnMic").disabled = false;
      // pass/hint only if rights
      $("btnPass").disabled = !(p.passRight > 0);
      if(setup.mode === 'vocab'){
        $("btnHint").disabled = !(p.hintRight > 0);
      } else {
        $("btnHint").disabled = true;
      }
    }

    // bottom bar
    const bar = $("scoreBar");
    bar.innerHTML = "";
    this.players.forEach((pl, i)=>{
      const div = document.createElement("div");
      div.className = `mini-score ${i===this.turnIndex ? "active":""}`;
      div.innerHTML = `
        <div class="ms-name" style="color:var(--p${pl.id})">${pl.name}</div>
        <div class="ms-val">${pl.score}</div>
        <div class="ms-sets">SET: ${pl.setWins}</div>
      `;
      bar.appendChild(div);
    });
  },

  // UI button actions
  action(type){
    if(this.state !== STATE.IDLE) return;
    const p = this.players[this.turnIndex];

    if(type === "pass"){
      if(p.passRight <= 0) return;
      p.passRight -= 1;
      // new word, same player, no counter inc
      // also reset per-word vocab state for this player
      p.slots = null;
      p.hintUsedThisWord = false;
      this.pickNextWordStrict();
      this.updateUI();
      this.startTurnFlow();
      return;
    }

    if(type === "hint"){
      if(setup.mode !== 'vocab') return;
      if(p.hintRight <= 0) return;
      // reveal next underscore
      const target = this.current.w;
      const slots = p.slots || target.split("").map((ch,i)=> i===0 ? ch : "_");
      let changed = false;
      for(let i=0;i<target.length;i++){
        if(slots[i] === "_"){
          slots[i] = target[i];
          changed = true;
          break;
        }
      }
      if(!changed) return; // all revealed
      p.hintRight -= 1;
      p.slots = slots;
      p.hintUsedThisWord = true;
      this.updateUI();
      return;
    }

    if(type === "mic"){
      this.startListening();
      return;
    }
  },

  startListening(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      alert("Bu cihazda Ses Tanƒ±ma (SpeechRecognition) yok.");
      return;
    }
    this.state = STATE.LISTENING;
    this.updateUI();

    const rec = new SR();
    rec.lang = LANG_CODES[setup.lang] || "en-US";
    rec.interimResults = false;
    rec.maxAlternatives = 1;

    // watchdog
    const watchdog = setTimeout(()=>{ try{ rec.stop(); }catch{} }, 8000);

    rec.onresult = (e)=>{
      clearTimeout(watchdog);
      const spoken = e.results?.[0]?.[0]?.transcript || "";
      this.onSpoken(spoken);
    };
    rec.onerror = ()=>{
      clearTimeout(watchdog);
      this.state = STATE.IDLE;
      this.updateUI();
    };
    rec.onend = ()=>{
      clearTimeout(watchdog);
      // if still listening, return to idle
      if(this.state === STATE.LISTENING){
        this.state = STATE.IDLE;
        this.updateUI();
      }
    };

    rec.start();
  },

  onSpoken(spoken){
    this.state = STATE.RESOLVING;
    this.updateUI();

    const p = this.players[this.turnIndex];
    const target = this.current.w;
    const score = similarityScore(target, spoken);
    const isCorrect = score >= 90;

    const overlay = $("overlay");
    const title = $("ovTitle");
    const sub = $("ovSub");
    const badge = $("ovBadge");
    const actions = $("varActions");

    overlay.classList.add("show");

    if(isCorrect){
      actions.style.display = "none";
      badge.style.display = "block";
      badge.textContent = `%${score} BENZERLƒ∞K`;
      badge.style.color = "var(--green)";

      // scoring
      const pts = (setup.mode === 'vocab' && p.hintUsedThisWord) ? 1 : 2;
      p.score += pts;
      p.wordsPlayed += 1;

      title.textContent = "HARƒ∞KA!";
      title.style.color = "var(--green)";
      sub.textContent = `+${pts} PUAN`;

      // reset per-word state for next word
      p.slots = null;
      p.hintUsedThisWord = false;

      // auto advance
      setTimeout(()=> this.finishCommittedTurn(), 1200);
    } else {
      // WRONG: deferred commit until "DEVAM" or "VAR absent"
      title.textContent = "OLMADI";
      title.style.color = "var(--red)";
      sub.textContent = `Doƒürusu: ${target}`;

      // store pending wrong (do NOT change score/wordsPlayed yet)
      this.pendingWrong = {
        playerId: p.id,
        wordKey: normalize(target),
        deltaScore: -1,
        deltaWords: +1
      };

      if(p.varRight > 0){
        actions.style.display = "flex";
        badge.style.display = "none";
        $("btnVarObjection").textContent = `ƒ∞Tƒ∞RAZ (VAR: ${p.varRight})`;
      } else {
        actions.style.display = "none";
        badge.style.display = "block";
        badge.textContent = `%${score} BENZERLƒ∞K`;
        badge.style.color = "var(--red)";

        // auto commit wrong and advance
        setTimeout(()=>{
          this.commitWrongAndAdvance();
        }, 1400);
      }
    }
  },

  // overlay buttons
  varObjection(){
    if(this.state !== STATE.RESOLVING) return;
    const p = this.players[this.turnIndex];
    if(!this.pendingWrong || this.pendingWrong.playerId !== p.id) return;
    if(p.varRight <= 0) return;

    p.varRight -= 1;

    // cancel pending wrong (no commit), repeat same word, same player
    this.pendingWrong = null;

    $("overlay").classList.remove("show");
    $("varActions").style.display = "none";
    $("ovBadge").style.display = "none";

    // keep slots state in vocab (do NOT reset)
    // return to turn flow (retry) ‚Äì same word, same player
    this.state = STATE.IDLE;
    this.updateUI();
    this.startTurnFlow(); // will TTS if pron, otherwise idle
  },

  varContinue(){
    if(this.state !== STATE.RESOLVING) return;
    this.commitWrongAndAdvance();
  },

  commitWrongAndAdvance(){
    const p = this.players[this.turnIndex];
    if(this.pendingWrong && this.pendingWrong.playerId === p.id){
      // commit wrong
      p.score = Math.max(0, p.score + this.pendingWrong.deltaScore);
      p.wordsPlayed += this.pendingWrong.deltaWords;
      this.pendingWrong = null;
      // reset per-word state for next word
      p.slots = null;
      p.hintUsedThisWord = false;
    } else {
      // if no pending, still advance
    }

    $("overlay").classList.remove("show");
    $("varActions").style.display = "none";
    $("ovBadge").style.display = "none";

    this.finishCommittedTurn();
  },

  finishCommittedTurn(){
    // advance to next word + next player
    this.pickNextWordStrict();
    this.nextPlayer(false);
  },

  nextPlayer(skipQuotaCheck){
    // advance index
    this.turnIndex = (this.turnIndex + 1) % this.players.length;

    // if next player already finished, keep advancing until eligible or set ends
    if(skipQuotaCheck){
      this.startTurnFlow();
      return;
    }

    let guard = 0;
    while(this.players[this.turnIndex].wordsPlayed >= 20 && guard < this.players.length){
      this.turnIndex = (this.turnIndex + 1) % this.players.length;
      guard++;
    }

    this.state = STATE.IDLE;
    this.updateUI();
    this.startTurnFlow();
  },

  endSet(){
    this.state = STATE.PAUSED;
    $("pauseModal").classList.remove("hidden");

    // compute sorted (copy)
    const sorted = [...this.players].sort((a,b)=> b.score - a.score);

    let winner = null;
    if(sorted.length === 1){
      winner = sorted[0];
    } else if(sorted[0].score > sorted[1].score){
      winner = sorted[0];
    }

    if(winner){
      // increment setWins on real player
      const real = this.players.find(x=>x.id===winner.id);
      real.setWins += 1;
    }

    // stats list
    let html = "";
    sorted.forEach(pl=>{
      html += `<div style="display:flex; justify-content:space-between; margin-bottom:6px;">
        <span style="color:var(--p${pl.id})">${pl.name}</span><b>${pl.score}</b>
      </div>`;
    });
    $("setStats").innerHTML = html;

    // match winner?
    const matchWinner = this.players.find(x=> x.setWins >= 3) || null;

    if(matchWinner){
      $("pauseTitle").textContent = "≈ûAMPƒ∞YON!";
      $("setWinnerMsg").textContent = `${matchWinner.name} MA√áI KAZANDI!`;
      $("btnContinueSet").textContent = "YENƒ∞ MA√á";
      $("btnContinueSet").onclick = ()=> location.reload();
    } else if(winner){
      $("pauseTitle").textContent = "SET SONUCU";
      $("setWinnerMsg").textContent = `${winner.name} SETƒ∞ KAZANDI!`;
      $("btnContinueSet").textContent = "SONRAKƒ∞ SET";
      $("btnContinueSet").onclick = ()=> this.continueGame();
    } else {
      $("pauseTitle").textContent = "SET SONUCU";
      $("setWinnerMsg").textContent = "SET BERABERE!";
      $("btnContinueSet").textContent = "SONRAKƒ∞ SET";
      $("btnContinueSet").onclick = ()=> this.continueGame();
    }
  },

  continueGame(){
    $("pauseModal").classList.add("hidden");

    // per-set reset (match-long hint remains)
    this.players.forEach(p=>{
      p.score = 0;
      p.wordsPlayed = 0;
      p.passRight = 1;
      p.varRight = 1;
      p.slots = null;
      p.hintUsedThisWord = false;
      // hintRight stays (match-long)
    });

    this.usedWords.clear();
    this.pendingWrong = null;

    // rebuild pool (same language)
    const raw = DB[setup.lang] || DB.en;
    this.pool = raw.slice().sort(()=>Math.random()-0.5);
    this.poolPos = 0;

    this.pickNextWordStrict();
    this.state = STATE.IDLE;
    this.updateUI();
    this.startTurnFlow();
  },

  speak(txt, cb){
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = LANG_CODES[setup.lang] || "en-US";
    u.onend = ()=> cb && cb();
    window.speechSynthesis.speak(u);
  }
};

// --- UI wiring ---
(function initUI(){
  // player count
  $("grpPlayers").querySelectorAll(".toggle-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $("grpPlayers").querySelectorAll(".toggle-btn").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      setup.playerCount = Number(btn.dataset.n);

      const container = $("nameInputs");
      container.innerHTML = "";
      const colors = ["var(--p0)","var(--p1)","var(--p2)","var(--p3)"];
      for(let i=0;i<setup.playerCount;i++){
        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "name-input";
        inp.id = `inp${i}`;
        inp.value = `Oyuncu ${i+1}`;
        inp.style.borderColor = colors[i];
        container.appendChild(inp);
      }
    });
  });

  // language
  $("grpLang").querySelectorAll(".lang-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $("grpLang").querySelectorAll(".lang-btn").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      setup.lang = btn.dataset.lang;
    });
  });

  // mode
  $("grpMode").querySelectorAll(".toggle-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $("grpMode").querySelectorAll(".toggle-btn").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      setup.mode = btn.dataset.mode;
    });
  });

  // start
  $("btnStart").addEventListener("click", ()=> game.init());

  // main controls
  $("btnPass").addEventListener("click", ()=> game.action("pass"));
  $("btnHint").addEventListener("click", ()=> game.action("hint"));
  $("btnMic").addEventListener("click", ()=> game.action("mic"));

  // overlay actions
  $("btnVarObjection").addEventListener("click", ()=> game.varObjection());
  $("btnVarContinue").addEventListener("click", ()=> game.varContinue());
})();
</script>

</body>
</html>
