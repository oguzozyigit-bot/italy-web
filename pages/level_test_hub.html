<!-- FILE: /pages/level_test_hub.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>italkyAI ‚Ä¢ Seviye Tespit Sƒ±navƒ±</title>

  <meta name="theme-color" content="#02000f">
  <style>html,body{background:#02000f !important;}</style>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#02000f;
      --card: rgba(255,255,255,0.04);
      --border: rgba(255,255,255,0.10);
      --muted: rgba(255,255,255,0.62);
      --ai: linear-gradient(135deg,#a5b4fc 0%,#6366f1 50%,#ec4899 100%);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
    html,body{ margin:0; height:100dvh; overflow:hidden; font-family:Outfit,system-ui,sans-serif; color:#fff; }

    /* shell mount alanƒ± */
    #pageContent{
      height: 100%;
      padding: 14px 14px calc(var(--footerH, 92px) + env(safe-area-inset-bottom) + 16px);
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
    }

    .hero{
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 14px 14px;
    }
    .hTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .hTitle{
      font-family:"Space Grotesk",system-ui,sans-serif;
      font-size:18px;
      font-weight:1000;
      margin:0;
      letter-spacing:-0.3px;
    }
    .hSub{
      margin:6px 0 0;
      font-size:12px;
      font-weight:900;
      color: var(--muted);
      line-height:1.45;
    }
    .chip{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      font-weight:1000;
      font-size:12px;
      color: rgba(255,255,255,0.86);
      white-space:nowrap;
    }
    .chip b{ background: var(--ai); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .search{
      flex:1;
      min-width: 180px;
      height:44px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      color:#fff;
      font-weight:900;
      padding: 0 12px;
      outline:none;
    }
    .btn{
      height:44px;
      padding: 0 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: scale(.99); }

    .grid{
      flex:1;
      min-height:0;
      overflow:auto;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      padding-bottom: 2px;
    }
    .grid::-webkit-scrollbar{ display:none; }

    @media(max-width:420px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }

    .langCard{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 12px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      min-height: 118px;
      position:relative;
      overflow:hidden;
    }
    .langCard:active{ transform: scale(.985); background: rgba(255,255,255,0.06); }

    .flagBox{
      width:54px;height:54px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 18px 44px rgba(0,0,0,0.22);
      font-size: 26px;
    }
    .langName{
      font-size: 12px;
      font-weight: 1000;
      text-align:center;
      line-height:1.1;
      color: rgba(255,255,255,0.92);
    }
    .status{
      font-size: 10px;
      font-weight: 900;
      text-align:center;
      color: rgba(255,255,255,0.62);
      line-height:1.15;
    }
    .status .lvl{
      font-weight: 1000;
      background: var(--ai);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    .toast{
      position: fixed;
      left:50%;
      top:18px;
      transform:translateX(-50%) translateY(-120px);
      background:rgba(10,10,18,.92);
      border:1px solid rgba(165,180,252,.35);
      padding:10px 14px;
      border-radius:999px;
      color:#fff;
      z-index:999999;
      font-weight:900;
      font-size:12px;
      transition:.28s;
      backdrop-filter: blur(12px);
      pointer-events:none;
      max-width:min(92vw,520px);
      text-align:center;
    }
    .toast.show{ transform:translateX(-50%) translateY(0); }
  </style>
</head>

<body>
  <div id="pageContent">
    <div class="hero">
      <div class="hTop">
        <div>
          <h1 class="hTitle">Seviye Tespit Sƒ±navƒ±</h1>
          <p class="hSub">T√ºm diller i√ßin seviye tespit. Dilini se√ß ‚Üí sƒ±nava gir ‚Üí sonu√ß profiline i≈ülenir.</p>
        </div>
        <div class="chip">S√ºre: <b>40 dk</b></div>
      </div>

      <div style="height:10px"></div>

      <div class="controls">
        <input class="search" id="q" placeholder="Dil ara‚Ä¶ (English, T√ºrk√ße, Deutsch)" />
        <button class="btn" id="btnReset">Sƒ±fƒ±rla</button>
      </div>
    </div>

    <div class="grid" id="grid"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { mountShell } from "/js/ui_shell.js";
    import { supabase } from "/js/supabase_client.js";

    mountShell({ scroll:"none" });

    const $ = (id)=>document.getElementById(id);
    function toast(msg){
      const t = $("toast");
      t.textContent = String(msg||"");
      t.classList.add("show");
      clearTimeout(window.__to);
      window.__to = setTimeout(()=>t.classList.remove("show"), 1400);
    }

    // ‚úÖ auth guard
    const { data:{ session } } = await supabase.auth.getSession();
    if(!session?.user){
      location.replace("/pages/login.html");
      throw new Error("no session");
    }

    // ‚úÖ profilden levels oku (levels[langCode] = "A1" gibi)
    let LEVELS = {};
    try{
      const { data: prof, error } = await supabase
        .from("profiles")
        .select("levels")
        .eq("id", session.user.id)
        .single();
      if(!error){
        LEVELS = (prof?.levels && typeof prof.levels === "object") ? prof.levels : {};
      }
    }catch{}

    // ‚úÖ ƒ∞lk 5 + TR en ba≈üta, kalanlar alfabetik
    const FIRST = [
      { code:"tr", name:"T√ºrk√ße", flag:"üáπüá∑" },
      { code:"en", name:"English", flag:"üá¨üáß" },
      { code:"de", name:"Deutsch", flag:"üá©üá™" },
      { code:"fr", name:"Fran√ßais", flag:"üá´üá∑" },
      { code:"es", name:"Espa√±ol", flag:"üá™üá∏" },
      { code:"it", name:"Italiano", flag:"üáÆüáπ" },
    ];

    // ‚úÖ 81 hedef i√ßin geni≈ü liste (eksikler i√ßin de √ßalƒ±≈üƒ±r)
    // Not: Flag bazƒ± dillerde ‚Äúdil bayraƒüƒ±‚Äù net olmayabilir; burada en yaygƒ±n √ºlke bayraƒüƒ± kullanƒ±ldƒ±.
    const ALL = [
      {code:"af",name:"Afrikaans",flag:"üáøüá¶"},
      {code:"sq",name:"Shqip",flag:"üá¶üá±"},
      {code:"am",name:"Amharic",flag:"üá™üáπ"},
      {code:"ar",name:"ÿßŸÑÿπÿ±ÿ®Ÿäÿ©",flag:"üá∏üá¶"},
      {code:"hy",name:"’Ä’°’µ’•÷Ä’•’∂",flag:"üá¶üá≤"},
      {code:"az",name:"Az…ôrbaycanca",flag:"üá¶üáø"},
      {code:"eu",name:"Euskara",flag:"üá™üá∏"},
      {code:"bn",name:"‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ",flag:"üáßüá©"},
      {code:"bs",name:"Bosanski",flag:"üáßüá¶"},
      {code:"bg",name:"–ë—ä–ª–≥–∞—Ä—Å–∫–∏",flag:"üáßüá¨"},
      {code:"ca",name:"Catal√†",flag:"üá™üá∏"},
      {code:"zh",name:"‰∏≠Êñá",flag:"üá®üá≥"},
      {code:"hr",name:"Hrvatski",flag:"üá≠üá∑"},
      {code:"cs",name:"ƒåe≈°tina",flag:"üá®üáø"},
      {code:"da",name:"Dansk",flag:"üá©üá∞"},
      {code:"nl",name:"Nederlands",flag:"üá≥üá±"},
      {code:"en",name:"English",flag:"üá¨üáß"},
      {code:"et",name:"Eesti",flag:"üá™üá™"},
      {code:"fi",name:"Suomi",flag:"üá´üáÆ"},
      {code:"fr",name:"Fran√ßais",flag:"üá´üá∑"},
      {code:"gl",name:"Galego",flag:"üá™üá∏"},
      {code:"ka",name:"·É•·Éê·É†·Éó·É£·Éö·Éò",flag:"üá¨üá™"},
      {code:"de",name:"Deutsch",flag:"üá©üá™"},
      {code:"el",name:"ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨",flag:"üá¨üá∑"},
      {code:"gu",name:"‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä",flag:"üáÆüá≥"},
      {code:"ht",name:"Krey√≤l",flag:"üá≠üáπ"},
      {code:"ha",name:"Hausa",flag:"üá≥üá¨"},
      {code:"he",name:"◊¢◊ë◊®◊ô◊™",flag:"üáÆüá±"},
      {code:"hi",name:"‡§π‡§ø‡§®‡•ç‡§¶‡•Ä",flag:"üáÆüá≥"},
      {code:"hu",name:"Magyar",flag:"üá≠üá∫"},
      {code:"is",name:"√çslenska",flag:"üáÆüá∏"},
      {code:"id",name:"Bahasa Indonesia",flag:"üáÆüá©"},
      {code:"ga",name:"Gaeilge",flag:"üáÆüá™"},
      {code:"it",name:"Italiano",flag:"üáÆüáπ"},
      {code:"ja",name:"Êó•Êú¨Ë™û",flag:"üáØüáµ"},
      {code:"jv",name:"Basa Jawa",flag:"üáÆüá©"},
      {code:"kn",name:"‡≤ï‡≤®‡≥ç‡≤®‡≤°",flag:"üáÆüá≥"},
      {code:"kk",name:"“ö–∞–∑–∞“õ—à–∞",flag:"üá∞üáø"},
      {code:"km",name:"·ûÅ·üí·ûò·üÇ·ûö",flag:"üá∞üá≠"},
      {code:"ko",name:"ÌïúÍµ≠Ïñ¥",flag:"üá∞üá∑"},
      {code:"ku",name:"Kurd√Æ",flag:"üáπüá∑"},
      {code:"ky",name:"–ö—ã—Ä–≥—ã–∑—á–∞",flag:"üá∞üá¨"},
      {code:"lo",name:"‡∫•‡∫≤‡∫ß",flag:"üá±üá¶"},
      {code:"lv",name:"Latvie≈°u",flag:"üá±üáª"},
      {code:"lt",name:"Lietuvi≈≥",flag:"üá±üáπ"},
      {code:"mk",name:"–ú–∞–∫–µ–¥–æ–Ω—Å–∫–∏",flag:"üá≤üá∞"},
      {code:"ms",name:"Bahasa Melayu",flag:"üá≤üáæ"},
      {code:"ml",name:"‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç",flag:"üáÆüá≥"},
      {code:"mr",name:"‡§Æ‡§∞‡§æ‡§†‡•Ä",flag:"üáÆüá≥"},
      {code:"mn",name:"–ú–æ–Ω–≥–æ–ª",flag:"üá≤üá≥"},
      {code:"ne",name:"‡§®‡•á‡§™‡§æ‡§≤‡•Ä",flag:"üá≥üáµ"},
      {code:"no",name:"Norsk",flag:"üá≥üá¥"},
      {code:"fa",name:"ŸÅÿßÿ±ÿ≥€å",flag:"üáÆüá∑"},
      {code:"pl",name:"Polski",flag:"üáµüá±"},
      {code:"pt",name:"Portugu√™s",flag:"üáµüáπ"},
      {code:"pa",name:"‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä",flag:"üáÆüá≥"},
      {code:"ro",name:"Rom√¢nƒÉ",flag:"üá∑üá¥"},
      {code:"ru",name:"–†—É—Å—Å–∫–∏–π",flag:"üá∑üá∫"},
      {code:"sr",name:"–°—Ä–ø—Å–∫–∏",flag:"üá∑üá∏"},
      {code:"si",name:"‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω",flag:"üá±üá∞"},
      {code:"sk",name:"Slovenƒçina",flag:"üá∏üá∞"},
      {code:"sl",name:"Sloven≈°ƒçina",flag:"üá∏üáÆ"},
      {code:"so",name:"Soomaali",flag:"üá∏üá¥"},
      {code:"es",name:"Espa√±ol",flag:"üá™üá∏"},
      {code:"sw",name:"Kiswahili",flag:"üá∞üá™"},
      {code:"sv",name:"Svenska",flag:"üá∏üá™"},
      {code:"ta",name:"‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç",flag:"üáÆüá≥"},
      {code:"te",name:"‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å",flag:"üáÆüá≥"},
      {code:"th",name:"‡πÑ‡∏ó‡∏¢",flag:"üáπüá≠"},
      {code:"tr",name:"T√ºrk√ße",flag:"üáπüá∑"},
      {code:"uk",name:"–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞",flag:"üá∫üá¶"},
      {code:"ur",name:"ÿßÿ±ÿØŸà",flag:"üáµüá∞"},
      {code:"uz",name:"O‚Äòzbek",flag:"üá∫üáø"},
      {code:"vi",name:"Ti·∫øng Vi·ªát",flag:"üáªüá≥"},
      {code:"cy",name:"Cymraeg",flag:"üè¥"},
      {code:"xh",name:"isiXhosa",flag:"üáøüá¶"},
      {code:"yo",name:"Yor√πb√°",flag:"üá≥üá¨"},
      {code:"zu",name:"isiZulu",flag:"üáøüá¶"},
    ];

    // FIRST'i koru, ALL'den tekrarlarƒ± √ßƒ±kar, sonra alfabetik sƒ±rala
    const firstCodes = new Set(FIRST.map(x=>x.code));
    const rest = ALL.filter(x=>!firstCodes.has(x.code))
      .sort((a,b)=>a.name.localeCompare(b.name, "tr", { sensitivity:"base" }));

    // 81 hedef: FIRST + rest‚Äôten ilk (81 - FIRST.length)
    const TARGET_COUNT = 81;
    const LIST = [...FIRST, ...rest].slice(0, TARGET_COUNT);

    function levelFor(code){
      const v = LEVELS?.[code];
      return (typeof v === "string" && v.trim()) ? v.trim() : "";
    }

    function render(filter=""){
      const q = String(filter||"").trim().toLowerCase();
      const items = !q ? LIST : LIST.filter(x=>{
        return x.code.includes(q) || x.name.toLowerCase().includes(q);
      });

      $("grid").innerHTML = items.map(x=>{
        const lvl = levelFor(x.code);
        const status = lvl ? `Seviyeniz: <span class="lvl">${lvl}</span>` : "Hen√ºz sƒ±nava katƒ±lmadƒ±nƒ±z";
        return `
          <div class="langCard" data-code="${x.code}">
            <div class="flagBox">${x.flag || "üåê"}</div>
            <div class="langName">${x.name}</div>
            <div class="status">${status}</div>
          </div>
        `;
      }).join("");

      document.querySelectorAll(".langCard").forEach(card=>{
        card.addEventListener("click", ()=>{
          const code = card.getAttribute("data-code");
          if(!code) return;
          localStorage.setItem("italky_level_lang", code);
          toast("Sƒ±nav sayfasƒ±na ge√ßiliyor‚Ä¶");
          // ‚úÖ intro sayfasƒ±na lang paramƒ±yla
          setTimeout(()=>location.href = `/pages/level_test_intro.html?lang=${encodeURIComponent(code)}`, 120);
        }, { passive:true });
      });
    }

    $("q").addEventListener("input", ()=>render($("q").value));
    $("btnReset").addEventListener("click", ()=>{
      $("q").value = "";
      render("");
    });

    render("");
  </script>
</body>
</html>
