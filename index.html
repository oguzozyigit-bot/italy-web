<script type="module">
  import { supabase } from "/js/supabase_client.js";
  import { ensureAuthAndCacheUser, loginWithGoogle } from "/js/auth.js";

  const toastEl = document.getElementById("toast");
  const HOME = "/pages/home.html";
  const STORAGE_KEY = "italky_user_v1";

  function toast(msg){
    if(!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(window.__to);
    window.__to = setTimeout(()=>toastEl.classList.remove("show"), 2200);
  }

  // --- NATIVE BRIDGE ---
  
  // 1. Android tarafı giriş yapınca bu fonksiyonu tetikleyecek
  window.onNativeLoginSuccess = async function(jsonResponse) {
    try {
      const data = typeof jsonResponse === "string" ? JSON.parse(jsonResponse) : jsonResponse;
      
      // Gelen JWT ve Kullanıcı bilgisini sakla
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data.user));
      localStorage.setItem("italky_token", data.token); // Backend'den gelen kendi JWT'niz

      toast("Hoş geldin " + data.user.full_name + "!");
      
      // Sayfayı yönlendir
      setTimeout(() => location.replace(HOME), 800);
    } catch (e) {
      toast("Giriş işlenirken hata oluştu.");
      console.error("Native login error:", e);
    }
  };

  function isInApk(){
    // Android tarafında addJavascriptInterface(..., "Native") demiştik
    return !!(window.Native && typeof window.Native.startGoogleLogin === "function");
  }

  async function checkSession(){
    // APK içinde native session kontrolü
    if(hasLocalUser()){
      location.replace(HOME);
      return;
    }

    // Web için standart Supabase kontrolü
    try{
      const { data: { session } } = await supabase.auth.getSession();
      if(session){
        await ensureAuthAndCacheUser();
        location.replace(HOME);
      }
    }catch(e){ console.warn(e); }
  }

  async function handleGoogleClick(){
    if(isInApk()){
      toast("Güvenli giriş başlatılıyor...");
      window.Native.startGoogleLogin(); // Android SDK'yı tetikler
    } else {
      toast("Google yönlendiriliyor...");
      await loginWithGoogle(); // Normal Web akışı
    }
  }

  function hasLocalUser(){
    const raw = localStorage.getItem(STORAGE_KEY);
    return !!raw;
  }

  document.getElementById("googleBtn")?.addEventListener("click", handleGoogleClick);
  checkSession();
</script>
